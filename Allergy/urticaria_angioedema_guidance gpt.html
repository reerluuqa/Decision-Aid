<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Urticaria & Angioedema ‚Äì Rapid Clinical Pathway (Local)</title>
<style>
  :root{
    --bg:#0b1020;
    --panel:#0f1733;
    --panel2:#0c1430;
    --card:#111b3d;
    --text:#eaf0ff;
    --muted:#aab7e6;
    --line:rgba(255,255,255,.10);
    --shadow: 0 12px 28px rgba(0,0,0,.35);
    --shadow2: 0 8px 20px rgba(0,0,0,.28);
    --red:#ff3b30;
    --red2:#ff6b61;
    --green:#20c997;
    --green2:#30e0b4;
    --amber:#ffb020;
    --blue:#4da3ff;
    --violet:#8a6bff;
    --chip: rgba(255,255,255,.08);
    --focus: rgba(77,163,255,.35);
    --radius: 18px;
    --radius2: 14px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  }

  /* Base */
  html,body{height:100%;}
  body{
    margin:0;
    font-family: var(--sans);
    background: radial-gradient(900px 500px at 10% 0%, rgba(138,107,255,.18), transparent 55%),
                radial-gradient(900px 500px at 90% 0%, rgba(77,163,255,.18), transparent 55%),
                radial-gradient(900px 500px at 50% 110%, rgba(32,201,151,.10), transparent 55%),
                linear-gradient(180deg, var(--bg), #070b18 70%);
    color:var(--text);
  }
  a{ color: var(--blue); text-decoration: none; }
  a:hover{ text-decoration: underline; }

  .app{
    display:grid;
    grid-template-columns: 320px 1fr;
    gap: 18px;
    padding: 18px;
    max-width: 1280px;
    margin: 0 auto;
  }

  /* Sidebar */
  .sidebar{
    position: sticky;
    top: 18px;
    align-self: start;
    border: 1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border-radius: var(--radius);
    box-shadow: var(--shadow2);
    overflow:hidden;
  }
  .brand{
    padding: 16px 16px 12px;
    border-bottom: 1px solid var(--line);
    background: linear-gradient(135deg, rgba(138,107,255,.18), rgba(77,163,255,.10));
  }
  .brand h1{
    margin:0;
    font-size: 15px;
    letter-spacing: .3px;
    font-weight: 800;
  }
  .brand .sub{
    margin-top: 6px;
    font-size: 12px;
    color: var(--muted);
    line-height: 1.35;
  }
  .nav{
    padding: 12px;
    display:flex;
    flex-direction:column;
    gap: 8px;
  }
  .nav button{
    all: unset;
    display:flex;
    align-items:center;
    gap: 10px;
    padding: 10px 10px;
    border-radius: 14px;
    cursor:pointer;
    color: var(--text);
    border: 1px solid transparent;
    background: rgba(255,255,255,.03);
    transition: transform .08s ease, background .15s ease, border-color .15s ease;
  }
  .nav button:hover{
    background: rgba(255,255,255,.06);
    border-color: rgba(255,255,255,.08);
    transform: translateY(-1px);
  }
  .nav button[aria-current="true"]{
    background: rgba(77,163,255,.12);
    border-color: rgba(77,163,255,.22);
    box-shadow: 0 0 0 3px rgba(77,163,255,.14) inset;
  }

  .ico{
    width: 22px; height: 22px;
    display:inline-grid; place-items:center;
    border-radius: 10px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.08);
  }
  .ico svg{ width: 16px; height: 16px; opacity:.95; }

  .side-footer{
    border-top: 1px solid var(--line);
    padding: 12px 14px;
    color: var(--muted);
    font-size: 12px;
    display:flex;
    gap: 10px;
    align-items: center;
    justify-content: space-between;
  }
  .pill{
    display:inline-flex;
    gap:8px;
    align-items:center;
    padding: 6px 10px;
    border-radius: 999px;
    background: rgba(255,255,255,.05);
    border: 1px solid rgba(255,255,255,.08);
  }
  .kbd{
    font-family: var(--mono);
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 8px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.10);
    color: var(--text);
  }

  /* Main header */
  .main{
    border-radius: var(--radius);
    border: 1px solid var(--line);
    overflow:hidden;
    box-shadow: var(--shadow);
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
  }
  .topbar{
    padding: 16px 16px 14px;
    border-bottom: 1px solid var(--line);
    display:flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    justify-content: space-between;
    background:
      radial-gradient(600px 220px at 15% 0%, rgba(32,201,151,.13), transparent 60%),
      radial-gradient(600px 220px at 85% 0%, rgba(255,59,48,.10), transparent 60%);
  }
  .topbar .title{
    display:flex;
    gap: 10px;
    align-items: center;
  }
  .topbar h2{
    margin:0;
    font-size: 18px;
    letter-spacing: .2px;
  }
  .topbar .meta{
    margin-top: 4px;
    font-size: 12px;
    color: var(--muted);
  }

  .searchRow{
    display:flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }
  .search{
    position:relative;
    width: 380px;
    max-width: min(380px, 70vw);
  }
  .search input{
    width:100%;
    padding: 10px 12px 10px 38px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.15);
    color: var(--text);
    outline:none;
  }
  .search input:focus{
    border-color: rgba(77,163,255,.35);
    box-shadow: 0 0 0 4px var(--focus);
  }
  .search .lens{
    position:absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    opacity:.85;
  }
  .btn{
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.05);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 14px;
    cursor:pointer;
    font-weight: 650;
    transition: transform .08s ease, background .15s ease, border-color .15s ease;
  }
  .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18); }
  .btn:active{ transform: translateY(0); }
  .btn.secondary{ background: rgba(77,163,255,.10); border-color: rgba(77,163,255,.22); }
  .btn.danger{ background: rgba(255,59,48,.10); border-color: rgba(255,59,48,.25); }
  .btn.success{ background: rgba(32,201,151,.10); border-color: rgba(32,201,151,.22); }

  /* Content */
  .content{
    padding: 16px;
  }

  .grid2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }
  @media (max-width: 980px){
    .app{ grid-template-columns: 1fr; }
    .sidebar{ position: relative; top:auto; }
    .grid2{ grid-template-columns: 1fr; }
    .search{ width:100%; max-width: 100%; }
  }

  .card{
    border: 1px solid rgba(255,255,255,.10);
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border-radius: var(--radius);
    box-shadow: 0 8px 22px rgba(0,0,0,.22);
    overflow:hidden;
  }
  .card .hd{
    padding: 14px 14px 12px;
    display:flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    border-bottom: 1px solid var(--line);
    background: rgba(0,0,0,.08);
  }
  .card .hd h3{
    margin:0;
    font-size: 14px;
    letter-spacing:.2px;
  }
  .card .bd{ padding: 14px; }

  .callout{
    border-radius: var(--radius);
    padding: 14px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
    display:flex;
    gap: 12px;
    align-items: flex-start;
    box-shadow: 0 12px 26px rgba(0,0,0,.18);
    position:relative;
  }
  .callout .badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 6px 10px;
    border-radius: 999px;
    font-weight: 800;
    letter-spacing: .2px;
    font-size: 12px;
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(255,255,255,.06);
    width: fit-content;
  }
  .callout .txt{ flex:1; }
  .callout .txt h4{ margin: 0 0 6px; font-size: 14px; }
  .callout .txt p{ margin:0; color: var(--muted); line-height: 1.4; font-size: 13px; }
  .callout .items{ margin-top: 10px; display:grid; gap: 8px; }
  .item{
    display:flex;
    gap:10px;
    align-items:flex-start;
    padding: 10px 10px;
    border-radius: 14px;
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.08);
    transition: transform .08s ease, background .15s ease, border-color .15s ease;
  }
  .item:hover{ transform: translateY(-1px); background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.14); }
  .item .dot{
    width: 26px; height: 26px;
    border-radius: 10px;
    display:grid; place-items:center;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.18);
    flex: 0 0 auto;
  }
  .item .dot svg{ width: 16px; height: 16px; }
  .item .k{ font-weight: 750; font-size: 13px; }
  .item .v{ color: var(--muted); font-size: 12.5px; margin-top: 2px; line-height: 1.35; }
  .item .stack{ display:flex; flex-direction:column; }

  .red{ border-color: rgba(255,59,48,.35); background: rgba(255,59,48,.08); }
  .red .badge{ background: rgba(255,59,48,.12); border-color: rgba(255,59,48,.30); color: #ffe9e8; }
  .green{ border-color: rgba(32,201,151,.30); background: rgba(32,201,151,.07); }
  .green .badge{ background: rgba(32,201,151,.10); border-color: rgba(32,201,151,.25); color: #e7fff6; }
  .amber{ border-color: rgba(255,176,32,.32); background: rgba(255,176,32,.07); }
  .amber .badge{ background: rgba(255,176,32,.12); border-color: rgba(255,176,32,.30); color: #fff5de; }

  /* Accordions */
  details{
    border-radius: var(--radius);
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    overflow:hidden;
  }
  details + details{ margin-top: 10px; }
  summary{
    cursor:pointer;
    padding: 12px 14px;
    display:flex;
    gap: 10px;
    align-items:center;
    list-style: none;
    user-select:none;
    outline:none;
  }
  summary::-webkit-details-marker{ display:none; }
  summary .chev{ margin-left:auto; opacity:.9; transition: transform .16s ease; }
  details[open] summary .chev{ transform: rotate(90deg); }
  summary .label{ font-weight: 800; font-size: 13px; }
  summary .hint{ color: var(--muted); font-size: 12px; }
  details .inner{ padding: 0 14px 14px; color: var(--muted); font-size: 13px; line-height: 1.45; }
  .inner .mini{
    margin-top: 10px;
    display:grid;
    gap: 8px;
  }
  .chipRow{ display:flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
  .chip{
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.10);
    background: var(--chip);
    color: var(--text);
    font-size: 12px;
    cursor: pointer;
    transition: transform .08s ease, background .15s ease, border-color .15s ease;
  }
  .chip:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.16); }
  .chip:active{ transform: translateY(0); }

  /* Flow */
  .flow{
    display:grid;
    grid-template-columns: 1fr;
    gap: 12px;
  }
  .step{
    border-radius: var(--radius);
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    padding: 12px;
    display:flex;
    gap: 12px;
    align-items:flex-start;
    position: relative;
    overflow:hidden;
  }
  .step::before{
    content:"";
    position:absolute;
    left:0; top:0; bottom:0;
    width: 6px;
    background: rgba(77,163,255,.8);
  }
  .step.green::before{ background: rgba(32,201,151,.9); }
  .step.red::before{ background: rgba(255,59,48,.9); }
  .step.amber::before{ background: rgba(255,176,32,.95); }
  .step .n{
    width: 34px; height: 34px;
    border-radius: 14px;
    display:grid; place-items:center;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.12);
    font-weight: 900;
    flex: 0 0 auto;
  }
  .step .s{
    flex:1;
  }
  .step .s .t{
    font-weight: 900;
    font-size: 13px;
    margin: 2px 0 6px;
    color: var(--text);
  }
  .step .s .d{
    color: var(--muted);
    font-size: 12.5px;
    line-height: 1.4;
  }
  .step .actions{
    display:flex;
    flex-direction: column;
    gap: 8px;
    align-items:flex-end;
  }
  .miniBtn{
    font-size: 12px;
    padding: 7px 10px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.05);
    color: var(--text);
    cursor:pointer;
  }
  .miniBtn:hover{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18); }

  /* Forms */
  .formGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .field{
    display:flex;
    flex-direction:column;
    gap: 6px;
  }
  .field label{
    font-size: 12px;
    color: var(--muted);
  }
  .field input,.field select,.field textarea{
    padding: 10px 10px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.16);
    color: var(--text);
    outline:none;
  }
  .field input:focus,.field select:focus,.field textarea:focus{
    border-color: rgba(77,163,255,.35);
    box-shadow: 0 0 0 4px var(--focus);
  }
  textarea{ min-height: 84px; resize: vertical; }
  .helper{
    font-size: 12px;
    color: var(--muted);
    margin-top: 8px;
    line-height: 1.4;
  }

  .table{
    width:100%;
    border-collapse: separate;
    border-spacing: 0;
    overflow:hidden;
    border-radius: var(--radius);
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.02);
  }
  .table th, .table td{
    padding: 10px 10px;
    border-bottom: 1px solid rgba(255,255,255,.08);
    vertical-align: top;
    font-size: 12.5px;
  }
  .table th{
    text-align:left;
    color: var(--text);
    background: rgba(255,255,255,.05);
    font-weight: 850;
  }
  .table td{ color: var(--muted); }
  .table tr:last-child td{ border-bottom: none; }
  .rowActions{
    display:flex;
    gap: 8px;
    justify-content:flex-end;
  }
  .tag{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.05);
    font-size: 11px;
    color: var(--text);
  }
  .tag.red{ background: rgba(255,59,48,.10); border-color: rgba(255,59,48,.22); }
  .tag.green{ background: rgba(32,201,151,.10); border-color: rgba(32,201,151,.22); }

  /* Toast */
  .toast{
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    background: rgba(15,23,51,.92);
    border: 1px solid rgba(255,255,255,.12);
    box-shadow: var(--shadow);
    border-radius: 999px;
    padding: 10px 12px;
    display:flex;
    gap: 10px;
    align-items:center;
    opacity: 0;
    pointer-events:none;
    transition: opacity .18s ease, transform .18s ease;
    max-width: min(720px, 92vw);
  }
  .toast.show{
    opacity: 1;
    transform: translateX(-50%) translateY(-4px);
  }
  .toast .msg{ font-size: 12.5px; color: var(--text); }
  .toast .small{ font-size: 12px; color: var(--muted); }
  .toast .x{
    margin-left:auto;
    cursor:pointer;
    border-radius: 999px;
    width: 30px; height: 30px;
    display:grid; place-items:center;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.05);
  }

  /* Print */
  @media print{
    body{ background: #fff; color:#000; }
    .app{ grid-template-columns: 1fr; max-width: none; padding:0; }
    .sidebar, .topbar .searchRow, .toast{ display:none !important; }
    .main{ border:none; box-shadow:none; background:#fff; }
    .card, details, .callout, .step{ break-inside: avoid; }
    .card,.callout,.step,details{ background:#fff !important; color:#000 !important; border: 1px solid #ddd !important; }
    .muted, .helper, .table td{ color:#333 !important; }
  }
</style>
</head>

<body>
<div class="app">

  <!-- Sidebar -->
  <aside class="sidebar" aria-label="Navigation">
    <div class="brand">
      <h1>Urticaria & Angioedema</h1>
      <div class="sub">Rapid pathway ‚Ä¢ emphasises red flags, core triage, and stepwise control.</div>
    </div>

    <div class="nav" role="navigation">
      <button data-route="triage" aria-current="true">
        <span class="ico" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 2l9 4v6c0 5-3.8 9.7-9 10-5.2-.3-9-5-9-10V6l9-4Z" stroke="currentColor" stroke-width="2"/></svg>
        </span>
        <span>Rapid triage</span>
      </button>

      <button data-route="pathway">
        <span class="ico" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none"><path d="M4 6h10M4 12h16M4 18h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </span>
        <span>Core pathway</span>
      </button>

      <button data-route="dosing">
        <span class="ico" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none"><path d="M8 2h8v4H8V2Zm-3 7h14a3 3 0 0 1 3 3v7H2v-7a3 3 0 0 1 3-3Z" stroke="currentColor" stroke-width="2"/></svg>
        </span>
        <span>Stepwise control</span>
      </button>

      <button data-route="uas7">
        <span class="ico" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none"><path d="M4 19V5m0 14h16M8 15l2-3 3 2 3-6 2 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </span>
        <span>UAS7 tool</span>
      </button>

      <button data-route="diary">
        <span class="ico" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none"><path d="M7 4h10a2 2 0 0 1 2 2v14H7a2 2 0 0 0-2 2V6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2"/><path d="M7 20h12" stroke="currentColor" stroke-width="2"/></svg>
        </span>
        <span>Trigger diary</span>
      </button>

      <button data-route="referral">
        <span class="ico" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none"><path d="M6 7h12M6 12h8M6 17h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M18 2v6M15 5h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </span>
        <span>Referral & tests</span>
      </button>
    </div>

    <div class="side-footer">
      <span class="pill"><span class="kbd">/</span> search</span>
      <span class="pill"><span class="kbd">P</span> print</span>
    </div>
  </aside>

  <!-- Main -->
  <main class="main" role="main">
    <header class="topbar">
      <div class="title">
        <span class="ico" aria-hidden="true" style="background: rgba(255,255,255,.08)">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 21s-7-4.4-7-11a7 7 0 0 1 14 0c0 6.6-7 11-7 11Z" stroke="currentColor" stroke-width="2"/><path d="M9 10h6M12 7v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </span>
        <div>
          <h2 id="pageTitle">Rapid triage</h2>
          <div class="meta" id="pageMeta">Airway risk first ‚Ä¢ classify phenotype ‚Ä¢ act fast</div>
        </div>
      </div>

      <div class="searchRow">
        <div class="search" role="search">
          <span class="lens" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none"><path d="M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </span>
          <input id="q" type="text" placeholder="Search within pathway (e.g., ACEi, C4, tranexamic, airway)" autocomplete="off" />
        </div>
        <button class="btn secondary" id="copyLink">Copy deep link</button>
        <button class="btn" id="reset">Reset</button>
        <button class="btn" id="printBtn" title="Print current view">Print</button>
      </div>
    </header>

    <section class="content" id="view"></section>
  </main>

</div>

<!-- Toast -->
<div class="toast" id="toast" role="status" aria-live="polite">
  <div>
    <div class="msg" id="toastMsg">Copied</div>
    <div class="small" id="toastSub"></div>
  </div>
  <div class="x" id="toastX" aria-label="Dismiss">
    <svg viewBox="0 0 24 24" width="16" height="16" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
  </div>
</div>

<script>
/* --------------------------- tiny helpers --------------------------- */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const escapeHtml = (s) => (s ?? "").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
const nowIso = () => new Date().toISOString().slice(0,10);

function toast(msg, sub=""){
  $("#toastMsg").textContent = msg;
  $("#toastSub").textContent = sub;
  $("#toast").classList.add("show");
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(()=>$("#toast").classList.remove("show"), 2200);
}

/* --------------------------- data (pathway) --------------------------
   Built from local doc pathway text:
   - Angioedema resolves fully between episodes (often <24h)
   - If no clear trigger, allergy unlikely; use trigger diary
   - With urticaria + swelling: likely spontaneous urticaria (benign nuisance)
   - Without urticaria + no trigger: check complement C4
   - ACE inhibitor angioedema: stop ACEi; can occur after years; antihistamines/steroids/adrenaline usually ineffective; ARB usually tolerated; airway episodes need urgent care; icatibant used but evidence poor
   - Stepwise antihistamine escalation; consider tranexamic acid 1000 mg TDS; 1‚Äì4 weeks between dose steps; stay controlled 3‚Äì6 months then step down
   - Avoid NSAIDs and ACEi (associated)
   - Refer to specialist urticaria service if problematic despite high-dose antihistamines; include UAS7
--------------------------------------------------------------------- */

const PAGES = {
  triage: {
    title: "Rapid triage",
    meta: "Airway risk first ‚Ä¢ classify phenotype ‚Ä¢ act fast",
    render: () => `
      <div class="grid2">
        <div class="card">
          <div class="hd">
            <h3>Red flags (act now)</h3>
            <span class="tag red" title="Immediate action">üö® Immediate</span>
          </div>
          <div class="bd">
            <div class="callout red" data-search="airway breathing throat constriction light headed 999">
              <div class="txt">
                <div class="badge">üî¥ RED FLAGS</div>
                <h4>Airway involvement or systemic compromise</h4>
                <p>Airway compromise is uncommon, but if present: treat as time-critical and escalate immediately.</p>
                <div class="items">
                  <div class="item">
                    <div class="dot" aria-hidden="true">ü´Å</div>
                    <div class="stack">
                      <div class="k">Breathing difficulty / stridor / voice change</div>
                      <div class="v">Any airway symptoms ‚Üí urgent in-hospital attention / emergency response.</div>
                    </div>
                  </div>
                  <div class="item">
                    <div class="dot" aria-hidden="true">üß†</div>
                    <div class="stack">
                      <div class="k">Throat constriction or light-headedness</div>
                      <div class="v">Emergency response pathway / ambulance activation.</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="callout amber" data-search="persistent swelling not angioedema duration 24 hours">
              <div class="txt">
                <div class="badge">üü† KEY PITFALL</div>
                <h4>Persistent swelling ‚â† angioedema</h4>
                <p>Angioedema typically resolves completely between episodes (generally &lt;24 hours). Persistent swelling suggests alternative diagnoses.</p>
              </div>
            </div>

          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h3>Phenotype (choose the lane)</h3>
            <span class="tag">üß≠ Decision</span>
          </div>
          <div class="bd">
            <div class="flow">
              <div class="step green" data-search="urticaria wheals angioedema with urticaria spontaneous urticaria">
                <div class="n">1</div>
                <div class="s">
                  <div class="t">Swelling + urticaria (wheals) and no clear trigger</div>
                  <div class="d">Most consistent with <b>spontaneous urticaria</b> (may include angioedema). Not an allergy; often autoimmune; typically resolves over time.</div>
                </div>
                <div class="actions">
                  <button class="miniBtn" onclick="go('dosing')">Go to stepwise control</button>
                  <button class="miniBtn" onclick="go('uas7')">Open UAS7 tool</button>
                </div>
              </div>

              <div class="step amber" data-search="no trigger diary suspected triggers time from exposure photographs">
                <div class="n">2</div>
                <div class="s">
                  <div class="t">Unclear trigger or concern for allergy</div>
                  <div class="d">Keep a detailed trigger diary: suspected triggers, latency to symptoms, symptom description + photos.</div>
                </div>
                <div class="actions">
                  <button class="miniBtn" onclick="go('diary')">Trigger diary</button>
                </div>
              </div>

              <div class="step green" data-search="angioedema without urticaria complement C4 normal elevated low">
                <div class="n">3</div>
                <div class="s">
                  <div class="t">Swelling without urticaria + no clear trigger</div>
                  <div class="d">Send blood for <b>complement C4</b>. If low, re-refer with result. If normal/elevated, consider spontaneous angioedema as likely diagnosis.</div>
                </div>
                <div class="actions">
                  <button class="miniBtn" onclick="go('referral')">C4 & referral</button>
                </div>
              </div>

              <div class="step red" data-search="ACE inhibitor ACEi induced angioedema stop ACEi ARB tolerated icatibant ineffective antihistamine steroid adrenaline">
                <div class="n">4</div>
                <div class="s">
                  <div class="t">On ACE inhibitor (even long-term)</div>
                  <div class="d"><b>ACEi angioedema can occur after years.</b> Primary action: stop ACEi and avoid all ACE inhibitors. Episodes may persist for ~3 months after cessation; if beyond, reassess other causes.</div>
                </div>
                <div class="actions">
                  <button class="miniBtn" onclick="go('referral')">ACEi pathway</button>
                </div>
              </div>
            </div>

            <div style="height:12px"></div>
            <details>
              <summary>
                <span class="label">Common co-factors (often overlooked)</span>
                <span class="hint">click to expand</span>
                <span class="chev">‚Ä∫</span>
              </summary>
              <div class="inner" data-search="stress trauma infection exercise temperature pressure NSAIDs alcohol fatigue sleep deprivation">
                Co-factors frequently associated with symptom flares:
                <div class="chipRow">
                  <span class="chip" onclick="copyText('Stress')">Stress</span>
                  <span class="chip" onclick="copyText('Trauma')">Trauma</span>
                  <span class="chip" onclick="copyText('Infection')">Infection</span>
                  <span class="chip" onclick="copyText('Exercise')">Exercise</span>
                  <span class="chip" onclick="copyText('Temperature change')">Temperature change</span>
                  <span class="chip" onclick="copyText('Pressure')">Pressure</span>
                  <span class="chip" onclick="copyText('NSAIDs')">NSAIDs</span>
                  <span class="chip" onclick="copyText('Alcohol')">Alcohol</span>
                  <span class="chip" onclick="copyText('Fatigue / sleep deprivation')">Fatigue / sleep deprivation</span>
                </div>
                <div class="helper">Tip: click a chip to copy into documentation.</div>
              </div>
            </details>

          </div>
        </div>
      </div>
    `
  },

  pathway: {
    title: "Core pathway",
    meta: "One screen logic ‚Ä¢ focused actions ‚Ä¢ referral triggers",
    render: () => `
      <div class="grid2">

        <div class="card">
          <div class="hd">
            <h3>Immediate actions</h3>
            <span class="tag green">‚úÖ Recommended</span>
          </div>
          <div class="bd">
            <div class="callout green" data-search="avoid NSAIDs ACE inhibitors urticaria angioedema">
              <div class="txt">
                <div class="badge">üü¢ DO NOW</div>
                <h4>Reduce provocation & iatrogenic drivers</h4>
                <p>Medication review and avoidance steps that reduce recurrence risk.</p>
                <div class="items">
                  <div class="item">
                    <div class="dot" aria-hidden="true">üíä</div>
                    <div class="stack">
                      <div class="k">Avoid NSAIDs where feasible</div>
                      <div class="v">NSAIDs are associated with urticaria/angioedema flares.</div>
                    </div>
                  </div>
                  <div class="item">
                    <div class="dot" aria-hidden="true">‚õî</div>
                    <div class="stack">
                      <div class="k">Stop & avoid ACE inhibitors if ACEi angioedema suspected</div>
                      <div class="v">ARB is usually tolerated and offers similar cardioprotective benefits.</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="callout amber" data-search="antihistamines steroids adrenaline ineffective ACEi induced angioedema">
              <div class="txt">
                <div class="badge">üü† IMPORTANT</div>
                <h4>ACEi-induced angioedema: typical therapies often fail</h4>
                <p>Antihistamines, glucocorticoids, and adrenaline are usually considered ineffective. Episodes often resolve spontaneously; airway involvement still mandates urgent care.</p>
              </div>
            </div>

          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h3>Diagnostic anchor</h3>
            <span class="tag">üß© Clarify mechanism</span>
          </div>
          <div class="bd">
            <details open>
              <summary>
                <span class="label">Is this angioedema?</span>
                <span class="hint">episode pattern</span>
                <span class="chev">‚Ä∫</span>
              </summary>
              <div class="inner" data-search="angioedema resolves completely between episodes less than 24 hours persistent swelling">
                <div class="mini">
                  <div class="item">
                    <div class="dot" aria-hidden="true">‚è±Ô∏è</div>
                    <div class="stack">
                      <div class="k">Typical duration</div>
                      <div class="v">Angioedema resolves completely between episodes; episodes generally do not last longer than 24 hours.</div>
                    </div>
                  </div>
                  <div class="item">
                    <div class="dot" aria-hidden="true">üß±</div>
                    <div class="stack">
                      <div class="k">Persistent swelling</div>
                      <div class="v">Not consistent with angioedema ‚Üí consider alternative causes.</div>
                    </div>
                  </div>
                </div>
              </div>
            </details>

            <details>
              <summary>
                <span class="label">With urticaria (wheals)</span>
                <span class="hint">most common</span>
                <span class="chev">‚Ä∫</span>
              </summary>
              <div class="inner" data-search="spontaneous urticaria benign nuisance not allergy autoimmune high alert resolves within 3 years">
                Likely <b>spontaneous urticaria</b> (with or without angioedema), usually benign and not allergy-mediated.
                <div class="chipRow">
                  <span class="chip" onclick="go('dosing')">Stepwise control</span>
                  <span class="chip" onclick="go('uas7')">UAS7 scoring</span>
                </div>
              </div>
            </details>

            <details>
              <summary>
                <span class="label">Without urticaria (isolated swelling)</span>
                <span class="hint">send C4</span>
                <span class="chev">‚Ä∫</span>
              </summary>
              <div class="inner" data-search="complement C4 low normal elevated spontaneous angioedema histamine bradykinin">
                Send blood for <b>complement C4</b> when swelling occurs without urticaria and there is no clear trigger.
                <div class="mini">
                  <div class="item">
                    <div class="dot" aria-hidden="true">üß™</div>
                    <div class="stack">
                      <div class="k">C4 low</div>
                      <div class="v">Re-refer with result for specialist input.</div>
                    </div>
                  </div>
                  <div class="item">
                    <div class="dot" aria-hidden="true">‚úÖ</div>
                    <div class="stack">
                      <div class="k">C4 normal / elevated</div>
                      <div class="v">Consider spontaneous angioedema as likely diagnosis.</div>
                    </div>
                  </div>
                </div>
                <div class="chipRow">
                  <span class="chip" onclick="go('referral')">C4/referral panel</span>
                </div>
              </div>
            </details>

          </div>
        </div>

      </div>
    `
  },

  dosing: {
    title: "Stepwise control",
    meta: "Non-sedating antihistamines first ‚Ä¢ escalate safely ‚Ä¢ step down once controlled",
    render: () => `
      <div class="grid2">
        <div class="card">
          <div class="hd">
            <h3>High-yield algorithm</h3>
            <span class="tag green">‚úÖ Action ladder</span>
          </div>
          <div class="bd">
            <div class="callout green" data-search="loratadine cetirizine fexofenadine double triple quadruple dose 1-4 weeks">
              <div class="txt">
                <div class="badge">üü¢ FIRST-LINE</div>
                <h4>Non-sedating H1 antihistamines (stepwise)</h4>
                <p>Use PRN if infrequent; regular dosing if weekly+ symptoms. Escalate beyond conventional doses if needed (double/triple/quadruple), leaving 1‚Äì4 weeks between each incremental step.</p>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="flow">
              <div class="step green" data-search="infrequent symptoms antihistamine PRN repeat after half an hour">
                <div class="n">A</div>
                <div class="s">
                  <div class="t">Infrequent symptoms</div>
                  <div class="d">Non-sedating antihistamine PRN; dose may be repeated after ~30 minutes if required.</div>
                </div>
                <div class="actions">
                  <button class="miniBtn" onclick="prefillPlan('PRN')">Load note</button>
                </div>
              </div>

              <div class="step green" data-search="frequent weekly or more antihistamine regular dosing">
                <div class="n">B</div>
                <div class="s">
                  <div class="t">Frequent symptoms (weekly+)</div>
                  <div class="d">Use regular non-sedating antihistamine.</div>
                </div>
                <div class="actions">
                  <button class="miniBtn" onclick="prefillPlan('REG')">Load note</button>
                </div>
              </div>

              <div class="step amber" data-search="exceed conventional dose double triple quadruple two tablets BD drowsiness heavy machinery">
                <div class="n">C</div>
                <div class="s">
                  <div class="t">If not controlled ‚Üí increase dose</div>
                  <div class="d">Escalate to higher doses (e.g., double/triple/quadruple; example: two tablets BD). Long-term safety is acceptable; monitor drowsiness and advise against operating heavy machinery if sedated.</div>
                </div>
                <div class="actions">
                  <button class="miniBtn" onclick="openDoseHelper()">Dose helper</button>
                </div>
              </div>

              <div class="step amber" data-search="tranexamic acid 1000 mg three times a day">
                <div class="n">D</div>
                <div class="s">
                  <div class="t">If still inadequately controlled</div>
                  <div class="d">Trial of tranexamic acid <b>1000 mg TDS</b> may benefit some patients.</div>
                </div>
                <div class="actions">
                  <button class="miniBtn" onclick="prefillPlan('TXA')">Load note</button>
                </div>
              </div>

              <div class="step green" data-search="complete control 3-6 months step down">
                <div class="n">E</div>
                <div class="s">
                  <div class="t">Once complete control achieved</div>
                  <div class="d">Maintain that step for <b>3‚Äì6 months</b>, then step down gradually. If recurrence occurs, revert to the last effective step and retry step-down after 3‚Äì6 months.</div>
                </div>
                <div class="actions">
                  <button class="miniBtn" onclick="prefillPlan('STEPDOWN')">Load note</button>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h3>Quick documentation</h3>
            <span class="tag">üìù One-click note</span>
          </div>
          <div class="bd">
            <div class="formGrid">
              <div class="field">
                <label>Antihistamine</label>
                <select id="ah">
                  <option value="Loratadine 10 mg">Loratadine 10 mg</option>
                  <option value="Cetirizine 10 mg">Cetirizine 10 mg</option>
                  <option value="Fexofenadine 180 mg">Fexofenadine 180 mg</option>
                </select>
              </div>
              <div class="field">
                <label>Dose step</label>
                <select id="stepSel">
                  <option value="standard">Standard</option>
                  <option value="double">Double dose</option>
                  <option value="triple">Triple dose</option>
                  <option value="quadruple">Quadruple dose</option>
                </select>
              </div>
              <div class="field">
                <label>Interval between escalations</label>
                <select id="intervalSel">
                  <option value="1‚Äì4 weeks">1‚Äì4 weeks</option>
                  <option value="~2 weeks">~2 weeks</option>
                  <option value="~4 weeks">~4 weeks</option>
                </select>
              </div>
              <div class="field">
                <label>Control duration before stepping down</label>
                <select id="maintSel">
                  <option value="3‚Äì6 months">3‚Äì6 months</option>
                  <option value="3 months">3 months</option>
                  <option value="6 months">6 months</option>
                </select>
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="field">
              <label>Generated note (click to copy)</label>
              <textarea id="note" readonly onclick="copyText(this.value)"></textarea>
              <div class="helper">Tip: click inside the note to copy. Press <span class="kbd">P</span> to print.</div>
            </div>

            <div style="height:10px"></div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn success" onclick="genNote()">Generate</button>
              <button class="btn" onclick="copyText($('#note').value)">Copy</button>
              <button class="btn secondary" onclick="go('referral')">Referral triggers</button>
            </div>

            <div style="height:12px"></div>

            <div class="callout amber" data-search="avoid NSAIDs ACE inhibitors">
              <div class="txt">
                <div class="badge">üü† REMINDERS</div>
                <h4>Avoidance</h4>
                <p>Both NSAIDs and ACE inhibitors are associated with urticaria/angioedema and should be avoided where feasible.</p>
              </div>
            </div>

          </div>
        </div>
      </div>

      <dialog id="doseDialog" style="max-width: 720px; width: min(720px, 92vw); border:none; border-radius: 18px; padding:0; background: rgba(15,23,51,.98); color: var(--text); box-shadow: var(--shadow);">
        <div style="padding: 14px 14px 12px; border-bottom: 1px solid rgba(255,255,255,.12); display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <div style="font-weight: 900;">Dose helper (quick reference)</div>
          <button class="btn" onclick="$('#doseDialog').close()">Close</button>
        </div>
        <div style="padding: 14px;">
          <div class="callout green" style="margin-bottom: 10px;">
            <div class="txt">
              <div class="badge">üü¢ SAFE ESCALATION</div>
              <h4>Beyond standard dose may be required</h4>
              <p>Doubling/tripling/quadrupling is described as safe long-term; counsel re drowsiness and heavy machinery if sedation occurs.</p>
            </div>
          </div>
          <table class="table" aria-label="Dose stepping reference">
            <thead>
              <tr>
                <th>Agent</th><th>Standard</th><th>Double</th><th>Triple</th><th>Quadruple</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><b>Loratadine</b></td>
                <td>10 mg daily</td>
                <td>20 mg daily or 10 mg BD</td>
                <td>30 mg daily (e.g., 10 mg TDS)</td>
                <td>40 mg daily (e.g., 20 mg BD)</td>
              </tr>
              <tr>
                <td><b>Cetirizine</b></td>
                <td>10 mg daily</td>
                <td>20 mg daily or 10 mg BD</td>
                <td>30 mg daily (e.g., 10 mg TDS)</td>
                <td>40 mg daily (e.g., 20 mg BD)</td>
              </tr>
              <tr>
                <td><b>Fexofenadine</b></td>
                <td>180 mg daily</td>
                <td>360 mg daily (e.g., 180 mg BD)</td>
                <td>540 mg daily (e.g., 180 mg TDS)</td>
                <td>720 mg daily (e.g., 360 mg BD)</td>
              </tr>
            </tbody>
          </table>
          <div class="helper">Note: This is a pragmatic step visualization to support documentation; keep interval between escalations at 1‚Äì4 weeks.</div>
        </div>
      </dialog>
    `
  },

  uas7: {
    title: "UAS7 tool",
    meta: "Fast scoring ‚Ä¢ copy result ‚Ä¢ supports referral",
    render: () => `
      <div class="grid2">
        <div class="card">
          <div class="hd">
            <h3>UAS7 calculator</h3>
            <span class="tag">üìà Weekly score</span>
          </div>
          <div class="bd" data-search="UAS7 wheals itch 0 to 3 over 7 days 0 to 6 daily">
            <div class="callout green" style="margin-bottom: 12px;">
              <div class="txt">
                <div class="badge">üü¢ HOW IT WORKS</div>
                <h4>Two scores/day for 7 days</h4>
                <p>Score <b>wheals</b> and <b>itch</b> each from 0‚Äì3 daily. Add together (0‚Äì6 per day). Sum across 7 days = <b>UAS7</b>.</p>
              </div>
            </div>

            <table class="table" id="uasTable" aria-label="UAS7 entry table">
              <thead>
                <tr>
                  <th style="width:70px;">Day</th>
                  <th>Wheals (0‚Äì3)</th>
                  <th>Itch (0‚Äì3)</th>
                  <th style="width:90px;">Daily</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <th colspan="3">Total UAS7</th>
                  <th id="uasTotal">0</th>
                </tr>
              </tfoot>
            </table>

            <div style="height: 12px"></div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn success" onclick="uasCopy()">Copy summary</button>
              <button class="btn" onclick="uasReset()">Reset</button>
              <button class="btn secondary" onclick="go('referral')">Referral panel</button>
            </div>

            <div class="helper" id="uasHint"></div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h3>Referral cue card</h3>
            <span class="tag red">üè• Escalate</span>
          </div>
          <div class="bd">
            <div class="callout red" data-search="protracted problematic despite high dose antihistamines refer Specialist Urticaria Service omalizumab immunosuppressive">
              <div class="txt">
                <div class="badge">üî¥ REFER</div>
                <h4>Problematic symptoms despite high-dose antihistamines</h4>
                <p>If urticaria remains protracted/problematic despite high-dose non-sedating antihistamines, refer to a specialist urticaria service (access to omalizumab ¬± immunosuppressive therapies). Include UAS7 with referral.</p>
                <div class="items">
                  <div class="item">
                    <div class="dot" aria-hidden="true">üìé</div>
                    <div class="stack">
                      <div class="k">Attach UAS7</div>
                      <div class="v">Generated from the table on the left (copy button).</div>
                    </div>
                  </div>
                  <div class="item">
                    <div class="dot" aria-hidden="true">üíä</div>
                    <div class="stack">
                      <div class="k">Document high-dose regimen</div>
                      <div class="v">E.g., cetirizine/loratadine 20 mg BD or fexofenadine 360 mg BD.</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div style="height:12px"></div>
            <details>
              <summary>
                <span class="label">One-click referral phrase</span>
                <span class="hint">copy to clipboard</span>
                <span class="chev">‚Ä∫</span>
              </summary>
              <div class="inner">
                <button class="chip" onclick="copyText(referralPhrase())">Copy referral text</button>
                <div class="helper">This generates a short summary including high-dose failure + UAS7 total.</div>
              </div>
            </details>
          </div>
        </div>
      </div>
    `
  },

  diary: {
    title: "Trigger diary",
    meta: "Capture suspected trigger, latency, reproducibility, response",
    render: () => `
      <div class="grid2">
        <div class="card">
          <div class="hd">
            <h3>Diary entry builder</h3>
            <span class="tag">üóÇÔ∏è Exportable</span>
          </div>
          <div class="bd" data-search="trigger diary suspected triggers time from exposure symptoms photographs reproducible treatment response">
            <div class="callout amber" style="margin-bottom: 12px;">
              <div class="txt">
                <div class="badge">üü† USEFUL WHEN</div>
                <h4>Suspected trigger or diagnostic uncertainty</h4>
                <p>Record suspected trigger, time from exposure to symptom onset, detailed symptoms + photos, reproducibility, and treatment/response.</p>
              </div>
            </div>

            <div class="formGrid">
              <div class="field">
                <label>Item / trigger (food, medication, exposure)</label>
                <input id="d_item" placeholder="e.g., penicillin, peanut, NSAID, exercise, temperature change" />
              </div>
              <div class="field">
                <label>How long after exposure?</label>
                <input id="d_latency" placeholder="e.g., 2 hours after dose; 1 day later" />
              </div>
              <div class="field">
                <label>Symptoms (include distribution + photos if available)</label>
                <input id="d_symptoms" placeholder="e.g., facial swelling, wheals, rash, throat tightness" />
              </div>
              <div class="field">
                <label>Reproducible?</label>
                <select id="d_repro">
                  <option value="Unclear">Unclear</option>
                  <option value="Yes (every exposure)">Yes (every exposure)</option>
                  <option value="Intermittent (some exposures)">Intermittent (some exposures)</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>

            <div style="height:10px"></div>
            <div class="field">
              <label>Treatment & response</label>
              <textarea id="d_tx" placeholder="e.g., antihistamines at home, ED treatment, resolved in 24h"></textarea>
            </div>

            <div style="height:10px"></div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn success" onclick="addDiary()">Add row</button>
              <button class="btn" onclick="exportDiary()">Export CSV</button>
              <button class="btn secondary" onclick="printDiary()">Print diary</button>
              <button class="btn danger" onclick="clearDiary()">Clear</button>
            </div>

            <div style="height:12px"></div>
            <table class="table" id="diaryTable" aria-label="Trigger diary table">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Symptoms</th>
                  <th>Latency</th>
                  <th>Reproducible</th>
                  <th>Treatment & response</th>
                  <th style="width:120px;">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <div class="helper">Local-only: data is stored in your browser (localStorage) and never leaves the device unless you export/print.</div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h3>At-a-glance prompts</h3>
            <span class="tag">üß† High yield</span>
          </div>
          <div class="bd">
            <details open>
              <summary>
                <span class="label">What to capture (minimum dataset)</span>
                <span class="hint">documentation</span>
                <span class="chev">‚Ä∫</span>
              </summary>
              <div class="inner">
                <div class="mini">
                  <div class="item"><div class="dot">üéØ</div><div class="stack"><div class="k">Exact suspected trigger(s)</div><div class="v">Food, medication, co-factor, contact, infection, exertion, temperature/pressure.</div></div></div>
                  <div class="item"><div class="dot">‚è±Ô∏è</div><div class="stack"><div class="k">Latency from exposure</div><div class="v">Minutes, hours, days (be precise; include dosing day if medication).</div></div></div>
                  <div class="item"><div class="dot">üñºÔ∏è</div><div class="stack"><div class="k">Symptoms + photos</div><div class="v">Wheals vs swelling, distribution, airway symptoms; photo timestamps if available.</div></div></div>
                  <div class="item"><div class="dot">üîÅ</div><div class="stack"><div class="k">Reproducibility</div><div class="v">Every exposure vs intermittent vs unclear.</div></div></div>
                  <div class="item"><div class="dot">üíä</div><div class="stack"><div class="k">Treatment & response</div><div class="v">What was used and how quickly it worked; duration to full resolution.</div></div></div>
                </div>
              </div>
            </details>

            <details>
              <summary>
                <span class="label">When diary matters most</span>
                <span class="hint">triage</span>
                <span class="chev">‚Ä∫</span>
              </summary>
              <div class="inner">
                <div class="chipRow">
                  <span class="chip" onclick="go('triage')">Unclear phenotype</span>
                  <span class="chip" onclick="go('pathway')">Possible allergy concern</span>
                  <span class="chip" onclick="go('referral')">Pre-referral workup</span>
                </div>
              </div>
            </details>
          </div>
        </div>
      </div>
    `
  },

  referral: {
    title: "Referral & tests",
    meta: "C4 decision ‚Ä¢ ACEi management ‚Ä¢ specialist urticaria referral",
    render: () => `
      <div class="grid2">
        <div class="card">
          <div class="hd">
            <h3>C4 decision support</h3>
            <span class="tag">üß™ Lab</span>
          </div>
          <div class="bd">
            <div class="callout green" data-search="swelling without urticaria complement C4 low normal elevated">
              <div class="txt">
                <div class="badge">üü¢ TEST</div>
                <h4>Isolated swelling (no wheals) + no clear trigger</h4>
                <p>Send blood for <b>complement C4</b>.</p>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="formGrid" data-search="C4 low re-refer normal elevated spontaneous angioedema">
              <div class="field">
                <label>C4 result</label>
                <select id="c4">
                  <option value="unknown">Not available / unknown</option>
                  <option value="low">Low</option>
                  <option value="normal">Normal</option>
                  <option value="high">Elevated</option>
                </select>
              </div>
              <div class="field">
                <label>Urticaria present?</label>
                <select id="wheals">
                  <option value="yes">Yes (wheals present)</option>
                  <option value="no">No (isolated swelling)</option>
                </select>
              </div>
            </div>

            <div style="height:10px"></div>
            <div class="callout" id="c4Advice">
              <div class="txt">
                <div class="badge">üß≠ OUTPUT</div>
                <h4>Recommendation</h4>
                <p>Select values to generate decision support.</p>
              </div>
            </div>

            <div style="height:10px"></div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn success" onclick="evalC4()">Generate</button>
              <button class="btn" onclick="copyText($('#c4Advice').innerText)">Copy</button>
              <button class="btn secondary" onclick="go('dosing')">Stepwise control</button>
            </div>

          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h3>ACE inhibitor angioedema</h3>
            <span class="tag red">‚õî Drug</span>
          </div>
          <div class="bd" data-search="ACE inhibitor angioedema stop avoid all ACEi persists 3 months ARB tolerated icatibant poor evidence">
            <div class="callout red">
              <div class="txt">
                <div class="badge">üî¥ CORE ACTION</div>
                <h4>Discontinue ACE inhibitor</h4>
                <p>ACEi-associated angioedema can occur after years of tolerance. Stop the culprit drug and avoid all ACE inhibitors.</p>
                <div class="items">
                  <div class="item">
                    <div class="dot" aria-hidden="true">üóìÔ∏è</div>
                    <div class="stack">
                      <div class="k">Episodes may persist after stopping</div>
                      <div class="v">May continue for ~3 months; if beyond this, consider alternative causes and check C4 (then re-refer with results).</div>
                    </div>
                  </div>
                  <div class="item">
                    <div class="dot" aria-hidden="true">üîÑ</div>
                    <div class="stack">
                      <div class="k">ARB usually tolerated</div>
                      <div class="v">Often provides similar cardioprotective benefits.</div>
                    </div>
                  </div>
                  <div class="item">
                    <div class="dot" aria-hidden="true">‚ö†Ô∏è</div>
                    <div class="stack">
                      <div class="k">Typical allergy meds often ineffective</div>
                      <div class="v">Antihistamines, glucocorticoids and adrenaline are usually ineffective in ACEi-induced angioedema.</div>
                    </div>
                  </div>
                  <div class="item">
                    <div class="dot" aria-hidden="true">üß¨</div>
                    <div class="stack">
                      <div class="k">Icatibant</div>
                      <div class="v">Has been used with good effect in some cases, but evidence base is poor.</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div style="height:12px"></div>
            <details>
              <summary>
                <span class="label">One-click ACEi note</span>
                <span class="hint">copy</span>
                <span class="chev">‚Ä∫</span>
              </summary>
              <div class="inner">
                <button class="chip" onclick="copyText(aceiNote())">Copy ACEi plan</button>
              </div>
            </details>

          </div>
        </div>
      </div>

      <div style="height:14px"></div>

      <div class="card">
        <div class="hd">
          <h3>Specialist urticaria referral</h3>
          <span class="tag red">üè• Referral</span>
        </div>
        <div class="bd">
          <div class="grid2">
            <div class="callout red" data-search="protracted problematic despite high dose antihistamines refer specialist urticaria service omalizumab immunosuppressive therapies">
              <div class="txt">
                <div class="badge">üî¥ REFER WHEN</div>
                <h4>Protracted/problematic despite high-dose antihistamines</h4>
                <p>Consider referral to a specialist urticaria service (access to omalizumab ¬± immunosuppression). Include UAS7.</p>
                <div class="chipRow">
                  <span class="chip" onclick="go('uas7')">Open UAS7</span>
                  <span class="chip" onclick="go('dosing')">Review dose steps</span>
                </div>
              </div>
            </div>
            <div class="callout green" data-search="high dose loratadine cetirizine 20 mg BD fexofenadine 360 mg BD">
              <div class="txt">
                <div class="badge">üü¢ INCLUDE IN REFERRAL</div>
                <h4>Minimum referral content</h4>
                <p>High-dose regimen attempted, duration of each step, co-factors/NSAID exposure, and UAS7 score.</p>
                <div class="items">
                  <div class="item"><div class="dot">üìà</div><div class="stack"><div class="k">UAS7 total</div><div class="v">Copy from UAS7 tool.</div></div></div>
                  <div class="item"><div class="dot">üíä</div><div class="stack"><div class="k">High-dose H1</div><div class="v">e.g., loratadine/cetirizine 20 mg BD or fexofenadine 360 mg BD.</div></div></div>
                  <div class="item"><div class="dot">üß©</div><div class="stack"><div class="k">Phenotype</div><div class="v">Wheals + swelling vs isolated swelling; response to meds.</div></div></div>
                </div>
              </div>
            </div>
          </div>

          <div style="height:12px"></div>
          <details>
            <summary>
              <span class="label">Generate referral summary</span>
              <span class="hint">copyable</span>
              <span class="chev">‚Ä∫</span>
            </summary>
            <div class="inner">
              <div class="formGrid">
                <div class="field">
                  <label>High-dose tried?</label>
                  <select id="hdose">
                    <option value="Yes ‚Äì inadequate control despite high-dose non-sedating antihistamines">Yes ‚Äì inadequate control despite high-dose non-sedating antihistamines</option>
                    <option value="Partially ‚Äì dose escalation limited by sedation/adherence">Partially ‚Äì dose escalation limited by sedation/adherence</option>
                    <option value="No ‚Äì escalation not yet completed">No ‚Äì escalation not yet completed</option>
                  </select>
                </div>
                <div class="field">
                  <label>Key co-factors</label>
                  <input id="cofac" placeholder="e.g., NSAIDs, infection, stress, exercise" />
                </div>
              </div>
              <div style="height:10px"></div>
              <button class="btn success" onclick="copyText(buildReferral())">Copy referral summary</button>
            </div>
          </details>

        </div>
      </div>
    `
  }
};

/* --------------------------- router/render --------------------------- */
function go(route){
  const keys = Object.keys(PAGES);
  if(!keys.includes(route)) route = "triage";
  history.replaceState(null, "", "#"+route);
  render(route);
  // set sidebar state
  $$(".nav button").forEach(b=>b.setAttribute("aria-current", String(b.dataset.route===route)));
  // focus top for fast scanning
  window.scrollTo({top:0, behavior:"instant"});
}

function render(route){
  const page = PAGES[route] || PAGES.triage;
  $("#pageTitle").textContent = page.title;
  $("#pageMeta").textContent  = page.meta;
  $("#view").innerHTML = page.render();

  // page-specific init hooks
  if(route==="uas7"){ initUAS7(); }
  if(route==="diary"){ loadDiary(); }
  if(route==="dosing"){ genNote(); }
  if(route==="referral"){ hookC4(); evalC4(); }

  // apply current search filter if active
  applySearch($("#q").value.trim());
}

/* --------------------------- search --------------------------- */
function applySearch(query){
  query = (query || "").trim().toLowerCase();
  const view = $("#view");
  const nodes = $$("[data-search], .card, details, .callout, .step, .item", view);

  if(!query){
    nodes.forEach(n=>n.style.display="");
    $$("mark", view).forEach(m=>m.replaceWith(m.textContent));
    return;
  }

  // naive highlight on elements with text
  nodes.forEach(n=>{
    const hay = (n.getAttribute("data-search") || "") + " " + (n.textContent || "");
    const hit = hay.toLowerCase().includes(query);
    n.style.display = hit ? "" : "none";
  });

  // make sure containers with visible children remain visible
  $$(".card", view).forEach(card=>{
    const any = Array.from(card.querySelectorAll("*")).some(el=>el.style.display!== "none");
    card.style.display = any ? "" : "none";
  });
}

$("#q").addEventListener("input", (e)=> applySearch(e.target.value));
document.addEventListener("keydown", (e)=>{
  if(e.key === "/" && document.activeElement !== $("#q")){
    e.preventDefault();
    $("#q").focus();
  }
  if(e.key.toLowerCase()==="p" && (e.metaKey || e.ctrlKey)){
    // allow standard print
    return;
  }
  if(e.key.toLowerCase()==="p" && !e.metaKey && !e.ctrlKey){
    // quick print
    e.preventDefault();
    window.print();
  }
});

/* --------------------------- nav clicks --------------------------- */
$$(".nav button").forEach(btn=>{
  btn.addEventListener("click", ()=> go(btn.dataset.route));
});

/* --------------------------- topbar controls --------------------------- */
$("#reset").addEventListener("click", ()=>{
  $("#q").value="";
  applySearch("");
  toast("Reset", "Search cleared");
});

$("#printBtn").addEventListener("click", ()=> window.print());

$("#copyLink").addEventListener("click", async ()=>{
  const route = (location.hash || "#triage").slice(1);
  const link = location.origin + location.pathname + "#" + route;
  try{
    await navigator.clipboard.writeText(link);
    toast("Copied deep link", route);
  }catch{
    toast("Copy failed", "Clipboard unavailable");
  }
});

$("#toastX").addEventListener("click", ()=> $("#toast").classList.remove("show"));

/* --------------------------- clipboard helpers --------------------------- */
async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    toast("Copied", (text||"").slice(0, 60) + ((text||"").length>60 ? "‚Ä¶" : ""));
  }catch{
    toast("Copy failed", "Clipboard unavailable");
  }
}
window.copyText = copyText;
window.go = go;

/* --------------------------- dosing note generator --------------------------- */
function genNote(){
  const ah = $("#ah")?.value || "Loratadine 10 mg";
  const step = $("#stepSel")?.value || "standard";
  const interval = $("#intervalSel")?.value || "1‚Äì4 weeks";
  const maint = $("#maintSel")?.value || "3‚Äì6 months";

  const stepText = ({
    standard: "standard dosing",
    double: "double-dose step",
    triple: "triple-dose step",
    quadruple: "quadruple-dose step"
  })[step] || "standard dosing";

  const t = [
    `Working impression: spontaneous urticaria ¬± angioedema (if wheals present) / spontaneous angioedema (if isolated swelling).`,
    `Plan: non-sedating H1 antihistamine (${ah}) ‚Äì ${stepText}; escalate stepwise if not controlled, leaving ${interval} between steps.`,
    `Counsel: higher-than-conventional doses may be required; monitor drowsiness and avoid heavy machinery if sedated.`,
    `If still inadequately controlled: consider trial tranexamic acid 1000 mg TDS.`,
    `Once complete control achieved: maintain for ${maint}, then step down gradually; if recurrence, revert to last effective step and re-attempt step-down after ${maint}.`,
    `Avoid: NSAIDs; consider ACEi cessation/avoidance if relevant.`
  ].join("\n");

  if($("#note")) $("#note").value = t;
}
window.genNote = genNote;

function prefillPlan(mode){
  const ah = $("#ah")?.value || "Cetirizine 10 mg";
  const base = {
    PRN: `Non-sedating H1 antihistamine PRN (${ah}); may repeat after ~30 minutes if needed.`,
    REG: `Regular non-sedating H1 antihistamine (${ah}); escalate stepwise if not controlled (1‚Äì4 weeks between steps).`,
    TXA: `Trial tranexamic acid 1000 mg TDS for persistent angioedema/urticaria not controlled on high-dose antihistamines.`,
    STEPDOWN: `After complete symptom control, maintain effective step for 3‚Äì6 months, then step down; if relapse, return to last effective step and re-attempt step-down 3‚Äì6 months later.`
  }[mode] || "";
  if($("#note")){
    $("#note").value = base + "\n\n" + $("#note").value;
    toast("Loaded", "Inserted text at top of note");
  }
}
window.prefillPlan = prefillPlan;

function openDoseHelper(){
  $("#doseDialog")?.showModal?.();
}
window.openDoseHelper = openDoseHelper;

/* --------------------------- UAS7 --------------------------- */
function initUAS7(){
  const tbody = $("#uasTable tbody");
  tbody.innerHTML = "";
  for(let d=1; d<=7; d++){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>Day ${d}</b></td>
      <td>${sel("w",d)}</td>
      <td>${sel("i",d)}</td>
      <td id="day_${d}">0</td>
    `;
    tbody.appendChild(tr);
  }
  $$("select", tbody).forEach(s=> s.addEventListener("change", uasRecalc));
  uasRecalc();
  $("#uasHint").textContent = "Tip: keep this open during the week; values persist in this browser.";
  // restore from storage
  const saved = JSON.parse(localStorage.getItem("uas7") || "null");
  if(saved){
    for(const k of Object.keys(saved)){
      const el = document.getElementById(k);
      if(el) el.value = saved[k];
    }
    uasRecalc();
  }
}

function sel(prefix, day){
  return `<select id="${prefix}_${day}">
    <option value="0">0</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
  </select>`;
}

function uasRecalc(){
  let total = 0;
  const snapshot = {};
  for(let d=1; d<=7; d++){
    const w = parseInt($("#w_"+d)?.value ?? "0", 10);
    const i = parseInt($("#i_"+d)?.value ?? "0", 10);
    const day = w+i;
    const cell = $("#day_"+d);
    if(cell) cell.textContent = String(day);
    total += day;
    snapshot["w_"+d] = String(w);
    snapshot["i_"+d] = String(i);
  }
  $("#uasTotal").textContent = String(total);
  localStorage.setItem("uas7", JSON.stringify(snapshot));
}
window.uasRecalc = uasRecalc;

function uasCopy(){
  const total = $("#uasTotal")?.textContent || "0";
  const lines = [];
  for(let d=1; d<=7; d++){
    const w = $("#w_"+d)?.value || "0";
    const i = $("#i_"+d)?.value || "0";
    lines.push(`Day ${d}: wheals ${w}, itch ${i} (daily ${parseInt(w,10)+parseInt(i,10)})`);
  }
  const out = `UAS7 (week ending ${nowIso()}): ${total}\n` + lines.join("\n");
  copyText(out);
}
window.uasCopy = uasCopy;

function uasReset(){
  localStorage.removeItem("uas7");
  initUAS7();
  toast("Reset", "UAS7 cleared");
}
window.uasReset = uasReset;

function referralPhrase(){
  const total = $("#uasTotal")?.textContent || "0";
  return `Referral: chronic/spontaneous urticaria ¬± angioedema; symptoms remain problematic despite high-dose non-sedating antihistamines. UAS7=${total} (week ending ${nowIso()}). Please assess for specialist therapies (e.g., omalizumab ¬± other options).`;
}
window.referralPhrase = referralPhrase;

/* --------------------------- Diary --------------------------- */
function loadDiary(){
  const rows = JSON.parse(localStorage.getItem("diaryRows") || "[]");
  const tbody = $("#diaryTable tbody");
  tbody.innerHTML = "";
  rows.forEach((r, idx)=> tbody.appendChild(diaryRow(r, idx)));
}
function diaryRow(r, idx){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${escapeHtml(r.item)}</td>
    <td>${escapeHtml(r.symptoms)}</td>
    <td>${escapeHtml(r.latency)}</td>
    <td>${escapeHtml(r.repro)}</td>
    <td>${escapeHtml(r.tx)}</td>
    <td>
      <div class="rowActions">
        <button class="miniBtn" title="Copy row" onclick="copyText(${JSON.stringify(formatDiary(r))})">Copy</button>
        <button class="miniBtn" title="Delete row" onclick="delDiary(${idx})">Delete</button>
      </div>
    </td>
  `;
  return tr;
}
function formatDiary(r){
  return `Trigger diary: ${r.item} | latency: ${r.latency} | symptoms: ${r.symptoms} | reproducible: ${r.repro} | treatment/response: ${r.tx}`;
}
function addDiary(){
  const r = {
    item: $("#d_item").value.trim(),
    latency: $("#d_latency").value.trim(),
    symptoms: $("#d_symptoms").value.trim(),
    repro: $("#d_repro").value,
    tx: $("#d_tx").value.trim()
  };
  if(!r.item || !r.symptoms){
    toast("Missing fields", "Item and symptoms are required");
    return;
  }
  const rows = JSON.parse(localStorage.getItem("diaryRows") || "[]");
  rows.push(r);
  localStorage.setItem("diaryRows", JSON.stringify(rows));
  loadDiary();
  $("#d_item").value=""; $("#d_latency").value=""; $("#d_symptoms").value=""; $("#d_tx").value="";
  toast("Added", "Diary row saved locally");
}
window.addDiary = addDiary;

function delDiary(idx){
  const rows = JSON.parse(localStorage.getItem("diaryRows") || "[]");
  rows.splice(idx, 1);
  localStorage.setItem("diaryRows", JSON.stringify(rows));
  loadDiary();
  toast("Deleted", "Row removed");
}
window.delDiary = delDiary;

function clearDiary(){
  localStorage.removeItem("diaryRows");
  loadDiary();
  toast("Cleared", "Diary emptied");
}
window.clearDiary = clearDiary;

function exportDiary(){
  const rows = JSON.parse(localStorage.getItem("diaryRows") || "[]");
  if(!rows.length){ toast("Nothing to export"); return; }
  const header = ["Item","Symptoms","Latency","Reproducible","Treatment & response"];
  const csv = [header.join(",")].concat(rows.map(r=>[r.item,r.symptoms,r.latency,r.repro,r.tx].map(v=>('"'+String(v).replaceAll('"','""')+'"')).join(","))).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "trigger-diary.csv";
  a.click();
  URL.revokeObjectURL(a.href);
  toast("Exported", "trigger-diary.csv downloaded");
}
window.exportDiary = exportDiary;

function printDiary(){
  // ensure table is visible on print
  window.print();
}
window.printDiary = printDiary;

/* --------------------------- Referral / C4 logic --------------------------- */
function hookC4(){
  ["c4","wheals"].forEach(id=>{
    $("#"+id)?.addEventListener("change", evalC4);
  });
}

function evalC4(){
  const c4 = $("#c4")?.value || "unknown";
  const wheals = $("#wheals")?.value || "yes";
  const box = $("#c4Advice");

  let cls = "callout";
  let title = "Recommendation";
  let text = "Select values to generate decision support.";

  if(wheals === "yes"){
    cls = "callout green";
    title = "Urticaria present";
    text = "With wheals + swelling and no clear trigger, phenotype is most consistent with spontaneous urticaria ¬± angioedema. Use stepwise non-sedating antihistamines; consider referral if problematic despite high-dose therapy; include UAS7.";
  }else{
    // isolated swelling lane
    if(c4 === "unknown"){
      cls = "callout amber";
      title = "Isolated swelling ‚Äì send C4";
      text = "Swelling without urticaria and no clear trigger ‚Üí send complement C4. If low, re-refer with result. If normal/elevated, consider spontaneous angioedema as likely diagnosis.";
    }else if(c4 === "low"){
      cls = "callout red";
      title = "C4 low ‚Äì re-refer";
      text = "C4 low in the setting of recurrent isolated swelling ‚Üí re-refer to specialist clinic and include C4 result with referral.";
    }else if(c4 === "normal" || c4 === "high"){
      cls = "callout green";
      title = "C4 normal/elevated";
      text = "C4 normal/elevated with isolated swelling and no trigger ‚Üí consider spontaneous angioedema as likely diagnosis; manage symptomatically and review co-factors/medications (avoid NSAIDs; exclude ACEi-related angioedema).";
    }
  }

  box.className = cls;
  box.innerHTML = `
    <div class="txt">
      <div class="badge">üß≠ OUTPUT</div>
      <h4>${escapeHtml(title)}</h4>
      <p>${escapeHtml(text)}</p>
    </div>
  `;
}
window.evalC4 = evalC4;

function aceiNote(){
  return [
    "ACE inhibitor‚Äìassociated angioedema suspected.",
    "Action: discontinue ACE inhibitor immediately and avoid all ACE inhibitors in future.",
    "Counsel: episodes may persist for ~3 months after stopping; if swelling continues beyond this, reassess other causes and send complement C4 (then re-refer with result).",
    "Management note: antihistamines, glucocorticoids and adrenaline are usually ineffective; airway involvement requires urgent emergency care.",
    "ARB is usually tolerated and may be used for similar cardioprotective benefit (as appropriate)."
  ].join(" ");
}
window.aceiNote = aceiNote;

function buildReferral(){
  const hdose = $("#hdose")?.value || "";
  const cof = ($("#cofac")?.value || "").trim();
  const uas = JSON.parse(localStorage.getItem("uas7") || "null");
  let total = 0;
  if(uas){
    for(let d=1; d<=7; d++){
      total += (parseInt(uas["w_"+d]||"0",10) + parseInt(uas["i_"+d]||"0",10));
    }
  }
  const parts = [
    "Referral: spontaneous urticaria ¬± angioedema.",
    hdose + ".",
    `UAS7=${total} (week ending ${nowIso()}).`,
    cof ? ("Co-factors/associations: " + cof + ".") : "Co-factors assessed (stress/infection/exercise/temperature/pressure/NSAIDs/alcohol/fatigue).",
    "Request: specialist urticaria assessment (access to omalizumab ¬± other therapies)."
  ];
  return parts.join(" ");
}
window.buildReferral = buildReferral;

/* --------------------------- init --------------------------- */
(function init(){
  const route = (location.hash || "#triage").slice(1);
  render(route);
  $$(".nav button").forEach(b=>b.setAttribute("aria-current", String(b.dataset.route===route)));
})();
</script>
</body>
</html>
