<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Clinical QuickRef — Achilles Tendinopathy</title>
  <style>
    :root{
      --bg:#0b0e12;
      --panel:#111722;
      --panel2:#0f141d;
      --text:#e7edf6;
      --muted:#a8b3c5;
      --border:#273043;
      --shadow: 0 10px 28px rgba(0,0,0,.35);
      --accent:#7aa2ff;
      --danger:#ff4d4d;
      --warning:#ffb020;
      --ok:#39d98a;

      --radius:14px;
      --gap:12px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;

      --base: 14.5px;
      --baseBusy: 17.5px;
      --line: 1.28;
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb;
        --panel:#ffffff;
        --panel2:#fbfcff;
        --text:#0c1220;
        --muted:#4b576b;
        --border:#d9e0ee;
        --shadow: 0 10px 24px rgba(12,18,32,.10);
        --accent:#245bff;
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      font-size:var(--base);
      line-height:var(--line);
      background:var(--bg);
      color:var(--text);
    }

    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,0)) , var(--bg);
      border-bottom:1px solid var(--border);
      backdrop-filter:saturate(140%) blur(10px);
    }
    .topbar-inner{
      max-width:1280px;
      margin:0 auto;
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .brand{
      display:flex; flex-direction:column;
      min-width:170px;
    }
    .brand b{font-size:14px; letter-spacing:.2px}
    .brand span{font-size:12px; color:var(--muted)}
    .searchwrap{
      flex:1;
      display:flex;
      gap:8px;
      align-items:center;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 10px;
      box-shadow:var(--shadow);
    }
    .searchwrap input{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:15px;
    }
    .pill{
      font-size:12px;
      color:var(--muted);
      padding:4px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      background:var(--panel2);
      user-select:none;
      white-space:nowrap;
    }
    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--panel);
      box-shadow:var(--shadow);
      cursor:pointer;
      user-select:none;
    }
    .toggle input{accent-color:var(--accent)}
    .toggle small{color:var(--muted); font-size:12px}

    /* Layout */
    .wrap{
      max-width:1280px;
      margin:0 auto;
      padding:12px;
      display:grid;
      grid-template-columns: 240px 1fr 300px;
      gap:var(--gap);
      align-items:start;
    }
    @media (max-width: 1080px){
      .wrap{grid-template-columns: 220px 1fr}
      .right{display:none}
    }
    @media (max-width: 760px){
      .wrap{grid-template-columns: 1fr}
      .left{position:static}
      .right{display:block}
    }

    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .card h3{
      margin:0;
      padding:12px 12px 8px 12px;
      font-size:13px;
      letter-spacing:.2px;
      color:var(--muted);
      text-transform:uppercase;
    }
    .card .body{padding:10px 12px 12px 12px}

    /* Left nav */
    .left{
      position:sticky;
      top:70px;
    }
    .navbtn{
      width:100%;
      text-align:left;
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel2);
      color:var(--text);
      cursor:pointer;
      margin-bottom:8px;
    }
    .navbtn:hover{border-color:rgba(122,162,255,.55)}
    .navbtn .k{font-family:var(--mono); font-size:11px; color:var(--muted)}
    .muted{color:var(--muted)}
    .small{font-size:12px}

    /* Center content */
    .section{
      margin-bottom:12px;
    }
    .section-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px 10px 12px;
      border-bottom:1px solid var(--border);
    }
    .section-head h2{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
    }
    .badge{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel2);
      color:var(--muted);
      white-space:nowrap;
    }

    details.panel{
      border-top:1px solid var(--border);
      padding:0;
    }
    details.panel:first-of-type{border-top:0}
    details.panel summary{
      list-style:none;
      cursor:pointer;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    details.panel summary::-webkit-details-marker{display:none}
    details.panel summary b{
      font-size:14px;
      letter-spacing:.15px;
    }
    .chev{
      font-family:var(--mono);
      color:var(--muted);
      font-size:12px;
      opacity:.95;
    }
    details[open] .chev{transform:rotate(90deg)}
    .panel-body{
      padding:0 12px 12px 12px;
    }
    ul{
      margin:8px 0 0 18px;
      padding:0;
    }
    li{margin:6px 0}

    /* Urgency banners */
    .banner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      margin-top:10px;
    }
    .banner b{letter-spacing:.2px}
    .banner.red{border-color:rgba(255,77,77,.55); background:rgba(255,77,77,.10)}
    .banner.amber{border-color:rgba(255,176,32,.55); background:rgba(255,176,32,.10)}
    .banner.green{border-color:rgba(57,217,138,.55); background:rgba(57,217,138,.10)}
    .banner .tag{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.12);
      color:var(--muted);
      white-space:nowrap;
    }

    /* Right sidebar */
    .action{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--panel2);
      padding:10px;
      margin-bottom:10px;
    }
    .action h4{
      margin:0 0 8px 0;
      font-size:13px;
      letter-spacing:.2px;
    }
    .row{
      display:flex;
      gap:8px;
      align-items:center;
      margin:6px 0;
    }
    label{font-size:12px; color:var(--muted)}
    input[type="number"], input[type="text"]{
      width:100%;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      padding:8px 10px;
      outline:none;
    }
    button{
      width:100%;
      border-radius:12px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(122,162,255,.18), rgba(122,162,255,.08));
      color:var(--text);
      padding:9px 10px;
      cursor:pointer;
      font-weight:600;
    }
    button:hover{border-color:rgba(122,162,255,.6)}
    .out{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      padding:8px 10px;
      border-radius:12px;
      border:1px dashed var(--border);
      background:rgba(0,0,0,.08);
      white-space:pre-wrap;
      min-height:42px;
    }

    /* Search filtering */
    .hidden{display:none !important}
    mark{
      background:rgba(122,162,255,.22);
      border:1px solid rgba(122,162,255,.25);
      color:inherit;
      padding:0 2px;
      border-radius:4px;
    }

    /* Busy clinic mode */
    body.busy{
      font-size:var(--baseBusy);
      line-height:1.25;
    }
    body.busy .brand span,
    body.busy .pill,
    body.busy .badge,
    body.busy .muted,
    body.busy .small { display:none; }

    body.busy [data-essential="0"]{ display:none !important; }

    /* Keyboard hint */
    .kbd{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--border);
      border-bottom-width:2px;
      border-radius:8px;
      padding:2px 6px;
      background:var(--panel2);
      user-select:none;
      white-space:nowrap;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand" aria-label="App title">
        <b>Clinical QuickRef</b>
        <span>10-second retrieval — single page</span>
      </div>

      <div class="searchwrap" role="search">
        <span class="kbd" title="Keyboard shortcut">/</span>
        <input id="q" type="text" placeholder="Search diagnoses, red flags, management, dosing… (type to filter)" autocomplete="off" />
        <span id="count" class="pill">All</span>
      </div>

      <label class="toggle" title="Busy Clinic Mode: essentials only + larger text">
        <input id="busy" type="checkbox" />
        <div>
          <div style="font-weight:700">Busy Clinic Mode</div>
          <small>Essentials only · larger text</small>
        </div>
      </label>
    </div>
  </header>

  <main class="wrap">
    <!-- LEFT -->
    <aside class="left card" aria-label="Jump to section">
      <h3>Jump to</h3>
      <div class="body">
        <button class="navbtn" data-jump="#sec-overview"><span>Overview</span><span class="k">1</span></button>
        <button class="navbtn" data-jump="#sec-rupture"><span>Rupture (exclude)</span><span class="k">2</span></button>
        <button class="navbtn" data-jump="#sec-dx"><span>Diagnosis</span><span class="k">3</span></button>
        <button class="navbtn" data-jump="#sec-mx"><span>Management</span><span class="k">4</span></button>
        <button class="navbtn" data-jump="#sec-safetynet"><span>Safety-net</span><span class="k">5</span></button>

        <div class="banner green" style="margin-top:10px" data-essential="1">
          <div>
            <b>Pro tip</b><div class="small muted">Press <span class="kbd">/</span> to focus search.</div>
          </div>
          <span class="tag">Speed</span>
        </div>
      </div>
    </aside>

    <!-- CENTER -->
    <section class="center">
      <!-- Overview -->
      <article id="sec-overview" class="card section" data-section>
        <div class="section-head">
          <h2>Achilles tendinopathy — rapid reference</h2>
          <span class="badge">Adults ≥18 · primary care/ED triage</span>
        </div>

        <div class="body">
          <div class="banner red" data-essential="1">
            <div>
              <b>REFER IMMEDIATELY</b>
              <div class="small muted">If Achilles tendon rupture suspected (same-day ortho pathway/local protocol).</div>
            </div>
            <span class="tag">Red</span>
          </div>

          <details class="panel" open data-panel>
            <summary><b>Pattern recognition</b><span class="chev">›</span></summary>
            <div class="panel-body">
              <ul>
                <li data-essential="1"><b>Mid-portion</b>: gradual onset pain typically <b>2–6 cm proximal</b> to insertion; activity-limiting.</li>
                <li data-essential="1"><b>Insertional</b>: pain ± swelling at insertion on posterior calcaneus; impaired function.</li>
                <li data-essential="1"><b>Stiffness</b> common (morning or after prolonged sitting).</li>
                <li data-essential="0">Often precipitated by excessive mechanical load / training change.</li>
              </ul>
            </div>
          </details>

          <details class="panel" data-panel>
            <summary><b>Key risk factors / associations</b><span class="chev">›</span></summary>
            <div class="panel-body">
              <ul>
                <li data-essential="1">Metabolic: diabetes mellitus, dyslipidaemia / hypercholesterolaemia.</li>
                <li data-essential="1">Drug exposures: <b>fluoroquinolones</b>, systemic corticosteroids; consider statins/aromatase inhibitors in relevant contexts.</li>
                <li data-essential="0">Biomechanics/training: footwear, distance/intensity changes, hard/sloping surfaces, prior injury.</li>
              </ul>
            </div>
          </details>

          <details class="panel" data-panel>
            <summary><b>Imaging & tests</b><span class="chev">›</span></summary>
            <div class="panel-body">
              <ul>
                <li data-essential="1"><b>Clinical diagnosis</b> is typical; <b>US/MRI not routinely indicated</b> for uncomplicated cases.</li>
                <li data-essential="0">Targeted labs (e.g., HbA1c, lipid profile) if underlying metabolic driver suspected.</li>
              </ul>
            </div>
          </details>
        </div>
      </article>

      <!-- Rupture -->
      <article id="sec-rupture" class="card section" data-section>
        <div class="section-head">
          <h2>Exclude Achilles tendon rupture</h2>
          <span class="badge">High-stakes miss</span>
        </div>

        <div class="body">
          <div class="banner red" data-essential="1">
            <div>
              <b>REFER IMMEDIATELY</b>
              <div class="small muted">Suspected rupture → urgent ortho pathway/same-day referral.</div>
            </div>
            <span class="tag">Red</span>
          </div>

          <details class="panel" open data-panel>
            <summary><b>History features suggestive of rupture</b><span class="chev">›</span></summary>
            <div class="panel-body">
              <ul>
                <li data-essential="1">Sudden posterior leg pain during sport/running ± audible “snap”; may feel “kicked/struck”.</li>
                <li data-essential="1">Difficulty weight bearing; weakness pushing off.</li>
                <li data-essential="0">Pain may be absent in ~⅓ of complete ruptures; bruising/swelling may be mild.</li>
              </ul>
            </div>
          </details>

          <details class="panel" data-panel>
            <summary><b>Exam: Simmonds triad (prone, feet over edge)</b><span class="chev">›</span></summary>
            <div class="panel-body">
              <ul>
                <li data-essential="1"><b>Angle of declination</b>: injured side may sit more dorsiflexed.</li>
                <li data-essential="1"><b>Palpation</b>: gap may be present (can be masked by swelling/bleeding).</li>
                <li data-essential="1"><b>Calf squeeze test</b>: reduced/absent plantarflexion response on injured side.</li>
                <li data-essential="0">Chronic rupture can be subtle: pain/swelling resolved; gap filled with fibrous tissue; calf wasting; accessory plantarflexors may compensate.</li>
              </ul>
            </div>
          </details>
        </div>
      </article>

      <!-- Diagnosis -->
      <article id="sec-dx" class="card section" data-section>
        <div class="section-head">
          <h2>Diagnosis (when rupture excluded)</h2>
          <span class="badge">Clinical assessment</span>
        </div>

        <div class="body">
          <details class="panel" open data-panel>
            <summary><b>Focused assessment</b><span class="chev">›</span></summary>
            <div class="panel-body">
              <ul>
                <li data-essential="1">Inspect: redness, swelling, asymmetry.</li>
                <li data-essential="1">Palpate tendon: tenderness, heat, crepitus, thickening, nodularity.</li>
                <li data-essential="1">Pain worsens with passive dorsiflexion; assess ankle ROM.</li>
                <li data-essential="1">Functional provocation: hop/heel-raise endurance (as appropriate).</li>
                <li data-essential="0">Consider VISA-A questionnaire for symptom severity with activity.</li>
              </ul>
            </div>
          </details>

          <details class="panel" data-panel>
            <summary><b>Differential diagnoses around posterior heel</b><span class="chev">›</span></summary>
            <div class="panel-body">
              <ul>
                <li data-essential="1">Retrocalcaneal bursitis; Haglund deformity; posterior ankle impingement; os trigonum.</li>
                <li data-essential="0">Peroneal/other tendon disorders; plantaris tendinopathy; fascial tear; calcaneal fracture.</li>
                <li data-essential="0">Sural nerve irritation/neuroma; fat pad irritation; systemic inflammatory disease.</li>
              </ul>
            </div>
          </details>
        </div>
      </article>

      <!-- Management -->
      <article id="sec-mx" class="card section" data-section>
        <div class="section-head">
          <h2>Management (primary care / ED discharge plan)</h2>
          <span class="badge">Conservative first-line</span>
        </div>

        <div class="body">
          <div class="banner green" data-essential="1">
            <div>
              <b>ROUTINE MANAGEMENT</b>
              <div class="small muted">Weight bear as tolerated; activity modification; early rehab pathway.</div>
            </div>
            <span class="tag">Green</span>
          </div>

          <details class="panel" open data-panel>
            <summary><b>Immediate measures</b><span class="chev">›</span></summary>
            <div class="panel-body">
              <ul>
                <li data-essential="1"><b>Relative rest</b>: reduce/stop precipitating activity; restart when pain allows.</li>
                <li data-essential="1"><b>Weight bearing</b> as tolerated.</li>
                <li data-essential="1">Cold packs/ice after acute flare for symptom relief.</li>
                <li data-essential="1"><b>Analgesia</b>: paracetamol; NSAIDs may help short-term in acute phase but avoid prolonged reliance.</li>
              </ul>
            </div>
          </details>

          <details class="panel" data-panel>
            <summary><b>Address underlying drivers</b><span class="chev">›</span></summary>
            <div class="panel-body">
              <ul>
                <li data-essential="1"><b>Fluoroquinolone exposure</b>: discontinue and use alternative if clinically appropriate.</li>
                <li data-essential="0">Optimise metabolic factors (diabetes/dyslipidaemia) where relevant.</li>
              </ul>
            </div>
          </details>

          <details class="panel" data-panel>
            <summary><b>Referral thresholds</b><span class="chev">›</span></summary>
            <div class="panel-body">
              <ul>
                <li data-essential="1"><b>Physiotherapy</b>: if symptoms fail to improve within <b>7–10 days</b>.</li>
                <li data-essential="1"><b>Do not</b> inject corticosteroid into/around tendon.</li>
                <li data-essential="1">Chronic/refractory cases: consider sports medicine or orthopaedics assessment.</li>
              </ul>
            </div>
          </details>

          <details class="panel" data-panel>
            <summary><b>Secondary care options (context)</b><span class="chev">›</span></summary>
            <div class="panel-body">
              <ul>
                <li data-essential="0">Structured loading programmes: eccentric or heavy-slow resistance (concentric/eccentric).</li>
                <li data-essential="0">ESWT: explain uncertainty regarding efficacy where offered.</li>
                <li data-essential="0">Surgery in chronic non-responders (e.g., debridement).</li>
              </ul>
            </div>
          </details>
        </div>
      </article>

      <!-- Safety-net -->
      <article id="sec-safetynet" class="card section" data-section>
        <div class="section-head">
          <h2>Safety-net & follow-up</h2>
          <span class="badge">Prevent miss / deterioration</span>
        </div>

        <div class="body">
          <div class="banner amber" data-essential="1">
            <div>
              <b>SAFETY-NET</b>
              <div class="small muted">Escalate if clinical course deviates from expected recovery trajectory.</div>
            </div>
            <span class="tag">Amber</span>
          </div>

          <details class="panel" open data-panel>
            <summary><b>Return/seek urgent review if…</b><span class="chev">›</span></summary>
            <div class="panel-body">
              <ul>
                <li data-essential="1">New sudden “snap”/acute posterior leg pain; new inability to push off or weight bear → <b>treat as rupture until proven otherwise</b>.</li>
                <li data-essential="1">Rapidly increasing swelling, marked bruising, progressive functional loss.</li>
                <li data-essential="0">Persistent symptoms beyond expected timeframe despite adherence to rehab/loading plan.</li>
              </ul>
            </div>
          </details>

          <details class="panel" data-panel>
            <summary><b>Expected trajectory (counselling)</b><span class="chev">›</span></summary>
            <div class="panel-body">
              <ul>
                <li data-essential="1">Many improve with conservative care; meaningful improvement often seen by ~12 weeks.</li>
                <li data-essential="0">Symptoms can persist for months; recurrence/contralateral involvement can occur.</li>
              </ul>
            </div>
          </details>
        </div>
      </article>

      <div class="card" style="padding:10px 12px" data-essential="0">
        <div class="muted small">
          Content seeded from NICE CKS Achilles tendinopathy (last revised June 2020) and structured for rapid retrieval. :contentReference[oaicite:1]{index=1}
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="right card" aria-label="Quick actions">
      <h3>Quick Actions</h3>
      <div class="body">
        <div class="action" data-action>
          <h4>BMI (risk factor context)</h4>
          <div class="row">
            <div style="flex:1">
              <label for="wt">Weight (kg)</label>
              <input id="wt" type="number" inputmode="decimal" min="0" step="0.1" placeholder="e.g., 82" />
            </div>
            <div style="flex:1">
              <label for="ht">Height (cm)</label>
              <input id="ht" type="number" inputmode="decimal" min="0" step="0.1" placeholder="e.g., 175" />
            </div>
          </div>
          <button id="calcBmi">Calculate BMI</button>
          <div id="bmiOut" class="out" aria-live="polite">—</div>
        </div>

        <div class="action" data-action>
          <h4>Referral criteria (at-a-glance)</h4>
          <div class="banner red" style="margin:0 0 8px 0" data-essential="1">
            <div><b>Rupture suspected</b><div class="small muted">Same-day ortho pathway.</div></div><span class="tag">Red</span>
          </div>
          <div class="banner green" style="margin:0 0 8px 0" data-essential="1">
            <div><b>Physio</b><div class="small muted">No improvement in 7–10 days.</div></div><span class="tag">Green</span>
          </div>
          <div class="banner amber" style="margin:0" data-essential="0">
            <div><b>Refractory/chronic</b><div class="small muted">Sports medicine / orthopaedics.</div></div><span class="tag">Amber</span>
          </div>
        </div>

        <div class="action" data-action>
          <h4>One-tap snippets</h4>
          <button data-snippet="rupture">Copy: Rupture exclusion (Simmonds triad)</button>
          <div style="height:8px"></div>
          <button data-snippet="plan">Copy: Discharge plan (tendinopathy)</button>
          <div style="height:8px"></div>
          <button data-snippet="safetynet">Copy: Safety-net wording</button>
          <div id="clipOut" class="out" style="margin-top:10px">Clipboard: —</div>
        </div>

        <div class="action" data-essential="0">
          <h4>Search tips</h4>
          <div class="muted small">
            Search matches section titles + bullet text. Collapsed panels with matches remain visible.
            Press <span class="kbd">Esc</span> to clear search.
          </div>
        </div>
      </div>
    </aside>
  </main>

  <script>
    (function(){
      const $ = (sel, root=document) => root.querySelector(sel);
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

      const q = $("#q");
      const count = $("#count");
      const busy = $("#busy");

      // Keyboard shortcuts: "/" focus search; Esc clears
      document.addEventListener("keydown", (e) => {
        if (e.key === "/" && document.activeElement !== q) {
          e.preventDefault();
          q.focus();
        }
        if (e.key === "Escape") {
          if (document.activeElement === q || q.value.trim() !== "") {
            q.value = "";
            q.dispatchEvent(new Event("input"));
            q.blur();
          }
        }
      });

      // Jump buttons
      $$(".navbtn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const target = btn.getAttribute("data-jump");
          const el = document.querySelector(target);
          if (el) el.scrollIntoView({behavior:"smooth", block:"start"});
        });
      });

      // Busy clinic mode
      const applyBusy = () => {
        document.body.classList.toggle("busy", !!busy.checked);
        localStorage.setItem("busyMode", busy.checked ? "1" : "0");
      };
      busy.checked = localStorage.getItem("busyMode") === "1";
      busy.addEventListener("change", applyBusy);
      applyBusy();

      // Search highlighting and filtering
      const panels = $$("[data-panel]");
      const sections = $$("[data-section]");
      const originalHTML = new Map();

      // Cache original li innerHTML for clean re-highlighting
      $$("li, summary b, .section-head h2").forEach(node=>{
        originalHTML.set(node, node.innerHTML);
      });

      const normalize = (s) => (s || "").toLowerCase().trim();
      const tokensOf = (s) => normalize(s).split(/\s+/).filter(Boolean).slice(0, 12);

      function markText(node, tokens){
        const src = originalHTML.get(node) ?? node.innerHTML;
        let html = src;
        tokens.forEach(t=>{
          // avoid regex injection
          const safe = t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
          const re = new RegExp(`(${safe})`, "ig");
          html = html.replace(re, "<mark>$1</mark>");
        });
        node.innerHTML = html;
      }

      function clearMarks(){
        originalHTML.forEach((html, node)=>{ node.innerHTML = html; });
      }

      function filter(){
        const query = normalize(q.value);
        clearMarks();

        if (!query){
          // show all
          sections.forEach(s=>s.classList.remove("hidden"));
          panels.forEach(p=>p.classList.remove("hidden"));
          count.textContent = "All";
          return;
        }

        const tokens = tokensOf(query);

        let visibleSections = 0;
        sections.forEach(sec=>{
          let secHit = false;

          // section title
          const title = $(".section-head h2", sec);
          const titleText = normalize(title?.textContent);
          if (titleText && tokens.every(t=>titleText.includes(t))) secHit = true;

          // panels within
          const secPanels = $$("[data-panel]", sec);
          secPanels.forEach(p=>{
            const text = normalize(p.textContent);
            const hit = tokens.every(t=>text.includes(t));
            p.classList.toggle("hidden", !hit);
            if (hit){
              secHit = true;
              // Expand matched panels for speed
              p.open = true;

              // Highlight summary and list items
              const sb = $("summary b", p);
              if (sb) markText(sb, tokens);
              $$("li", p).forEach(li=>{
                if (tokens.some(t=>normalize(li.textContent).includes(t))) markText(li, tokens);
              });
            }
          });

          // If section title hits but panel text doesn't, keep section and unhide panels (to avoid empty sections)
          if (secHit){
            visibleSections++;
            sec.classList.remove("hidden");
            if (title) markText(title, tokens);
            const anyVisiblePanel = secPanels.some(p=>!p.classList.contains("hidden"));
            if (!anyVisiblePanel){
              secPanels.forEach(p=>p.classList.remove("hidden"));
            }
          } else {
            sec.classList.add("hidden");
          }
        });

        count.textContent = visibleSections + " section" + (visibleSections===1 ? "" : "s");
      }

      q.addEventListener("input", filter);

      // Quick Actions: BMI
      $("#calcBmi").addEventListener("click", ()=>{
        const wt = parseFloat($("#wt").value);
        const htCm = parseFloat($("#ht").value);
        const out = $("#bmiOut");
        if (!wt || !htCm){
          out.textContent = "Enter weight (kg) and height (cm).";
          return;
        }
        const m = htCm / 100;
        const bmi = wt / (m*m);
        let cat = "";
        if (bmi < 18.5) cat = "Underweight";
        else if (bmi < 25) cat = "Healthy weight";
        else if (bmi < 30) cat = "Overweight";
        else cat = "Obesity";
        out.textContent = `BMI: ${bmi.toFixed(1)} (${cat})`;
      });

      // Quick Actions: clipboard snippets
      const snippets = {
        rupture:
`Achilles rupture exclusion:
• History: sudden posterior leg pain ± audible snap; weakness pushing off; difficulty weight bearing (pain may be absent).
• Exam (Simmonds triad): increased dorsiflexion angle, palpable gap (may be masked), calf squeeze → absent plantarflexion.`,
        plan:
`Achilles tendinopathy plan:
• Relative rest/activity modification; weight bear as tolerated.
• Ice after acute flare; analgesia (paracetamol; avoid prolonged NSAID reliance).
• Review risk factors (metabolic; fluoroquinolone exposure).
• Physio referral if not improving in 7–10 days; avoid corticosteroid injection around tendon.`,
        safetynet:
`Safety-net:
Return urgently if sudden snap/acute worsening pain, new inability to push off or weight bear, or rapidly increasing swelling/bruising (treat as possible rupture).`
      };

      $$("button[data-snippet]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const key = btn.getAttribute("data-snippet");
          const text = snippets[key] || "";
          try{
            await navigator.clipboard.writeText(text);
            $("#clipOut").textContent = "Clipboard: copied.";
          }catch(e){
            // Fallback
            $("#clipOut").textContent = "Clipboard: copy failed (browser blocked).";
          }
        });
      });

      // Initial render
      filter();
    })();
  </script>
</body>
</html>
