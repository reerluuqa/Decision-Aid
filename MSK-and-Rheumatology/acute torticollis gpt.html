<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Acute Torticollis (Wry Neck) ‚Äî Clinical Decision Support</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      /* lively but clinical palette */
      --bg: #0b1220;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.085);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --faint: rgba(255,255,255,0.55);
      --border: rgba(255,255,255,0.14);

      --urgent: #ff3b5c;
      --urgent2:#ff7a8f;
      --routine:#26c6da;
      --routine2:#7be7f2;

      --good:#19d18a;
      --warn:#ffcc00;

      --link:#8bb5ff;

      --shadow: 0 18px 50px rgba(0,0,0,0.50);
      --radius: 18px;
      --radius2: 24px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f8fc;
        --panel:#ffffff;
        --panel2:#f2f5ff;
        --text:#0b1220;
        --muted:rgba(11,18,32,0.72);
        --faint:rgba(11,18,32,0.55);
        --border:rgba(11,18,32,0.10);
        --shadow: 0 18px 50px rgba(14,29,56,0.12);
        --link:#1e5eff;
      }
      .gridGlow{ opacity:.55; }
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: radial-gradient(1200px 700px at 20% 0%, rgba(38,198,218,0.22), transparent 60%),
                  radial-gradient(900px 600px at 90% 20%, rgba(255,59,92,0.18), transparent 55%),
                  linear-gradient(180deg, var(--bg), var(--bg));
      line-height:1.45;
      letter-spacing: 0.1px;
    }

    a{ color:var(--link); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .wrap{
      max-width: 1220px;
      margin: 0 auto;
      padding: 22px 18px 70px;
    }

    /* subtle grid glow background */
    .gridGlow{
      position:fixed; inset:0; pointer-events:none; z-index:-1;
      background:
        linear-gradient(to right, rgba(255,255,255,0.06) 1px, transparent 1px) 0 0 / 28px 28px,
        linear-gradient(to bottom, rgba(255,255,255,0.06) 1px, transparent 1px) 0 0 / 28px 28px;
      mask-image: radial-gradient(600px 420px at 30% 25%, black 45%, transparent 70%);
      opacity:.18;
    }

    header{
      display:grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 18px;
      align-items: stretch;
      margin-top: 6px;
    }
    @media (max-width: 980px){
      header{ grid-template-columns: 1fr; }
    }

    .hero{
      background: linear-gradient(180deg, rgba(255,255,255,0.09), rgba(255,255,255,0.05));
      border:1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 18px 18px 16px;
      position:relative;
      overflow:hidden;
    }

    .hero::before{
      content:"";
      position:absolute; inset:-120px -120px auto auto;
      width: 260px; height: 260px;
      background: radial-gradient(circle at 30% 30%, rgba(255,59,92,0.35), transparent 60%);
      transform: rotate(12deg);
    }

    .kicker{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      font-size: 12px;
      letter-spacing: .2px;
      user-select:none;
      white-space:nowrap;
    }
    .pill strong{ color: var(--text); font-weight:650; }
    .hero h1{
      margin:0 0 8px;
      font-size: 26px;
      letter-spacing: -0.4px;
      line-height:1.15;
    }
    .hero p{
      margin: 0 0 12px;
      color: var(--muted);
      font-size: 14.5px;
      max-width: 78ch;
    }

    .quickActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .btn{
      appearance:none; border:none; cursor:pointer;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 650;
      letter-spacing: .15px;
      display:inline-flex; align-items:center; gap:10px;
      background: rgba(255,255,255,0.08);
      color: var(--text);
      border: 1px solid var(--border);
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.11); }
    .btn:active{ transform: translateY(0px) scale(0.99); }
    .btnPrimary{
      background: linear-gradient(180deg, rgba(38,198,218,0.25), rgba(38,198,218,0.14));
      border-color: rgba(38,198,218,0.45);
    }
    .btnDanger{
      background: linear-gradient(180deg, rgba(255,59,92,0.25), rgba(255,59,92,0.12));
      border-color: rgba(255,59,92,0.45);
    }

    .rightPanel{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .controls{
      background: linear-gradient(180deg, rgba(255,255,255,0.09), rgba(255,255,255,0.05));
      border:1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .controlRow{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }

    .search{
      flex: 1 1 240px;
      display:flex; gap:10px; align-items:center;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.12);
      padding: 10px 12px;
      min-width: 240px;
    }
    @media (prefers-color-scheme: light){
      .search{ background: rgba(11,18,32,0.04); }
    }
    .search input{
      border:none; outline:none;
      background: transparent;
      color: var(--text);
      width:100%;
      font-size: 14px;
    }
    .search input::placeholder{ color: var(--faint); }

    .toggles{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      cursor:pointer;
      user-select:none;
      transition: background .2s ease, border-color .2s ease, transform .08s ease;
      font-size: 13px;
    }
    .chip:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.10); }
    .chip[data-on="true"]{ border-color: rgba(255,255,255,0.35); background: rgba(255,255,255,0.12); }
    .chip .dot{
      width: 10px; height: 10px; border-radius: 99px; background: var(--routine);
      box-shadow: 0 0 0 3px rgba(38,198,218,0.15);
    }
    .chip.urgent .dot{ background: var(--urgent); box-shadow: 0 0 0 3px rgba(255,59,92,0.16); }
    .chip.meds .dot{ background: var(--warn); box-shadow: 0 0 0 3px rgba(255,204,0,0.14); }
    .chip.advice .dot{ background: var(--good); box-shadow: 0 0 0 3px rgba(25,209,138,0.14); }

    .stickyNav{
      position: sticky;
      top: 10px;
      z-index: 20;
      margin-top: 16px;
      border-radius: var(--radius2);
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.22);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    @media (prefers-color-scheme: light){
      .stickyNav{ background: rgba(255,255,255,0.72); }
    }

    .navInner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      flex-wrap:wrap;
    }

    .navTitle{
      display:flex; align-items:center; gap:10px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .navTitle small{
      font-weight: 650;
      color: var(--muted);
      letter-spacing: .25px;
    }

    .navLinks{
      display:flex; gap: 8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .navLinks a{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
      color: var(--muted);
      background: transparent;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
      font-size: 13px;
      user-select:none;
    }
    .navLinks a:hover{
      background: rgba(255,255,255,0.08);
      border-color: var(--border);
      color: var(--text);
      text-decoration:none;
    }
    .navLinks a.active{
      background: rgba(38,198,218,0.16);
      border-color: rgba(38,198,218,0.35);
      color: var(--text);
    }

    main{
      margin-top: 16px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .section{
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 14px;
      position:relative;
      overflow:hidden;
    }

    .sectionHeader{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap: 12px; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .sectionHeader h2{
      margin:0;
      font-size: 18px;
      letter-spacing: -0.2px;
      display:flex; align-items:center; gap:10px;
    }
    .sectionHeader p{
      margin: 4px 0 0;
      color: var(--muted);
      max-width: 90ch;
      font-size: 13.5px;
    }

    .badgeRow{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
      margin-top:2px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--muted);
      background: rgba(255,255,255,0.06);
      user-select:none;
      white-space:nowrap;
    }
    .badge.urgent{ border-color: rgba(255,59,92,0.40); background: rgba(255,59,92,0.10); color: var(--text); }
    .badge.routine{ border-color: rgba(38,198,218,0.40); background: rgba(38,198,218,0.10); color: var(--text); }
    .badge.meds{ border-color: rgba(255,204,0,0.45); background: rgba(255,204,0,0.10); color: var(--text); }
    .badge.advice{ border-color: rgba(25,209,138,0.45); background: rgba(25,209,138,0.10); color: var(--text); }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      grid-column: span 6;
      background: rgba(255,255,255,0.06);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      position:relative;
      overflow:hidden;
    }
    .card.span4{ grid-column: span 4; }
    .card.span8{ grid-column: span 8; }
    .card.span12{ grid-column: 1 / -1; }

    @media (max-width: 980px){
      .card,.card.span4,.card.span8,.card.span12{ grid-column: 1 / -1; }
    }

    .cardTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 8px;
    }
    .cardTitle h3{
      margin:0;
      font-size: 14.5px;
      letter-spacing: -0.15px;
      display:flex; align-items:center; gap:10px;
    }
    .cardTitle .flag{
      display:inline-flex; align-items:center; gap:8px;
      font-weight: 750;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      user-select:none;
      white-space:nowrap;
    }
    .flag.urgent{ border-color: rgba(255,59,92,0.45); background: rgba(255,59,92,0.12); }
    .flag.routine{ border-color: rgba(38,198,218,0.45); background: rgba(38,198,218,0.12); }
    .flag.meds{ border-color: rgba(255,204,0,0.55); background: rgba(255,204,0,0.12); }
    .flag.advice{ border-color: rgba(25,209,138,0.55); background: rgba(25,209,138,0.12); }

    ul{ margin: 8px 0 0 20px; padding:0; color: var(--muted); }
    li{ margin: 6px 0; }
    .tight li{ margin: 4px 0; }

    .actionBox{
      border-radius: var(--radius);
      padding: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      position:relative;
      overflow:hidden;
    }
    .actionBox.urgent{
      border-color: rgba(255,59,92,0.45);
      background: linear-gradient(180deg, rgba(255,59,92,0.13), rgba(255,255,255,0.04));
    }
    .actionBox.routine{
      border-color: rgba(38,198,218,0.45);
      background: linear-gradient(180deg, rgba(38,198,218,0.13), rgba(255,255,255,0.04));
    }

    .actionBox h4{
      margin:0 0 6px;
      font-size: 14px;
      display:flex; align-items:center; gap:10px;
    }
    .actionBox p{ margin:0; color: var(--muted); font-size: 13.5px; }

    .steps{
      display:grid; gap:10px;
      margin-top: 10px;
    }
    .step{
      display:grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      align-items:flex-start;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
    }
    .num{
      width: 30px; height: 30px; border-radius: 10px;
      display:grid; place-items:center;
      font-family: var(--mono);
      font-size: 12px;
      border: 1px solid var(--border);
      color: var(--text);
      background: rgba(255,255,255,0.08);
    }
    .step b{ display:block; margin-bottom: 2px; }
    .step span{ color: var(--muted); font-size: 13.5px; display:block; }

    details{
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,0.05);
      padding: 10px 10px;
    }
    details + details{ margin-top: 10px; }
    summary{
      cursor:pointer;
      list-style:none;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight: 750;
      color: var(--text);
      user-select:none;
    }
    summary::-webkit-details-marker{ display:none; }
    .summaryHint{ color: var(--muted); font-weight: 650; font-size: 12px; }
    .detailBody{
      margin-top: 10px;
      color: var(--muted);
      font-size: 13.5px;
    }

    .kbd{
      font-family: var(--mono);
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      white-space:nowrap;
    }

    .footerNote{
      margin-top: 16px;
      color: var(--faint);
      font-size: 12.5px;
      display:flex;
      gap: 10px;
      align-items:flex-start;
    }

    .hiddenByFilter{ display:none !important; }

    /* toast */
    .toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 50;
      min-width: 220px;
      max-width: 420px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.35);
      color: var(--text);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      display:none;
      font-size: 13px;
    }
    @media (prefers-color-scheme: light){
      .toast{ background: rgba(255,255,255,0.82); }
    }
    .toast strong{ font-weight: 800; }
    .toast small{ color: var(--muted); display:block; margin-top: 3px; }

    @media print{
      .stickyNav,.controls,.toast,.quickActions{ display:none !important; }
      body{ background:#fff; }
      .section,.hero,.controls{ box-shadow:none; }
      a{ color:#000; text-decoration:underline; }
    }
  </style>
</head>

<body>
<div class="gridGlow" aria-hidden="true"></div>

<div class="wrap">
  <header>
    <section class="hero" aria-label="Title and overview">
      <div class="kicker">
        <span class="pill">
          <span aria-hidden="true">üß≠</span>
          <strong>Decision support</strong>
          <span>acute torticollis / acute neck pain</span>
        </span>
        <span class="pill">
          <span aria-hidden="true">üë§</span>
          <strong>Age</strong>
          <span>‚â•16 years</span>
        </span>
        <span class="pill">
          <span aria-hidden="true">‚è±Ô∏è</span>
          <strong>Typical course</strong>
          <span>improves 24‚Äì48h; resolves 7‚Äì10d</span>
        </span>
      </div>

      <h1>Acute torticollis (wry neck)</h1>
      <p>
        Clinically diagnosed, usually within 1‚Äì2 days of onset. In typical cases, investigations are not required.
        Prioritise exclusion of serious spinal/infective/neoplastic and neurological pathology, then treat pain and restore movement early.
      </p>

      <div class="quickActions">
        <button class="btn btnDanger" data-jump="#triage" title="Jump to red flags">
          <span aria-hidden="true">üö®</span> Red flags & urgent pathway
        </button>
        <button class="btn btnPrimary" data-jump="#management" title="Jump to initial management">
          <span aria-hidden="true">üß∞</span> Initial management
        </button>
        <button class="btn" id="expandAll" title="Expand all accordions">
          <span aria-hidden="true">üìÇ</span> Expand all
        </button>
        <button class="btn" id="collapseAll" title="Collapse all accordions">
          <span aria-hidden="true">üóÇÔ∏è</span> Collapse all
        </button>
      </div>

      <div class="footerNote">
        <span aria-hidden="true">üìå</span>
        <div>
          <div><strong>Use-case:</strong> rapid bedside scanning + structured documentation prompts.</div>
          <div>Keyboard: <span class="kbd">/</span> search ¬∑ <span class="kbd">g</span> then <span class="kbd">t</span> triage ¬∑ <span class="kbd">g</span> then <span class="kbd">m</span> management</div>
        </div>
      </div>
    </section>

    <aside class="rightPanel">
      <section class="controls" aria-label="Search and filters">
        <div class="controlRow" style="margin-bottom:10px;">
          <div class="search" role="search">
            <span aria-hidden="true">üîé</span>
            <input id="searchBox" type="text" placeholder="Search e.g. ‚Äòmyelopathy‚Äô, ‚ÄòSpurling‚Äô, ‚Äòfever‚Äô, ‚Äòexercises‚Äô‚Ä¶" autocomplete="off" />
            <button class="btn" id="clearSearch" style="padding:8px 10px;" title="Clear search">‚úï</button>
          </div>
        </div>

        <div class="controlRow" aria-label="Content filters">
          <div class="toggles">
            <div class="chip urgent" data-filter="urgent" data-on="true" role="button" tabindex="0" aria-pressed="true">
              <span class="dot" aria-hidden="true"></span> Urgent
            </div>
            <div class="chip" data-filter="routine" data-on="true" role="button" tabindex="0" aria-pressed="true">
              <span class="dot" aria-hidden="true"></span> Routine
            </div>
            <div class="chip meds" data-filter="meds" data-on="true" role="button" tabindex="0" aria-pressed="true">
              <span class="dot" aria-hidden="true"></span> Meds
            </div>
            <div class="chip advice" data-filter="advice" data-on="true" role="button" tabindex="0" aria-pressed="true">
              <span class="dot" aria-hidden="true"></span> Advice
            </div>
          </div>
        </div>
      </section>

      <nav class="stickyNav" aria-label="Sticky navigation">
        <div class="navInner">
          <div class="navTitle">
            <span aria-hidden="true">üß†</span>
            Pathway
            <small id="activeSectionLabel">‚Äî</small>
          </div>

          <div class="navLinks" id="navLinks">
            <a href="#triage" data-key="t"><span aria-hidden="true">üö®</span> Triage</a>
            <a href="#assessment" data-key="a"><span aria-hidden="true">ü©∫</span> Assessment</a>
            <a href="#ddx" data-key="d"><span aria-hidden="true">üß©</span> Ddx</a>
            <a href="#investigations" data-key="i"><span aria-hidden="true">üß™</span> Ix</a>
            <a href="#management" data-key="m"><span aria-hidden="true">üß∞</span> Tx</a>
            <a href="#advice" data-key="p"><span aria-hidden="true">üì£</span> Advice</a>
            <a href="#safetynet" data-key="s"><span aria-hidden="true">üõü</span> Safety-net</a>
          </div>
        </div>
      </nav>
    </aside>
  </header>

  <main>

    <!-- TRIAGE -->
    <section class="section" id="triage" data-section="Triage">
      <div class="sectionHeader">
        <div>
          <h2><span aria-hidden="true">üö®</span> Triage: red flags & urgent referral triggers</h2>
          <p>Separate ‚Äúsimple acute torticollis‚Äù from serious spinal/infective/neoplastic/neurological pathology. Prioritise immediate escalation when red flags are present.</p>
        </div>
        <div class="badgeRow">
          <span class="badge urgent"><span aria-hidden="true">‚ö†Ô∏è</span> Urgent pathway</span>
        </div>
      </div>

      <div class="grid">
        <div class="card span12 contentCard" data-tags="urgent triage red flags malignancy infection inflammation myelopathy neurological headache photophobia trauma osteoporosis surgery">
          <div class="cardTitle">
            <h3><span aria-hidden="true">üü•</span> Red flags (act now)</h3>
            <span class="flag urgent"><span aria-hidden="true">üö®</span> URGENT</span>
          </div>

          <div class="grid" style="margin-top:6px;">
            <div class="actionBox urgent contentCard span6" data-tags="urgent fever night sweats weight loss cancer lymphadenopathy vertebral tenderness night pain nausea vomiting headache photophobia phonophobia visual loss rash erythema wounds exudate" style="grid-column: span 6;">
              <h4><span aria-hidden="true">ü¶†</span> Infection / malignancy / inflammation pattern</h4>
              <p>Fever, night sweats, unexplained weight loss, cervical lymphadenopathy, intractable night pain, escalating pain, exquisite vertebral tenderness, generalised stiffness; nausea/vomiting; new/severe headache; photophobia/phonophobia; visual loss; skin erythema/wounds/exudate.</p>
            </div>

            <div class="actionBox urgent contentCard span6" data-tags="urgent myelopathy paresis sensory changes clumsy hands gait babinski clonus spasticity hoffman lhermitte bowel bladder ataxia" style="grid-column: span 6;">
              <h4><span aria-hidden="true">üß†</span> Cervical myelopathy / major neurological compromise</h4>
              <p>Paresis, sensory loss, altered tone, clumsy/weak hands, gait disturbance; Babinski/hyperreflexia/clonus/spasticity; Hoffman; Lhermitte; bowel/bladder dysfunction; severe gait ataxia.</p>
            </div>

            <div class="actionBox urgent contentCard span6" data-tags="urgent altered cognitive state weakness multiple myotomes dermatomes ataxia vertigo facial pain headaches" style="grid-column: span 6;">
              <h4><span aria-hidden="true">üß≠</span> Other concerning neurological features</h4>
              <p>Altered cognition; weakness involving &gt;1 myotome or sensory loss &gt;1 dermatome; headache with ataxia/vertigo/facial pain.</p>
            </div>

            <div class="actionBox urgent contentCard span6" data-tags="urgent age under 20 over 55 cancer vascular disease inflammatory arthritis TB immunosuppression drug abuse AIDS trauma fall height osteoporosis neck surgery" style="grid-column: span 6;">
              <h4><span aria-hidden="true">üß±</span> High-risk context</h4>
              <p>New symptoms &lt;20y or &gt;55y; history of cancer/vascular disease; inflammatory arthritis, TB, immunosuppression, substance misuse; violent trauma or fall from height; minor trauma with osteoporosis risk; prior neck surgery.</p>
            </div>
          </div>

          <div class="steps">
            <div class="step contentCard" data-tags="urgent pathway refer emergency escalation" >
              <div class="num">1</div>
              <div>
                <b>Identify red flags</b>
                <span>Any red flag shifts pathway to urgent assessment/secondary care escalation.</span>
              </div>
            </div>
            <div class="step contentCard" data-tags="urgent infection meningitis kernig brudzinski nuchal rigidity" >
              <div class="num">2</div>
              <div>
                <b>If meningitis suspected</b>
                <span>Assess for nuchal rigidity (e.g., Kernig/Brudzinski) and escalate without delay.</span>
              </div>
            </div>
            <div class="step contentCard" data-tags="urgent trauma fracture dislocation imaging" >
              <div class="num">3</div>
              <div>
                <b>If injury suspected</b>
                <span>Manage as potential cervical injury; imaging pathway as per trauma protocol.</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <details class="contentCard" data-tags="urgent medication dystonia dopamine antagonist metoclopramide prochlorperazine domperidone antipsychotic" open>
        <summary>
          <span>Medication-associated acute dystonia (secondary torticollis)</span>
          <span class="summaryHint">look for dopamine antagonists</span>
        </summary>
        <div class="detailBody">
          Consider acute dystonic reaction if recent exposure to dopamine receptor antagonist medications (e.g., antipsychotics, metoclopramide, prochlorperazine, domperidone). This is uncommon but high-yield in ED/acute care.
        </div>
      </details>
    </section>

    <!-- ASSESSMENT -->
    <section class="section" id="assessment" data-section="Assessment">
      <div class="sectionHeader">
        <div>
          <h2><span aria-hidden="true">ü©∫</span> Assessment: rapid structure</h2>
          <p>History and examination to differentiate mechanical neck pain from neuropathic/radicular patterns and to identify serious pathology early.</p>
        </div>
        <div class="badgeRow">
          <span class="badge routine"><span aria-hidden="true">‚úÖ</span> Routine workflow</span>
        </div>
      </div>

      <div class="grid">
        <div class="card span6 contentCard" data-tags="routine history onset duration occupational anxiety depression infection cancer fever medication trauma">
          <div class="cardTitle">
            <h3><span aria-hidden="true">üó£Ô∏è</span> History (ask explicitly)</h3>
            <span class="flag routine"><span aria-hidden="true">üü¶</span> ROUTINE</span>
          </div>
          <ul class="tight">
            <li>Onset, duration, pattern; typical presentation within 1‚Äì2 days.</li>
            <li>Occupational/postural triggers (screen position, seating, sleep support, unbalanced loads).</li>
            <li>Prior infection; <b>fever</b> (treat as infective until excluded).</li>
            <li>History of <b>cancer</b> (assume malignant cause until excluded).</li>
            <li>Inflammatory arthropathy (e.g. RA ‚Üí consider atlanto-axial pathology).</li>
            <li>Psychological factors (anxiety/depression) that may modulate pain and recovery.</li>
            <li>Medication changes (dopamine antagonists) ‚Üí acute dystonia.</li>
          </ul>
        </div>

        <div class="card span6 contentCard" data-tags="routine examination ROM palpation tenderness spasm trigger points neuro reflexes gait coordination skin rash petechiae purpura papulovesicular">
          <div class="cardTitle">
            <h3><span aria-hidden="true">üñêÔ∏è</span> Examination (high-yield)</h3>
            <span class="flag routine"><span aria-hidden="true">üü¶</span> ROUTINE</span>
          </div>
          <ul class="tight">
            <li>Inspect posture/head tilt; assess active ROM (pain-limited, asymmetry).</li>
            <li>Palpate for tenderness, spasm, trigger points.</li>
            <li>Neuro screen: power, sensation, reflexes; gait and coordination.</li>
            <li>Skin: prodromal rash distribution, petechiae/palpable purpura, erythema/wounds.</li>
          </ul>
        </div>

        <div class="card span12 contentCard" data-tags="routine spurling test radiculopathy contraindications RA cancer infection injury">
          <div class="cardTitle">
            <h3><span aria-hidden="true">üß™</span> Targeted manoeuvres</h3>
            <span class="flag routine"><span aria-hidden="true">üü¶</span> ROUTINE</span>
          </div>

          <details class="contentCard" data-tags="routine spurling test radiculopathy limb pain">
            <summary>
              <span>Spurling test (to support cervical radiculopathy)</span>
              <span class="summaryHint">avoid in high-risk contexts</span>
            </summary>
            <div class="detailBody">
              Seated: lateral flexion toward symptomatic side and apply axial load. Reproduction of radicular limb pain supports cervical radiculopathy.
              <br><br>
              <b>Do not perform</b> when there is concern for RA, cancer, infection, or possible neck injury.
            </div>
          </details>

          <details class="contentCard" data-tags="urgent meningitis kernig brudzinski nuchal rigidity">
            <summary>
              <span>Kernig / Brudzinski (if meningitis suspected)</span>
              <span class="summaryHint">triage-level if positive</span>
            </summary>
            <div class="detailBody">
              Use to demonstrate nuchal rigidity in appropriate clinical context. Positive findings should accelerate escalation.
            </div>
          </details>
        </div>
      </div>
    </section>

    <!-- DIFFERENTIAL -->
    <section class="section" id="ddx" data-section="Differential">
      <div class="sectionHeader">
        <div>
          <h2><span aria-hidden="true">üß©</span> Differential diagnosis: keep it broad, prioritise dangerous</h2>
          <p>Secondary torticollis and non-musculoskeletal processes can mimic ‚Äúsimple wry neck‚Äù. Anchor on the red-flag screen.</p>
        </div>
        <div class="badgeRow">
          <span class="badge routine"><span aria-hidden="true">üß†</span> Diagnostic framing</span>
        </div>
      </div>

      <div class="grid">
        <div class="card span12 contentCard" data-tags="routine differential disc prolapse trauma whiplash adverse drug reaction arthritis cervical strain fracture dislocation radiculopathy myelopathy malignancy meningitis stroke encephalitis psychogenic dystonia wilson huntington genetic">
          <div class="cardTitle">
            <h3><span aria-hidden="true">üìö</span> Key alternatives to consider</h3>
            <span class="flag routine"><span aria-hidden="true">üü¶</span> ROUTINE</span>
          </div>
          <ul>
            <li><b>Acute disc prolapse</b> (common cause of severe secondary torticollis).</li>
            <li><b>Trauma</b> (whiplash-type injury; cervical strain/fracture/dislocation).</li>
            <li><b>Medication adverse effects</b> (dopamine antagonists; stimulant/cocaine exposure).</li>
            <li><b>Degenerative/inflammatory arthritis</b> of cervical spine.</li>
            <li><b>Radiculopathy / myelopathy</b>.</li>
            <li><b>Malignancy</b>, <b>meningitis</b>.</li>
            <li><b>Neurological causes of dystonia</b> (stroke, encephalitis); psychogenic dystonia.</li>
            <li><b>Genetic/metabolic</b> dystonia syndromes (e.g., Wilson‚Äôs, Huntington‚Äôs, DYT-1).</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- INVESTIGATIONS -->
    <section class="section" id="investigations" data-section="Investigations">
      <div class="sectionHeader">
        <div>
          <h2><span aria-hidden="true">üß™</span> Investigations: when to do more</h2>
          <p>Typical acute torticollis is clinical. Escalate investigations if atypical features, red flags, suspected injury, infection, malignancy, or alternative/secondary diagnoses.</p>
        </div>
        <div class="badgeRow">
          <span class="badge routine"><span aria-hidden="true">üßæ</span> Selective testing</span>
        </div>
      </div>

      <div class="grid">
        <div class="card span6 contentCard" data-tags="routine investigations not required typical 1-2 days onset">
          <div class="cardTitle">
            <h3><span aria-hidden="true">üü©</span> Typical presentation</h3>
            <span class="flag routine"><span aria-hidden="true">‚úÖ</span> NO ROUTINE IX</span>
          </div>
          <div class="actionBox routine contentCard" data-tags="routine reassurance self-limited">
            <h4><span aria-hidden="true">üéØ</span> Default</h4>
            <p>In typical cases presenting within 1‚Äì2 days without red flags, investigations are usually unnecessary.</p>
          </div>
        </div>

        <div class="card span6 contentCard" data-tags="urgent investigations referral atypical red flags injury infection malignancy alternative diagnosis">
          <div class="cardTitle">
            <h3><span aria-hidden="true">üü®</span> Indications to investigate / refer</h3>
            <span class="flag urgent"><span aria-hidden="true">‚ö†Ô∏è</span> TRIGGER</span>
          </div>
          <ul class="tight">
            <li>Atypical presentation.</li>
            <li>Any red flag symptoms/signs.</li>
            <li>Suspected cervical injury.</li>
            <li>Recent infection history or systemic features.</li>
            <li>Suspicion of malignancy.</li>
            <li>Alternative or secondary diagnosis suspected.</li>
          </ul>
        </div>

        <div class="card span12 contentCard" data-tags="urgent routine labs ESR CRP FBC cultures imaging xray CT MRI bone scan CT myelography">
          <div class="cardTitle">
            <h3><span aria-hidden="true">üß∞</span> Example investigation set (context-dependent)</h3>
            <span class="flag routine"><span aria-hidden="true">üü¶</span> SELECTIVE</span>
          </div>
          <div class="grid">
            <div class="actionBox contentCard" data-tags="labs ESR CRP FBC cultures" style="grid-column: span 6;">
              <h4><span aria-hidden="true">üß´</span> Laboratory</h4>
              <p>Consider ESR/CRP, FBC, and targeted cultures (fungal/viral) when infection/inflammation is suspected.</p>
            </div>
            <div class="actionBox contentCard" data-tags="imaging xray CT MRI bone scan CT myelography cranial CT" style="grid-column: span 6;">
              <h4><span aria-hidden="true">üñºÔ∏è</span> Imaging</h4>
              <p>Typically arranged via specialist/secondary care pathway: cervical X-ray, CT/MRI C-spine, CT myelography, bone scan; cranial CT as indicated by clinical picture.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- MANAGEMENT -->
    <section class="section" id="management" data-section="Management">
      <div class="sectionHeader">
        <div>
          <h2><span aria-hidden="true">üß∞</span> Management: stepwise, movement-forward</h2>
          <p>Analgesia + early mobilisation + selective physiotherapy. Safety-net if not improving or if deterioration occurs.</p>
        </div>
        <div class="badgeRow">
          <span class="badge meds"><span aria-hidden="true">üíä</span> Analgesia</span>
          <span class="badge advice"><span aria-hidden="true">üß†</span> Self-management</span>
        </div>
      </div>

      <div class="grid">
        <div class="card span6 contentCard" data-tags="meds routine management analgesics ibuprofen paracetamol codeine NSAID choice severity preference tolerability adverse effects">
          <div class="cardTitle">
            <h3><span aria-hidden="true">üíä</span> Analgesia (oral; tailor to patient)</h3>
            <span class="flag meds"><span aria-hidden="true">üíõ</span> MEDS</span>
          </div>
          <div class="steps">
            <div class="step contentCard" data-tags="meds paracetamol ibuprofen first line">
              <div class="num">1</div>
              <div>
                <b>Start with simple analgesia</b>
                <span>Paracetamol and/or ibuprofen according to pain severity, preferences, and risk profile.</span>
              </div>
            </div>
            <div class="step contentCard" data-tags="meds codeine escalation">
              <div class="num">2</div>
              <div>
                <b>Escalate if needed</b>
                <span>Consider codeine for more severe pain if appropriate.</span>
              </div>
            </div>
            <div class="step contentCard" data-tags="meds NSAID risk GI renal cardiovascular shortest duration">
              <div class="num">3</div>
              <div>
                <b>NSAID stewardship</b>
                <span>Use lowest effective dose and shortest duration; consider GI/CV/renal risk and gastroprotection where indicated.</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card span6 contentCard" data-tags="routine management physiotherapy referral advice return if not improve deteriorate">
          <div class="cardTitle">
            <h3><span aria-hidden="true">üßë‚Äçü¶Ω</span> Non-pharmacological</h3>
            <span class="flag advice"><span aria-hidden="true">üü©</span> ADVICE</span>
          </div>
          <div class="actionBox routine contentCard" data-tags="routine physiotherapy referral">
            <h4><span aria-hidden="true">üßë‚Äç‚öïÔ∏è</span> Consider physiotherapy</h4>
            <p>Referral may be appropriate when pain is limiting function or recovery is delayed.</p>
          </div>
          <div class="actionBox routine contentCard" data-tags="routine mobilisation avoid collar movement improves outcomes">
            <h4><span aria-hidden="true">üèÉ</span> Keep moving early</h4>
            <p>Avoid cervical collar; outcomes are improved with movement rather than immobilisation.</p>
          </div>
          <div class="actionBox urgent contentCard" data-tags="urgent return review deterioration no improvement">
            <h4><span aria-hidden="true">üõü</span> Reassess if not improving</h4>
            <p>Advise return for further assessment if symptoms do not improve or deteriorate.</p>
          </div>
        </div>

        <div class="card span12 contentCard" data-tags="routine urgent pathway management steps triage red flags">
          <div class="cardTitle">
            <h3><span aria-hidden="true">üß≠</span> Two-lane pathway (fast scan)</h3>
            <span class="flag routine"><span aria-hidden="true">üü¶</span> PATHWAY</span>
          </div>

          <div class="grid">
            <div class="actionBox urgent contentCard" data-tags="urgent lane red flags refer" style="grid-column: span 6;">
              <h4><span aria-hidden="true">üö®</span> Urgent lane</h4>
              <p>If any red flags, suspected infection/malignancy/myelopathy/major neuro deficit or injury ‚Üí urgent escalation and directed investigations.</p>
            </div>
            <div class="actionBox routine contentCard" data-tags="routine lane simple acute torticollis treat pain mobilise" style="grid-column: span 6;">
              <h4><span aria-hidden="true">‚úÖ</span> Routine lane</h4>
              <p>Typical acute torticollis ‚Üí analgesia + heat/cold + gentle ROM + avoid collar; consider physio; safety-net.</p>
            </div>
          </div>
        </div>
      </div>

      <details class="contentCard" data-tags="meds NSAID safety ibuprofen naproxen PPI risk GI renal cardiovascular older adults">
        <summary>
          <span>NSAID risk reminders (quick stewardship checklist)</span>
          <span class="summaryHint">GI/CV/renal</span>
        </summary>
        <div class="detailBody">
          Review contraindications and individual GI/CV/renal risk; choose lowest-risk option where possible, use lowest effective dose for shortest duration, and consider gastroprotection for higher-risk patients.
        </div>
      </details>
    </section>

    <!-- ADVICE -->
    <section class="section" id="advice" data-section="Patient advice">
      <div class="sectionHeader">
        <div>
          <h2><span aria-hidden="true">üì£</span> Patient advice: practical, movement-safe</h2>
          <p>Set expectations, reduce fear-avoidance, and provide concrete self-management steps.</p>
        </div>
        <div class="badgeRow">
          <span class="badge advice"><span aria-hidden="true">üü©</span> Advice</span>
        </div>
      </div>

      <div class="grid">
        <div class="card span6 contentCard" data-tags="advice prognosis resolves 24-48 hours week recurrence common">
          <div class="cardTitle">
            <h3><span aria-hidden="true">üß†</span> What to explain</h3>
            <span class="flag advice"><span aria-hidden="true">üü©</span> ADVICE</span>
          </div>
          <ul class="tight">
            <li>Usually improves within 24‚Äì48 hours; may take up to a week.</li>
            <li>Recurrence is common.</li>
            <li>Goal is pain control and gradual restoration of range of motion.</li>
          </ul>
        </div>

        <div class="card span6 contentCard" data-tags="advice heat cold packs low firm pillow avoid collar avoid driving cycling">
          <div class="cardTitle">
            <h3><span aria-hidden="true">üß∞</span> Do / Don‚Äôt</h3>
            <span class="flag advice"><span aria-hidden="true">üü©</span> ADVICE</span>
          </div>
          <div class="grid">
            <div class="actionBox routine contentCard" data-tags="advice do heat cold pillow analgesics" style="grid-column: span 6;">
              <h4><span aria-hidden="true">‚úÖ</span> Do</h4>
              <p>Analgesics as needed; heat or cold packs; sleep on a low firm pillow.</p>
            </div>
            <div class="actionBox urgent contentCard" data-tags="advice dont collar drive bike rotate head traffic" style="grid-column: span 6;">
              <h4><span aria-hidden="true">‚õî</span> Don‚Äôt</h4>
              <p>Avoid cervical collar (limits movement); avoid driving/cycling when neck rotation is restricted.</p>
            </div>
          </div>
        </div>

        <div class="card span12 contentCard" data-tags="advice exercises neck rotation stretch flexibility gentle">
          <div class="cardTitle">
            <h3><span aria-hidden="true">ü§∏</span> Gentle exercises (micro-dose, pain-limited)</h3>
            <span class="flag advice"><span aria-hidden="true">üü©</span> ADVICE</span>
          </div>

          <div class="grid">
            <div class="actionBox routine contentCard" data-tags="advice neck rotation exercise hold 5 seconds 3 each side" style="grid-column: span 6;">
              <h4><span aria-hidden="true">üîÑ</span> Neck rotation</h4>
              <p>Sit upright, shoulders relaxed. Slowly rotate head toward one shoulder as far as comfortable; hold 5 seconds; return. Repeat other side. <b>3 reps each side</b>.</p>
            </div>
            <div class="actionBox routine contentCard" data-tags="advice neck stretch lateral flexion hold shoulder down 5 seconds 3 each side" style="grid-column: span 6;">
              <h4><span aria-hidden="true">‚ÜîÔ∏è</span> Neck stretch</h4>
              <p>Sit upright. Hold left shoulder down with right hand; gently tilt head right; hold 5 seconds; repeat opposite. <b>3 reps each side</b>.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SAFETY NET -->
    <section class="section" id="safetynet" data-section="Safety-net">
      <div class="sectionHeader">
        <div>
          <h2><span aria-hidden="true">üõü</span> Safety-net: what should trigger re-evaluation</h2>
          <p>Make ‚Äúreturn criteria‚Äù explicit and memorable. If deterioration occurs, re-screen red flags and broaden the differential.</p>
        </div>
        <div class="badgeRow">
          <span class="badge urgent"><span aria-hidden="true">‚ö†Ô∏è</span> Escalation triggers</span>
        </div>
      </div>

      <div class="grid">
        <div class="card span12 contentCard" data-tags="urgent safety net deterioration not improving red flags">
          <div class="cardTitle">
            <h3><span aria-hidden="true">üìç</span> Re-attendance / review triggers</h3>
            <span class="flag urgent"><span aria-hidden="true">üö®</span> SAFETY</span>
          </div>

          <div class="steps">
            <div class="step contentCard" data-tags="urgent return criteria">
              <div class="num">1</div>
              <div>
                <b>Symptoms not improving</b>
                <span>If no trajectory toward improvement, reassess diagnosis and consider investigations/referral.</span>
              </div>
            </div>
            <div class="step contentCard" data-tags="urgent deterioration">
              <div class="num">2</div>
              <div>
                <b>Symptoms deteriorate</b>
                <span>Repeat neuro exam; re-check infection/malignancy/myelopathy/trauma red flags.</span>
              </div>
            </div>
            <div class="step contentCard" data-tags="urgent new neuro deficits fever severe headache night pain">
              <div class="num">3</div>
              <div>
                <b>New red flags emerge</b>
                <span>Escalate urgently: fever/systemic symptoms, new neuro signs, severe headache/photophobia, escalating night pain, or vertebral tenderness.</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <details class="contentCard" data-tags="routine documentation prompts">
        <summary>
          <span>Documentation prompts (one-minute)</span>
          <span class="summaryHint">copy into note</span>
        </summary>
        <div class="detailBody">
          <ul class="tight">
            <li>Onset/time course; precipitant posture/sleep/loads; trauma yes/no.</li>
            <li>Systemic: fever/weight loss/night sweats; cancer history; infection risks.</li>
            <li>Neuro: power/sensation/reflexes; gait; myelopathy screen; sphincter symptoms.</li>
            <li>Skin/rash; meningism if relevant.</li>
            <li>Plan: analgesia, mobilisation advice, return criteria, referral/ix if indicated.</li>
          </ul>
        </div>
      </details>
    </section>

    <section class="section">
      <div class="sectionHeader">
        <div>
          <h2><span aria-hidden="true">üìé</span> Source snapshot</h2>
          <p>Clinical recommendations reflect the uploaded NICE CKS topic extract (last revised Oct 2023 in the provided text). :contentReference[oaicite:1]{index=1}</p>
        </div>
      </div>
      <div class="actionBox contentCard routine" data-tags="routine source">
        <h4><span aria-hidden="true">üóÉÔ∏è</span> Tip</h4>
        <p>Keep this page locally (single HTML file) and update the embedded content when your local guideline changes.</p>
      </div>
    </section>

  </main>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
  const $  = (q, el=document) => el.querySelector(q);

  const state = {
    filters: { urgent:true, routine:true, meds:true, advice:true },
    query: ""
  };

  // Smooth jump buttons
  $$(".btn[data-jump]").forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-jump");
      const el = document.querySelector(target);
      if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
      toast("Navigation", "Jumped to " + target.replace("#",""));
    });
  });

  // Expand/collapse all details
  const expandAll = () => $$("details").forEach(d => d.open = true);
  const collapseAll = () => $$("details").forEach(d => d.open = false);
  $("#expandAll").addEventListener("click", () => { expandAll(); toast("Accordions","Expanded all sections"); });
  $("#collapseAll").addEventListener("click", () => { collapseAll(); toast("Accordions","Collapsed all sections"); });

  // Filter chips
  $$(".chip").forEach(chip => {
    const key = chip.dataset.filter;
    const toggle = () => {
      const on = !(chip.dataset.on === "true");
      chip.dataset.on = String(on);
      chip.setAttribute("aria-pressed", String(on));
      state.filters[key] = on;
      applyFilters();
      toast("Filter", `${capitalize(key)} ${on ? "shown" : "hidden"}`);
    };
    chip.addEventListener("click", toggle);
    chip.addEventListener("keydown", (e) => {
      if(e.key === "Enter" || e.key === " "){ e.preventDefault(); toggle(); }
    });
  });

  // Search
  const searchBox = $("#searchBox");
  const clearSearch = $("#clearSearch");

  const focusSearch = () => searchBox.focus();

  const setQuery = (q) => {
    state.query = (q || "").trim().toLowerCase();
    applyFilters();
  };

  searchBox.addEventListener("input", (e) => setQuery(e.target.value));
  clearSearch.addEventListener("click", () => { searchBox.value = ""; setQuery(""); toast("Search","Cleared"); });

  // Keyboard shortcuts
  let gPrefix = false;
  window.addEventListener("keydown", (e) => {
    // ignore if typing into an input
    const tag = (document.activeElement?.tagName || "").toLowerCase();
    const typing = tag === "input" || tag === "textarea";
    if(!typing && e.key === "/"){
      e.preventDefault();
      focusSearch();
      toast("Shortcut", "Search focused");
      return;
    }
    if(typing) return;

    if(e.key.toLowerCase() === "g"){
      gPrefix = true;
      setTimeout(() => gPrefix = false, 800);
      return;
    }
    if(gPrefix){
      gPrefix = false;
      const k = e.key.toLowerCase();
      const map = { t:"#triage", a:"#assessment", d:"#ddx", i:"#investigations", m:"#management", p:"#advice", s:"#safetynet" };
      if(map[k]){
        document.querySelector(map[k]).scrollIntoView({behavior:"smooth", block:"start"});
        toast("Shortcut", "Jumped to " + map[k].replace("#",""));
      }
    }
  });

  // Active nav highlighting
  const sections = $$("section.section[id]");
  const navLinks = $$("#navLinks a");
  const activeLabel = $("#activeSectionLabel");

  const linkById = new Map(navLinks.map(a => [a.getAttribute("href").slice(1), a]));

  const setActive = (id) => {
    navLinks.forEach(a => a.classList.toggle("active", a.getAttribute("href") === "#" + id));
    const sec = document.getElementById(id);
    const label = sec?.dataset.section ? `¬∑ ${sec.dataset.section}` : "‚Äî";
    activeLabel.textContent = label;
  };

  const obs = new IntersectionObserver((entries) => {
    entries.sort((a,b) => b.intersectionRatio - a.intersectionRatio);
    const top = entries.find(e => e.isIntersecting);
    if(top) setActive(top.target.id);
  }, { root:null, rootMargin:"-30% 0px -62% 0px", threshold:[0.05,0.15,0.25,0.4,0.6] });

  sections.forEach(s => obs.observe(s));

  // Apply filters + search to .contentCard blocks
  function applyFilters(){
    const cards = $$(".contentCard");
    const q = state.query;

    cards.forEach(card => {
      const tags = (card.dataset.tags || "").toLowerCase();
      const text = (card.textContent || "").toLowerCase();

      // filter logic: if a card is tagged with a category that is OFF, hide it.
      const hitUrgent = tags.includes("urgent");
      const hitRoutine = tags.includes("routine");
      const hitMeds = tags.includes("meds");
      const hitAdvice = tags.includes("advice");

      let visible = true;

      // Category filters only apply if the card declares that category.
      if(hitUrgent && !state.filters.urgent) visible = false;
      if(hitRoutine && !state.filters.routine) visible = false;
      if(hitMeds && !state.filters.meds) visible = false;
      if(hitAdvice && !state.filters.advice) visible = false;

      // Search filter: match on tags OR visible text
      if(q){
        const match = tags.includes(q) || text.includes(q);
        if(!match) visible = false;
      }

      card.classList.toggle("hiddenByFilter", !visible);
    });

    // Hide empty parent cards that contain only hidden children (lightweight pass)
    $$(".card").forEach(card => {
      const kids = $$(".contentCard", card);
      if(kids.length === 0) return;
      const anyVisible = kids.some(k => !k.classList.contains("hiddenByFilter"));
      // allow the card itself to remain if it is explicitly a contentCard and visible
      const selfVisible = !card.classList.contains("hiddenByFilter");
      card.classList.toggle("hiddenByFilter", !anyVisible && !selfVisible && !!state.query);
    });
  }

  // Nav click smooth scroll
  navLinks.forEach(a => {
    a.addEventListener("click", (e) => {
      e.preventDefault();
      const id = a.getAttribute("href").slice(1);
      const el = document.getElementById(id);
      if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
    });
  });

  // Toast helper
  const toastEl = $("#toast");
  let toastTimer = null;
  function toast(title, msg){
    toastEl.innerHTML = `<strong>${escapeHtml(title)}</strong><small>${escapeHtml(msg || "")}</small>`;
    toastEl.style.display = "block";
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => { toastEl.style.display = "none"; }, 2200);
  }

  function capitalize(s){ return (s||"").slice(0,1).toUpperCase() + (s||"").slice(1); }
  function escapeHtml(str){
    return (str||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // initial
  applyFilters();
  setActive("triage");
})();
</script>
</body>
</html>
