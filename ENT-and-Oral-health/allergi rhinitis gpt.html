<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Allergic Rhinitis ‚Äî Rapid Clinical Guide</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#0c1526;
      --card:#101f38;
      --text:#e8eefc;
      --muted:#a9b7d6;
      --line:rgba(255,255,255,.08);
      --shadow: 0 18px 55px rgba(0,0,0,.35);
      --radius:18px;

      --red:#ff3b3b;
      --red2:#ff6b6b;
      --green:#2fe58d;
      --green2:#4ff3a2;
      --amber:#ffcd4a;
      --blue:#6aa8ff;
      --purple:#b38cff;

      --focus: 0 0 0 4px rgba(106,168,255,.25);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 650px at 25% -10%, rgba(106,168,255,.18), transparent 55%),
        radial-gradient(900px 520px at 80% 0%, rgba(47,229,141,.16), transparent 50%),
        radial-gradient(1100px 650px at 50% 120%, rgba(179,140,255,.13), transparent 55%),
        var(--bg);
      color:var(--text);
      line-height:1.35;
    }

    .wrap{max-width:1220px;margin:0 auto;padding:24px 18px 70px}
    .topbar{
      position:sticky; top:0; z-index:50;
      padding:14px 0;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,18,32,.92), rgba(11,18,32,.65));
      border-bottom:1px solid var(--line);
    }
    .topbar .row{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      max-width:1220px; margin:0 auto; padding:0 18px;
    }

    .brand{
      display:flex; gap:12px; align-items:center;
      min-width:260px;
    }
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(106,168,255,.25), rgba(47,229,141,.22));
      border:1px solid rgba(255,255,255,.12);
      display:grid; place-items:center;
      box-shadow: 0 12px 28px rgba(0,0,0,.3);
    }
    .brand h1{
      font-size:15px; margin:0;
      letter-spacing:.2px;
      font-weight:750;
    }
    .brand .sub{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
      display:flex; gap:8px; align-items:center;
    }
    .pill{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--muted);
      white-space:nowrap;
    }

    .search{
      flex:1;
      display:flex; gap:10px; align-items:center;
      max-width:560px;
    }
    .search input{
      width:100%;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:11px 12px 11px 42px;
      color:var(--text);
      outline:none;
      transition:.18s ease;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    .search input:focus{box-shadow:var(--focus); border-color:rgba(106,168,255,.45)}
    .search .icon{
      position:relative;
      margin-left:12px;
      width:0; height:0;
    }
    .search .icon svg{
      position:absolute; left:12px; top:-12px;
      opacity:.85;
    }

    .actions{display:flex; gap:10px; align-items:center}
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:.16s ease;
      display:inline-flex; align-items:center; gap:9px;
      font-weight:650; font-size:12.5px;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.09)}
    .btn:active{transform:translateY(0)}
    .btn:focus{outline:none; box-shadow:var(--focus)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(47,229,141,.22), rgba(106,168,255,.18));
      border-color:rgba(47,229,141,.35);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(255,59,59,.20), rgba(255,205,74,.10));
      border-color:rgba(255,59,59,.35);
    }

    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:unset}
      .actions{flex-wrap:wrap; justify-content:flex-end}
    }

    .panel{
      background: linear-gradient(180deg, rgba(16,31,56,.78), rgba(12,21,38,.62));
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .panel .hd .title{
      display:flex; align-items:center; gap:10px;
    }
    .panel .hd h2{
      margin:0; font-size:13.5px; letter-spacing:.2px;
    }
    .panel .hd p{
      margin:3px 0 0; font-size:12px; color:var(--muted);
    }
    .panel .bd{padding:14px}

    .kpi{
      display:grid; grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .kpi .chip{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      padding:10px;
      display:flex; gap:10px; align-items:flex-start;
      transition:.16s ease;
    }
    .kpi .chip:hover{background:rgba(255,255,255,.09)}
    .kpi .chip b{display:block;font-size:12px}
    .kpi .chip span{display:block;font-size:11.5px;color:var(--muted);margin-top:2px}
    .kpi .dot{
      width:12px;height:12px;border-radius:999px;margin-top:2px; flex:0 0 auto;
      box-shadow:0 0 0 4px rgba(255,255,255,.05);
    }
    .dot.red{background:var(--red)}
    .dot.green{background:var(--green)}
    .dot.amber{background:var(--amber)}
    .dot.blue{background:var(--blue)}

    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
      margin:10px 0 0;
    }
    .seg button{
      flex:1;
      min-width:120px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:14px;
      padding:10px 10px;
      cursor:pointer;
      transition:.16s ease;
      text-align:left;
    }
    .seg button:hover{background:rgba(255,255,255,.09)}
    .seg button.active{
      border-color:rgba(47,229,141,.45);
      background:rgba(47,229,141,.10);
      box-shadow:0 0 0 4px rgba(47,229,141,.12);
    }
    .seg small{display:block;color:var(--muted);margin-top:2px;font-size:11px}

    .callout{
      border-radius:18px;
      padding:12px 12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      display:flex; gap:12px; align-items:flex-start;
    }
    .callout + .callout{margin-top:10px}
    .callout .ico{
      width:36px;height:36px;border-radius:14px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      flex:0 0 auto;
    }
    .callout .txt b{display:block;font-size:12.5px}
    .callout .txt p{margin:4px 0 0;font-size:12px;color:var(--muted)}
    .callout.red{border-color: rgba(255,59,59,.38); background: rgba(255,59,59,.10)}
    .callout.red .ico{border-color: rgba(255,59,59,.45); background: rgba(255,59,59,.12)}
    .callout.green{border-color: rgba(47,229,141,.36); background: rgba(47,229,141,.09)}
    .callout.green .ico{border-color: rgba(47,229,141,.42); background: rgba(47,229,141,.10)}
    .callout.amber{border-color: rgba(255,205,74,.35); background: rgba(255,205,74,.08)}
    .callout.amber .ico{border-color: rgba(255,205,74,.45); background: rgba(255,205,74,.10)}

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 9px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--muted);
    }
    .badge.red{border-color:rgba(255,59,59,.40); background:rgba(255,59,59,.12); color:#ffd6d6}
    .badge.green{border-color:rgba(47,229,141,.36); background:rgba(47,229,141,.10); color:#cbffe6}
    .badge.blue{border-color:rgba(106,168,255,.38); background:rgba(106,168,255,.10); color:#d7e8ff}
    .badge.amber{border-color:rgba(255,205,74,.38); background:rgba(255,205,74,.10); color:#fff1c7}

    .cards{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){ .cards{grid-template-columns:1fr} }

    details{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      overflow:hidden;
      transition:.16s ease;
    }
    details[open]{background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.13)}
    summary{
      list-style:none;
      cursor:pointer;
      padding:12px 12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      user-select:none;
    }
    summary::-webkit-details-marker{display:none}
    summary .left{display:flex; gap:10px; align-items:center}
    summary .label{font-weight:760;font-size:12.5px}
    summary .hint{font-size:11.5px;color:var(--muted)}
    summary .chev{opacity:.85; transition:.16s ease}
    details[open] summary .chev{transform:rotate(180deg)}
    .acc{
      padding:0 12px 12px;
      color:var(--muted);
      font-size:12px;
    }

    .list{
      margin:10px 0 0; padding:0;
      display:grid; gap:8px;
    }
    .li{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.10);
      transition:.14s ease;
    }
    .li:hover{background:rgba(0,0,0,.14)}
    .li .mark{
      width:18px;height:18px;border-radius:8px; flex:0 0 auto; margin-top:2px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
    }
    .li .mark.red{border-color:rgba(255,59,59,.35); background:rgba(255,59,59,.10)}
    .li .mark.green{border-color:rgba(47,229,141,.30); background:rgba(47,229,141,.08)}
    .li .mark.blue{border-color:rgba(106,168,255,.30); background:rgba(106,168,255,.08)}
    .li b{display:block;color:var(--text);font-size:12.5px}
    .li span{display:block;margin-top:2px}

    .stickyNote{
      position:fixed; right:18px; bottom:18px; z-index:80;
      width:min(420px, calc(100vw - 36px));
      border-radius:20px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(16,31,56,.92), rgba(10,18,33,.88));
      box-shadow: 0 22px 70px rgba(0,0,0,.45);
      overflow:hidden;
      transform: translateY(0);
    }
    .stickyNote.hidden{display:none}
    .stickyNote .hd{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .stickyNote .hd b{font-size:12.5px}
    .stickyNote .bd{padding:12px}
    .stickyNote .bd .mini{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .stickyNote .bd .mini .badge{cursor:pointer}
    .stickyNote .bd .rec{
      margin-top:10px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.16);
      padding:10px;
      color:var(--muted);
      font-size:12px;
      background: rgba(255,255,255,.04);
    }

    .foot{
      margin-top:16px;
      color:var(--muted);
      font-size:12px;
      display:flex; gap:12px; flex-wrap:wrap;
      justify-content:space-between;
      opacity:.9;
    }

    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .twocol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){ .twocol{grid-template-columns:1fr} }

    .hr{height:1px;background:var(--line);margin:12px 0}

    .tip{
      position:relative; display:inline-flex; align-items:center; gap:6px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      font-size:11px;
      cursor:help;
    }
    .tip:hover .popover{opacity:1; transform:translateY(0); pointer-events:auto}
    .popover{
      position:absolute;
      left:0; top:120%;
      width: min(340px, 70vw);
      background: rgba(10,18,33,.98);
      border: 1px solid rgba(255,255,255,.14);
      border-radius:16px;
      padding:10px;
      box-shadow: 0 18px 55px rgba(0,0,0,.45);
      opacity:0;
      transform: translateY(-4px);
      transition:.14s ease;
      pointer-events:none;
      z-index:20;
      color:var(--muted);
      font-size:11.5px;
    }

    /* Print */
    @media print{
      .topbar, .stickyNote, .btn, .search { display:none !important; }
      body{ background:#fff; color:#111; }
      .panel{ box-shadow:none; border:1px solid #ddd; background:#fff; }
      .callout, details, .li { border:1px solid #ddd; background:#fff; }
      .muted{ color:#333; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="row">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <!-- lungs/nose-ish icon -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M12 2v8" stroke="rgba(232,238,252,.9)" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 10c-2.2 0-4 1.8-4 4v7c0 .6-.4 1-1 1H6c-2.2 0-4-1.8-4-4v-2c0-3.5 2-6.7 5.2-8.2" stroke="rgba(232,238,252,.75)" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 10c2.2 0 4 1.8 4 4v7c0 .6.4 1 1 1h1c2.2 0 4-1.8 4-4v-2c0-3.5-2-6.7-5.2-8.2" stroke="rgba(232,238,252,.75)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h1>Allergic Rhinitis ‚Äî Rapid Guide</h1>
          <div class="sub">
            <span class="pill" id="lastSaved">Session: not saved</span>
            <span class="pill">UK primary care</span>
          </div>
        </div>
      </div>

      <div class="search" role="search">
        <span class="icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="rgba(232,238,252,.8)" stroke-width="2"/>
            <path d="M16.5 16.5 21 21" stroke="rgba(232,238,252,.8)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </span>
        <input id="q" placeholder="Search within this guide (e.g. 'unilateral', 'Dymista', 'xylometazoline', 'spray technique')‚Ä¶" autocomplete="off" />
      </div>

      <div class="actions">
        <button class="btn danger" id="btnRedFlags" title="Jump to red flags">
          <span aria-hidden="true">üö©</span> Red flags
        </button>
        <button class="btn primary" id="btnQuickPlan" title="Open quick-plan drawer">
          <span aria-hidden="true">‚ö°</span> Quick plan
        </button>
        <button class="btn" id="btnPrint" title="Print (clean layout)">
          <span aria-hidden="true">üñ®Ô∏è</span> Print
        </button>
        <button class="btn" id="btnReset" title="Reset all selections">
          <span aria-hidden="true">‚Ü∫</span> Reset
        </button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT: RAPID DECISION -->
      <section class="panel" id="panelDecision">
        <div class="hd">
          <div class="title">
            <span class="badge blue"><span aria-hidden="true">üß≠</span> Rapid decision</span>
            <div>
              <h2>2-step: classify ‚Üí treat</h2>
              <p>Pick age + severity + pattern, then copy the plan.</p>
            </div>
          </div>
          <span class="tip">‚ìò How this works
            <span class="popover">
              The ‚Äúplan‚Äù is generated from: first-line options (intranasal corticosteroid / antihistamine),
              severity/persistence step-up, review at 2‚Äì4 weeks, and escalation/referral triggers.
            </span>
          </span>
        </div>

        <div class="bd">
          <div class="kpi" aria-label="Key prompts">
            <div class="chip" id="kpiRed">
              <span class="dot red" aria-hidden="true"></span>
              <div>
                <b>Rule out red flags</b>
                <span>Unilateral / blood-stained discharge / recurrent epistaxis / nasal pain ‚Üí urgent ENT.</span>
              </div>
            </div>
            <div class="chip">
              <span class="dot amber" aria-hidden="true"></span>
              <div>
                <b>Confirm pattern</b>
                <span>Intermittent vs persistent; seasonal vs perennial triggers.</span>
              </div>
            </div>
            <div class="chip">
              <span class="dot green" aria-hidden="true"></span>
              <div>
                <b>Start first-line</b>
                <span>Intranasal steroid most effective; intranasal antihistamine fastest onset.</span>
              </div>
            </div>
            <div class="chip">
              <span class="dot blue" aria-hidden="true"></span>
              <div>
                <b>Review</b>
                <span>Reassess at 2‚Äì4 weeks if persistent symptoms; step up if needed.</span>
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="seg" aria-label="Age group">
            <button data-set="age" data-val="child" class="active" id="age_child">
              <b>Child</b><small>‚â•24 months to 11y</small>
            </button>
            <button data-set="age" data-val="adol" id="age_adol">
              <b>Adolescent</b><small>12‚Äì17y</small>
            </button>
            <button data-set="age" data-val="adult" id="age_adult">
              <b>Adult</b><small>‚â•18y</small>
            </button>
          </div>

          <div class="seg" aria-label="Severity / impact" style="margin-top:10px">
            <button data-set="sev" data-val="mild" class="active" id="sev_mild">
              <b>Mild / intermittent</b><small>No major sleep/QoL disruption</small>
            </button>
            <button data-set="sev" data-val="modsev" id="sev_modsev">
              <b>Moderate‚Äìsevere</b><small>Sleep/QoL/daily activities affected</small>
            </button>
          </div>

          <div class="seg" aria-label="Persistence" style="margin-top:10px">
            <button data-set="pers" data-val="intermittent" class="active" id="pers_int">
              <b>Intermittent</b><small>&lt;4 days/week OR &lt;4 weeks</small>
            </button>
            <button data-set="pers" data-val="persistent" id="pers_pers">
              <b>Persistent</b><small>‚â•4 days/week AND ‚â•4 weeks</small>
            </button>
          </div>

          <div class="seg" aria-label="Prominent symptoms" style="margin-top:10px">
            <button data-set="sx" data-val="mixed" class="active" id="sx_mixed">
              <b>Mixed (blocked + sneeze/itch/run)</b><small>Typical presentation</small>
            </button>
            <button data-set="sx" data-val="watery" id="sx_watery">
              <b>Watery rhinorrhoea dominant</b><small>Consider ipratropium add-on ‚â•12y</small>
            </button>
            <button data-set="sx" data-val="blockage" id="sx_block">
              <b>Severe blockage</b><small>Drops may be useful; short decongestant burst if needed</small>
            </button>
          </div>

          <div class="hr"></div>

          <div class="callout green" id="planCard">
            <div class="ico" aria-hidden="true">
              <!-- check -->
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M20 7 10 17l-4-4" stroke="rgba(235,255,245,.95)" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="txt">
              <b>Recommended next steps</b>
              <p id="planText">Loading‚Ä¶</p>
              <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                <button class="btn primary" id="copyPlan">üìã Copy plan</button>
                <button class="btn" id="pinPlan">üìå Pin to corner</button>
              </div>
            </div>
          </div>

          <div class="callout red" style="margin-top:10px">
            <div class="ico" aria-hidden="true">
              <!-- alert -->
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M12 9v4" stroke="rgba(255,230,230,.95)" stroke-width="2.4" stroke-linecap="round"/>
                <path d="M12 17h.01" stroke="rgba(255,230,230,.95)" stroke-width="3.2" stroke-linecap="round"/>
                <path d="M10.3 3.9 2.2 18a2 2 0 0 0 1.7 3h16.2a2 2 0 0 0 1.7-3L13.7 3.9a2 2 0 0 0-3.4 0Z" stroke="rgba(255,230,230,.85)" stroke-width="2"/>
              </svg>
            </div>
            <div class="txt">
              <b>Don‚Äôt miss: urgent ENT (2-week wait)</b>
              <p>Red flags: unilateral symptoms, blood-stained discharge, recurrent epistaxis, or nasal pain.</p>
            </div>
          </div>

          <div class="foot">
            <span>Hover for detail ‚Ä¢ Accordion for depth ‚Ä¢ Built for fast scanning</span>
            <span class="mono" id="stateLine">state: ‚Äî</span>
          </div>
        </div>
      </section>

      <!-- RIGHT: CONTENT -->
      <section class="panel" id="panelContent">
        <div class="hd">
          <div class="title">
            <span class="badge blue"><span aria-hidden="true">üìö</span> Clinician content</span>
            <div>
              <h2>High-yield, scannable guidance</h2>
              <p>Accordions + two-column cards. Use search to jump.</p>
            </div>
          </div>
          <span class="badge amber" title="Reminder">Review at 2‚Äì4 weeks if persistent symptoms</span>
        </div>

        <div class="bd">
          <div class="cards" id="cards">

            <!-- RED FLAGS -->
            <div class="panel" style="box-shadow:none" id="section-redflags">
              <div class="hd">
                <div class="title">
                  <span class="badge red"><span aria-hidden="true">üö©</span> Red flags</span>
                  <div>
                    <h2>ENT urgent referral triggers</h2>
                    <p>Make these visually ‚Äúloud‚Äù in your head.</p>
                  </div>
                </div>
              </div>
              <div class="bd">
                <div class="callout red">
                  <div class="ico" aria-hidden="true">üß®</div>
                  <div class="txt">
                    <b>Urgent ENT (two-week wait)</b>
                    <p><span class="badge red">Any</span> unilateral symptoms ‚Ä¢ blood-stained nasal discharge ‚Ä¢ recurrent epistaxis ‚Ä¢ nasal pain.</p>
                  </div>
                </div>

                <div class="callout amber" style="margin-top:10px">
                  <div class="ico" aria-hidden="true">üß©</div>
                  <div class="txt">
                    <b>Consider alternative/structural pathology</b>
                    <p>Unilateral symptoms are more likely another cause (e.g., polyps/foreign body/tumour/CSF leak) ‚Üí reassess diagnosis.</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- DIAGNOSIS SNAP -->
            <div class="panel" style="box-shadow:none" id="section-dx">
              <div class="hd">
                <div class="title">
                  <span class="badge blue"><span aria-hidden="true">üîé</span> Diagnosis</span>
                  <div>
                    <h2>Recognise + assess fast</h2>
                    <p>Typical pattern + exclude alternatives.</p>
                  </div>
                </div>
              </div>
              <div class="bd">
                <details open>
                  <summary>
                    <div class="left">
                      <span class="badge blue">Suspect</span>
                      <div>
                        <div class="label">Classic features</div>
                        <div class="hint">Sneezing ‚Ä¢ itch ‚Ä¢ rhinorrhoea ‚Ä¢ congestion (usually bilateral)</div>
                      </div>
                    </div>
                    <span class="chev" aria-hidden="true">‚ñæ</span>
                  </summary>
                  <div class="acc">
                    Often within minutes of allergen exposure; look for associated conjunctival symptoms and atopic history.
                  </div>
                </details>

                <details style="margin-top:10px">
                  <summary>
                    <div class="left">
                      <span class="badge amber">Assess</span>
                      <div>
                        <div class="label">Impact + triggers</div>
                        <div class="hint">Sleep/QoL ‚Ä¢ indoor/outdoor ‚Ä¢ work-related</div>
                      </div>
                    </div>
                    <span class="chev" aria-hidden="true">‚ñæ</span>
                  </summary>
                  <div class="acc">
                    Establish timing/persistence; ask about home/pets/occupation; screen for co-morbidity (asthma/eczema/sinusitis/OSA).
                  </div>
                </details>

                <details style="margin-top:10px">
                  <summary>
                    <div class="left">
                      <span class="badge blue">Investigate</span>
                      <div>
                        <div class="label">When to test</div>
                        <div class="hint">Typical history ‚Üí therapeutic trial first</div>
                      </div>
                    </div>
                    <span class="chev" aria-hidden="true">‚ñæ</span>
                  </summary>
                  <div class="acc">
                    Consider skin-prick or serum-specific IgE when diagnosis uncertain, avoidance decisions depend on confirming allergen, or refractory symptoms.
                  </div>
                </details>
              </div>
            </div>

            <!-- INITIAL MANAGEMENT -->
            <div class="panel" style="box-shadow:none" id="section-initial">
              <div class="hd">
                <div class="title">
                  <span class="badge green"><span aria-hidden="true">‚úÖ</span> Initial management</span>
                  <div>
                    <h2>First-line (fast choice)</h2>
                    <p>Pick the simplest effective option.</p>
                  </div>
                </div>
              </div>

              <div class="bd">
                <div class="twocol">
                  <div class="callout green">
                    <div class="ico" aria-hidden="true">üíä</div>
                    <div class="txt">
                      <b>Most effective: intranasal corticosteroid</b>
                      <p>Onset ~6‚Äì8 hours after first dose; maximal effect may take ~2 weeks. Don‚Äôt exceed prescribed dose; preparations have comparable efficacy.</p>
                    </div>
                  </div>
                  <div class="callout green">
                    <div class="ico" aria-hidden="true">‚ö°</div>
                    <div class="txt">
                      <b>Fastest onset: intranasal antihistamine</b>
                      <p>Works within minutes but less effective than intranasal corticosteroid for overall control.</p>
                    </div>
                  </div>
                </div>

                <div class="hr"></div>

                <details open>
                  <summary>
                    <div class="left">
                      <span class="badge green">Mild / intermittent</span>
                      <div>
                        <div class="label">Default approach</div>
                        <div class="hint">Child: antihistamine; Adult/adolescent: any first-line</div>
                      </div>
                    </div>
                    <span class="chev" aria-hidden="true">‚ñæ</span>
                  </summary>
                  <div class="acc">
                    Children: suggest intranasal or oral non-sedating antihistamine. Adolescents/adults: intranasal or oral non-sedating antihistamine, or intranasal corticosteroid, or combinations per preference.
                  </div>
                </details>

                <details style="margin-top:10px">
                  <summary>
                    <div class="left">
                      <span class="badge green">Moderate‚Äìsevere / persistent</span>
                      <div>
                        <div class="label">Default approach</div>
                        <div class="hint">Intranasal steroid ¬± intranasal antihistamine</div>
                      </div>
                    </div>
                    <span class="chev" aria-hidden="true">‚ñæ</span>
                  </summary>
                  <div class="acc">
                    Prefer regularly prescribed intranasal corticosteroid; consider combined intranasal corticosteroid + intranasal antihistamine for better efficacy than steroid alone.
                  </div>
                </details>

                <details style="margin-top:10px">
                  <summary>
                    <div class="left">
                      <span class="badge blue">Course timing</span>
                      <div>
                        <div class="label">When to stop / restart</div>
                        <div class="hint">Step down if no exposure; restart pre-season</div>
                      </div>
                    </div>
                    <span class="chev" aria-hidden="true">‚ñæ</span>
                  </summary>
                  <div class="acc">
                    If intermittent with no ongoing exposure, step down and stop. If recurrent episodes controlled by intranasal steroid, restart ~2 weeks before expected re-exposure (or several weeks before if timing uncertain).
                  </div>
                </details>

                <div class="callout amber" style="margin-top:10px">
                  <div class="ico" aria-hidden="true">üëÅÔ∏è</div>
                  <div class="txt">
                    <b>Eye symptoms?</b>
                    <p>Use antihistamine eye drops or chromone eye drops (e.g., sodium cromoglycate, nedocromil).</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- FAILURE / STEP UP -->
            <div class="panel" style="box-shadow:none" id="section-stepup">
              <div class="hd">
                <div class="title">
                  <span class="badge amber"><span aria-hidden="true">üß±</span> Treatment failure</span>
                  <div>
                    <h2>Step-up (high-yield)</h2>
                    <p>Fix technique/compliance first.</p>
                  </div>
                </div>
              </div>

              <div class="bd">
                <div class="callout amber">
                  <div class="ico" aria-hidden="true">üß†</div>
                  <div class="txt">
                    <b>Before escalating</b>
                    <p>Check adherence + intranasal spray/drop technique; reconsider diagnosis/non-allergic triggers; assess co-morbidity.</p>
                  </div>
                </div>

                <div class="list" aria-label="Step-up options">
                  <div class="li">
                    <div class="mark amber" aria-hidden="true">‚ûï</div>
                    <div>
                      <b>Severe congestion</b>
                      <span>Add short-term intranasal decongestant (e.g., xylometazoline) for up to <span class="badge amber">5‚Äì7 days</span>.</span>
                    </div>
                  </div>
                  <div class="li">
                    <div class="mark blue" aria-hidden="true">üíß</div>
                    <div>
                      <b>Persistent watery rhinorrhoea</b>
                      <span>Despite intranasal corticosteroid + oral antihistamine: add intranasal anticholinergic (ipratropium) in adults or ‚â•12y.</span>
                    </div>
                  </div>
                  <div class="li">
                    <div class="mark green" aria-hidden="true">üéØ</div>
                    <div>
                      <b>Persistent itch/sneeze</b>
                      <span>Use oral antihistamine regularly (not PRN), or prescribe combined intranasal corticosteroid + antihistamine spray if monotherapy ineffective.</span>
                    </div>
                  </div>
                  <div class="li">
                    <div class="mark green" aria-hidden="true">ü´Å</div>
                    <div>
                      <b>Co-existent asthma + ongoing symptoms</b>
                      <span>Consider leukotriene receptor antagonist (montelukast) as add-on to an oral or intranasal antihistamine.</span>
                    </div>
                  </div>
                  <div class="li">
                    <div class="mark red" aria-hidden="true">‚ö†Ô∏è</div>
                    <div>
                      <b>Adult severe uncontrolled QoL impact</b>
                      <span>Consider short oral corticosteroid burst for rapid relief: prednisolone <span class="badge red">0.5 mg/kg</span> morning for <span class="badge red">5‚Äì10 days</span>. (Children: seek specialist advice if considering oral steroids.)</span>
                    </div>
                  </div>
                </div>

                <div class="callout red" style="margin-top:10px">
                  <div class="ico" aria-hidden="true">‚õî</div>
                  <div class="txt">
                    <b>Avoid</b>
                    <p>Combined use of intranasal <em>and</em> oral antihistamine is not recommended.</p>
                  </div>
                </div>

                <div class="callout green" style="margin-top:10px">
                  <div class="ico" aria-hidden="true">üìÖ</div>
                  <div class="txt">
                    <b>Review cadence</b>
                    <p>If symptoms persist after initial treatment, review at <span class="badge amber">2‚Äì4 weeks</span> and step up as needed.</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- REFERRAL -->
            <div class="panel" style="box-shadow:none" id="section-referral">
              <div class="hd">
                <div class="title">
                  <span class="badge red"><span aria-hidden="true">üè•</span> Referral</span>
                  <div>
                    <h2>Who to refer + where</h2>
                    <p>Make referral decisions obvious.</p>
                  </div>
                </div>
              </div>
              <div class="bd">
                <div class="list">
                  <div class="li">
                    <div class="mark red" aria-hidden="true">üö®</div>
                    <div>
                      <b>Urgent ENT (2-week wait)</b>
                      <span>Unilateral symptoms, blood-stained discharge, recurrent epistaxis, or nasal pain.</span>
                    </div>
                  </div>
                  <div class="li">
                    <div class="mark amber" aria-hidden="true">üß±</div>
                    <div>
                      <b>ENT (routine)</b>
                      <span>Predominant obstruction or structural abnormality (e.g., deviated septum) making intranasal therapy difficult.</span>
                    </div>
                  </div>
                  <div class="li">
                    <div class="mark blue" aria-hidden="true">üß¨</div>
                    <div>
                      <b>Allergy specialist</b>
                      <span>Persistent symptoms despite optimal primary care; allergy testing needed for avoidance decisions; patient wants immunotherapy; diagnosis uncertain (choose allergy vs ENT clinically).</span>
                    </div>
                  </div>
                </div>

                <details style="margin-top:10px">
                  <summary>
                    <div class="left">
                      <span class="badge blue">Immunotherapy</span>
                      <div>
                        <div class="label">Who benefits</div>
                        <div class="hint">One dominant allergen + objective IgE sensitisation</div>
                      </div>
                    </div>
                    <span class="chev" aria-hidden="true">‚ñæ</span>
                  </summary>
                  <div class="acc">
                    Consider when symptoms track allergen exposure, IgE sensitivity is confirmed, and symptoms persist despite optimal pharmacotherapy. Options include SCIT or SLIT (typically multi-year courses).
                  </div>
                </details>
              </div>
            </div>

            <!-- PRESCRIBING: DOSES -->
            <div class="panel" style="box-shadow:none" id="section-doses">
              <div class="hd">
                <div class="title">
                  <span class="badge green"><span aria-hidden="true">üßæ</span> Doses</span>
                  <div>
                    <h2>Intranasal steroid + combo spray quick doses</h2>
                    <p>Keep this as a prescribing aide-m√©moire.</p>
                  </div>
                </div>
              </div>

              <div class="bd">
                <details open>
                  <summary>
                    <div class="left">
                      <span class="badge green">Intranasal corticosteroids</span>
                      <div>
                        <div class="label">Low systemic absorption options</div>
                        <div class="hint">Mometasone / fluticasone propionate / fluticasone furoate</div>
                      </div>
                    </div>
                    <span class="chev" aria-hidden="true">‚ñæ</span>
                  </summary>
                  <div class="acc">
                    <div class="list">
                      <div class="li">
                        <div class="mark green" aria-hidden="true">M</div>
                        <div>
                          <b>Mometasone intranasal spray</b>
                          <span>3‚Äì11y: 50 micrograms OD into each nostril. ‚â•12y/adult: 100 micrograms OD into each nostril; if needed up to 200 micrograms OD, then reduce when controlled. (1 spray = 50 micrograms)</span>
                        </div>
                      </div>
                      <div class="li">
                        <div class="mark green" aria-hidden="true">FP</div>
                        <div>
                          <b>Fluticasone propionate nasal spray</b>
                          <span>4‚Äì11y: 50 micrograms OD each nostril; if needed 50 micrograms BD. ‚â•12y/adult: 100 micrograms OD each nostril; if needed 100 micrograms BD; once controlled reduce to 50 micrograms OD each nostril. (1 spray = 50 micrograms)</span>
                        </div>
                      </div>
                      <div class="li">
                        <div class="mark green" aria-hidden="true">FF</div>
                        <div>
                          <b>Fluticasone furoate intranasal spray</b>
                          <span>6‚Äì11y: 27.5 micrograms OD each nostril; if needed 55 micrograms OD; then reduce to minimum effective. ‚â•12y/adult: 55 micrograms OD each nostril; reduce to 27.5 micrograms OD when controlled. (1 spray = 27.5 micrograms)</span>
                        </div>
                      </div>
                    </div>

                    <div class="callout amber" style="margin-top:10px">
                      <div class="ico" aria-hidden="true">üõë</div>
                      <div class="txt">
                        <b>Contraindications/cautions (headline)</b>
                        <p>Do not use with recent nasal surgery, untreated nasal infection, or pulmonary TB; use caution with immunosuppression/high-dose or prolonged courses; monitor growth in children on prolonged therapy.</p>
                      </div>
                    </div>
                  </div>
                </details>

                <details style="margin-top:10px">
                  <summary>
                    <div class="left">
                      <span class="badge green">Combined intranasal steroid + antihistamine</span>
                      <div>
                        <div class="label">Moderate‚Äìsevere AR (UK options)</div>
                        <div class="hint">Dymista / Ryaltris (‚â•12y & adults)</div>
                      </div>
                    </div>
                    <span class="chev" aria-hidden="true">‚ñæ</span>
                  </summary>
                  <div class="acc">
                    <div class="list">
                      <div class="li">
                        <div class="mark green" aria-hidden="true">Dy</div>
                        <div>
                          <b>Dymista¬Æ (azelastine + fluticasone propionate)</b>
                          <span>‚â•12y/adult: 1 spray <span class="badge green">BD</span> into each nostril.</span>
                        </div>
                      </div>
                      <div class="li">
                        <div class="mark green" aria-hidden="true">Ry</div>
                        <div>
                          <b>Ryaltris¬Æ (olopatadine + mometasone)</b>
                          <span>‚â•12y/adult: 2 sprays <span class="badge green">BD</span> into each nostril.</span>
                        </div>
                      </div>
                    </div>
                    <div class="callout red" style="margin-top:10px">
                      <div class="ico" aria-hidden="true">‚ö†Ô∏è</div>
                      <div class="txt">
                        <b>Headline contraindications</b>
                        <p>Hypersensitivity, untreated nasal infection, recent nasal surgery/trauma, TB.</p>
                      </div>
                    </div>
                  </div>
                </details>
              </div>
            </div>

            <!-- TECHNIQUE + SELF-CARE -->
            <div class="panel" style="box-shadow:none" id="section-technique">
              <div class="hd">
                <div class="title">
                  <span class="badge blue"><span aria-hidden="true">üß¥</span> Technique & self-care</span>
                  <div>
                    <h2>High-yield adherence multipliers</h2>
                    <p>Fix these before ‚Äúfailing treatment‚Äù.</p>
                  </div>
                </div>
              </div>

              <div class="bd">
                <details open>
                  <summary>
                    <div class="left">
                      <span class="badge blue">Nasal spray technique</span>
                      <div>
                        <div class="label">Aim outwards; don‚Äôt sniff</div>
                        <div class="hint">Quick steps clinicians can teach in 30 seconds</div>
                      </div>
                    </div>
                    <span class="chev" aria-hidden="true">‚ñæ</span>
                  </summary>
                  <div class="acc">
                    <ol class="muted" style="margin:8px 0 0 18px; padding:0">
                      <li>Shake, look down.</li>
                      <li>Right hand ‚Üí left nostril; aim nozzle towards the lateral wall (not septum).</li>
                      <li>Spray while breathing in gently; <b>do not sniff</b>.</li>
                      <li>Swap hands; repeat other side.</li>
                    </ol>
                  </div>
                </details>

                <details style="margin-top:10px">
                  <summary>
                    <div class="left">
                      <span class="badge blue">Nasal drops</span>
                      <div>
                        <div class="label">Useful if severe obstruction</div>
                        <div class="hint">Higher misadministration risk</div>
                      </div>
                    </div>
                    <span class="chev" aria-hidden="true">‚ñæ</span>
                  </summary>
                  <div class="acc">
                    Blow nose gently ‚Üí shake ‚Üí head back ‚Üí instil drops ‚Üí keep head tilted; sniff gently to let drops penetrate ‚Üí repeat other side if required.
                  </div>
                </details>

                <details style="margin-top:10px">
                  <summary>
                    <div class="left">
                      <span class="badge green">Saline irrigation</span>
                      <div>
                        <div class="label">Low-risk adjunct</div>
                        <div class="hint">Spray/pump/squirt bottle OTC</div>
                      </div>
                    </div>
                    <span class="chev" aria-hidden="true">‚ñæ</span>
                  </summary>
                  <div class="acc">
                    Consider saline irrigation to rinse the nasal cavity; can improve symptom burden and reduce mucosal irritant load.
                  </div>
                </details>

                <details style="margin-top:10px">
                  <summary>
                    <div class="left">
                      <span class="badge amber">Avoidance (targeted)</span>
                      <div>
                        <div class="label">Only when a culprit allergen is plausible/confirmed</div>
                        <div class="hint">Pollen / HDM / animal / occupational</div>
                      </div>
                    </div>
                    <span class="chev" aria-hidden="true">‚ñæ</span>
                  </summary>
                  <div class="acc">
                    Pollen: minimise high-count exposure; keep windows closed; shower after exposure; consider wraparound sunglasses/masks.
                    HDM/animal/occupational: consider allergy confirmation if significant lifestyle changes are proposed.
                  </div>
                </details>
              </div>
            </div>

          </div>

          <div class="foot">
            <span>Content derived from NICE CKS allergic rhinitis topic (last revised Jan 2024).</span>
            <span class="mono">Local-only ‚Ä¢ No network calls ‚Ä¢ Your browser stores selections</span>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Quick plan drawer -->
  <div class="stickyNote hidden" id="drawer" role="dialog" aria-label="Quick plan">
    <div class="hd">
      <b>‚ö° Quick plan (copy/paste)</b>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="btn" id="copyDrawer">üìã Copy</button>
        <button class="btn" id="closeDrawer">‚úï</button>
      </div>
    </div>
    <div class="bd">
      <div class="mini" id="miniBadges"></div>
      <div class="rec" id="drawerText"></div>
      <div class="hr"></div>
      <div class="muted" style="font-size:11.5px">
        Tip: click a badge to jump to the relevant section.
      </div>
    </div>
  </div>

  <script>
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    const state = {
      age: "child",        // child | adol | adult
      sev: "mild",         // mild | modsev
      pers: "intermittent",// intermittent | persistent
      sx: "mixed",         // mixed | watery | blockage
      pinned: false
    };

    const LS_KEY = "ar_rapid_guide_state_v1";

    function iconSVG(name){
      const map = {
        red: "üö©",
        green: "‚úÖ",
        amber: "üß±",
        blue: "üîé",
        rx: "üíä",
        fast: "‚ö°",
        review: "üìÖ",
        refer: "üè•",
        avoid: "üß¥"
      };
      return map[name] || "‚Ä¢";
    }

    function saveState(){
      const payload = {...state, savedAt: new Date().toISOString()};
      localStorage.setItem(LS_KEY, JSON.stringify(payload));
      const d = new Date();
      $("#lastSaved").textContent = "Saved: " + d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return;
        const parsed = JSON.parse(raw);
        ["age","sev","pers","sx","pinned"].forEach(k=>{
          if(parsed[k] !== undefined) state[k] = parsed[k];
        });
        if(parsed.savedAt){
          const d = new Date(parsed.savedAt);
          $("#lastSaved").textContent = "Saved: " + d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
        }
      }catch(e){}
    }

    function setActiveButtons(){
      $$("button[data-set]").forEach(btn=>{
        const key = btn.dataset.set;
        const val = btn.dataset.val;
        btn.classList.toggle("active", state[key] === val);
      });
      $("#stateLine").textContent = `state: age=${state.age} ‚Ä¢ severity=${state.sev} ‚Ä¢ persistence=${state.pers} ‚Ä¢ sx=${state.sx}`;
    }

    function plan(){
      // Red flags always shown separately; plan focuses on management.
      const bits = [];

      // Baseline: self-care + saline irrigation (optional)
      bits.push(`Start with targeted self-management (trigger review, consider saline irrigation; teach spray technique).`);

      // First-line selection by severity/age
      if(state.sev === "mild"){
        if(state.age === "child"){
          bits.push(`First-line: intranasal OR oral non-sedating antihistamine.`);
        } else {
          bits.push(`First-line: any of intranasal corticosteroid OR intranasal/oral non-sedating antihistamine (patient preference).`);
        }
      } else { // modsev
        bits.push(`First-line: intranasal corticosteroid (regular). Consider combined intranasal corticosteroid + intranasal antihistamine if control inadequate.`);
        bits.push(`Counsel: onset ~6‚Äì8 h; maximal effect may take ~2 weeks; avoid dose escalation beyond prescribed; preparations broadly comparable.`);
        if(state.sx === "blockage"){
          bits.push(`If severe obstruction: consider nasal drops formulation/technique support.`);
        }
      }

      // Persistence guidance
      if(state.pers === "persistent"){
        bits.push(`Persistent pattern: prefer regular intranasal corticosteroid (rather than PRN).`);
        bits.push(`Review at 2‚Äì4 weeks; step up if symptoms persist.`);
      } else {
        bits.push(`Intermittent pattern: step down and stop once exposure ceases and symptoms controlled.`);
      }

      // Symptom-specific add-ons (step-up)
      if(state.sx === "watery"){
        bits.push(`If watery rhinorrhoea persists despite intranasal corticosteroid + oral antihistamine: add intranasal ipratropium (adults / ‚â•12y).`);
      }
      if(state.sx === "blockage"){
        bits.push(`If sudden/severe congestion: short intranasal decongestant burst (e.g., xylometazoline) up to 5‚Äì7 days.`);
      }

      // Seasonal/pre-exposure strategy
      bits.push(`If recurrent seasonal episodes: restart intranasal corticosteroid ~2 weeks before expected re-exposure (earlier if timing uncertain).`);

      return bits;
    }

    function buildPlanText(){
      const bits = plan();

      // Highlight key action phrases with lightweight markup (no dense text walls)
      const toBullets = (arr) => arr.map(t => `‚Ä¢ ${t}`).join("\n");

      $("#planText").textContent = toBullets(bits);

      // Drawer
      $("#drawerText").textContent =
        toBullets(bits) +
        "\n\n‚Äî Escalation/referral ‚Äî\n" +
        "‚Ä¢ If red flags: urgent ENT (2-week wait): unilateral symptoms / blood-stained discharge / recurrent epistaxis / nasal pain.\n" +
        "‚Ä¢ If persistent symptoms despite optimal primary care: consider allergy specialist (testing ¬± immunotherapy) / ENT depending on presentation.\n";
    }

    function buildMiniBadges(){
      const badges = [];
      badges.push({label:"Red flags", cls:"red", jump:"#section-redflags"});
      badges.push({label:"Dx", cls:"blue", jump:"#section-dx"});
      badges.push({label:"First-line", cls:"green", jump:"#section-initial"});
      badges.push({label:"Step-up", cls:"amber", jump:"#section-stepup"});
      badges.push({label:"Referral", cls:"red", jump:"#section-referral"});
      badges.push({label:"Doses", cls:"green", jump:"#section-doses"});
      badges.push({label:"Technique", cls:"blue", jump:"#section-technique"});

      const box = $("#miniBadges");
      box.innerHTML = "";
      badges.forEach(b=>{
        const el = document.createElement("span");
        el.className = `badge ${b.cls}`;
        el.textContent = b.label;
        el.title = "Jump";
        el.addEventListener("click", ()=>{
          closeDrawer();
          document.querySelector(b.jump)?.scrollIntoView({behavior:"smooth", block:"start"});
        });
        box.appendChild(el);
      });
    }

    function openDrawer(){
      $("#drawer").classList.remove("hidden");
      $("#drawer").scrollIntoView({behavior:"smooth", block:"end"});
    }
    function closeDrawer(){
      $("#drawer").classList.add("hidden");
    }

    function copyText(txt){
      navigator.clipboard.writeText(txt).catch(()=>{
        // fallback
        const ta = document.createElement("textarea");
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
      });
    }

    function getPlanForClipboard(){
      return [
        "Allergic rhinitis ‚Äî rapid plan",
        `Age: ${state.age} | Severity: ${state.sev} | Persistence: ${state.pers} | Symptom focus: ${state.sx}`,
        "",
        plan().map(x => `- ${x}`).join("\n"),
        "",
        "Escalation/referral:",
        "- Red flags ‚Üí urgent ENT (2-week wait): unilateral symptoms / blood-stained discharge / recurrent epistaxis / nasal pain.",
        "- Persistent symptoms despite optimal management ‚Üí consider allergy specialist / ENT depending on presentation.",
      ].join("\n");
    }

    function applySearch(){
      const q = $("#q").value.trim().toLowerCase();
      const nodes = $$("#panelContent details, #panelContent .callout, #panelContent .li, #panelContent .hd h2, #panelContent .hd p");
      if(!q){
        nodes.forEach(n=> n.style.outline = "none");
        return;
      }
      nodes.forEach(n=>{
        const text = n.textContent.toLowerCase();
        if(text.includes(q)){
          n.style.outline = "2px solid rgba(106,168,255,.55)";
          n.style.outlineOffset = "3px";
        }else{
          n.style.outline = "none";
        }
      });
    }

    function bindUI(){
      // Segmented controls
      $$("button[data-set]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          state[btn.dataset.set] = btn.dataset.val;
          setActiveButtons();
          buildPlanText();
          saveState();
        });
      });

      // Top actions
      $("#btnRedFlags").addEventListener("click", ()=>{
        $("#section-redflags").scrollIntoView({behavior:"smooth", block:"start"});
      });
      $("#btnQuickPlan").addEventListener("click", ()=>{
        buildMiniBadges();
        openDrawer();
      });
      $("#btnPrint").addEventListener("click", ()=> window.print());
      $("#btnReset").addEventListener("click", ()=>{
        state.age="child"; state.sev="mild"; state.pers="intermittent"; state.sx="mixed"; state.pinned=false;
        setActiveButtons(); buildPlanText(); saveState();
        closeDrawer();
      });

      // Plan card actions
      $("#copyPlan").addEventListener("click", ()=> copyText(getPlanForClipboard()));
      $("#pinPlan").addEventListener("click", ()=>{
        buildMiniBadges();
        $("#drawer").classList.remove("hidden");
        state.pinned = true;
        saveState();
      });

      // Drawer actions
      $("#closeDrawer").addEventListener("click", ()=>{
        closeDrawer();
        state.pinned = false;
        saveState();
      });
      $("#copyDrawer").addEventListener("click", ()=> copyText(getPlanForClipboard()));

      // Search
      $("#q").addEventListener("input", applySearch);

      // KPI jump
      $("#kpiRed").addEventListener("click", ()=>{
        $("#section-redflags").scrollIntoView({behavior:"smooth", block:"start"});
      });
    }

    function init(){
      loadState();
      setActiveButtons();
      buildPlanText();
      buildMiniBadges();
      bindUI();

      if(state.pinned){
        $("#drawer").classList.remove("hidden");
      }
    }

    init();
  </script>
</body>
</html>
