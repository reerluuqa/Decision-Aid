<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GP Psychosocial + SCA Services — Revision App (Offline)</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#101a33;
      --panel2:#0f1730;
      --card:#121f3f;
      --muted:#9fb0d0;
      --text:#e8eeff;
      --accent:#7aa7ff;
      --accent2:#69e3c1;
      --danger:#ff6b7a;
      --warn:#ffd36a;
      --ok:#7dff9a;
      --border:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 15% 10%, rgba(122,167,255,.18), transparent 60%),
                  radial-gradient(1200px 800px at 90% 20%, rgba(105,227,193,.14), transparent 55%),
                  radial-gradient(1000px 700px at 70% 90%, rgba(255,211,106,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family:var(--sans);
      line-height:1.35;
      overflow:hidden;
    }
    a{color:inherit}
    .app{
      display:grid;
      grid-template-columns: 320px 1fr;
      height:100vh;
      gap:16px;
      padding:16px;
    }
    .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .sideTop{
      padding:16px 16px 10px 16px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(122,167,255,.85), rgba(105,227,193,.75));
      box-shadow: 0 10px 25px rgba(0,0,0,.3);
    }
    .brand h1{
      font-size:15px;
      margin:0;
      letter-spacing:.2px;
    }
    .brand .sub{
      font-size:12px;color:var(--muted);
      margin-top:2px;
    }
    .searchWrap{display:flex; gap:8px; align-items:center;}
    .search{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    .search:focus{border-color: rgba(122,167,255,.55); box-shadow:0 0 0 3px rgba(122,167,255,.12);}
    .pillRow{
      display:flex; flex-wrap:wrap; gap:8px;
      padding:10px 0 0 0;
    }
    .pill{
      border:1px solid var(--border);
      background: rgba(0,0,0,.14);
      color:var(--muted);
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition:.15s ease;
    }
    .pill:hover{transform:translateY(-1px); color:var(--text); border-color:rgba(255,255,255,.2)}
    .pill.active{color:var(--text); border-color:rgba(122,167,255,.55); background:rgba(122,167,255,.10)}
    .nav{
      padding:10px;
      overflow:auto;
      min-height:0;
    }
    .navBtn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 12px;
      margin:6px 0;
      border-radius:14px;
      border:1px solid transparent;
      background: transparent;
      color:var(--text);
      cursor:pointer;
      text-align:left;
      transition:.15s ease;
    }
    .navBtn:hover{background:rgba(255,255,255,.04); border-color:rgba(255,255,255,.08)}
    .navBtn.active{background:rgba(122,167,255,.10); border-color:rgba(122,167,255,.30)}
    .navBtn .meta{
      display:flex; flex-direction:column; gap:2px;
    }
    .navBtn .t{font-size:13px}
    .navBtn .d{font-size:12px; color:var(--muted)}
    .badge{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--border);
      padding:4px 8px;
      border-radius:999px;
      background: rgba(0,0,0,.14);
    }
    .sideBottom{
      padding:12px 14px;
      border-top:1px solid var(--border);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      background: rgba(0,0,0,.10);
    }
    .miniBtn{
      border:1px solid var(--border);
      background: rgba(0,0,0,.14);
      color:var(--text);
      padding:10px 10px;
      border-radius:14px;
      cursor:pointer;
      transition:.15s ease;
      font-size:12px;
    }
    .miniBtn:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.2)}
    .main{
      min-height:0;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .topBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:16px;
      border-radius:var(--radius2);
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.08));
      box-shadow:var(--shadow);
    }
    .topTitle h2{margin:0;font-size:16px}
    .topTitle p{margin:6px 0 0 0;color:var(--muted);font-size:12px}
    .topActions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--border);
      background: rgba(0,0,0,.14);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:.15s ease;
      font-size:12px;
    }
    .btn:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.2)}
    .btn.primary{border-color:rgba(122,167,255,.55); background:rgba(122,167,255,.12)}
    .btn.good{border-color:rgba(105,227,193,.55); background:rgba(105,227,193,.10)}
    .btn.warn{border-color:rgba(255,211,106,.55); background:rgba(255,211,106,.10)}
    .btn.danger{border-color:rgba(255,107,122,.55); background:rgba(255,107,122,.12)}
    .content{
      min-height:0;
      overflow:auto;
      padding:0;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
      padding:0 2px 2px 2px;
    }
    .card{
      grid-column: span 12;
      border:1px solid var(--border);
      border-radius:var(--radius2);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.12));
      box-shadow:var(--shadow);
      padding:16px;
      overflow:hidden;
    }
    .card h3{margin:0 0 8px 0;font-size:15px}
    .card p{margin:0;color:var(--muted);font-size:13px}
    .split{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      align-items:start;
    }
    .panel{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background: rgba(0,0,0,.14);
      padding:14px;
    }
    .panel h4{margin:0 0 10px 0;font-size:13px;color:var(--text)}
    .kvs{
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .kv{
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      background: rgba(0,0,0,.12);
    }
    .list{margin:0; padding-left:18px; color:var(--text)}
    .list li{margin:6px 0; color:var(--text)}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .hr{
      height:1px; background:var(--border);
      margin:12px 0;
    }
    .callout{
      border:1px solid rgba(122,167,255,.35);
      background: rgba(122,167,255,.10);
      padding:12px 12px;
      border-radius:14px;
      color:var(--text);
      font-size:13px;
    }
    .callout .label{font-size:12px; color:var(--muted); margin-bottom:6px}
    .tagRow{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    .tag{
      font-size:12px;
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.12);
      color:var(--muted);
      cursor:pointer;
      transition:.15s ease;
      user-select:none;
    }
    .tag:hover{transform:translateY(-1px); color:var(--text); border-color:rgba(255,255,255,.2)}
    .tag.active{border-color:rgba(105,227,193,.55); background:rgba(105,227,193,.10); color:var(--text)}
    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .note{
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.12);
      border-radius:14px;
      padding:12px;
      color:var(--muted);
      font-size:12px;
    }
    .flash{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .flashQ{
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-size:14px;
    }
    .flashA{
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(105,227,193,.30);
      background: rgba(105,227,193,.10);
      display:none;
      font-size:13px;
    }
    .flashA.show{display:block}
    .rateRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .small{font-size:12px;color:var(--muted)}
    .kbd{
      font-family:var(--mono);
      padding:2px 6px;
      border-radius:8px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.16);
      color:var(--text);
      font-size:12px;
    }
    .toast{
      position:fixed;
      right:16px;
      bottom:16px;
      max-width:380px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      box-shadow:var(--shadow);
      color:var(--text);
      display:none;
      z-index:9999;
    }
    .toast.show{display:block}
    @media (max-width: 980px){
      body{overflow:auto}
      .app{grid-template-columns:1fr; height:auto; overflow:visible}
      .main{overflow:visible}
      .content{overflow:visible}
    }
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="sideTop">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>GP Psychosocial + SCA Services</h1>
          <div class="sub">Offline revision app • fast recall → scripts → phrases</div>
        </div>
      </div>
      <div class="searchWrap">
        <input id="search" class="search" placeholder="Search: e.g. social prescriber, CAMHS, MARAC, DNACPR…" />
      </div>
      <div class="pillRow" id="quickFilters"></div>
    </div>

    <nav class="nav" id="nav"></nav>

    <div class="sideBottom">
      <button class="miniBtn" id="resetProgress">Reset progress</button>
      <button class="miniBtn" id="exportProgress">Export JSON</button>
      <button class="miniBtn" id="importProgress">Import JSON</button>
      <button class="miniBtn" id="copyCheats">Copy cheat line</button>
    </div>
  </aside>

  <main class="main">
    <header class="topBar">
      <div class="topTitle">
        <h2 id="pageTitle">Home</h2>
        <p id="pageDesc">A structured, exam-facing way to recall psychosocial management and “expected services” in GP SCA-style stations.</p>
      </div>
      <div class="topActions">
        <button class="btn primary" id="btnRapid">Rapid Recall</button>
        <button class="btn good" id="btnShowAnswer">Show Answer</button>
        <button class="btn warn" id="btnNextCard">Next Card</button>
        <button class="btn danger" id="btnHardReset">Hard reset app</button>
      </div>
    </header>

    <section class="content" id="content"></section>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
/* =========================
   DATA (from your sources’ structures)
   ========================= */

const DATA = {
  meta: {
    title: "GP Psychosocial + SCA Services (Offline)",
    version: "1.0",
    focus: [
      "Master services map (10 domains)",
      "8 exam-ready psychosocial scripts",
      "High-scoring, non-rehearsed SCA phrases",
      "Rapid recall flashcards + simple spaced repetition"
    ],
    shortcuts: [
      {k:"/", d:"Focus search"},
      {k:"N", d:"Next card"},
      {k:"A", d:"Toggle answer"},
      {k:"1/2/3", d:"Rate: Again / Good / Easy (Rapid mode)"}
    ]
  },

  quickFilters: [
    { key:"safeguarding", label:"Safeguarding" },
    { key:"mental-health", label:"Mental Health" },
    { key:"social", label:"Social Prescribing" },
    { key:"women", label:"Women’s Health" },
    { key:"paeds", label:"Paediatrics" },
    { key:"palliative", label:"Palliative" },
    { key:"sexual-health", label:"Sexual Health" },
    { key:"red-flags", label:"Red Flags" },
  ],

  pages: [
    { id:"home", title:"Home", desc:"How to use the app to score reliably in psychosocial + SCA management.", badge:"Start" },
    { id:"services", title:"Master Services Map", desc:"10 domains → ‘expected services’ + exam phrase triggers.", badge:"10" },
    { id:"scripts", title:"8 Referral Scripts", desc:"Patient-friendly, exam-safe language for core psychosocial referrals.", badge:"8" },
    { id:"phrases", title:"Phrase Bank", desc:"High-yield phrases that rescue borderline stations.", badge:"12" },
    { id:"checklist", title:"Consultation Checklist", desc:"A one-page cognitive scaffold (biopsychosocial + safety net + follow-up).", badge:"1" },
    { id:"flashcards", title:"Flashcards", desc:"Browse deck; use Rapid Recall for spaced repetition.", badge:"Deck" },
    { id:"drills", title:"Station Drills", desc:"Timer + prompts; practise ‘bridge → service → collaborative plan’.", badge:"Train" },
  ],

  servicesMap: [
    {
      id:"acute",
      title:"1. Acute / Red-Flag Medical Presentations",
      tags:["red-flags"],
      summary:"Bleeding, chest pain, neuro deficit, cancer suspicion → urgent pathways.",
      stations:["Bleeding in pregnancy","Chest pain","Haematuria","Neuro symptoms","Cancer suspicion: weight loss, jaundice, PR bleed, haemoptysis","Syncope","Severe headache"],
      expectedServices:[
        "Same-day secondary care referral",
        "EPAU (early pregnancy assessment unit)",
        "Acute medical unit / ED",
        "2WW cancer pathway",
        "Relevant specialty: haematology/oncology, neurology, gastroenterology, urology",
        "Urgent diagnostics: USS/CT/MRI via pathway"
      ],
      examPhrase:"Given the red-flag features, this needs urgent secondary care assessment under the appropriate pathway."
    },
    {
      id:"chronic",
      title:"2. Chronic Disease Management",
      tags:["social","mental-health"],
      summary:"Long-term conditions → structured reviews + MDT (often overlooked psychosocial burden).",
      stations:["COPD/asthma","Diabetes/CKD","Heart failure","Hypertension","Multimorbidity/polypharmacy","Frailty"],
      expectedServices:[
        "Practice nurse chronic disease review",
        "Clinical pharmacist medication review / inhaler technique",
        "Pulmonary rehab / respiratory team (where appropriate)",
        "Allied health: podiatry (diabetes), dietitian, physiotherapy",
        "Routine secondary care follow-up if indicated",
        "Social prescriber where function/finances/housing worsen control"
      ],
      examPhrase:"Alongside optimising the medical plan, I want to reduce the day-to-day burden, so we involve the right MDT support."
    },
    {
      id:"mh_adult",
      title:"3. Mental Health – Adult",
      tags:["mental-health"],
      summary:"Anxiety/depression/self-harm/psychosis → risk, capacity, and stepped care.",
      stations:["Depression","Anxiety/panic","Self-harm/ideation","Psychosis/mania","PTSD/trauma","Substance misuse","Somatisation"],
      expectedServices:[
        "NHS Talking Therapies (IAPT) / CBT (mild–moderate)",
        "Community mental health team (complex/severe)",
        "Crisis Resolution/Home Treatment (same-day if acute risk)",
        "Perinatal MH team (pregnancy to 1 year postpartum)",
        "Addiction services (alcohol/drugs; include gambling where relevant)",
        "Bereavement support (e.g., Cruse) when indicated"
      ],
      examPhrase:"Psychological support isn’t about ‘there’s something wrong’—it’s about coping better; I wouldn’t want you dealing with this alone."
    },
    {
      id:"mh_camhs",
      title:"4. Mental Health – Child & Adolescent (CAMHS)",
      tags:["mental-health","paeds"],
      summary:"Young person risk/functional decline → CAMHS/urgent pathways + family support.",
      stations:["Depression/anxiety in teen","Self-harm","Eating disorder","First-episode psychosis","Neurodevelopment concerns","School refusal/bullying impact"],
      expectedServices:[
        "CAMHS referral (routine vs urgent depending on risk)",
        "Same-day CAMHS/crisis input if high risk",
        "School nursing / pastoral team liaison (where appropriate)",
        "Safeguarding / social care when risk to child",
        "Family support services / parenting programmes"
      ],
      examPhrase:"Because of your age and the changes you’re describing, specialist input today is the safest option—this isn’t something I’d want to sit on."
    },
    {
      id:"safeguarding",
      title:"5. Safeguarding & Domestic Abuse",
      tags:["safeguarding"],
      summary:"Frame as support (not policing). Escalate appropriately (children/vulnerable adults).",
      stations:["Domestic abuse disclosure","Child protection concern","Neglect","Coercive control","Vulnerable adult risk","Non-engagement with care"],
      expectedServices:[
        "Safeguarding lead + social services (children/vulnerable adults)",
        "IDVA (Independent Domestic Violence Advisor) / specialist DA services",
        "MARAC where high-risk DA (multi-agency risk assessment conference)",
        "Police where immediate danger",
        "Document: factual account + risk assessment + safety plan"
      ],
      examPhrase:"Safeguarding isn’t about getting anyone into trouble—it allows us to bring in extra support rather than leaving you to manage alone."
    },
    {
      id:"women",
      title:"6. Women’s Health & Pregnancy",
      tags:["women"],
      summary:"Pregnancy bleeding/mental health/contraception → correct pathway + sensitive framing.",
      stations:["Early pregnancy bleeding","Perinatal MH","Contraception complexity","Postnatal issues","Domestic abuse in pregnancy"],
      expectedServices:[
        "EPAU for early pregnancy issues",
        "Community midwives / obstetric services",
        "Perinatal mental health team",
        "Sexual health services for complex contraception/STI risk where appropriate",
        "Safeguarding escalation where risk"
      ],
      examPhrase:"We’ll look after both the physical and emotional aspects—pregnancy changes the risk balance, so I’ll involve the right specialist team early."
    },
    {
      id:"paeds",
      title:"7. Paediatrics (Non-Mental Health)",
      tags:["paeds","safeguarding"],
      summary:"Unwell child vs chronic needs; consider safeguarding triggers and safety-net clearly.",
      stations:["Fever/serious illness rule-out","Asthma/wheeze","Failure to thrive","Enuresis/constipation","Developmental concerns","Immunisation hesitancy"],
      expectedServices:[
        "Paediatric assessment if red flags/unwell child",
        "Health visitor / school nurse",
        "Community paediatrics for developmental concerns",
        "Dietitian where nutrition/FTT",
        "Safeguarding referral if concerns arise"
      ],
      examPhrase:"I’ll be clear about what would worry me and exactly what to do if you see it—safety-netting here is part of the treatment."
    },
    {
      id:"palliative",
      title:"8. Palliative & End-of-Life Care",
      tags:["palliative"],
      summary:"Quality of life, anticipatory meds, care planning; avoid ‘bleak’ framing.",
      stations:["Cancer palliation","Frailty decline","Last days of life","Symptom control","DNACPR/ACP discussions"],
      expectedServices:[
        "Community palliative care team",
        "District nursing",
        "Hospice services",
        "Anticipatory prescribing & syringe driver input where needed",
        "SR1/DS1500 (where applicable)",
        "Advance care planning / DNACPR discussion"
      ],
      examPhrase:"At this stage, the priority is comfort and quality of life—we can still do a lot, even if we’re not trying to cure the illness."
    },
    {
      id:"social",
      title:"9. Social & Functional Issues",
      tags:["social"],
      summary:"Isolation, housing, finances, carers, employment—use social prescriber + benefits pathways.",
      stations:["Social isolation","Bereavement","Housing insecurity","Debt/benefits","Carer stress","Work stress / fit note","Release from prison / reintegration"],
      expectedServices:[
        "Social prescriber / link worker",
        "Citizens Advice / MoneyHelper",
        "Carers’ support services",
        "Occupational health / Access to Work (where relevant)",
        "Community voluntary sector support (befriending, groups)",
        "Practical ‘nugget’: pet care charities (e.g., Cinnamon Trust/PDSA) where admission is refused due to pets"
      ],
      examPhrase:"Sometimes the practical side is what makes everything else harder—there may be help available that doesn’t involve more medication."
    },
    {
      id:"sexual",
      title:"10. Sexual Health & Confidentiality",
      tags:["sexual-health"],
      summary:"Non-judgemental, expertise + anonymity; consider safeguarding where age/risk issues.",
      stations:["STI symptoms","Contraception advice","Partner notification","Sexual assault disclosure","Confidentiality dilemmas"],
      expectedServices:[
        "GUM / sexual health clinic (testing, partner notification, complex contraception)",
        "Specialist services for sexual assault where indicated",
        "Safeguarding escalation when underage/coercion risk",
        "Gender identity clinic/support groups where appropriate"
      ],
      examPhrase:"I refer people to the sexual health clinic because they’re the true experts in this and it’s confidential—would you prefer self-referral details or for me to refer?"
    }
  ],

  scripts: [
    {
      id:"script_social_prescriber",
      title:"1) Social & Practical Support — Social Prescriber",
      tags:["social"],
      scenario:"Chronic pain/anxiety where isolation, debt, or housing is driving symptoms.",
      sell:"Link the social issue to health outcomes and treatment effectiveness.",
      script:[
        "I can hear how heavy the burden of [issue] is, and it can make medical treatments much harder to work effectively.",
        "We have a specialist in the practice called a Social Prescriber who’s very good at navigating housing, benefits, debt, and local support.",
        "Would it be okay if I link you in with them so we tackle that part of the problem alongside the medical plan?"
      ]
    },
    {
      id:"script_iapt",
      title:"2) Mental Health Support — NHS Talking Therapies / CBT",
      tags:["mental-health"],
      scenario:"Patient resistant to ‘counselling’ or thinks it’s just ‘chatting’.",
      sell:"Frame as skills/strategies; improve control and functioning.",
      script:[
        "You’ve described feeling constantly on edge and struggling with sleep—medication can help symptoms, but it doesn’t always teach strategies for the thoughts that trigger them.",
        "CBT is structured and practical: it helps you spot patterns, test them, and build coping tools.",
        "Would you be open to me referring you to NHS Talking Therapies so you can try that approach?"
      ]
    },
    {
      id:"script_safeguarding",
      title:"3) Safeguarding / Domestic Abuse — Social Services / IDVA",
      tags:["safeguarding"],
      scenario:"You must refer due to risk, but preserve relationship and collaboration.",
      sell:"Frame as support, be explicit about duty of care, pace, and safety plan.",
      script:[
        "Thank you for trusting me with this—what you’ve described sounds frightening and exhausting.",
        "My priority is safety. I have a duty of care to make sure you (and any children) are safe, which means I need to involve our safeguarding team/Children’s Services.",
        "Safeguarding isn’t about blame—it’s about bringing in support. I’ll stay involved and we’ll go at a pace that feels manageable."
      ]
    },
    {
      id:"script_bereavement",
      title:"4) Bereavement / Grief — Cruse / Bereavement Support",
      tags:["mental-health","social"],
      scenario:"Somatic symptoms or low mood after loss; needs validation + signposting.",
      sell:"Normalise grief; offer structured support rather than ‘just time’.",
      script:[
        "What you’re feeling after this loss is understandable, and grief can affect sleep, appetite, and even physical symptoms.",
        "Sometimes it helps to talk with someone trained in bereavement support—many people find it gives them a way through the hardest parts.",
        "Would you like me to connect you with bereavement counselling/Cruse, and we’ll also review how you’re coping over the next few weeks?"
      ]
    },
    {
      id:"script_substance",
      title:"5) Substance Misuse — Addiction Services",
      tags:["mental-health"],
      scenario:"Alcohol/drugs (or gambling) contributing to risk, mood, adherence, or safeguarding.",
      sell:"Non-judgemental; frame as specialist help + harm reduction.",
      script:[
        "I’m not here to judge—my concern is the impact this is having on your health, safety, and day-to-day life.",
        "There are specialist teams who can support change at your pace and reduce harms even before you’ve fully stopped.",
        "Would it be okay if I refer you to our local addiction service so you have the right support around you?"
      ]
    },
    {
      id:"script_camhs",
      title:"6) Young Person Risk — CAMHS / Crisis Pathway",
      tags:["mental-health","paeds"],
      scenario:"Self-harm, eating disorder, psychosis, or high-risk deterioration.",
      sell:"Explain urgency; “I’d feel uncomfortable not…”; involve family appropriately.",
      script:[
        "Because of your age and what you’ve described, specialist input is the safest option.",
        "I’d feel uncomfortable not getting extra support involved today.",
        "With your permission, I’ll arrange urgent CAMHS/crisis input and we’ll make a clear safety plan for tonight, including who to contact if things escalate."
      ]
    },
    {
      id:"script_gum",
      title:"7) Sexual Health — GUM Clinic",
      tags:["sexual-health"],
      scenario:"STI screen or symptoms; patient embarrassed or fearful of judgement.",
      sell:"Expertise + anonymity + speed.",
      script:[
        "Thank you for being so open—these symptoms are common and nothing to be embarrassed about.",
        "The sexual health clinic are the true experts: they can test, treat quickly, and handle partner notification confidentially.",
        "Would you prefer self-referral details, or for me to send a referral today?"
      ]
    },
    {
      id:"script_fitnote",
      title:"8) Lifestyle & Occupational — Fit Note / Amended Duties",
      tags:["social"],
      scenario:"Patient wants to stay off work, but graded return is beneficial.",
      sell:"Frame work as part of recovery; “middle ground”; amendments.",
      script:[
        "I can see you’re not ready for your usual duties right now.",
        "Being off completely can sometimes increase isolation and slow recovery.",
        "A middle ground is a Fit Note recommending amended duties or reduced hours—shall we try that plan and review it in 2–3 weeks?"
      ]
    }
  ],

  phrases: [
    {
      group:"Transition phrase (buys thinking time)",
      tags:["all"],
      items:[
        "Let me take a step back and think about the bigger picture here.",
        "There are a few strands we need to address at the same time.",
        "This isn’t just about the test result — it’s about how this is affecting you."
      ]
    },
    {
      group:"Medical → Psychological bridge (high yield)",
      tags:["mental-health"],
      items:[
        "Medically, I know what to do next, but I’m also conscious this is taking a toll on you.",
        "From a physical point of view we have a plan, but emotionally this is a lot to carry.",
        "Even when the condition is stable, the impact on day-to-day life can be significant."
      ]
    },
    {
      group:"Introducing support without ‘over-medicalising’",
      tags:["mental-health"],
      items:[
        "Some people find it helpful to have space to talk this through with someone neutral.",
        "Support doesn’t mean there’s something ‘wrong’ — it’s about coping better.",
        "I wouldn’t want you dealing with this on your own."
      ]
    },
    {
      group:"Safeguarding (supportive, non-threatening)",
      tags:["safeguarding"],
      items:[
        "Safeguarding isn’t about getting anyone into trouble.",
        "It allows us to bring in extra support rather than leaving you to manage alone.",
        "I hear your concerns — we can go at a pace that feels manageable."
      ]
    },
    {
      group:"CAMHS / crisis referral (risk)",
      tags:["mental-health","paeds"],
      items:[
        "Because of your age and the changes you’re describing, specialist input today is the safest option.",
        "This isn’t something I’d want to sit on.",
        "I’d feel uncomfortable not getting extra support involved."
      ]
    },
    {
      group:"Social prescriber / practical support (often missed)",
      tags:["social"],
      items:[
        "Sometimes the practical side is what makes everything else harder.",
        "There may be help available that doesn’t involve more medication.",
        "We have colleagues who are very good at navigating benefits, work, and housing issues."
      ]
    },
    {
      group:"Palliative care (compassionate)",
      tags:["palliative"],
      items:[
        "At this stage, the priority is comfort and quality of life.",
        "We can still do a lot, even if we’re not trying to cure the illness.",
        "You don’t have to wait until things get worse to involve palliative support."
      ]
    },
    {
      group:"DNACPR / advance care planning",
      tags:["palliative"],
      items:[
        "This isn’t about giving up — it’s about making sure your wishes are respected.",
        "These decisions are best made when things are relatively calm.",
        "We can revisit this at any point."
      ]
    },
    {
      group:"Shared decision-making (scores heavily)",
      tags:["all"],
      items:[
        "How does that plan sound to you?",
        "What feels most important for you right now?",
        "Would it be okay if I made a suggestion?"
      ]
    },
    {
      group:"Safety-netting (not robotic)",
      tags:["red-flags"],
      items:[
        "If you notice X or Y, I’d want you to seek urgent help.",
        "I’ll be clear about what would worry me.",
        "If you’re unsure, it’s always safer to check."
      ]
    },
    {
      group:"Follow-up (signals ownership)",
      tags:["all"],
      items:[
        "I don’t want this to feel like a one-off conversation.",
        "Let’s keep this under review.",
        "I’ll make sure we follow this up rather than leaving it open-ended."
      ]
    },
    {
      group:"End-of-station summary (gold dust)",
      tags:["all"],
      items:[
        "So, to summarise — we’ve got a clear medical plan, we’ve addressed the emotional impact, and we’ve identified extra support to help day-to-day."
      ]
    }
  ],

  checklist: {
    title: "One-page SCA Consultation Scaffold",
    steps: [
      { h:"1) Open + agenda", b:[
        "Elicit patient goals + expectations (ICE where appropriate).",
        "Signal structure: ‘There are a few strands…’"
      ]},
      { h:"2) Biopsychosocial sweep", b:[
        "Bio: red flags, severity, comorbidity, meds, function.",
        "Psy: mood/anxiety, coping, sleep, trauma, risk (self-harm), capacity.",
        "Social: housing, finances, work, carers, support network, safeguarding."
      ]},
      { h:"3) Bridge + name the burden", b:[
        "Use the medical→psych bridge phrase.",
        "Validate emotion without over-labelling."
      ]},
      { h:"4) Plan: medical + psychosocial + service", b:[
        "One medical action + one support action (service referral).",
        "Frame referral as outcome-focused support (‘tackle the part that blocks recovery’).",
        "Shared decision-making language."
      ]},
      { h:"5) Safety net", b:[
        "Specify exact triggers to seek urgent help.",
        "Document and give clear route: 999/ED vs same-day GP/OOH."
      ]},
      { h:"6) Follow-up + ownership", b:[
        "Timeframe + modality (review in X days/weeks).",
        "End-of-station summary sentence hits all domains."
      ]}
    ],
    microMnemonics: [
      {k:"BRIDGE", v:"Bio plan → Recognise burden → Identify service → Decide together → Give safety net → Ensure follow-up"},
      {k:"SUPPORT", v:"Social prescriber • Usual stepped care (IAPT/CMHT) • Protection (safeguarding) • Occupational/fit note • Referral pathway • Trajectory review"}
    ]
  }
};

/* =========================
   PROGRESS (simple spaced repetition)
   ========================= */

const STORE_KEY = "psysca_progress_v1";
const defaultProgress = () => ({
  activeFilter: null,
  viewed: {},
  // Leitner-ish: cardId -> {box:1..5, due:timestamp}
  cards: {},
  lastDeckBuild: null,
});

function loadProgress(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return defaultProgress();
    const p = JSON.parse(raw);
    return Object.assign(defaultProgress(), p);
  }catch(e){
    return defaultProgress();
  }
}
function saveProgress(){
  localStorage.setItem(STORE_KEY, JSON.stringify(PROGRESS));
}
let PROGRESS = loadProgress();

/* =========================
   DECK BUILD
   ========================= */

function buildDeck(){
  const deck = [];
  // Services map cards
  for(const s of DATA.servicesMap){
    deck.push({
      id:"svc_"+s.id,
      type:"service",
      tags:s.tags,
      q:`SERVICE MAP: ${s.title}\n\nWhat are the expected services + a scoring exam phrase?`,
      a:
`Stations it covers:
- ${s.stations.join("\n- ")}

Expected services:
- ${s.expectedServices.join("\n- ")}

Exam phrase:
“${s.examPhrase}”`
    });
  }
  // Script cards
  for(const sc of DATA.scripts){
    deck.push({
      id:"scr_"+sc.id,
      type:"script",
      tags:sc.tags,
      q:`SCRIPT: ${sc.title}\n\nScenario:\n${sc.scenario}\n\nWhat is the ‘sell’ and the core lines?`,
      a:
`Sell:
- ${sc.sell}

Core script:
- ${sc.script.join("\n- ")}`
    });
  }
  // Phrase cards
  for(const grp of DATA.phrases){
    deck.push({
      id:"phr_"+grp.group.replaceAll(" ","_").replaceAll("/","_").toLowerCase(),
      type:"phrase",
      tags:grp.tags,
      q:`PHRASE BANK: ${grp.group}\n\nGive 2–3 high-scoring lines.`,
      a:`- ${grp.items.join("\n- ")}`
    });
  }
  // Checklist card
  deck.push({
    id:"chk_scaffold",
    type:"checklist",
    tags:["all"],
    q:`CHECKLIST: One-page SCA Consultation Scaffold\n\nWhat are the key steps?`,
    a: DATA.checklist.steps.map((x,i)=>`${i+1}) ${x.h}\n- ${x.b.join("\n- ")}`).join("\n\n")
  });

  PROGRESS.lastDeckBuild = Date.now();
  saveProgress();
  return deck;
}

const DECK = buildDeck();

/* =========================
   UI HELPERS
   ========================= */

const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

function toast(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2200);
}

function setTitle(title, desc){
  $("#pageTitle").textContent = title;
  $("#pageDesc").textContent = desc || "";
}

function escapeHtml(s){
  return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

function matchesSearch(obj, q){
  if(!q) return true;
  const hay = JSON.stringify(obj).toLowerCase();
  return hay.includes(q.toLowerCase());
}

/* =========================
   NAV + FILTERS
   ========================= */

function renderNav(){
  const nav = $("#nav");
  nav.innerHTML = "";
  for(const p of DATA.pages){
    const btn = document.createElement("button");
    btn.className = "navBtn";
    btn.dataset.page = p.id;
    btn.innerHTML = `
      <div class="meta">
        <div class="t">${escapeHtml(p.title)}</div>
        <div class="d">${escapeHtml(p.desc)}</div>
      </div>
      <div class="badge">${escapeHtml(p.badge)}</div>
    `;
    btn.onclick = ()=>go(p.id);
    nav.appendChild(btn);
  }
}

function renderQuickFilters(){
  const wrap = $("#quickFilters");
  wrap.innerHTML = "";
  for(const f of DATA.quickFilters){
    const el = document.createElement("div");
    el.className = "pill";
    el.textContent = f.label;
    el.dataset.key = f.key;
    el.onclick = ()=>{
      PROGRESS.activeFilter = (PROGRESS.activeFilter === f.key) ? null : f.key;
      saveProgress();
      updateFilterUI();
      rerender();
    };
    wrap.appendChild(el);
  }
  updateFilterUI();
}

function updateFilterUI(){
  $$("#quickFilters .pill").forEach(p=>{
    p.classList.toggle("active", p.dataset.key === PROGRESS.activeFilter);
  });
}

/* =========================
   ROUTER
   ========================= */

let CURRENT_PAGE = "home";
let RAPID_MODE = false;
let RAPID_CARD = null;

function go(pageId){
  CURRENT_PAGE = pageId;
  RAPID_MODE = false;
  RAPID_CARD = null;
  rerender();
  $$("#nav .navBtn").forEach(b=>b.classList.toggle("active", b.dataset.page===pageId));
}

/* =========================
   RENDER PAGES
   ========================= */

function rerender(){
  const q = $("#search").value.trim().toLowerCase();
  const filter = PROGRESS.activeFilter;

  if(CURRENT_PAGE === "home"){
    setTitle("Home", "Use this like an SCA autopilot: bridge → service → collaborative plan → safety-net → follow-up.");
    $("#content").innerHTML = renderHome(q, filter);
  } else if(CURRENT_PAGE === "services"){
    setTitle("Master Services Map", "10 domains. Each gives you ‘expected services’ + an exam phrase trigger.");
    $("#content").innerHTML = renderServices(q, filter);
  } else if(CURRENT_PAGE === "scripts"){
    setTitle("8 Referral Scripts", "Patient-friendly language that scores: outcome-focused, collaborative, and safe.");
    $("#content").innerHTML = renderScripts(q, filter);
  } else if(CURRENT_PAGE === "phrases"){
    setTitle("Phrase Bank", "High-scoring lines: transition, bridge, safeguarding, CAMHS, palliative, safety-net, follow-up.");
    $("#content").innerHTML = renderPhrases(q, filter);
  } else if(CURRENT_PAGE === "checklist"){
    setTitle("Consultation Checklist", "One-page scaffold to prevent omissions under exam stress.");
    $("#content").innerHTML = renderChecklist(q, filter);
  } else if(CURRENT_PAGE === "flashcards"){
    setTitle("Flashcards", "Browse the full deck. For spaced repetition use Rapid Recall.");
    $("#content").innerHTML = renderDeck(q, filter);
  } else if(CURRENT_PAGE === "drills"){
    setTitle("Station Drills", "Run a timed micro-station: open → bridge → service → SDM → SN → FU.");
    $("#content").innerHTML = renderDrills();
  }
}

function renderHome(q, filter){
  const active = filter ? `Active filter: <span class="kbd">${escapeHtml(filter)}</span>` : `Active filter: <span class="kbd">none</span>`;
  return `
    <div class="grid">
      <div class="card">
        <h3>How to score reliably in psychosocial-heavy GP stations</h3>
        <p class="muted">
          ${active} • Keyboard: <span class="kbd">/</span> search, <span class="kbd">N</span> next, <span class="kbd">A</span> answer, <span class="kbd">1/2/3</span> rate in Rapid Recall.
        </p>
        <div class="hr"></div>
        <div class="split">
          <div class="panel">
            <h4>Core scoring sequence (repeatable)</h4>
            <ol class="list">
              <li><b>Transition</b>: “step back / bigger picture”.</li>
              <li><b>Bridge</b> medical → psychological: acknowledge burden explicitly.</li>
              <li><b>Service</b>: name the right team <span class="muted">(and why it improves outcomes)</span>.</li>
              <li><b>Shared decision-making</b>: permission + collaboration.</li>
              <li><b>Safety-net</b>: specify triggers, not generic “go ED”.</li>
              <li><b>Follow-up ownership</b>: “not a one-off conversation”.</li>
            </ol>
          </div>
          <div class="panel">
            <h4>Fast “end-of-station” line (copy/paste into memory)</h4>
            <div class="callout">
              <div class="label">Gold-dust summary sentence</div>
              So, to summarise — we’ve got a clear medical plan, we’ve addressed the emotional impact, and we’ve identified extra support to help day-to-day.
            </div>
            <div class="tagRow">
              ${DATA.quickFilters.map(f=>`<span class="tag ${filter===f.key?'active':''}" onclick="window.__setFilter('${f.key}')">${escapeHtml(f.label)}</span>`).join("")}
            </div>
            <div class="note" style="margin-top:10px">
              Tip: In SCA, the <b>service name alone</b> scores less than the <b>link</b> (“your finances are worsening symptoms, so…”).
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Quick start</h3>
        <div class="twoCol">
          <div class="panel">
            <h4>1) Learn the services map</h4>
            <p class="muted">Open <b>Master Services Map</b> and drill: domain → services → exam phrase.</p>
            <div class="hr"></div>
            <button class="btn primary" onclick="window.__go('services')">Go to Services Map</button>
          </div>
          <div class="panel">
            <h4>2) Practise language under pressure</h4>
            <p class="muted">Use <b>8 Referral Scripts</b> then <b>Phrase Bank</b> to “sound safe + senior”.</p>
            <div class="hr"></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn" onclick="window.__go('scripts')">Scripts</button>
              <button class="btn" onclick="window.__go('phrases')">Phrases</button>
              <button class="btn good" onclick="window.__rapid()">Rapid Recall</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function passesFilter(tags, filter){
  if(!filter) return true;
  if(filter === "red-flags") return tags.includes("red-flags") || tags.includes("red-flags".replace("-"," "));
  if(filter === "sexual-health") return tags.includes("sexual-health");
  if(filter === "mental-health") return tags.includes("mental-health");
  if(filter === "safeguarding") return tags.includes("safeguarding");
  if(filter === "women") return tags.includes("women");
  if(filter === "paeds") return tags.includes("paeds");
  if(filter === "palliative") return tags.includes("palliative");
  if(filter === "social") return tags.includes("social");
  return tags.includes(filter);
}

function renderServices(q, filter){
  const items = DATA.servicesMap
    .filter(x=>passesFilter(x.tags, filter))
    .filter(x=>matchesSearch(x, q));
  return `
    <div class="grid">
      ${items.map(s=>`
        <div class="card">
          <h3>${escapeHtml(s.title)}</h3>
          <p class="muted">${escapeHtml(s.summary)}</p>
          <div class="hr"></div>
          <div class="split">
            <div class="panel">
              <h4>Stations it covers</h4>
              <ul class="list">${s.stations.map(a=>`<li>${escapeHtml(a)}</li>`).join("")}</ul>
            </div>
            <div class="panel">
              <h4>Expected services (the scoring bit)</h4>
              <ul class="list">${s.expectedServices.map(a=>`<li>${escapeHtml(a)}</li>`).join("")}</ul>
              <div class="hr"></div>
              <div class="callout">
                <div class="label">Exam phrase</div>
                “${escapeHtml(s.examPhrase)}”
              </div>
              <div class="tagRow">
                ${s.tags.map(t=>`<span class="tag ${PROGRESS.activeFilter===t?'active':''}" onclick="window.__setFilter('${t}')">${escapeHtml(t)}</span>`).join("")}
              </div>
            </div>
          </div>
        </div>
      `).join("")}
      ${items.length===0 ? `<div class="card"><h3>No matches</h3><p class="muted">Try clearing the filter or using fewer search terms.</p></div>` : ""}
    </div>
  `;
}

function renderScripts(q, filter){
  const items = DATA.scripts
    .filter(x=>passesFilter(x.tags, filter))
    .filter(x=>matchesSearch(x, q));
  return `
    <div class="grid">
      ${items.map(s=>`
        <div class="card">
          <h3>${escapeHtml(s.title)}</h3>
          <p class="muted"><b>Scenario:</b> ${escapeHtml(s.scenario)}</p>
          <div class="hr"></div>
          <div class="twoCol">
            <div class="panel">
              <h4>The “Sell” (what examiners reward)</h4>
              <p class="muted">${escapeHtml(s.sell)}</p>
              <div class="hr"></div>
              <div class="kvs">
                ${s.tags.map(t=>`<span class="kv">${escapeHtml(t)}</span>`).join("")}
              </div>
            </div>
            <div class="panel">
              <h4>Core lines (patient-friendly, exam-safe)</h4>
              <ul class="list">${s.script.map(l=>`<li>${escapeHtml(l)}</li>`).join("")}</ul>
            </div>
          </div>
        </div>
      `).join("")}
      ${items.length===0 ? `<div class="card"><h3>No matches</h3><p class="muted">Clear filter or search for a service: “IAPT”, “GUM”, “Fit Note”, “IDVA”.</p></div>` : ""}
    </div>
  `;
}

function renderPhrases(q, filter){
  const groups = DATA.phrases
    .map(g=>Object.assign({}, g, {items: g.items.filter(it=>matchesSearch(it, q))}))
    .filter(g=>g.items.length>0)
    .filter(g=>passesFilter(g.tags, filter) || (filter && g.tags.includes("all")));
  return `
    <div class="grid">
      <div class="card">
        <h3>How to use</h3>
        <p class="muted">In stations, pick <b>one transition</b>, <b>one bridge</b>, then <b>one service line</b>, then close with <b>safety-net + follow-up</b>.</p>
      </div>
      ${groups.map(g=>`
        <div class="card">
          <h3>${escapeHtml(g.group)}</h3>
          <div class="tagRow">
            ${(g.tags || []).map(t=>`<span class="tag ${PROGRESS.activeFilter===t?'active':''}" onclick="window.__setFilter('${t}')">${escapeHtml(t)}</span>`).join("")}
          </div>
          <div class="hr"></div>
          <ul class="list">
            ${g.items.map(it=>`<li>${escapeHtml(it)}</li>`).join("")}
          </ul>
        </div>
      `).join("")}
      ${groups.length===0 ? `<div class="card"><h3>No matches</h3><p class="muted">Try searching less specifically (e.g. “support”, “safety”, “plan”).</p></div>` : ""}
    </div>
  `;
}

function renderChecklist(q, filter){
  if(filter && filter !== "all") {
    // Checklist is universal; still show but indicate.
  }
  const c = DATA.checklist;
  return `
    <div class="grid">
      <div class="card">
        <h3>${escapeHtml(c.title)}</h3>
        <p class="muted">Use this as your internal running order to avoid omissions and keep the consultation “senior”.</p>
        <div class="hr"></div>
        <div class="twoCol">
          <div class="panel">
            <h4>Steps</h4>
            <ol class="list">
              ${c.steps.map(s=>`<li><b>${escapeHtml(s.h)}</b><ul class="list">${s.b.map(b=>`<li>${escapeHtml(b)}</li>`).join("")}</ul></li>`).join("")}
            </ol>
          </div>
          <div class="panel">
            <h4>Micro-mnemonics</h4>
            <div class="note"><b class="mono">${escapeHtml(c.microMnemonics[0].k)}</b> — ${escapeHtml(c.microMnemonics[0].v)}</div>
            <div class="note" style="margin-top:10px"><b class="mono">${escapeHtml(c.microMnemonics[1].k)}</b> — ${escapeHtml(c.microMnemonics[1].v)}</div>
            <div class="hr"></div>
            <button class="btn good" onclick="window.__rapid()">Rapid Recall (this checklist)</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

function renderDeck(q, filter){
  const items = DECK
    .filter(c=>passesFilter(c.tags || [], filter) || (filter && (c.tags||[]).includes("all")))
    .filter(c=>matchesSearch(c, q));
  return `
    <div class="grid">
      <div class="card">
        <h3>Deck</h3>
        <p class="muted">Tip: Use <b>Rapid Recall</b> for spaced repetition and rating (Again/Good/Easy). This view is for browsing.</p>
      </div>
      ${items.map(c=>`
        <div class="card">
          <h3>${escapeHtml(c.type.toUpperCase())}</h3>
          <div class="panel">
            <h4>Prompt</h4>
            <div class="flashQ"><pre style="margin:0;white-space:pre-wrap;font-family:var(--sans)">${escapeHtml(c.q)}</pre></div>
            <div class="hr"></div>
            <h4>Answer</h4>
            <div class="flashA show"><pre style="margin:0;white-space:pre-wrap;font-family:var(--sans)">${escapeHtml(c.a)}</pre></div>
            <div class="hr"></div>
            <div class="kvs">${(c.tags||[]).map(t=>`<span class="kv">${escapeHtml(t)}</span>`).join("")}</div>
          </div>
        </div>
      `).join("")}
      ${items.length===0 ? `<div class="card"><h3>No matches</h3><p class="muted">Clear filter or broaden search.</p></div>` : ""}
    </div>
  `;
}

function renderDrills(){
  return `
    <div class="grid">
      <div class="card">
        <h3>Timed micro-station drill</h3>
        <p class="muted">Goal: produce an SCA-sounding plan in ≤ 90 seconds using the scaffold.</p>
        <div class="hr"></div>
        <div class="twoCol">
          <div class="panel">
            <h4>Instructions</h4>
            <ol class="list">
              <li>Pick a domain (Services Map) and imagine a typical station from that set.</li>
              <li>Say a <b>transition</b> line.</li>
              <li>Say a <b>bridge</b> line (medical → psychological).</li>
              <li>Name the <b>service</b> + the “sell” (why it helps outcomes).</li>
              <li>Use <b>shared decision-making</b> question.</li>
              <li>Give <b>safety-net</b> triggers + <b>follow-up</b> timeframe.</li>
              <li>Finish with the <b>end-of-station summary sentence</b>.</li>
            </ol>
          </div>
          <div class="panel">
            <h4>Timer</h4>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <button class="btn primary" onclick="window.__timerStart(90)">Start 90s</button>
              <button class="btn" onclick="window.__timerStart(180)">Start 180s</button>
              <button class="btn danger" onclick="window.__timerStop()">Stop</button>
            </div>
            <div class="hr"></div>
            <div class="callout">
              <div class="label">Time left</div>
              <div id="timerReadout" style="font-size:18px;font-family:var(--mono)">--:--</div>
            </div>
            <div class="hr"></div>
            <button class="btn good" onclick="window.__rapid()">Rapid Recall (generate prompts)</button>
            <div class="note" style="margin-top:10px">
              Pattern to practise: <b>Bridge → Service → Collaborate</b>. This is the common fail point in psychosocial-heavy stations.
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

/* =========================
   RAPID RECALL
   ========================= */

function now(){ return Date.now(); }

function getCardState(id){
  if(!PROGRESS.cards[id]){
    PROGRESS.cards[id] = { box: 1, due: 0, seen: 0 };
  }
  return PROGRESS.cards[id];
}
function intervalForBox(box){
  // simple increasing intervals (ms)
  const day = 24*60*60*1000;
  const map = {1: 0, 2: day, 3: 3*day, 4: 7*day, 5: 14*day};
  return map[box] ?? day;
}
function chooseDueCard(){
  const filter = PROGRESS.activeFilter;
  const q = $("#search").value.trim().toLowerCase();

  const candidates = DECK.filter(c=>{
    const tags = c.tags || [];
    const okFilter = filter ? (passesFilter(tags, filter) || tags.includes("all")) : true;
    const okSearch = matchesSearch(c, q);
    if(!okFilter || !okSearch) return false;
    const st = getCardState(c.id);
    return st.due <= now();
  });

  const pool = candidates.length ? candidates : DECK.filter(c=>{
    const tags = c.tags || [];
    const okFilter = filter ? (passesFilter(tags, filter) || tags.includes("all")) : true;
    const okSearch = matchesSearch(c, q);
    return okFilter && okSearch;
  });

  if(!pool.length) return null;

  // Weighted random: prefer lower box + less seen
  const weighted = [];
  for(const c of pool){
    const st = getCardState(c.id);
    const w = (6 - st.box) + Math.max(0, 3 - st.seen);
    for(let i=0;i<w;i++) weighted.push(c);
  }
  return weighted[Math.floor(Math.random()*weighted.length)];
}

function renderRapid(card){
  if(!card){
    $("#content").innerHTML = `<div class="grid"><div class="card"><h3>No cards match your current filter/search</h3><p class="muted">Clear filter or reduce search terms.</p></div></div>`;
    return;
  }
  const st = getCardState(card.id);
  st.seen = (st.seen||0) + 1;
  saveProgress();

  $("#content").innerHTML = `
    <div class="grid">
      <div class="card">
        <h3>Rapid Recall</h3>
        <p class="muted">Rate yourself: <span class="kbd">1</span> Again • <span class="kbd">2</span> Good • <span class="kbd">3</span> Easy</p>
        <div class="hr"></div>
        <div class="flash">
          <div class="flashQ"><pre style="margin:0;white-space:pre-wrap;font-family:var(--sans)">${escapeHtml(card.q)}</pre></div>
          <div class="flashA" id="rapidAnswer"><pre style="margin:0;white-space:pre-wrap;font-family:var(--sans)">${escapeHtml(card.a)}</pre></div>
          <div class="panel">
            <div class="kvs">
              <span class="kv">Type: ${escapeHtml(card.type)}</span>
              <span class="kv">Box: ${st.box}</span>
              <span class="kv">Due: ${st.due ? new Date(st.due).toLocaleString() : "now"}</span>
              ${(card.tags||[]).map(t=>`<span class="kv">${escapeHtml(t)}</span>`).join("")}
            </div>
          </div>
          <div class="rateRow">
            <button class="btn danger" onclick="window.__rate(1)">1 • Again</button>
            <button class="btn primary" onclick="window.__rate(2)">2 • Good</button>
            <button class="btn good" onclick="window.__rate(3)">3 • Easy</button>
            <button class="btn" onclick="window.__toggleAnswer()">Toggle answer</button>
            <button class="btn warn" onclick="window.__next()">Next</button>
          </div>
          <div class="note">
            Scoring trick: Always add a <b>why</b> after naming a service (outcome-focused), then a <b>shared decision</b> question.
          </div>
        </div>
      </div>
    </div>
  `;
}

function startRapid(){
  RAPID_MODE = true;
  setTitle("Rapid Recall", "Spaced repetition: focus on weak areas, rate honestly, and keep moving.");
  RAPID_CARD = chooseDueCard();
  renderRapid(RAPID_CARD);
}

function toggleRapidAnswer(){
  const ans = $("#rapidAnswer");
  if(ans) ans.classList.toggle("show");
}

function nextRapid(){
  RAPID_CARD = chooseDueCard();
  renderRapid(RAPID_CARD);
}

function rateRapid(score){
  if(!RAPID_CARD) return;
  const st = getCardState(RAPID_CARD.id);

  if(score === 1){
    st.box = 1;
    st.due = now() + intervalForBox(1);
    toast("Marked AGAIN → back to Box 1");
  } else if(score === 2){
    st.box = Math.min(5, st.box + 1);
    st.due = now() + intervalForBox(st.box);
    toast(`Marked GOOD → Box ${st.box}`);
  } else if(score === 3){
    st.box = Math.min(5, st.box + 2);
    st.due = now() + intervalForBox_toggle(st.box);
    toast(`Marked EASY → Box ${st.box}`);
  }
  saveProgress();
  nextRapid();
}

function intervalForBox_toggle(box){
  // small boost for "Easy"
  const base = intervalForBox(box);
  return Math.floor(base * 1.3);
}

/* =========================
   GLOBAL HOOKS (for inline onclick)
   ========================= */

window.__go = go;
window.__rapid = startRapid;
window.__toggleAnswer = toggleRapidAnswer;
window.__next = nextRapid;
window.__rate = rateRapid;
window.__setFilter = (k)=>{ PROGRESS.activeFilter = (PROGRESS.activeFilter===k?null:k); saveProgress(); updateFilterUI(); rerender(); };

/* =========================
   TIMER
   ========================= */
let timerHandle = null;
let timerEnd = null;

function timerStart(seconds){
  timerStop();
  timerEnd = Date.now() + seconds*1000;
  const el = document.getElementById("timerReadout");
  const tick = ()=>{
    const left = Math.max(0, timerEnd - Date.now());
    const s = Math.floor(left/1000);
    const mm = String(Math.floor(s/60)).padStart(2,"0");
    const ss = String(s%60).padStart(2,"0");
    if(el) el.textContent = `${mm}:${ss}`;
    if(left<=0){
      timerStop();
      toast("Time. End with your summary sentence.");
    }
  };
  timerHandle = setInterval(tick, 200);
  tick();
}
function timerStop(){
  if(timerHandle) clearInterval(timerHandle);
  timerHandle = null;
  timerEnd = null;
  const el = document.getElementById("timerReadout");
  if(el) el.textContent = "--:--";
}
window.__timerStart = timerStart;
window.__timerStop = timerStop;

/* =========================
   TOP BAR BUTTONS
   ========================= */

$("#btnRapid").onclick = ()=> startRapid();
$("#btnShowAnswer").onclick = ()=> {
  if(RAPID_MODE) toggleRapidAnswer();
  else toast("Use Rapid Recall to show/hide answers quickly.");
};
$("#btnNextCard").onclick = ()=> {
  if(RAPID_MODE) nextRapid();
  else toast("Use Rapid Recall to cycle cards.");
};
$("#btnHardReset").onclick = ()=>{
  if(confirm("Hard reset (clears stored progress and reloads)?")){
    localStorage.removeItem(STORE_KEY);
    location.reload();
  }
};

/* =========================
   SIDEBAR BUTTONS
   ========================= */

$("#resetProgress").onclick = ()=>{
  if(confirm("Reset spaced repetition progress (keeps app data)?")){
    PROGRESS = defaultProgress();
    saveProgress();
    updateFilterUI();
    rerender();
    toast("Progress reset.");
  }
};

$("#exportProgress").onclick = ()=>{
  const blob = JSON.stringify(PROGRESS, null, 2);
  navigator.clipboard.writeText(blob).then(()=>toast("Progress JSON copied to clipboard."));
};

$("#importProgress").onclick = async ()=>{
  const txt = prompt("Paste previously exported JSON:");
  if(!txt) return;
  try{
    const obj = JSON.parse(txt);
    PROGRESS = Object.assign(defaultProgress(), obj);
    saveProgress();
    updateFilterUI();
    rerender();
    toast("Progress imported.");
  }catch(e){
    toast("Invalid JSON.");
  }
};

$("#copyCheats").onclick = ()=>{
  const line = "Bridge → Service (+why) → Shared decision → Safety-net triggers → Follow-up ownership → Summary sentence.";
  navigator.clipboard.writeText(line).then(()=>toast("Cheat line copied."));
};

/* =========================
   SEARCH + SHORTCUTS
   ========================= */

$("#search").addEventListener("input", ()=> rerender());

document.addEventListener("keydown", (e)=>{
  if(e.key === "/"){
    e.preventDefault();
    $("#search").focus();
  }
  if(e.key.toLowerCase() === "n"){
    if(RAPID_MODE) nextRapid();
  }
  if(e.key.toLowerCase() === "a"){
    if(RAPID_MODE) toggleRapidAnswer();
  }
  if(RAPID_MODE && ["1","2","3"].includes(e.key)){
    rateRapid(Number(e.key));
  }
});

/* =========================
   INIT
   ========================= */

renderNav();
renderQuickFilters();
go("home");
$$("#nav .navBtn").forEach(b=>b.classList.toggle("active", b.dataset.page==="home"));
</script>
</body>
</html>
