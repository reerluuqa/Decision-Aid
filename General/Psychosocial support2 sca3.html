<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GP Psychosocial Needs ‚Äì SCA Revision App (Offline)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#121a27;
      --panel2:#0f1622;
      --text:#e7eefc;
      --muted:#a7b3cc;
      --line:#233047;
      --accent:#7aa2ff;
      --good:#55d6a3;
      --warn:#ffd27a;
      --bad:#ff7a93;
      --chip:#1b2640;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    [data-theme="light"]{
      --bg:#f6f8ff;
      --panel:#ffffff;
      --panel2:#f0f4ff;
      --text:#101828;
      --muted:#475467;
      --line:#d5def7;
      --accent:#355cff;
      --chip:#eef2ff;
      --shadow: 0 10px 25px rgba(16,24,40,.10);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 20% 0%, rgba(122,162,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 80% 10%, rgba(85,214,163,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:22px 16px 80px}
    header{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      padding:16px 18px;border:1px solid var(--line);background:rgba(255,255,255,.02);
      border-radius:var(--radius2); box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      position:sticky; top:10px; z-index:50;
    }
    .title{
      display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(122,162,255,.95), rgba(85,214,163,.95));
      box-shadow: 0 10px 25px rgba(122,162,255,.20);
      flex:none;
    }
    h1{
      font-size:16px; margin:0; line-height:1.25; letter-spacing:.2px;
    }
    .sub{
      margin:2px 0 0;
      font-size:12px; color:var(--muted);
      max-width:760px;
    }
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .btn, .chip, .tab{
      border:1px solid var(--line); background: rgba(255,255,255,.02);
      color:var(--text); padding:9px 12px; border-radius:12px;
      cursor:pointer; user-select:none;
      font-size:13px;
    }
    .btn:hover,.tab:hover{border-color:rgba(122,162,255,.6)}
    .btn.primary{border-color:rgba(122,162,255,.75); background: rgba(122,162,255,.12)}
    .btn.good{border-color:rgba(85,214,163,.75); background: rgba(85,214,163,.10)}
    .btn.warn{border-color:rgba(255,210,122,.75); background: rgba(255,210,122,.10)}
    .btn.bad{border-color:rgba(255,122,147,.75); background: rgba(255,122,147,.10)}
    .search{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--line); border-radius:12px; padding:8px 10px;
      background: rgba(255,255,255,.02);
      min-width:min(360px, 70vw);
    }
    .search input{
      width:100%; border:0; outline:0; background:transparent; color:var(--text);
      font-size:13px;
    }
    .search .k{font-family:var(--mono); font-size:11px; color:var(--muted); border:1px solid var(--line);
      padding:2px 6px; border-radius:8px;
    }

    .grid{
      margin-top:18px;
      display:grid; grid-template-columns: 320px 1fr; gap:14px;
    }
    @media (max-width: 980px){
      header{position:static}
      .grid{grid-template-columns:1fr}
    }

    .panel{
      border:1px solid var(--line); border-radius:var(--radius2);
      background: rgba(255,255,255,.02);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:14px 14px 10px; border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .panel .hd h2{margin:0;font-size:13px;letter-spacing:.2px}
    .panel .hd p{margin:6px 0 0; font-size:12px; color:var(--muted)}
    .panel .bd{padding:12px 14px}

    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .tab.active{border-color:rgba(122,162,255,.75); background: rgba(122,162,255,.12)}
    .kpiRow{display:grid;grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:12px}
    .kpi{
      border:1px solid var(--line); border-radius:14px;
      padding:10px 10px; background: rgba(255,255,255,.02);
    }
    .kpi .n{font-size:18px;font-weight:700}
    .kpi .l{font-size:12px;color:var(--muted); margin-top:2px}
    .kpi .bar{
      margin-top:8px; height:8px; border-radius:999px; background: rgba(255,255,255,.05); overflow:hidden;
      border:1px solid var(--line);
    }
    .kpi .bar > div{height:100%; background: rgba(122,162,255,.55); width:0%}

    .cards{display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:12px}
    @media (max-width: 980px){ .cards{grid-template-columns:1fr} }
    .card{
      border:1px solid var(--line); border-radius:var(--radius2);
      background: rgba(255,255,255,.02);
      padding:12px; box-shadow: 0 8px 20px rgba(0,0,0,.18);
      transition: transform .08s ease;
    }
    .card:hover{transform: translateY(-1px); border-color: rgba(122,162,255,.55)}
    .card .top{display:flex;gap:10px; align-items:flex-start; justify-content:space-between}
    .card h3{margin:0;font-size:14px}
    .badge{
      font-size:11px; color:var(--muted);
      border:1px solid var(--line); background: rgba(255,255,255,.02);
      padding:4px 8px; border-radius:999px;
      white-space:nowrap;
    }
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .chips{display:flex;gap:8px;flex-wrap:wrap; margin-top:10px}
    .chip{background: rgba(255,255,255,.02); font-size:12px; padding:6px 10px}
    .chip.on{border-color: rgba(85,214,163,.75); background: rgba(85,214,163,.10)}
    .chip.off{opacity:.55}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .quote{
      border-left:3px solid rgba(122,162,255,.8);
      padding:8px 10px; background: rgba(122,162,255,.08);
      border-radius:12px;
      font-size:12.5px; line-height:1.4;
    }
    .list{margin:10px 0 0; padding-left:18px; font-size:12.5px; color:var(--text)}
    .list li{margin:6px 0}
    .callout{
      display:flex;gap:10px; align-items:flex-start;
      border:1px solid var(--line); border-radius:14px;
      padding:10px 10px; background: rgba(255,255,255,.02);
      margin-top:10px;
    }
    .dot{width:10px;height:10px;border-radius:999px;margin-top:4px;background:rgba(122,162,255,.85); flex:none}
    .callout .t{font-weight:650;font-size:12.5px}
    .callout .d{font-size:12px;color:var(--muted); margin-top:2px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:none}
    .select, textarea{
      width:100%;
      border:1px solid var(--line); border-radius:14px;
      background: rgba(255,255,255,.02);
      color:var(--text);
      padding:10px 12px;
      font-size:13px;
      outline:none;
    }
    textarea{min-height:150px; resize:vertical; line-height:1.4}
    .twoCol{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 980px){ .twoCol{grid-template-columns:1fr} }

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line); border-radius:999px; padding:6px 10px;
      font-size:12px; background: rgba(255,255,255,.02);
    }
    .pill b{font-family:var(--mono); font-size:11px; color:var(--muted)}
    .ok{color:var(--good)}
    .warnTxt{color:var(--warn)}
    .badTxt{color:var(--bad)}
    .footerNote{
      margin-top:12px; font-size:12px; color:var(--muted);
      border-top:1px solid var(--line); padding-top:10px;
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:18px; z-index:100;
    }
    .modal{
      width:min(980px, 98vw);
      max-height: min(90vh, 860px);
      overflow:auto;
      border:1px solid var(--line); border-radius:var(--radius2);
      background: var(--panel);
      box-shadow: var(--shadow);
    }
    .modal .mh{
      position:sticky; top:0;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.01));
      border-bottom:1px solid var(--line);
      padding:14px;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .modal .mh h3{margin:0;font-size:15px}
    .modal .mh p{margin:6px 0 0; font-size:12px; color:var(--muted)}
    .modal .mb{padding:14px}
    .closeX{font-size:13px}
    .sr{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
    }
    .tag{
      display:inline-block;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      padding:4px 8px;
      border-radius:999px;
      margin:4px 6px 0 0;
      font-size:11px;
      color:var(--muted);
    }
    .kbd{
      font-family:var(--mono);
      font-size:11px;
      border:1px solid var(--line);
      border-bottom-width:2px;
      padding:2px 6px;
      border-radius:8px;
      color:var(--muted);
      background: rgba(255,255,255,.02);
    }
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <div class="title">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>GP Psychosocial Needs ‚Äî SCA Revision (Offline)</h1>
          <p class="sub">
            Rapid recall for psychosocial management in GP consultations:
            services map, triggers, and ‚Äúnatural‚Äù high-scoring phrasing. Built for quick station closing + instant lookup.
          </p>
        </div>
      </div>

      <div class="controls">
        <div class="search" title="Search (press / to focus)">
          <span class="muted" style="font-size:13px">üîé</span>
          <input id="q" placeholder="Search: e.g., safeguarding, CAMHS, social prescriber, EPAU, DNACPR‚Ä¶" />
          <span class="k">/</span>
        </div>
        <button class="btn" id="themeBtn" title="Toggle light/dark">üåì Theme</button>
        <button class="btn" id="exportBtn" title="Export progress (JSON)">‚¨á Export</button>
        <button class="btn" id="importBtn" title="Import progress (JSON)">‚¨Ü Import</button>
        <input type="file" id="importFile" accept="application/json" hidden />
        <button class="btn bad" id="resetBtn" title="Reset all progress">‚Ü∫ Reset</button>
      </div>
    </header>

    <div class="grid">
      <!-- Left: Navigation -->
      <div class="panel">
        <div class="hd">
          <h2>Modes</h2>
          <p>Pick a workflow: <span class="kbd">Lookup</span>, <span class="kbd">Station Builder</span>, <span class="kbd">Flashcards</span>, <span class="kbd">Quiz</span>.</p>
          <div class="tabs" id="tabs"></div>

          <div class="kpiRow">
            <div class="kpi">
              <div class="n" id="kpiSeen">0</div>
              <div class="l">Flashcards reviewed</div>
              <div class="bar"><div id="kpiSeenBar"></div></div>
            </div>
            <div class="kpi">
              <div class="n" id="kpiMastered">0</div>
              <div class="l">Mastered (SR ‚â• 21d)</div>
              <div class="bar"><div id="kpiMasteredBar"></div></div>
            </div>
            <div class="kpi">
              <div class="n" id="kpiPins">0</div>
              <div class="l">Pinned items</div>
              <div class="bar"><div id="kpiPinsBar"></div></div>
            </div>
          </div>
        </div>
        <div class="bd" id="leftBody"></div>
      </div>

      <!-- Right: Content -->
      <div class="panel">
        <div class="hd" id="rightHeader">
          <h2 id="modeTitle">Lookup</h2>
          <p id="modeDesc">Find the right service/team fast, then close the station with a biopsychosocial summary.</p>
        </div>
        <div class="bd" id="rightBody"></div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mh">
        <div>
          <h3 id="modalTitle">Title</h3>
          <p id="modalSubtitle">Subtitle</p>
          <div id="modalTags"></div>
        </div>
        <div class="row">
          <button class="btn" id="pinBtn">üìå Pin</button>
          <button class="btn closeX" id="closeModal">‚úï Close</button>
        </div>
      </div>
      <div class="mb" id="modalBody"></div>
    </div>
  </div>

  <script>
    /**********************************************************************
     * Data (derived from the attached sources‚Äô frameworks)
     **********************************************************************/
    const DATA = {
      rings: [
        {name:"Medical", prompt:"Who treats the disease / manages red flags?", icon:"ü©∫"},
        {name:"Psychological", prompt:"Who supports coping/behaviour/mental health?", icon:"üß†"},
        {name:"Social", prompt:"Who helps function safely at home/work + reduces practical barriers?", icon:"üè†"},
      ],
      endOfStationCheck: [
        "Medical ‚Äî who treats the disease / what pathway keeps them safe?",
        "Psychological ‚Äî who supports coping, behaviour change, distress, risk?",
        "Social ‚Äî who helps them function safely (work, home, finance, housing, carers)?"
      ],
      rescueSentence:
        "At the moment we can manage this in primary care, but I‚Äôd want to involve additional support if things don‚Äôt improve or if the impact on you increases.",
      buckets: [
        {
          id:"acute",
          title:"Acute / Red Flags",
          badge:"Safety pathways",
          summary:"Same-day assessment, urgent diagnostics, or 2WW pathways when red flags present.",
          keyPhrase:"Given the red-flag features, this needs urgent secondary care assessment under the appropriate pathway.",
          services:[
            "Same-day secondary care assessment (A&E / AMU)",
            "2-week-wait cancer pathway (as indicated)",
            "EPAU (early pregnancy bleeding)",
            "Specialty: Neurology / Haematology / Gastroenterology / Urology",
            "Urgent diagnostics (US/CT/MRI via pathway)"
          ],
          triggers:[
            {t:"Chest pain / neuro deficit / syncope / severe headache", s:"A&E / AMU + specialty as indicated"},
            {t:"Haemoptysis / PR bleeding / weight loss + anaemia / suspected malignancy", s:"2WW pathway + urgent imaging/tests"},
            {t:"Early pregnancy bleeding", s:"EPAU / early pregnancy services"}
          ],
          scripts:[
            {title:"Red-flag framing (non-alarmist)", text:"I‚Äôm taking this seriously because there are a few features here that we class as red flags. The safest option is urgent assessment today under the appropriate pathway, so we don‚Äôt miss anything time-critical."},
            {title:"Safety-net (not robotic)", text:"If you notice worsening symptoms, new neurological signs, severe breathlessness, collapse, or you‚Äôre unsure, I‚Äôd want you to seek urgent help immediately ‚Äî it‚Äôs always safer to check."}
          ],
          tags:["same-day","2WW","EPAU","urgent"]
        },
        {
          id:"chronic",
          title:"Chronic Disease Optimisation",
          badge:"Self-management",
          summary:"Optimise control and adherence using specialist nurse teams + allied health + education.",
          keyPhrase:"I‚Äôd involve the specialist nurse team to support optimisation and self-management.",
          services:[
            "Disease-specific specialist nurses (COPD / asthma / diabetes / HF)",
            "Pulmonary rehabilitation (COPD)",
            "Podiatry + dietitian (diabetes)",
            "Renal clinic / endocrinology shared care (as needed)",
            "Community pharmacist for technique/adherence/med review"
          ],
          triggers:[
            {t:"COPD control issues / frequent exacerbations", s:"COPD nurse + pulmonary rehab + inhaler technique support"},
            {t:"Asthma poor control", s:"Asthma nurse + personal action plan"},
            {t:"Diabetes optimisation / insulin start", s:"DSN + structured education + podiatry"},
            {t:"HF / CKD complexity", s:"HF nurse / renal clinic shared care"}
          ],
          scripts:[
            {title:"Self-management pitch", text:"Medically we can optimise the treatment, but outcomes improve most when you‚Äôre supported to self-manage. I‚Äôd like our specialist nurse team to help with plans, triggers, technique, and follow-up."},
            {title:"Barrier-aware approach", text:"Sometimes it‚Äôs the practical barriers ‚Äî routines, work shifts, cost, or confidence with devices ‚Äî that derail control. We can tackle that directly rather than just escalating medication."}
          ],
          tags:["COPD nurse","asthma nurse","DSN","rehab","self-management"]
        },
        {
          id:"mhAdult",
          title:"Mental Health ‚Äî Adult",
          badge:"Risk + therapy",
          summary:"IAPT for mild‚Äìmoderate; CMHT/crisis for psychosis or significant risk; addiction services where relevant.",
          keyPhrase:"Psychological support alongside medical management is essential here.",
          services:[
            "NHS Talking Therapies / IAPT (CBT/counselling)",
            "CMHT (complex/severe, functional impairment)",
            "Crisis Resolution & Home Treatment Team (acute risk/suicidality/psychosis)",
            "Veterans‚Äô MH services (where applicable)",
            "Addiction services (alcohol/drugs/gambling)"
          ],
          triggers:[
            {t:"Low mood/anxiety without high risk", s:"NHS Talking Therapies / IAPT"},
            {t:"Active suicidal ideation / acute crisis", s:"Crisis team + same-day risk plan"},
            {t:"Psychosis / mania features", s:"CMHT / crisis resolution team (urgent)"},
            {t:"PTSD in veteran", s:"Veterans MH service"},
            {t:"Gambling/alcohol/drugs impacting function", s:"Addiction services + CBT"}
          ],
          scripts:[
            {title:"Therapy ‚Äòsell‚Äô (skills-based)", text:"Medication can dampen symptoms, but it doesn‚Äôt always teach strategies for the patterns that trigger them. CBT is practical and skills-based ‚Äî a toolkit to recognise unhelpful thoughts and change responses, which many patients find restores control."},
            {title:"Crisis escalation (examiner-safe)", text:"Given what you‚Äôve told me, I‚Äôd feel uncomfortable not getting extra support involved today. The safest option is urgent specialist input so you‚Äôre not carrying this alone."}
          ],
          tags:["IAPT","CBT","CMHT","crisis","addiction","veterans"]
        },
        {
          id:"mhChild",
          title:"Mental Health ‚Äî Child/Adolescent",
          badge:"CAMHS",
          summary:"Age + risk changes thresholds: CAMHS for moderate‚Äìsevere; CAMHS crisis where risk is high.",
          keyPhrase:"Because of age and risk, this needs urgent CAMHS involvement.",
          services:[
            "CAMHS (moderate/severe depression, self-harm, eating disorder, neurodevelopmental concerns)",
            "CAMHS crisis team (same-day if risk)",
            "School nurse / school counsellor",
            "Youth substance misuse services",
            "Safeguarding / social care if safety concerns"
          ],
          triggers:[
            {t:"Self-harm / suicidal ideation in teenager", s:"CAMHS crisis team (urgent)"},
            {t:"Eating disorder red flags", s:"CAMHS + paediatrics/acute if medically unstable"},
            {t:"Bullying/anxiety affecting school", s:"School nurse/counsellor + CAMHS if severe"},
            {t:"Substance misuse", s:"Youth substance misuse services + CAMHS if comorbid risk"}
          ],
          scripts:[
            {title:"Age threshold framing", text:"Because of your age and the changes you‚Äôre describing, specialist input is the safest option. This isn‚Äôt something I‚Äôd want to sit on."},
            {title:"School support normalisation", text:"Schools have a nurse/counsellor who can support discreetly and help bridge health and education ‚Äî it‚Äôs an extra layer of support, not you being ‚Äòin trouble‚Äô."}
          ],
          tags:["CAMHS","school nurse","youth services","risk"]
        },
        {
          id:"safeguarding",
          title:"Safeguarding & Domestic Abuse",
          badge:"Protective",
          summary:"Frame safeguarding as supportive, not punitive; escalate when immediate danger or child/vulnerable adult risk.",
          keyPhrase:"Safeguarding here is supportive and protective, not punitive.",
          services:[
            "Safeguarding team (children/adults) + social services",
            "IDVA (Independent Domestic Violence Advocate)",
            "MARAC (multi-agency risk assessment conference) where indicated",
            "Police only if immediate danger",
            "Women‚Äôs Aid / Men‚Äôs Aid (support pathways)"
          ],
          triggers:[
            {t:"Disclosure of domestic abuse / coercive control", s:"IDVA + safeguarding pathway + safety planning"},
            {t:"Child risk / neglect / missed appointments pattern", s:"Safeguarding children + social care (early help or escalation)"},
            {t:"Vulnerable adult abuse/neglect", s:"Adult safeguarding team"},
            {t:"Immediate danger", s:"Police / emergency response"}
          ],
          scripts:[
            {title:"Supportive safeguarding explanation", text:"My role is to make sure everyone is safe and supported. Safeguarding isn‚Äôt about getting anyone into trouble ‚Äî it‚Äôs about bringing in extra support so you‚Äôre not managing this level of risk alone."},
            {title:"If resistance", text:"I hear your concerns. We can go at a pace that feels manageable, but given what you‚Äôve told me I do have a duty of care to share this so we can build a safety net."}
          ],
          tags:["IDVA","MARAC","children","adult safeguarding","DV"]
        },
        {
          id:"womens",
          title:"Women‚Äôs Health & Pregnancy",
          badge:"Midwifery + safety",
          summary:"EPAU for early bleeding; midwifery early; safeguarding where vulnerability; perinatal MH when needed.",
          keyPhrase:"Early multi-disciplinary input improves outcomes.",
          services:[
            "EPAU (early pregnancy bleeding)",
            "Community midwives (coordination and engagement)",
            "Sexual health / GUM clinic (STI/contraception support as needed)",
            "Perinatal mental health team (up to 1 year postpartum) where significant symptoms",
            "Safeguarding if vulnerability/DA/teen pregnancy"
          ],
          triggers:[
            {t:"Early pregnancy bleeding", s:"EPAU"},
            {t:"Teen pregnancy / vulnerability / DA", s:"Midwifery + safeguarding/early help + IDVA if DA"},
            {t:"Postnatal severe anxiety/depression/psychosis risk", s:"Perinatal MH team (urgent if risk)"},
          ],
          scripts:[
            {title:"Midwifery coordination", text:"I‚Äôd like to link you in with midwifery services early so your care is coordinated and you‚Äôve got consistent support."},
            {title:"Perinatal MH escalation", text:"Because symptoms in pregnancy/postpartum can escalate quickly, specialist perinatal support is important ‚Äî we can still treat the physical aspects while supporting coping and bonding."}
          ],
          tags:["EPAU","midwives","perinatal MH","GUM","safeguarding"]
        },
        {
          id:"paeds",
          title:"Paediatrics (Non-MH)",
          badge:"Family unit",
          summary:"Support the child and the family system: health visitors, school nurse, dietetics, safeguarding if non-attendance.",
          keyPhrase:"We need to support the family unit, not just treat the child.",
          services:[
            "Health visitor (under 5s, development/feeding/parental support)",
            "School nurse (school-age issues impacting attendance/wellbeing)",
            "Paediatric outpatient referral (as indicated)",
            "Dietitian (obesity/faltering growth)",
            "Safeguarding if repeated DNAs / risk concerns"
          ],
          triggers:[
            {t:"Under-5 behaviour/feeding/development concerns", s:"Health visitor"},
            {t:"School attendance issues / chronic symptoms", s:"School nurse + paediatrics if needed"},
            {t:"Growth/weight concerns", s:"Dietitian + paediatric review"},
            {t:"Repeated DNAs + concern", s:"Safeguarding consideration"}
          ],
          scripts:[
            {title:"Family framing", text:"With children, treating the symptom is only part of it. Supporting routines, school, and the family‚Äôs capacity often makes the biggest difference."},
            {title:"Non-attendance", text:"If appointments are being missed, I‚Äôd want to understand barriers first, but we also have to consider safeguarding if a pattern suggests unmet health needs."}
          ],
          tags:["health visitor","school nurse","dietitian","DNA"]
        },
        {
          id:"frailty",
          title:"Frailty / Cognition / Capacity",
          badge:"Function + safety",
          summary:"Holistic functional assessment: memory clinic, OT, community geriatrics; adult safeguarding if concerns.",
          keyPhrase:"This needs a holistic functional assessment.",
          services:[
            "Memory clinic (formal cognitive assessment)",
            "OT / community geriatrics (home safety, aids, function)",
            "Adult safeguarding team (abuse/neglect/care concerns)",
            "Best-interest MDT (capacity concerns)"
          ],
          triggers:[
            {t:"Memory complaints / functional decline", s:"Memory clinic + functional assessment"},
            {t:"Falls / home hazards / ADL impairment", s:"OT + community geriatrics"},
            {t:"Capacity concerns for major decisions", s:"Best-interest MDT approach"},
            {t:"Care home / neglect concerns", s:"Adult safeguarding"}
          ],
          scripts:[
            {title:"Capacity tone", text:"I want to make sure decisions reflect your values and are made safely. If capacity is uncertain, we can use a best-interests approach with the right multidisciplinary input."},
            {title:"OT value", text:"Often we can keep people safer at home by reducing hazards and adding aids ‚Äî OT input can be transformative and prevents deterioration."}
          ],
          tags:["memory clinic","OT","capacity","adult safeguarding"]
        },
        {
          id:"palliative",
          title:"Palliative & End-of-Life",
          badge:"Comfort + preferences",
          summary:"Quality of life focus with community palliative care, hospice, district nurses, ACP/DNACPR framing.",
          keyPhrase:"The focus here is comfort, dignity, and respecting patient preferences.",
          services:[
            "Community palliative care team / hospice",
            "District nurses (home symptom control, practical care)",
            "Gold Standards Framework (planning/coordination)",
            "SR1 (DS1500) where appropriate + social prescriber for practical needs"
          ],
          triggers:[
            {t:"Advanced cancer / escalating symptoms", s:"Community palliative care + hospice support"},
            {t:"Home care needs / injections / wound care / syringe driver support", s:"District nurses + palliative team"},
            {t:"Financial/practical stress in serious illness", s:"SR1 (DS1500) + social prescriber"}
          ],
          scripts:[
            {title:"Palliative reframing", text:"At this stage, the priority is comfort and quality of life. We can still do a lot, even if we‚Äôre not trying to cure the illness ‚Äî and you don‚Äôt have to wait until things worsen to involve palliative support."},
            {title:"DNACPR framing", text:"This isn‚Äôt about giving up. It‚Äôs about making sure your wishes are respected, and avoiding intrusive treatments that are unlikely to help, while continuing active comfort care."}
          ],
          tags:["palliative","hospice","district nurses","GSF","SR1","DNACPR"]
        },
        {
          id:"social",
          title:"Social / Functional Issues",
          badge:"Practical determinants",
          summary:"Use social prescriber early: finance, housing, carers, work, isolation. Occupational health + fit note framing.",
          keyPhrase:"Addressing the social context is key to improving outcomes.",
          services:[
            "Social prescriber / link worker",
            "Citizens Advice / debt support signposting",
            "Carers‚Äô support services",
            "Local authority housing support",
            "Occupational health + fit note (amended duties where possible)",
            "Pet-care support charities when admission is refused due to pets (where locally available)"
          ],
          triggers:[
            {t:"Debt/housing insecurity/social isolation", s:"Social prescriber + targeted signposting"},
            {t:"Carer strain / burnout", s:"Carers‚Äô support assessment + respite options"},
            {t:"Work limitation due to health", s:"Fit note for amended duties + occupational health"}
          ],
          scripts:[
            {title:"Social prescriber ‚Äòsell‚Äô (health linkage)", text:"I can hear how heavy the practical stress is. As your GP, I‚Äôm concerned it‚Äôs fuelling your symptoms and making treatments less effective. We have a social prescriber who can work through options and advocate ‚Äî would you be open to me connecting you?" },
            {title:"Fit note framing (return-to-work as recovery tool)", text:"Staying off work completely for a long time can increase isolation and slow recovery. We can use a fit note for amended duties ‚Äî keeping you protected while staying connected and paid."}
          ],
          tags:["social prescriber","housing","debt","carers","fit note","occupational health"]
        },
        {
          id:"sexual",
          title:"Sexual Health & Confidentiality",
          badge:"Discreet expert care",
          summary:"GUM/sexual health clinics for testing, treatment, contact tracing, complex contraception; emphasise confidentiality.",
          keyPhrase:"Care is confidential and patient-led.",
          services:[
            "GUM / sexual health clinic (STI screen, treatment, contact tracing)",
            "HIV services where relevant",
            "Confidentiality: records separation / restricted access where applicable",
            "Counselling/support where identity/relationship stressors"
          ],
          triggers:[
            {t:"STI symptoms / exposure / testing request", s:"Sexual health clinic (often self-refer)"},
            {t:"Embarrassment / stigma concern", s:"Emphasise discretion + expertise"},
            {t:"Complex contraception needs", s:"Sexual health clinic / specialist service"}
          ],
          scripts:[
            {title:"Non-judgemental referral", text:"Thank you for being open. A sexual health clinic is the best place for fast, thorough testing and same-day treatment where needed. They‚Äôre discreet, and their records are separate from routine GP notes in many areas."},
            {title:"Patient-led confidentiality", text:"Care is confidential and patient-led. We can discuss what is and isn‚Äôt shared, and put sensible privacy measures in place."}
          ],
          tags:["GUM","STI","confidentiality","HIV","contraception"]
        }
      ],
      phrases: [
        {id:"bridge1", title:"Medical ‚Üí Psychological bridge", tags:["holistic"], text:"Medically, we have a plan, but I‚Äôm also conscious this is taking a toll on you."},
        {id:"bridge2", title:"‚ÄúBigger picture‚Äù transition", tags:["structure"], text:"Let me take a step back and think about the bigger picture ‚Äî there are a few strands we need to address at the same time."},
        {id:"safenet", title:"Safety-netting (non-robotic)", tags:["safety"], text:"I‚Äôll be clear about what would worry me. If you notice X or Y, I‚Äôd want you to seek urgent help ‚Äî if you‚Äôre unsure, it‚Äôs always safer to check."},
        {id:"follow", title:"Follow-up ownership", tags:["continuity"], text:"I don‚Äôt want this to feel like a one-off conversation ‚Äî let‚Äôs keep this under review and make a clear follow-up plan."},
        {id:"summaryGold", title:"Biopsychosocial station summary", tags:["closing"], text:"To summarise ‚Äî we‚Äôve got a clear medical plan, we‚Äôve talked about how this is affecting you emotionally, and we‚Äôve identified extra support to help day-to-day."},
        {id:"rescue", title:"One sentence that rescues borderline stations", tags:["closing","judgement"], text:"At the moment we can manage this in primary care, but I‚Äôd want to involve additional support if things don‚Äôt improve or if the impact on you increases."}
      ]
    };

    /**********************************************************************
     * Storage + Utilities
     **********************************************************************/
    const STORE_KEY = "gp_psychosocial_sca_v1";
    const now = () => Date.now();
    const clamp = (x,a,b)=>Math.min(b,Math.max(a,x));
    const fmtDate = (ms) => {
      const d = new Date(ms);
      return d.toLocaleDateString(undefined, {year:"numeric",month:"short",day:"2-digit"});
    };
    const uid = () => Math.random().toString(16).slice(2) + "_" + Math.random().toString(16).slice(2);

    function loadState(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){ return null; }
    }
    function saveState(st){
      localStorage.setItem(STORE_KEY, JSON.stringify(st));
    }

    // SM-2-ish (simple) spaced repetition
    // q: 0-again,1-hard,2-good,3-easy
    function srUpdate(card, grade){
      // card: {interval, ease, due, reps, lapses}
      const g = grade;
      card.reps = (card.reps||0) + 1;
      card.ease = card.ease ?? 2.3;
      card.interval = card.interval ?? 0;
      card.lapses = card.lapses ?? 0;

      if(g === 0){
        card.lapses += 1;
        card.interval = 1;
        card.ease = clamp(card.ease - 0.2, 1.3, 2.8);
      }else{
        if(card.interval < 1) card.interval = 1;
        if(card.interval === 1) card.interval = 3;
        else if(card.interval === 3) card.interval = 7;
        else{
          const mult = (g===1?1.1:(g===2?card.ease:(card.ease+0.15)));
          card.interval = Math.round(card.interval * mult);
        }
        card.ease = clamp(card.ease + (g===3?0.08:(g===2?0.02:(-0.05))), 1.3, 2.8);
      }
      const dueMs = now() + card.interval*24*3600*1000;
      card.due = dueMs;
      return card;
    }

    function defaultState(){
      const st = {
        theme: "dark",
        mode: "lookup",
        pins: {}, // id: true
        // flashcards: generated from buckets/phrases/scripts with SR metadata
        fc: {}, // cardId: {interval,ease,due,reps,lapses,seen}
        stats: {seen:0},
        lastQuiz: null
      };
      return st;
    }

    let STATE = loadState() || defaultState();

    function setTheme(theme){
      STATE.theme = theme;
      document.documentElement.dataset.theme = theme === "light" ? "light" : "dark";
      saveState(STATE);
    }

    /**********************************************************************
     * Build Flashcard bank
     **********************************************************************/
    function buildFlashcards(){
      const cards = [];

      // Bucket cards: trigger -> service, key phrase, station close checklists
      for(const b of DATA.buckets){
        cards.push({
          id:`bucket::${b.id}::key`,
          topic:b.title,
          type:"Key phrase",
          front:`Key line to say for: ${b.title}`,
          back:b.keyPhrase
        });
        for(const tr of b.triggers){
          cards.push({
            id:`bucket::${b.id}::tr::${uid()}`,
            topic:b.title,
            type:"Trigger ‚Üí Service",
            front:`If the station shows: ${tr.t}`,
            back:`Name: ${tr.s}`
          });
        }
        for(const sc of b.scripts){
          cards.push({
            id:`bucket::${b.id}::sc::${uid()}`,
            topic:b.title,
            type:"Script",
            front:`Say this naturally when relevant (${b.title}): ${sc.title}`,
            back: sc.text
          });
        }
      }

      // Global phrases
      for(const p of DATA.phrases){
        cards.push({
          id:`phrase::${p.id}`,
          topic:"High-scoring phrasing",
          type:"Phrase",
          front:p.title,
          back:p.text
        });
      }

      // End-of-station check
      cards.push({
        id:"global::endcheck",
        topic:"Station closing",
        type:"Checklist",
        front:"10-second end-of-station check",
        back: DATA.endOfStationCheck.map(x=>"‚Ä¢ "+x).join("\n")
      });

      return cards;
    }

    const FLASHCARDS = buildFlashcards();

    function getCardMeta(cardId){
      if(!STATE.fc[cardId]){
        STATE.fc[cardId] = {interval:0,ease:2.3,due:0,reps:0,lapses:0,seen:0};
        saveState(STATE);
      }
      return STATE.fc[cardId];
    }

    function isDue(meta){
      return !meta.due || meta.due <= now();
    }

    /**********************************************************************
     * UI Rendering
     **********************************************************************/
    const $ = (id)=>document.getElementById(id);
    const el = (tag, attrs={}, children=[])=>{
      const e = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)){
        if(k==="class") e.className=v;
        else if(k==="html") e.innerHTML=v;
        else if(k.startsWith("on") && typeof v==="function") e.addEventListener(k.slice(2), v);
        else e.setAttribute(k, v);
      }
      for(const c of children){
        if(typeof c==="string") e.appendChild(document.createTextNode(c));
        else if(c) e.appendChild(c);
      }
      return e;
    };

    const MODES = [
      {id:"lookup", title:"Lookup", desc:"Fast services map + scripts. Click a bucket to open details. Pin what you forget."},
      {id:"builder", title:"Station Builder", desc:"Select station archetypes and auto-generate a biopsychosocial closing summary + referrals."},
      {id:"flashcards", title:"Flashcards", desc:"Active recall with spaced repetition (offline)."},
      {id:"quiz", title:"Quiz", desc:"Trigger ‚Üí Service MCQ drill (fast pattern recognition)."},
    ];

    function renderTabs(){
      const tabs = $("tabs");
      tabs.innerHTML = "";
      for(const m of MODES){
        const t = el("button", {class:"tab"+(STATE.mode===m.id?" active":""), onclick:()=>setMode(m.id)}, [m.title]);
        tabs.appendChild(t);
      }
      const cur = MODES.find(x=>x.id===STATE.mode) || MODES[0];
      $("modeTitle").textContent = cur.title;
      $("modeDesc").textContent = cur.desc;
    }

    function setMode(mode){
      STATE.mode = mode;
      saveState(STATE);
      render();
    }

    function renderKPIs(){
      const total = FLASHCARDS.length;
      let seen=0, mastered=0;
      for(const c of FLASHCARDS){
        const meta = STATE.fc[c.id];
        if(meta?.seen) seen += 1;
        if((meta?.interval||0) >= 21) mastered += 1;
      }
      const pins = Object.keys(STATE.pins||{}).length;

      $("kpiSeen").textContent = String(seen);
      $("kpiMastered").textContent = String(mastered);
      $("kpiPins").textContent = String(pins);

      $("kpiSeenBar").style.width = `${Math.round(100*seen/Math.max(1,total))}%`;
      $("kpiMasteredBar").style.width = `${Math.round(100*mastered/Math.max(1,total))}%`;
      $("kpiPinsBar").style.width = `${Math.round(100*clamp(pins,0,50)/50)}%`;
    }

    function matchesQuery(obj, q){
      if(!q) return true;
      const s = JSON.stringify(obj).toLowerCase();
      return s.includes(q.toLowerCase());
    }

    function renderLeft(){
      const left = $("leftBody");
      left.innerHTML = "";

      const pinnedIds = Object.keys(STATE.pins||{});
      if(pinnedIds.length){
        const p = el("div", {class:"callout"}, [
          el("div",{class:"dot", style:"background:rgba(255,210,122,.9)"}),
          el("div",{},[
            el("div",{class:"t"} ,["Pinned quick links"]),
            el("div",{class:"d"},["Click to reopen. Keep this list small = high-yield."])
          ])
        ]);
        left.appendChild(p);

        const list = el("div",{class:"chips"});
        for(const id of pinnedIds){
          const item = pinLabel(id);
          const chip = el("button",{class:"chip on", onclick:()=>openPinned(id)},[item]);
          list.appendChild(chip);
        }
        left.appendChild(list);
        left.appendChild(el("div",{class:"divider"}));
      }

      // Always show the 10-second check
      left.appendChild(el("div", {class:"quote"}, [
        el("div",{class:"small"},[
          el("span",{class:"muted"},["‚ö° 10-second end-of-station check: "]),
          el("span",{},["Medical ‚Üí Psychological ‚Üí Social"])
        ]),
        el("ul",{class:"list"}, DATA.endOfStationCheck.map(x=>el("li",{},[x])))
      ]));

      left.appendChild(el("div",{class:"callout"},[
        el("div",{class:"dot", style:"background:rgba(85,214,163,.9)"}),
        el("div",{},[
          el("div",{class:"t"},["Borderline rescue line"]),
          el("div",{class:"d"},[DATA.rescueSentence])
        ])
      ]));

      left.appendChild(el("div",{class:"divider"}));

      // Mode-specific helpers
      if(STATE.mode==="lookup"){
        left.appendChild(el("div",{class:"small muted"},[
          "Tip: press ",
          el("span",{class:"kbd"},["/"]),
          " to search. Pin the ones you keep forgetting."
        ]));
      }
      if(STATE.mode==="flashcards"){
        const due = FLASHCARDS.filter(c=>isDue(getCardMeta(c.id))).length;
        left.appendChild(el("div",{class:"callout"},[
          el("div",{class:"dot"}),
          el("div",{},[
            el("div",{class:"t"},["Due today"]),
            el("div",{class:"d"},[`${due} cards due. Keep sessions short and frequent.`])
          ])
        ]));
      }
      if(STATE.mode==="quiz"){
        left.appendChild(el("div",{class:"small muted"},[
          "Aim: rapid recognition. Don‚Äôt overthink ‚Äî pick the most exam-expected service/team."
        ]));
      }
    }

    function pinLabel(id){
      // ids can be "bucket:acute" or "phrase:rescue" etc
      if(id.startsWith("bucket:")){
        const bid = id.split(":")[1];
        const b = DATA.buckets.find(x=>x.id===bid);
        return b ? `Bucket ‚Äî ${b.title}` : id;
      }
      if(id.startsWith("phrase:")){
        const pid = id.split(":")[1];
        const p = DATA.phrases.find(x=>x.id===pid);
        return p ? `Phrase ‚Äî ${p.title}` : id;
      }
      if(id.startsWith("script:")){
        const parts = id.split(":"); // script:bucketId:index
        const b = DATA.buckets.find(x=>x.id===parts[1]);
        const idx = parseInt(parts[2],10);
        const sc = b?.scripts?.[idx];
        return sc ? `Script ‚Äî ${sc.title}` : id;
      }
      return id;
    }

    function openPinned(id){
      if(id.startsWith("bucket:")){
        openBucket(id.split(":")[1]);
      }else if(id.startsWith("phrase:")){
        openPhrase(id.split(":")[1]);
      }else if(id.startsWith("script:")){
        const parts = id.split(":");
        const b = DATA.buckets.find(x=>x.id===parts[1]);
        const idx = parseInt(parts[2],10);
        const sc = b?.scripts?.[idx];
        if(b && sc) openScript(b, idx);
      }
    }

    function renderRight(){
      const q = $("q").value.trim();

      const right = $("rightBody");
      right.innerHTML = "";

      if(STATE.mode==="lookup"){
        const filtered = DATA.buckets.filter(b=>matchesQuery(b,q));
        right.appendChild(el("div",{class:"cards"},
          filtered.map(b=>bucketCard(b))
        ));
        if(!filtered.length){
          right.appendChild(el("div",{class:"callout"},[
            el("div",{class:"dot", style:"background:rgba(255,122,147,.9)"}),
            el("div",{},[
              el("div",{class:"t"},["No results"]),
              el("div",{class:"d"},["Try searching for a team (e.g., IAPT, IDVA, CAMHS) or a theme (safeguarding, DNACPR, work, housing)."])
            ])
          ]));
        }
      }

      if(STATE.mode==="builder"){
        right.appendChild(renderBuilder());
      }

      if(STATE.mode==="flashcards"){
        right.appendChild(renderFlashcards());
      }

      if(STATE.mode==="quiz"){
        right.appendChild(renderQuiz());
      }
    }

    function bucketCard(b){
      const pinId = `bucket:${b.id}`;
      const pinned = !!STATE.pins[pinId];

      const e = el("div",{class:"card"},[
        el("div",{class:"top"},[
          el("div",{},[
            el("h3",{},[b.title]),
            el("div",{class:"small muted", style:"margin-top:4px"},[b.summary])
          ]),
          el("div",{class:"badge"},[b.badge])
        ]),
        el("div",{class:"chips"},[
          el("button",{class:"chip"+(pinned?" on":""), onclick:(ev)=>{ev.stopPropagation(); togglePin(pinId);}},[pinned?"üìå Pinned":"üìå Pin"]),
          el("button",{class:"chip", onclick:(ev)=>{ev.stopPropagation(); openBucket(b.id);}},["Open ‚Üí"]),
        ]),
        el("div",{class:"divider"}),
        el("div",{class:"quote"},[
          el("b",{},["Key line: "]),
          b.keyPhrase
        ]),
        el("div",{class:"chips"}, (b.tags||[]).slice(0,6).map(t=>el("span",{class:"tag"},[t])))
      ]);
      e.addEventListener("click", ()=>openBucket(b.id));
      return e;
    }

    function togglePin(id){
      STATE.pins = STATE.pins || {};
      if(STATE.pins[id]) delete STATE.pins[id];
      else STATE.pins[id] = true;
      saveState(STATE);
      renderLeft();
      renderKPIs();
      // keep right intact
    }

    function openModal({title, subtitle, tags=[], pinId=null, bodyNodes=[]}){
      $("modalTitle").textContent = title;
      $("modalSubtitle").textContent = subtitle || "";
      const tagWrap = $("modalTags");
      tagWrap.innerHTML = "";
      for(const t of tags){
        tagWrap.appendChild(el("span",{class:"tag"},[t]));
      }

      const pinBtn = $("pinBtn");
      if(pinId){
        pinBtn.style.display = "inline-flex";
        const pinned = !!STATE.pins[pinId];
        pinBtn.textContent = pinned ? "üìå Unpin" : "üìå Pin";
        pinBtn.onclick = ()=>{togglePin(pinId); pinBtn.textContent = STATE.pins[pinId] ? "üìå Unpin" : "üìå Pin";};
      }else{
        pinBtn.style.display = "none";
      }

      const mb = $("modalBody");
      mb.innerHTML = "";
      for(const n of bodyNodes) mb.appendChild(n);

      $("modalBack").style.display = "flex";
      document.body.style.overflow = "hidden";
    }

    function closeModal(){
      $("modalBack").style.display = "none";
      document.body.style.overflow = "";
    }

    function openBucket(bucketId){
      const b = DATA.buckets.find(x=>x.id===bucketId);
      if(!b) return;

      const nodes = [];

      nodes.push(el("div",{class:"quote"},[
        el("b",{},["Key line to say: "]),
        b.keyPhrase
      ]));

      nodes.push(el("div",{class:"divider"}));

      nodes.push(el("div",{class:"twoCol"},[
        el("div",{},[
          el("h3",{style:"margin:0 0 8px;font-size:13px"},["Expected services/teams"]),
          el("ul",{class:"list"}, b.services.map(x=>el("li",{},[x])))
        ]),
        el("div",{},[
          el("h3",{style:"margin:0 0 8px;font-size:13px"},["Triggers ‚Üí what to name"]),
          el("ul",{class:"list"}, b.triggers.map(x=>el("li",{},[
            el("b",{},[x.t]),
            el("span",{class:"muted"},[" ‚Üí "]),
            x.s
          ])))
        ])
      ]));

      nodes.push(el("div",{class:"divider"}));

      nodes.push(el("h3",{style:"margin:0 0 8px;font-size:13px"},["Exam-safe scripts (natural phrasing)"]));

      b.scripts.forEach((sc, idx)=>{
        const pinId = `script:${b.id}:${idx}`;
        const pinned = !!STATE.pins[pinId];
        nodes.push(el("div",{class:"card", style:"margin:10px 0"},[
          el("div",{class:"top"},[
            el("div",{},[
              el("h3",{},[sc.title]),
              el("div",{class:"small muted", style:"margin-top:4px"},["Use when the station needs you to ‚Äòsell‚Äô support/referral without sounding checklisty."])
            ]),
            el("div",{class:"badge"},["Script"])
          ]),
          el("div",{class:"quote"},[sc.text]),
          el("div",{class:"chips"},[
            el("button",{class:"chip"+(pinned?" on":""), onclick:()=>togglePin(pinId)},[pinned?"üìå Pinned":"üìå Pin"]),
            el("button",{class:"chip", onclick:()=>copyText(sc.text)},["Copy"])
          ])
        ]));
      });

      nodes.push(el("div",{class:"divider"}));

      nodes.push(el("div",{class:"callout"},[
        el("div",{class:"dot"}),
        el("div",{},[
          el("div",{class:"t"},["Close the station in one line"]),
          el("div",{class:"d"},["To summarise ‚Äî clear medical plan, emotional impact acknowledged, and practical support to function day-to-day."])
        ])
      ]));

      openModal({
        title: b.title,
        subtitle: b.summary,
        tags: b.tags || [],
        pinId: `bucket:${b.id}`,
        bodyNodes: nodes
      });
    }

    function openScript(bucket, idx){
      const sc = bucket.scripts[idx];
      openModal({
        title: sc.title,
        subtitle: bucket.title,
        tags: bucket.tags || [],
        pinId: `script:${bucket.id}:${idx}`,
        bodyNodes: [
          el("div",{class:"quote"},[sc.text]),
          el("div",{class:"chips"},[
            el("button",{class:"chip"}, {onclick:()=>copyText(sc.text)}, ["Copy"]),
            el("button",{class:"chip"}, {onclick:()=>openBucket(bucket.id)}, ["Open bucket ‚Üí"])
          ])
        ]
      });
    }

    function openPhrase(pid){
      const p = DATA.phrases.find(x=>x.id===pid);
      if(!p) return;
      openModal({
        title: p.title,
        subtitle: "High-scoring phrasing",
        tags: p.tags || [],
        pinId: `phrase:${p.id}`,
        bodyNodes: [
          el("div",{class:"quote"},[p.text]),
          el("div",{class:"chips"},[
            el("button",{class:"chip"}, {onclick:()=>copyText(p.text)}, ["Copy"]),
          ])
        ]
      });
    }

    function copyText(txt){
      navigator.clipboard?.writeText(txt).catch(()=>{});
    }

    /**********************************************************************
     * Builder Mode
     **********************************************************************/
    function renderBuilder(){
      const wrap = el("div",{},[]);
      const q = $("q").value.trim().toLowerCase();

      const helper = el("div",{class:"callout"},[
        el("div",{class:"dot"}),
        el("div",{},[
          el("div",{class:"t"},["Station Builder"]),
          el("div",{class:"d"},[
            "Pick 1‚Äì2 archetypes that fit the station. The app generates a biopsychosocial closing summary + likely services to name."
          ])
        ])
      ]);
      wrap.appendChild(helper);

      const choices = DATA.buckets.filter(b=>!q || matchesQuery(b,q));

      const chosen = new Set();
      const selectedKey = "builder_selected";
      const prev = STATE[selectedKey] || [];
      prev.forEach(x=>chosen.add(x));

      const grid = el("div",{class:"cards", style:"margin-top:12px"}, choices.map(b=>{
        const on = chosen.has(b.id);
        const c = el("div",{class:"card"},[
          el("div",{class:"top"},[
            el("div",{},[
              el("h3",{},[b.title]),
              el("div",{class:"small muted", style:"margin-top:4px"},[b.badge+" ‚Ä¢ "+b.summary])
            ]),
            el("div",{class:"badge"},[on?"Selected":"Click to select"])
          ]),
          el("div",{class:"chips"},[
            el("button",{class:"chip"+(on?" on":""), onclick:(ev)=>{ev.stopPropagation(); toggleSelect(b.id);}},[on?"‚úì Selected":"Ôºã Select"]),
            el("button",{class:"chip", onclick:(ev)=>{ev.stopPropagation(); openBucket(b.id);}},["Preview ‚Üí"])
          ])
        ]);
        c.addEventListener("click",()=>toggleSelect(b.id));
        return c;
      }));
      wrap.appendChild(grid);

      const out = el("div",{class:"divider"});
      wrap.appendChild(out);

      const outputBox = el("div",{class:"twoCol"},[
        el("div",{},[
          el("h3",{style:"margin:0 0 8px;font-size:13px"},["Generated: services to name (high yield)"]),
          el("div",{id:"builderServices"})
        ]),
        el("div",{},[
          el("h3",{style:"margin:0 0 8px;font-size:13px"},["Generated: biopsychosocial closing summary"]),
          el("textarea",{id:"builderSummary", spellcheck:"false"})
        ])
      ]);
      wrap.appendChild(outputBox);

      const buttons = el("div",{class:"row", style:"margin-top:10px"},[
        el("button",{class:"btn primary", onclick:()=>regenBuilder()},["‚Üª Regenerate"]),
        el("button",{class:"btn good", onclick:()=>copyText($("builderSummary").value)},["Copy summary"]),
        el("button",{class:"btn", onclick:()=>{STATE[selectedKey]=[]; saveState(STATE); render();}},["Clear selection"])
      ]);
      wrap.appendChild(buttons);

      const note = el("div",{class:"footerNote"},[
        "Technique: you‚Äôre not scored for naming obscure services; you‚Äôre scored for recognising the archetype, naming 1‚Äì2 appropriate teams, and explaining why it improves safety/outcomes."
      ]);
      wrap.appendChild(note);

      function toggleSelect(id){
        if(chosen.has(id)) chosen.delete(id);
        else{
          // keep to max 2 by default; exam-realistic
          if(chosen.size >= 2){
            const first = chosen.values().next().value;
            chosen.delete(first);
          }
          chosen.add(id);
        }
        STATE[selectedKey] = Array.from(chosen);
        saveState(STATE);
        regenBuilder();
        render(); // refresh labels/badges
      }

      function regenBuilder(){
        const sel = Array.from(chosen).map(id=>DATA.buckets.find(b=>b.id===id)).filter(Boolean);
        const services = [];
        const phrases = [];

        // Construct management + rationale
        for(const b of sel){
          // high-yield: key phrase + top 4 services
          phrases.push(`‚Ä¢ ${b.title}: ${b.keyPhrase}`);
          b.services.slice(0,4).forEach(s=>services.push(`‚Ä¢ ${s}`));
        }

        // Ensure biopsychosocial closure exists even with 1 selection
        const closing =
`Medically, we have a clear plan: ${sel[0]?.keyPhrase || "appropriate assessment/treatment and safety-netting."}
Psychologically, I want to acknowledge the impact this is having, and offer support (for example talking therapies if relevant).
Socially, I‚Äôd like to address practical barriers to recovery (work, housing, finances, carers) and involve our social prescriber where helpful.

To summarise ‚Äî we‚Äôve got a clear medical plan, we‚Äôve talked about how this is affecting you emotionally, and we‚Äôve identified extra support to help you manage day to day.`;

        $("builderSummary").value = closing;

        const sv = $("builderServices");
        sv.innerHTML = "";
        const svcCard = el("div",{class:"card"},[
          el("div",{class:"quote"},[
            el("b",{},["Say (archetype lines): "]),
            "\n"+(phrases.length?phrases.join("\n"):"‚Ä¢ Pick a bucket to generate lines.")
          ]),
          el("div",{class:"divider"}),
          el("div",{class:"small muted"},["Name 1‚Äì2 services confidently (not a long list):"]),
          el("pre",{style:"white-space:pre-wrap;margin:10px 0 0;font-size:12.5px;color:var(--text);background:rgba(255,255,255,.02);border:1px solid var(--line);padding:10px;border-radius:14px"},[
            (services.length?services.join("\n"):"Select an archetype above.")
          ])
        ]);
        sv.appendChild(svcCard);
      }

      // initial generation
      regenBuilder();
      return wrap;
    }

    /**********************************************************************
     * Flashcards Mode
     **********************************************************************/
    function renderFlashcards(){
      const wrap = el("div",{},[]);
      const q = $("q").value.trim().toLowerCase();

      const dueCards = FLASHCARDS.filter(c=>{
        if(q && !(c.topic.toLowerCase().includes(q) || c.front.toLowerCase().includes(q) || c.back.toLowerCase().includes(q))) return false;
        return isDue(getCardMeta(c.id));
      });

      const allMatch = FLASHCARDS.filter(c=>{
        if(!q) return true;
        return c.topic.toLowerCase().includes(q) || c.front.toLowerCase().includes(q) || c.back.toLowerCase().includes(q);
      });

      const top = el("div",{class:"callout"},[
        el("div",{class:"dot"}),
        el("div",{},[
          el("div",{class:"t"},["Flashcards (Spaced repetition)"]),
          el("div",{class:"d"},[
            `${dueCards.length} due now. Search filters the deck.`
          ])
        ])
      ]);
      wrap.appendChild(top);

      const row = el("div",{class:"row", style:"margin-top:10px"},[
        el("button",{class:"btn primary", onclick:()=>nextCard()},["Start / Next due"]),
        el("span",{class:"pill"},[el("b",{},["Deck"]), ` ${allMatch.length} cards match`]),
        el("span",{class:"pill"},[el("b",{},["Due"]), ` ${dueCards.length}`]),
      ]);
      wrap.appendChild(row);

      const stage = el("div",{class:"card", style:"margin-top:12px"},[
        el("div",{class:"small muted"},["Press Next to begin. Review quickly; aim for fluency not perfection."]),
        el("div",{class:"divider"}),
        el("div",{id:"fcMeta", class:"sr"}),
        el("h3",{id:"fcFront", style:"margin:8px 0 0;font-size:15px"},[""]),
        el("div",{class:"divider"}),
        el("div",{id:"fcBackWrap", style:"display:none"},[
          el("div",{class:"quote", id:"fcBack"},[""])
        ]),
        el("div",{class:"chips", style:"margin-top:12px"},[
          el("button",{class:"chip", id:"revealBtn", onclick:()=>reveal()},["Reveal answer"]),
          el("button",{class:"chip off", id:"againBtn", onclick:()=>grade(0)},["Again"]),
          el("button",{class:"chip off", id:"hardBtn", onclick:()=>grade(1)},["Hard"]),
          el("button",{class:"chip off", id:"goodBtn", onclick:()=>grade(2)},["Good"]),
          el("button",{class:"chip off", id:"easyBtn", onclick:()=>grade(3)},["Easy"]),
          el("button",{class:"chip", id:"pinCardBtn", onclick:()=>pinCurrentCard()},["üìå Pin"]),
          el("button",{class:"chip", id:"copyBackBtn", onclick:()=>copyCurrentBack()},["Copy answer"]),
        ])
      ]);
      wrap.appendChild(stage);

      let current = null;

      function nextCard(){
        const candidates = FLASHCARDS.filter(c=>{
          if(q && !(c.topic.toLowerCase().includes(q) || c.front.toLowerCase().includes(q) || c.back.toLowerCase().includes(q))) return false;
          return isDue(getCardMeta(c.id));
        });
        current = candidates.length
          ? candidates[Math.floor(Math.random()*candidates.length)]
          : (allMatch.length ? allMatch[Math.floor(Math.random()*allMatch.length)] : null);

        if(!current){
          $("fcFront").textContent = "No cards in deck.";
          $("fcBack").textContent = "";
          $("fcMeta").textContent = "";
          $("fcBackWrap").style.display = "none";
          lockGrades(true);
          return;
        }

        const meta = getCardMeta(current.id);
        meta.seen = (meta.seen||0) + 1;
        STATE.stats.seen = (STATE.stats.seen||0) + 1;
        saveState(STATE);
        renderKPIs();

        $("fcMeta").textContent = `${current.topic} ‚Ä¢ ${current.type} ‚Ä¢ interval=${meta.interval||0}d ‚Ä¢ ease=${(meta.ease||2.3).toFixed(2)} ‚Ä¢ due=${meta.due?fmtDate(meta.due):"now"}`;
        $("fcFront").textContent = current.front;
        $("fcBack").textContent = current.back;
        $("fcBackWrap").style.display = "none";
        lockGrades(true);
      }

      function reveal(){
        if(!current) return;
        $("fcBackWrap").style.display = "block";
        lockGrades(false);
      }

      function lockGrades(locked){
        const ids = ["againBtn","hardBtn","goodBtn","easyBtn"];
        ids.forEach(i=>{
          const b = $(i);
          b.classList.toggle("off", locked);
          b.disabled = locked;
        });
      }

      function grade(g){
        if(!current) return;
        const meta = getCardMeta(current.id);
        srUpdate(meta, g);
        saveState(STATE);
        renderKPIs();
        nextCard();
      }

      function pinCurrentCard(){
        if(!current) return;
        const id = `card:${current.id}`;
        togglePin(id);
        $("pinCardBtn").textContent = STATE.pins[id] ? "üìå Pinned" : "üìå Pin";
      }

      function copyCurrentBack(){
        if(!current) return;
        copyText(current.back);
      }

      // Auto-start if due exists
      if(dueCards.length) setTimeout(()=>nextCard(), 50);

      return wrap;
    }

    /**********************************************************************
     * Quiz Mode (MCQ)
     **********************************************************************/
    function renderQuiz(){
      const wrap = el("div",{},[]);
      const q = $("q").value.trim().toLowerCase();

      const bank = [];
      for(const b of DATA.buckets){
        for(const tr of b.triggers){
          if(q && !(b.title.toLowerCase().includes(q) || tr.t.toLowerCase().includes(q) || tr.s.toLowerCase().includes(q))) continue;
          bank.push({bucket:b, trigger:tr});
        }
      }

      const top = el("div",{class:"callout"},[
        el("div",{class:"dot"}),
        el("div",{},[
          el("div",{class:"t"},["Quiz: Trigger ‚Üí Service/Team"]),
          el("div",{class:"d"},["Pick the most exam-expected service/team. Use search to narrow topics."])
        ])
      ]);
      wrap.appendChild(top);

      const stage = el("div",{class:"card", style:"margin-top:12px"},[
        el("div",{class:"row"},[
          el("button",{class:"btn primary", onclick:()=>nextQ()},["Next question"]),
          el("span",{class:"pill"},[el("b",{},["Bank"]), ` ${bank.length}`]),
          el("span",{class:"pill"},[el("b",{},["Score"]), el("span",{id:"quizScore"},[" 0/0"])])
        ]),
        el("div",{class:"divider"}),
        el("div",{id:"quizStem", style:"font-size:14px;font-weight:700"},["Press Next question"]),
        el("div",{class:"small muted", id:"quizHint", style:"margin-top:6px"},[""]),
        el("div",{class:"divider"}),
        el("div",{id:"quizOpts"})
      ]);
      wrap.appendChild(stage);

      const footer = el("div",{class:"footerNote"},[
        "High-yield heuristic: name one clear team from the correct archetype, then explain why it improves safety/outcomes (risk, engagement, function, access)."
      ]);
      wrap.appendChild(footer);

      let score = {correct:0,total:0};
      function updateScore(){
        $("quizScore").textContent = ` ${score.correct}/${score.total}`;
      }

      function nextQ(){
        if(!bank.length){
          $("quizStem").textContent = "No questions match your search.";
          $("quizHint").textContent = "";
          $("quizOpts").innerHTML = "";
          return;
        }
        const item = bank[Math.floor(Math.random()*bank.length)];
        const correct = item.trigger.s;

        // create distractors from other triggers
