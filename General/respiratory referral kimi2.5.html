<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapid Respiratory Referral Generator</title>
    <style>
        :root {
            --nhs-blue: #005eb8;
            --nhs-green: #007f3b;
            --nhs-red: #da291c;
            --nhs-warm-yellow: #ffb81c;
            --nhs-purple: #330072;
            --bg-grey: #f0f4f5;
            --card-bg: #ffffff;
            --text-primary: #212b32;
            --text-secondary: #4c6272;
            --border: #d8dde0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-grey);
            color: var(--text-primary);
            line-height: 1.5;
            padding-bottom: 100px;
        }

        header {
            background: linear-gradient(135deg, var(--nhs-blue) 0%, var(--nhs-purple) 100%);
            color: white;
            padding: 2rem 1rem;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 0.95rem;
            font-style: italic;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .panel-header {
            padding: 1.25rem;
            background: var(--bg-grey);
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--nhs-blue);
        }

        .condition-tabs {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--bg-grey);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--border);
            background: white;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
            color: var(--text-secondary);
        }

        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .tab-btn.active {
            background: var(--nhs-blue);
            color: white;
            border-color: var(--nhs-blue);
        }

        .form-content {
            padding: 1.5rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--nhs-purple);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--nhs-purple);
            border-radius: 2px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .required::after {
            content: '*';
            color: var(--nhs-red);
            margin-left: 4px;
        }

        input, select, textarea {
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.2s;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--nhs-blue);
            box-shadow: 0 0 0 3px rgba(0, 94, 184, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-grey);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-label {
            cursor: pointer;
            user-select: none;
            font-weight: 500;
        }

        .quick-fill {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            background: var(--nhs-warm-yellow);
            color: var(--text-primary);
            border: none;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            margin-left: auto;
            margin-bottom: 0.5rem;
        }

        .quick-fill:hover {
            background: #e6a619;
        }

        .output-panel {
            position: sticky;
            top: 120px;
            height: fit-content;
        }

        .output-content {
            padding: 1.5rem;
            background: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            border-left: 4px solid var(--nhs-green);
            max-height: 60vh;
            overflow-y: auto;
        }

        .action-bar {
            padding: 1rem;
            background: white;
            border-top: 2px solid var(--border);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--nhs-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #004a8f;
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--nhs-green);
            color: white;
        }

        .btn-success:hover {
            background: #00662f;
        }

        .btn-danger {
            background: var(--nhs-red);
            color: white;
        }

        .hidden {
            display: none !important;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .badge-copd { background: #e0f2fe; color: #0369a1; }
        .badge-asthma { background: #fef3c7; color: #92400e; }
        .badge-cough { background: #fce7f3; color: #be185d; }

        .hoop-counter {
            background: rgba(255,255,255,0.1);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .mrc-scale {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
        }

        .mrc-option {
            text-align: center;
            padding: 0.75rem 0.5rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .mrc-option:hover {
            border-color: var(--nhs-blue);
            background: #e0f2fe;
        }

        .mrc-option.selected {
            background: var(--nhs-blue);
            color: white;
            border-color: var(--nhs-blue);
        }

        .mrc-desc {
            font-size: 0.7rem;
            font-weight: normal;
            margin-top: 0.25rem;
            opacity: 0.9;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--nhs-green);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: none;
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .info-box {
            background: #e0f2fe;
            border-left: 4px solid var(--nhs-blue);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0 6px 6px 0;
            font-size: 0.9rem;
        }

        .warning-box {
            background: #fef3c7;
            border-left: 4px solid var(--nhs-warm-yellow);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0 6px 6px 0;
            font-size: 0.9rem;
        }

        @media print {
            header, .input-panel, .action-bar { display: none; }
            .output-panel { width: 100%; position: static; }
            .output-content { border: none; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <h1>ü´Å Rapid Respiratory Referral Generator</h1>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <p class="subtitle">"Jump through their hoops faster so you can get back to actual medicine"</p>
            <span class="hoop-counter">Hoops templated: 27</span>
        </div>
    </div>
</header>

<div class="container">
    <div class="panel input-panel">
        <div class="condition-tabs">
            <button class="tab-btn active" onclick="switchTab('copd')">
                COPD <span class="badge badge-copd">6 fields</span>
            </button>
            <button class="tab-btn" onclick="switchTab('asthma')">
                Asthma <span class="badge badge-asthma">11 fields</span>
            </button>
            <button class="tab-btn" onclick="switchTab('cough')">
                Chronic Cough <span class="badge badge-cough">8 fields</span>
            </button>
        </div>

        <div class="form-content" id="form-container">
            <!-- COPD Form -->
            <div id="copd-form" class="condition-form">
                <div class="info-box">
                    <strong>Referral Strategy:</strong> Ensure FEV1 &lt; 50% predicted or frequent exacerbations (‚â•2) to justify tertiary referral. Include BODE index if available.
                </div>

                <div class="form-section">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 class="section-title">Core Requirements</h3>
                        <button class="quick-fill" onclick="autoFillCOPD()">‚ö° Auto-fill common</button>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Reason for Referral</label>
                        <select id="copd-reason" onchange="updateOutput()">
                            <option value="">Select primary reason...</option>
                            <option value="Frequent exacerbations despite optimal therapy">Frequent exacerbations (‚â•2/yr)</option>
                            <option value="Rapid decline in FEV1">Rapid FEV1 decline</option>
                            <option value="Cor pulmonale assessment">Cor pulmonale</option>
                            <option value="Oxygen assessment">LTOT assessment</option>
                            <option value="Surgical/lung volume reduction">Surgical intervention</option>
                            <option value="Diagnostic uncertainty">Diagnostic uncertainty</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="required">Clinical Question Being Asked</label>
                        <textarea id="copd-question" placeholder="e.g., suitability for pulmonary rehab / LTOT assessment / surgical candidacy..." oninput="updateOutput()"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Smoking History (pack years)</label>
                            <input type="text" id="copd-smoking" placeholder="e.g., 40 pack years, quit 2019" oninput="updateOutput()">
                        </div>
                        <div class="form-group">
                            <label>Occupational History</label>
                            <input type="text" id="copd-occupation" placeholder="e.g., coal miner, painter" oninput="updateOutput()">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">Clinical Status</h3>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="required">MRC Dyspnoea Scale (Select one)</label>
                        <div class="mrc-scale">
                            <div class="mrc-option" onclick="selectMRC(1)" data-value="1">
                                1
                                <div class="mrc-desc">Not breathless</div>
                            </div>
                            <div class="mrc-option" onclick="selectMRC(2)" data-value="2">
                                2
                                <div class="mrc-desc">Walking pace</div>
                            </div>
                            <div class="mrc-option" onclick="selectMRC(3)" data-value="3">
                                3
                                <div class="mrc-desc">Stops after 100m</div>
                            </div>
                            <div class="mrc-option" onclick="selectMRC(4)" data-value="4">
                                4
                                <div class="mrc-desc">Stops after 50m</div>
                            </div>
                            <div class="mrc-option" onclick="selectMRC(5)" data-value="5">
                                5
                                <div class="mrc-desc">Cannot leave house</div>
                            </div>
                        </div>
                        <input type="hidden" id="copd-mrc" value="">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Exacerbations (last 12 months)</label>
                            <input type="number" id="copd-exacerbations" min="0" placeholder="Number of episodes" oninput="updateOutput()">
                        </div>
                        <div class="form-group">
                            <label class="required">Hospital Admissions (last 12 months)</label>
                            <input type="number" id="copd-admissions" min="0" placeholder="Number of admissions" oninput="updateOutput()">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">Investigations</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Most Recent Spirometry</label>
                            <input type="text" id="copd-spirometry" placeholder="FEV1 1.2L (45% predicted), FVC 2.5L, ratio 0.48" oninput="updateOutput()">
                        </div>
                        <div class="form-group">
                            <label>Date of Spirometry</label>
                            <input type="date" id="copd-spiro-date" onchange="updateOutput()">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Chest X-ray Result</label>
                            <input type="text" id="copd-cxr" placeholder="e.g., hyperinflated, no masses" oninput="updateOutput()">
                        </div>
                        <div class="form-group">
                            <label>CXR Date</label>
                            <input type="date" id="copd-cxr-date" onchange="updateOutput()">
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 1rem;">
                        <label>Current Medications (include SABA/SAMA/LABA/LAMA/ICS)</label>
                        <textarea id="copd-meds" placeholder="Fostair 200/6 2 puffs bd&#10;Spiriva Respimat 2.5mcg 2 puffs od&#10;Salmeterol..." oninput="updateOutput()"></textarea>
                    </div>
                </div>
            </div>

            <!-- Asthma Form -->
            <div id="asthma-form" class="condition-form hidden">
                <div class="warning-box">
                    <strong>NICE Requirements:</strong> Must demonstrate BTS steps 4-5 or problematic severe asthma before referral. Include FeNO and eosinophil count if available.
                </div>

                <div class="form-section">
                    <h3 class="section-title">Core Requirements</h3>
                    
                    <div class="form-group">
                        <label class="required">Reason for Referral</label>
                        <select id="asthma-reason" onchange="updateOutput()">
                            <option value="">Select reason...</option>
                            <option value="Difficult asthma - BTS step 4/5">Difficult asthma (Step 4/5)</option>
                            <option value="Diagnostic uncertainty">Diagnostic uncertainty</option>
                            <option value="Severe eosinophilic asthma">Severe eosinophilic phenotype</option>
                            <option value="Biological therapy candidacy">Biological therapy assessment</option>
                            <option value="Frequent exacerbations">Frequent exacerbations (‚â•3/yr)</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="required">Clinical Question</label>
                        <textarea id="asthma-question" placeholder="e.g., suitability for omalizumab / mepolizumab, diagnostic confirmation..." oninput="updateOutput()"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Smoking History</label>
                            <input type="text" id="asthma-smoking" placeholder="Never / Ex-smoker 10 py..." oninput="updateOutput()">
                        </div>
                        <div class="form-group">
                            <label class="required">Occupational History</label>
                            <input type="text" id="asthma-occupation" placeholder="e.g., baker (flour), hairdresser (persulfates)" oninput="updateOutput()">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">RCP 3 Questions (Control)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Day symptoms (‚â•1x/week)?</label>
                            <select id="asthma-rcp1" onchange="updateOutput()">
                                <option value="No">No - Well controlled</option>
                                <option value="Yes">Yes - Poorly controlled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nocturnal waking (any)?</label>
                            <select id="asthma-rcp2" onchange="updateOutput()">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Reliever use (‚â•2x/week)?</label>
                            <select id="asthma-rcp3" onchange="updateOutput()">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">Exacerbation History</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Exacerbations (12 months)</label>
                            <input type="number" id="asthma-exacerbations" min="0" oninput="updateOutput()">
                        </div>
                        <div class="form-group">
                            <label class="required">Hospital Admissions</label>
                            <input type="number" id="asthma-admissions" min="0" oninput="updateOutput()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Steroid courses (last 12 months)</label>
                            <input type="number" id="asthma-steroids" min="0" placeholder="Number of rescue courses" oninput="updateOutput()">
                        </div>
                        <div class="form-group">
                            <label class="required">Antibiotic courses</label>
                            <input type="number" id="asthma-antibiotics" min="0" oninput="updateOutput()">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">Medication & Optimization</h3>
                    <div class="form-group">
                        <checkbox-group>
                            <input type="checkbox" id="asthma-optimized" onchange="updateOutput()">
                            <label class="checkbox-label" for="asthma-optimized">Optimised per GMMMG guidance (ICS/LABA, LTRA, LAMA tried)</label>
                        </checkbox-group>
                    </div>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="required">Inhalers prescribed (last 12 months) with quantities</label>
                        <textarea id="asthma-inhalers" placeholder="Fostair 200/6 - 13 inhalers&#10;Ventolin - 24 inhalers..." oninput="updateOutput()"></textarea>
                    </div>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label>Up-to-date Medication Review Date</label>
                        <input type="date" id="asthma-review" onchange="updateOutput()">
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">Investigations</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Recent PEFR (Best/Predicted %)</label>
                            <input type="text" id="asthma-pefr" placeholder="e.g., 450 L/min (78% predicted)" oninput="updateOutput()">
                        </div>
                        <div class="form-group">
                            <label class="required">FBC (Eosinophils)</label>
                            <input type="text" id="asthma-fbc" placeholder="e.g., 0.6 x10^9/L (elevated)" oninput="updateOutput()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Chest X-ray Date (&lt;3 months)</label>
                            <input type="date" id="asthma-cxr-date" onchange="updateOutput()">
                        </div>
                        <div class="form-group">
                            <label>CXR Result</label>
                            <input type="text" id="asthma-cxr" placeholder="Normal / Hyperinflated..." oninput="updateOutput()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Respiratory/Allergy History Summary</label>
                        <textarea id="asthma-history" placeholder="Atopy, eczema, family history, triggers..." oninput="updateOutput()"></textarea>
                    </div>
                </div>
            </div>

            <!-- Chronic Cough Form -->
            <div id="cough-form" class="condition-form hidden">
                <div class="info-box">
                    <strong>Definition:</strong> Cough lasting &gt;8 weeks. Ensure ACE-I stopped 3 months prior to referral. Complete all three trial pathways before referral.
                </div>

                <div class="form-section">
                    <h3 class="section-title">Basic Requirements</h3>
                    
                    <div class="form-group">
                        <label class="required">Reason for Referral</label>
                        <select id="cough-reason" onchange="updateOutput()">
                            <option value="">Select...</option>
                            <option value="Chronic cough >8 weeks despite trials">Refractory chronic cough (post-trials)</option>
                            <option value="Suspected refractory asthma">Suspected cough-variant asthma</option>
                            <option value="Chronic refractory UACS">Refractory UACS</option>
                            <option value="GORD refractory to PPI">Refractory GORD-related cough</option>
                            <option value="Diagnostic uncertainty">Red flag investigation</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="required">Clinical Question</label>
                        <textarea id="cough-question" placeholder="e.g., exclusion of underlying pathology / cough hypersensitivity diagnosis..." oninput="updateOutput()"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Cough Duration</label>
                            <input type="text" id="cough-duration" placeholder="e.g., 12 weeks" oninput="updateOutput()">
                        </div>
                        <div class="form-group">
                            <label class="required">Smoking History</label>
                            <input type="text" id="cough-smoking" oninput="updateOutput()">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">ACE-I & Basic Trials</h3>
                    <div class="form-group">
                        <checkbox-group>
                            <input type="checkbox" id="cough-acei" onchange="updateOutput()">
                            <label class="checkbox-label" for="cough-acei">ACE-I stopped ‚â•3 months ago and reviewed</label>
                        </checkbox-group>
                    </div>
                    
                    <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-grey); border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--nhs-purple);">Required Trial Pathways:</h4>
                        
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <checkbox-group>
                                <input type="checkbox" id="cough-nasal" onchange="updateOutput()">
                                <label class="checkbox-label" for="cough-nasal">
                                    <strong>Nasal/Allergic trialled:</strong> Steroid nasal spray ¬± antihistamine for 6 weeks
                                </label>
                            </checkbox-group>
                        </div>

                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <checkbox-group>
                                <input type="checkbox" id="cough-ppi" onchange="updateOutput()">
                                <label class="checkbox-label" for="cough-ppi">
                                    <strong>Reflux trialled:</strong> BD PPI + Ranitidine 300mg nocte for 8 weeks
                                </label>
                            </checkbox-group>
                        </div>

                        <div class="form-group">
                            <checkbox-group>
                                <input type="checkbox" id="cough-asthma" onchange="updateOutput()">
                                <label class="checkbox-label" for="cough-asthma">
                                    <strong>Asthma trialled:</strong> Prednisolone 30mg 10 days + ICS (BDP 200mcg bd) 8 weeks
                                </label>
                            </checkbox-group>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">Investigations</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Recent CXR</label>
                            <input type="text" id="cough-cxr" placeholder="e.g., Normal, no mass/hilar..." oninput="updateOutput()">
                        </div>
                        <div class="form-group">
                            <label>CXR Date</label>
                            <input type="date" id="cough-cxr-date" onchange="updateOutput()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Recent PEFR</label>
                            <input type="text" id="cough-pefr" placeholder="Best/Variability..." oninput="updateOutput()">
                        </div>
                        <div class="form-group">
                            <label class="required">FBC</label>
                            <input type="text" id="cough-fbc" placeholder="Eosinophils noted..." oninput="updateOutput()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Respiratory/Atopic History</label>
                        <textarea id="cough-history" oninput="updateOutput()"></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">NorthWest Cough Network</h3>
                    <div class="form-group">
                        <checkbox-group>
                            <input type="checkbox" id="cough-pathway" checked onchange="updateOutput()">
                            <label class="checkbox-label" for="cough-pathway">NorthWest Cough Network pathway completed</label>
                        </checkbox-group>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="panel output-panel">
        <div class="panel-header">
            <span class="panel-title">üìã Generated Referral Text</span>
            <span style="font-size: 0.8rem; color: var(--text-secondary);" id="word-count">0 words</span>
        </div>
        <div class="output-content" id="output-text">
Select a condition type and fill the form to generate referral text...
        </div>
        <div class="action-bar">
            <button class="btn btn-danger" onclick="clearAll()">Clear All</button>
            <button class="btn btn-success" onclick="copyToClipboard()">üìã Copy to Clipboard</button>
        </div>
    </div>
</div>

<div class="toast" id="toast">Copied to clipboard! Ready to paste into referral.</div>

<script>
    let currentTab = 'copd';
    let selectedMRC = 0;

    // Storage key
    const STORAGE_KEY = 'resp_referral_data';

    // Initialize
    window.onload = function() {
        loadData();
        updateOutput();
    };

    function switchTab(tab) {
        currentTab = tab;
        
        // Update buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.closest('.tab-btn').classList.add('active');
        
        // Show/hide forms
        document.querySelectorAll('.condition-form').forEach(form => {
            form.classList.add('hidden');
        });
        document.getElementById(tab + '-form').classList.remove('hidden');
        
        updateOutput();
    }

    function selectMRC(level) {
        selectedMRC = level;
        document.getElementById('copd-mrc').value = level;
        document.querySelectorAll('.mrc-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector(`.mrc-option[data-value="${level}"]`).classList.add('selected');
        updateOutput();
        saveData();
    }

    function updateOutput() {
        let output = '';
        
        if (currentTab === 'copd') {
            output = generateCOPDText();
        } else if (currentTab === 'asthma') {
            output = generateAsthmaText();
        } else if (currentTab === 'cough') {
            output = generateCoughText();
        }
        
        document.getElementById('output-text').textContent = output;
        document.getElementById('word-count').textContent = output.split(/\s+/).length + ' words';
        saveData();
    }

    function generateCOPDText() {
        const reason = document.getElementById('copd-reason').value || '[REASON REQUIRED]';
        const question = document.getElementById('copd-question').value || '[CLINICAL QUESTION REQUIRED]';
        const smoking = document.getElementById('copd-smoking').value || '[SMOKING HISTORY REQUIRED]';
        const occupation = document.getElementById('copd-occupation').value || 'Nil significant';
        const mrc = selectedMRC || '[MRC REQUIRED]';
        const exacerbations = document.getElementById('copd-exacerbations').value || '0';
        const admissions = document.getElementById('copd-admissions').value || '0';
        const spirometry = document.getElementById('copd-spirometry').value || '[SPIROMETRY REQUIRED]';
        const spiroDate = document.getElementById('copd-spiro-date').value || '[DATE]';
        const cxr = document.getElementById('copd-cxr').value || '[CXR REQUIRED]';
        const cxrDate = document.getElementById('copd-cxr-date').value || '[DATE]';
        const meds = document.getElementById('copd-meds').value || '[MEDICATION LIST REQUIRED]';

        return `RESPIRATORY REFERRAL - COPD

REASON FOR REFERRAL: ${reason}
CLINICAL QUESTION: ${question}

HISTORY:
Smoking History: ${smoking}
Occupational History: ${occupation}
Respiratory History: COPD diagnosed [insert date], currently GOLD [stage if known]

CLINICAL STATUS:
MRC Dyspnoea Score: Grade ${mrc}
Exacerbation History: ${exacerbations} exacerbations in last 12 months requiring oral steroids/antibiotics
Hospital Admissions: ${admissions} admission(s) in last 12 months

CURRENT MEDICATIONS (Optimised):
${meds}

INVESTIGATIONS:
Most Recent Spirometry (${spiroDate}): ${spirometry}
Chest X-ray (${cxrDate}): ${cxr}

ADDITIONAL:
- Inhaler technique checked and optimised
- Vaccinations up to date (Pneumococcal, Annual Flu, COVID)
- Pulmonary rehabilitation: [completed/declined/not yet offered]

Please accept this patient for assessment regarding the above clinical question.`;
    }

    function generateAsthmaText() {
        const reason = document.getElementById('asthma-reason').value || '[REASON REQUIRED]';
        const question = document.getElementById('asthma-question').value || '[CLINICAL QUESTION REQUIRED]';
        const smoking = document.getElementById('asthma-smoking').value || '[REQUIRED]';
        const occupation = document.getElementById('asthma-occupation').value || '[REQUIRED]';
        const rcp1 = document.getElementById('asthma-rcp1').value;
        const rcp2 = document.getElementById('asthma-rcp2').value;
        const rcp3 = document.getElementById('asthma-rcp3').value;
        const exacerbations = document.getElementById('asthma-exacerbations').value || '0';
        const admissions = document.getElementById('asthma-admissions').value || '0';
        const steroids = document.getElementById('asthma-steroids').value || '0';
        const antibiotics = document.getElementById('asthma-antibiotics').value || '0';
        const optimized = document.getElementById('asthma-optimized').checked ? 'Yes - optimised per GMMMG pathway' : 'No';
        const inhalers = document.getElementById('asthma-inhalers').value || '[REQUIRED]';
        const review = document.getElementById('asthma-review').value || '[DATE REQUIRED]';
        const pefr = document.getElementById('asthma-pefr').value || '[REQUIRED]';
        const fbc = document.getElementById('asthma-fbc').value || '[REQUIRED]';
        const cxrDate = document.getElementById('asthma-cxr-date').value || '[<3 MONTHS REQUIRED]';
        const cxr = document.getElementById('asthma-cxr').value || '[REQUIRED]';
        const history = document.getElementById('asthma-history').value || 'Not specified';

        return `RESPIRATORY REFERRAL - ASTHMA

REASON FOR REFERRAL: ${reason}
CLINICAL QUESTION: ${question}

HISTORY:
Smoking History: ${smoking}
Occupational History: ${occupation}
Respiratory/Allergy History: ${history}

ASTHMA CONTROL (RCP 3 Questions):
- Day symptoms ‚â•1x/week: ${rcp1}
- Nocturnal waking: ${rcp2}
- Reliever use ‚â•2x/week: ${rcp3}

EXACERBATION HISTORY (Last 12 months):
- Exacerbations requiring rescue steroids: ${exacerbations}
- Hospital Admissions: ${admissions}
- Courses of prednisolone prescribed: ${steroids}
- Courses of antibiotics for chest: ${antibiotics}

MEDICATION HISTORY:
Number/name of inhalers prescribed (last 12 months):
${inhalers}

Optimised on medication per GMMMG guidance: ${optimized}
Last Medication Review: ${review}

INVESTIGATIONS:
Recent PEFR: ${pefr}
FBC: ${fbc} (Eosinophil count noted for biologic candidacy)
Chest X-ray (${cxrDate}): ${cxr}

Please assess for difficult asthma management/biological therapy suitability.`;
    }

    function generateCoughText() {
        const reason = document.getElementById('cough-reason').value || '[REASON REQUIRED]';
        const question = document.getElementById('cough-question').value || '[CLINICAL QUESTION REQUIRED]';
        const duration = document.getElementById('cough-duration').value || '[>8 WEEKS REQUIRED]';
        const smoking = document.getElementById('cough-smoking').value || '[REQUIRED]';
        const acei = document.getElementById('cough-acei').checked ? 'Yes - stopped minimum 3 months ago, no improvement' : '[MUST STOP ACE-I FIRST]';
        const nasal = document.getElementById('cough-nasal').checked ? 'Completed' : 'Not done';
        const ppi = document.getElementById('cough-ppi').checked ? 'Completed' : 'Not done';
        const asthma = document.getElementById('cough-asthma').checked ? 'Completed' : 'Not done';
        const cxr = document.getElementById('cough-cxr').value || '[REQUIRED]';
        const cxrDate = document.getElementById('cough-cxr-date').value || '[DATE]';
        const pefr = document.getElementById('cough-pefr').value || '[REQUIRED]';
        const fbc = document.getElementById('cough-fbc').value || '[REQUIRED]';
        const history = document.getElementById('cough-history').value || 'Not specified';
        const pathway = document.getElementById('cough-pathway').checked ? 'Yes - NorthWest Cough Network pathway completed' : '';

        return `RESPIRATORY REFERRAL - CHRONIC COUGH

REASON FOR REFERRAL: ${reason}
CLINICAL QUESTION: ${question}

DEFINITION: Chronic cough defined as cough lasting ${duration} (>8 weeks)

HISTORY:
Smoking History: ${smoking}
Respiratory/Atopic History: ${history}

ACE-I REVIEW:
ACE-I stopped and reviewed after 3 months: ${acei}

MEDICATION TRIALS COMPLETED:
1. Suspected post-nasal drip/allergic rhinitis:
   Trial of steroid nasal spray ¬± antihistamine (6 weeks): ${nasal}
   
2. Suspected reflux-related cough:
   BD PPI plus ranitidine 300mg at night for 8 weeks: ${ppi}
   
3. Suspected asthma diagnosis:
   Prednisolone 30mg 10 days + 8-week trial ICS 200mcg BD (BDP equivalent): ${asthma}

INVESTIGATIONS:
Chest X-ray (${cxrDate}): ${cxr}
Recent PEFR: ${pefr}
FBC: ${fbc}

PATHWAY:
${pathway}

Please accept for specialist cough clinic assessment/refractory cough investigation.`;
    }

    function autoFillCOPD() {
        document.getElementById('copd-question').value = 'Assessment for oxygen therapy suitability / pulmonary rehabilitation / further management of frequent exacerbations';
        document.getElementById('copd-meds').value = 'Fostair 200/6 2 puffs bd\nSpiriva Respimat 2.5mcg 2 puffs od\nSalbutamol prn';
        updateOutput();
        saveData();
    }

    function clearAll() {
        if(confirm('Clear all fields?')) {
            localStorage.removeItem(STORAGE_KEY);
            document.querySelectorAll('input, textarea').forEach(el => {
                if(el.type === 'checkbox') el.checked = false;
                else el.value = '';
            });
            selectedMRC = 0;
            document.querySelectorAll('.mrc-option').forEach(opt => opt.classList.remove('selected'));
            updateOutput();
        }
    }

    function copyToClipboard() {
        const text = document.getElementById('output-text').textContent;
        navigator.clipboard.writeText(text).then(() => {
            const toast = document.getElementById('toast');
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        });
    }

    function saveData() {
        const data = {
            currentTab: currentTab,
            copd: {},
            asthma: {},
            cough: {},
            mrc: selectedMRC
        };
        
        document.querySelectorAll('input, textarea, select').forEach(el => {
            if(el.id) {
                const prefix = el.id.split('-')[0];
                if(data[prefix]) {
                    if(el.type === 'checkbox') {
                        data[prefix][el.id] = el.checked;
                    } else {
                        data[prefix][el.id] = el.value;
                    }
                }
            }
        });
        
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadData() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if(saved) {
            const data = JSON.parse(saved);
            selectedMRC = data.mrc || 0;
            
            // Restore MRC selection visually
            if(selectedMRC > 0) {
                document.querySelector(`.mrc-option[data-value="${selectedMRC}"]`)?.classList.add('selected');
                document.getElementById('copd-mrc').value = selectedMRC;
            }
            
            // Restore form values
            ['copd', 'asthma', 'cough'].forEach(section => {
                if(data[section]) {
                    Object.keys(data[section]).forEach(key => {
                        const el = document.getElementById(key);
                        if(el) {
                            if(el.type === 'checkbox') {
                                el.checked = data[section][key];
                            } else {
                                el.value = data[section][key];
                            }
                        }
                    });
                }
            });
        }
    }
</script>

</body>
</html>