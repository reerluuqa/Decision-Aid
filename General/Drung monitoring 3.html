<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UK HMT Drug Monitoring ‚Äì Clinical Reference</title>
  <style>
    :root {
      /* Palette - Clinical Modern */
      --bg-body: #f1f5f9;      /* Slate 100 */
      --bg-card: #ffffff;
      --text-main: #1e293b;    /* Slate 800 */
      --text-muted: #64748b;   /* Slate 500 */
      
      /* Status Colors */
      --danger: #ef4444;       /* Red 500 */
      --danger-bg: #fef2f2;    /* Red 50 */
      --danger-border: #fca5a5;
      
      --warn: #f59e0b;         /* Amber 500 */
      --warn-bg: #fffbeb;      /* Amber 50 */
      --warn-border: #fcd34d;
      
      --ok: #10b981;           /* Emerald 500 */
      --ok-bg: #ecfdf5;        /* Emerald 50 */
      
      --primary: #0f172a;      /* Slate 900 */
      --primary-hover: #334155;
      
      /* Spacing & Layout */
      --radius: 12px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-hover: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* --- Header --- */
    header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid #e2e8f0;
      padding: 16px 0;
      box-shadow: var(--shadow-sm);
    }

    .wrap {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .header-top {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }

    h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 800;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    h1 svg { width: 24px; height: 24px; color: var(--primary); }

    .sub { margin: 4px 0 0; font-size: 13px; color: var(--text-muted); max-width: 600px; }

    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* --- Inputs --- */
    .search-wrap {
      position: relative;
      flex-grow: 1;
      max-width: 400px;
    }
    
    .search-wrap svg {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      width: 16px;
      height: 16px;
    }

    input[type="search"] {
      width: 100%;
      padding: 10px 12px 10px 36px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 14px;
      background: #fff;
      transition: border-color 0.2s;
    }
    input[type="search"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.1);
    }

    select {
      padding: 10px 32px 10px 12px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 14px;
      background-color: #fff;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 16px;
    }

    button {
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid transparent;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-primary:hover { background: var(--primary-hover); }
    
    .btn-outline {
      background: white;
      border-color: #cbd5e1;
      color: var(--text-main);
    }
    .btn-outline:hover { border-color: var(--primary); color: var(--primary); }

    /* Toggle Switch */
    .toggle-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 500;
      user-select: none;
      cursor: pointer;
      padding: 6px 12px;
      background: white;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
    }
    .toggle-switch {
      width: 32px;
      height: 18px;
      background: #cbd5e1;
      border-radius: 99px;
      position: relative;
      transition: background 0.2s;
    }
    .toggle-switch::after {
      content: '';
      position: absolute;
      left: 2px;
      top: 2px;
      width: 14px;
      height: 14px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    input[type="checkbox"] { display: none; }
    input[type="checkbox"]:checked + .toggle-switch { background: var(--danger); }
    input[type="checkbox"]:checked + .toggle-switch::after { transform: translateX(14px); }

    /* --- Main Grid --- */
    main { padding: 24px 0 48px; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 20px;
    }

    /* --- Card Design --- */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      border: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      transition: transform 0.2s, box-shadow 0.2s;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    /* Severity Indicator Bar */
    .card[data-severity="danger"] { border-left: 5px solid var(--danger); }
    .card[data-severity="warn"] { border-left: 5px solid var(--warn); }
    .card[data-severity="ok"] { border-left: 5px solid var(--ok); }

    .card-header {
      padding: 14px 16px;
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .drug-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-main);
      margin: 0;
      line-height: 1.2;
    }

    .cat-badge {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 700;
      color: var(--text-muted);
      background: #f1f5f9;
      padding: 2px 8px;
      border-radius: 4px;
    }

    /* Severity Icon in Header */
    .sev-icon {
      flex-shrink: 0;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 10px;
    }
    .card[data-severity="danger"] .sev-icon { background: var(--danger-bg); color: var(--danger); }
    .card[data-severity="warn"] .sev-icon { background: var(--warn-bg); color: var(--warn); }
    .card[data-severity="ok"] .sev-icon { background: var(--ok-bg); color: var(--ok); }

    /* Content Area */
    .card-body { padding: 16px; flex-grow: 1; }

    /* The "Red Box" for Danger Actions */
    .alert-box {
      background: var(--danger-bg);
      border: 1px solid var(--danger-border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }
    .alert-title {
      color: var(--danger);
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 0 0 6px 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .alert-list {
      margin: 0;
      padding-left: 18px;
      font-size: 13px;
      color: #7f1d1d;
    }
    .alert-list li { margin-bottom: 4px; }
    .alert-list li:last-child { margin-bottom: 0; }

    /* Standard Data Rows */
    .data-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .data-item {
      font-size: 12px;
    }
    .label {
      display: block;
      color: var(--text-muted);
      font-weight: 600;
      margin-bottom: 4px;
      text-transform: uppercase;
      font-size: 10px;
      letter-spacing: 0.3px;
    }
    .value {
      color: var(--text-main);
      font-size: 13px;
    }

    /* Key Risks */
    .risks-container {
      margin-bottom: 16px;
    }
    .risk-pill {
      display: inline-block;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      background: #f1f5f9;
      color: var(--text-muted);
      margin-right: 6px;
      margin-bottom: 6px;
      border: 1px solid #e2e8f0;
    }

    /* Details / Micro-prompt */
    details {
      background: #f8fafc;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      overflow: hidden;
    }
    summary {
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      color: var(--text-muted);
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    summary:hover { color: var(--primary); background: #f1f5f9; }
    summary::after { content: '+'; font-weight: bold; }
    details[open] summary::after { content: '-'; }
    
    .details-content {
      padding: 12px;
      font-size: 12px;
      color: var(--text-main);
      border-top: 1px solid #e2e8f0;
      line-height: 1.5;
    }

    /* Utility for Highlights */
    .hl {
      background-color: #fef08a; /* Yellow 200 */
      color: #854d0e;
      padding: 1px 4px;
      border-radius: 3px;
      font-weight: 700;
    }

    /* Footer */
    .footer-meta {
      margin-top: 40px;
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
    }
    .tips-row {
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .tip-pill {
      background: #e0f2fe;
      color: #0369a1;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }

    /* Hidden Utility */
    .hidden { display: none !important; }

    /* Print Styles */
    @media print {
      body { background: white; }
      header, .tips-row, details { display: none !important; }
      .grid { display: block; }
      .card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ccc;
        margin-bottom: 20px;
        border-left: 5px solid #000; /* Make borders visible in B&W */
      }
      .wrap { max-width: 100%; padding: 0; }
    }
  </style>
</head>
<body>

  <header>
    <div class="wrap">
      <div class="header-top">
        <div>
          <h1>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path>
            </svg>
            UK HMT Monitoring
          </h1>
          <p class="sub">Clinical reference for drug monitoring, side effects, and stop thresholds.</p>
        </div>
        <div class="controls">
          <label class="toggle-wrap" title="Show only High Risk medications">
            <input type="checkbox" id="highRiskToggle">
            <span class="toggle-switch"></span>
            High Risk Only
          </label>
          <button id="print" class="btn-outline">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>
            Print
          </button>
        </div>
      </div>

      <div class="controls">
        <div class="search-wrap">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          <input id="q" type="search" placeholder="Search drug, risk (e.g. 'ALT'), or action..." />
        </div>
        <select id="cat">
          <option value="all">All Categories</option>
        </select>
        <button id="reset" class="btn-outline">Reset</button>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="grid" id="grid">
        <!-- Cards injected here -->
      </div>
      
      <div class="footer-meta">
        <div class="tips-row">
          <span class="tip-pill">üî¥ Red Box = Stop Immediately</span>
          <span class="tip-pill">üü° Amber = Caution/Dose Adjust</span>
          <span class="tip-pill">üîç Search = 'pneumonitis', 'INR', 'creatinine'</span>
        </div>
        <p style="margin-top: 16px;">Last updated: <span id="stamp"></span></p>
      </div>
    </div>
  </main>

  <script>
    // --- Data Source ---
    const data = [
      // 1) Conventional DMARDs
      {
        category: "Conventional DMARDs",
        drug: "Methotrexate",
        baseline: "FBC, U&E, LFTs, CXR ¬± Hep B/C",
        monitoring: "2 weeks (stable) ‚Üí monthly ‚Üí 2-3 monthly",
        keyRisks: ["Myelosuppression", "Hepatotoxicity", "Pneumonitis", "Mucositis"],
        action: [
          "Stop if WCC < 3.5 or Plt < 150",
          "Stop if ALT/AST > 2‚Äì3√ó ULN",
          "New dyspnoea/cough/fever: urgent assessment for pneumonitis"
        ],
        highlight: ["WCC < 3.5", "Plt < 150", "ALT/AST > 2‚Äì3√ó ULN", "pneumonitis"],
        severity: "danger"
      },
      {
        category: "Conventional DMARDs",
        drug: "Sulfasalazine",
        baseline: "FBC, LFTs",
        monitoring: "2‚Äì4 weeks √ó 3 months ‚Üí then 3 monthly",
        keyRisks: ["Agranulocytosis", "Hepatitis", "Rash"],
        action: [
          "Stop if neutrophils < 2.0",
          "Stop if ALT/AST > 2√ó ULN"
        ],
        highlight: ["neutrophils < 2.0", "ALT/AST > 2√ó ULN"],
        severity: "warn"
      },
      {
        category: "Conventional DMARDs",
        drug: "Leflunomide",
        baseline: "FBC, LFT, BP",
        monitoring: "2 weeks √ó 6 months ‚Üí then monthly",
        keyRisks: ["Hepatotoxicity", "Hypertension", "Cytopenia"],
        action: [
          "Stop if ALT/AST > 3√ó ULN",
          "Severe toxicity: cholestyramine washout"
        ],
        highlight: ["ALT/AST > 3√ó ULN", "cholestyramine washout"],
        severity: "danger"
      },
      {
        category: "Conventional DMARDs",
        drug: "Hydroxychloroquine",
        baseline: "Baseline ophthalmic assessment",
        monitoring: "Annual eye review after 5 years (earlier if risk)",
        keyRisks: ["Retinopathy"],
        action: [
          "Stop if OCT/visual field changes consistent with toxicity"
        ],
        highlight: ["retinopathy", "OCT"],
        severity: "warn"
      },
      {
        category: "Conventional DMARDs",
        drug: "Azathioprine",
        baseline: "TPMT activity/genotype, FBC, LFT",
        monitoring: "Weekly ‚Üí monthly ‚Üí 3 monthly",
        keyRisks: ["Myelosuppression", "Hepatitis", "Pancreatitis"],
        action: [
          "Dose reduce/stop if neutropenia or LFT derangement",
          "Acute pancreatitis symptoms: stop and assess"
        ],
        highlight: ["TPMT", "myelosuppression", "pancreatitis"],
        severity: "danger"
      },
      {
        category: "Conventional DMARDs",
        drug: "Mycophenolate mofetil",
        baseline: "FBC, LFT (¬± renal)",
        monitoring: "Weekly ‚Üí monthly ‚Üí 3 monthly",
        keyRisks: ["Cytopenia", "Infection"],
        action: [
          "Dose reduce/stop if cytopenias",
          "Hold during serious infection"
        ],
        highlight: ["cytopenia", "serious infection"],
        severity: "warn"
      },

      // 2) Biologics / targeted
      {
        category: "Biologics & JAK inhibitors",
        drug: "Anti-TNF (e.g., Adalimumab, Infliximab)",
        baseline: "TB screen (IGRA ¬± CXR), Hep B/C ¬± HIV",
        monitoring: "Clinical infection screen; bloods per local policy",
        keyRisks: ["TB reactivation", "Serious infection", "HF worsening"],
        action: [
          "Hold during serious infection",
          "Investigate fever/night sweats: TB until proven otherwise"
        ],
        highlight: ["TB reactivation", "hold during serious infection"],
        severity: "danger"
      },
      {
        category: "Biologics & JAK inhibitors",
        drug: "Rituximab",
        baseline: "Hepatitis B status, immunoglobulins",
        monitoring: "FBC; IgG periodically (esp. recurrent infections)",
        keyRisks: ["Hypogammaglobulinaemia", "Infection"],
        action: [
          "Delay/review if low IgG + infections"
        ],
        highlight: ["IgG", "hypogammaglobulinaemia"],
        severity: "warn"
      },
      {
        category: "Biologics & JAK inhibitors",
        drug: "JAK inhibitors",
        baseline: "FBC, LFT, lipids; VTE risk assessment",
        monitoring: "FBC/LFT 4‚Äì8 weeks then ~3 monthly; lipids later",
        keyRisks: ["VTE", "Herpes zoster", "Cytopenia"],
        action: [
          "Stop/withhold if significant cytopenia",
          "New VTE symptoms: urgent assessment and stop"
        ],
        highlight: ["VTE", "zoster", "cytopenia"],
        severity: "danger"
      },

      // 3) Cardiovascular
      {
        category: "Cardiovascular",
        drug: "ACE inhibitor / ARB",
        baseline: "U&E, K‚Å∫, creatinine/eGFR",
        monitoring: "Recheck U&E/K‚Å∫ 1‚Äì2 weeks after start/change",
        keyRisks: ["AKI", "Hyperkalaemia"],
        action: [
          "Stop if K‚Å∫ > 6.0 mmol/L",
          "Stop/adjust if creatinine rises > 30%"
        ],
        highlight: ["K‚Å∫ > 6.0", "creatinine rises > 30%"],
        severity: "danger"
      },
      {
        category: "Cardiovascular",
        drug: "Loop/thiazide diuretics",
        baseline: "U&E",
        monitoring: "U&E 1‚Äì2 weeks after start/change",
        keyRisks: ["Hyponatraemia", "Hypokalaemia", "AKI"],
        action: [
          "Reduce/withhold if severe derangement or AKI"
        ],
        highlight: ["hyponatraemia", "hypokalaemia", "AKI"],
        severity: "warn"
      },
      {
        category: "Cardiovascular",
        drug: "Spironolactone",
        baseline: "U&E, K‚Å∫",
        monitoring: "U&E/K‚Å∫ ~1 week; then monthly √ó 3; then 3‚Äì6 monthly",
        keyRisks: ["Hyperkalaemia", "Gynaecomastia"],
        action: [
          "Stop if K‚Å∫ > 5.5 mmol/L",
          "Review interacting meds (ACEi/ARB, NSAIDs)"
        ],
        highlight: ["K‚Å∫ > 5.5", "interacting meds"],
        severity: "danger"
      },
      {
        category: "Cardiovascular",
        drug: "Digoxin",
        baseline: "U&E, ECG (level if indicated)",
        monitoring: "Level if toxicity suspected, renal dysfunction, interactions",
        keyRisks: ["Arrhythmias", "Nausea", "Confusion", "Visual disturbance"],
        action: [
          "Hold drug; check level and K‚Å∫"
        ],
        highlight: ["toxicity suspected", "digoxin level", "K‚Å∫"],
        severity: "warn"
      },
      {
        category: "Cardiovascular",
        drug: "Amiodarone",
        baseline: "TFT, LFT, CXR",
        monitoring: "TFT + LFT every 6 months; respiratory symptoms",
        keyRisks: ["Thyroid dysfunction", "Pulmonary toxicity", "Hepatitis"],
        action: [
          "Suspected pulmonary toxicity: stop and urgent assessment",
          "Significant LFT derangement: review/stop"
        ],
        highlight: ["pulmonary toxicity", "TFT every 6 months"],
        severity: "danger"
      },

      // 4) Anticoagulants
      {
        category: "Anticoagulation",
        drug: "Warfarin",
        baseline: "Baseline INR, bleeding risk",
        monitoring: "INR weekly until stable ‚Üí 4‚Äì12 weekly",
        keyRisks: ["Bleeding", "Drug/food interactions"],
        action: [
          "Bleeding: manage per INR/clinical severity (hold ¬± reversal)"
        ],
        highlight: ["INR", "reversal"],
        severity: "danger"
      },
      {
        category: "Anticoagulation",
        drug: "DOACs (Apixaban, Rivaroxaban, etc.)",
        baseline: "U&E/eGFR, LFT, weight",
        monitoring: "Renal function at least annually",
        keyRisks: ["Bleeding", "Accumulation with renal impairment"],
        action: [
          "Dose adjust or switch if eGFR declines below thresholds"
        ],
        highlight: ["renal function", "dose adjust"],
        severity: "warn"
      },
      {
        category: "Anticoagulation",
        drug: "Heparin (UFH/LMWH)",
        baseline: "FBC/platelets, U&E",
        monitoring: "Platelets day 5‚Äì10 for HIT risk; APTT for UFH",
        keyRisks: ["HIT", "Bleeding"],
        action: [
          "Suspected HIT: stop all heparin immediately"
        ],
        highlight: ["HIT", "stop all heparin"],
        severity: "danger"
      },

      // 5) Endocrine / metabolic
      {
        category: "Endocrine & metabolic",
        drug: "Lithium",
        baseline: "U&E/eGFR, TFT, calcium, weight",
        monitoring: "Level every 3 months; U&E/TFT 6 monthly",
        keyRisks: ["Toxicity", "Nephrogenic DI", "Hypothyroidism"],
        action: [
          "Level > 1.5 mmol/L: stop and urgent assessment",
          "Avoid dehydration/NSAIDs/ACEi/thiazides"
        ],
        highlight: ["level > 1.5", "NSAIDs", "thiazides"],
        severity: "danger"
      },
      {
        category: "Endocrine & metabolic",
        drug: "Metformin",
        baseline: "eGFR, B12",
        monitoring: "eGFR at least annually",
        keyRisks: ["Lactic acidosis", "B12 deficiency"],
        action: [
          "Stop if eGFR < 30 mL/min/1.73m¬≤",
          "Hold during acute illness/dehydration/hypoxia/AKI"
        ],
        highlight: ["eGFR < 30", "hold during acute illness"],
        severity: "danger"
      },
      {
        category: "Endocrine & metabolic",
        drug: "Thionamides (Carbimazole/PTU)",
        baseline: "FBC, TFT, LFT",
        monitoring: "TFT every 4‚Äì6 weeks; FBC if symptoms",
        keyRisks: ["Agranulocytosis", "Hepatitis"],
        action: [
          "Sore throat/fever/ulcers: stop and urgent FBC",
          "Jaundice/LFT rise: stop and assess"
        ],
        highlight: ["sore throat/fever", "stop and urgent FBC"],
        severity: "danger"
      },

      // 6) Antimicrobials
      {
        category: "Antimicrobials",
        drug: "Gentamicin",
        baseline: "U&eGFR, weight, hearing",
        monitoring: "Drug levels + U&E regularly",
        keyRisks: ["Nephrotoxicity", "Ototoxicity"],
        action: [
          "Adjust dose/interval by levels; stop if toxicity"
        ],
        highlight: ["drug levels", "nephrotoxicity", "ototoxicity"],
        severity: "danger"
      },
      {
        category: "Antimicrobials",
        drug: "Vancomycin",
        baseline: "U&eGFR, weight",
        monitoring: "Trough levels + renal function",
        keyRisks: ["Nephrotoxicity"],
        action: [
          "Adjust dosing by levels; review if rising creatinine"
        ],
        highlight: ["trough levels", "rising creatinine"],
        severity: "warn"
      },
      {
        category: "Antimicrobials",
        drug: "Linezolid",
        baseline: "FBC",
        monitoring: "Weekly FBC if prolonged therapy",
        keyRisks: ["Thrombocytopenia", "Anaemia", "Serotonin syndrome"],
        action: [
          "Stop if significant cytopenia; review serotonergic meds"
        ],
        highlight: ["weekly FBC", "thrombocytopenia"],
        severity: "warn"
      },
      {
        category: "Antimicrobials",
        drug: "Isoniazid",
        baseline: "LFT, neuropathy risk",
        monitoring: "LFT if symptomatic/high risk",
        keyRisks: ["Hepatitis", "Peripheral neuropathy"],
        action: [
          "Stop if ALT/AST > 3√ó ULN with symptoms",
          "Give pyridoxine if neuropathy risk"
        ],
        highlight: ["ALT/AST > 3√ó ULN", "pyridoxine"],
        severity: "warn"
      },

      // 7) Other high-risk
      {
        category: "Other high-risk drugs",
        drug: "Valproate",
        baseline: "LFT, platelets",
        monitoring: "LFT/platelets periodically",
        keyRisks: ["Hepatotoxicity", "Thrombocytopenia", "Pancreatitis"],
        action: [
          "Stop if significant LFT derangement, bleeding, or pancreatitis"
        ],
        highlight: ["hepatotoxicity", "thrombocytopenia", "pancreatitis"],
        severity: "danger"
      },
      {
        category: "Other high-risk drugs",
        drug: "Carbamazepine",
        baseline: "FBC, U&E (Na‚Å∫), LFT",
        monitoring: "FBC/Na‚Å∫ periodically",
        keyRisks: ["Agranulocytosis", "SIADH ‚Üí hyponatraemia"],
        action: [
          "Stop if significant neutropenia; manage hyponatraemia"
        ],
        highlight: ["neutropenia", "SIADH", "hyponatraemia"],
        severity: "danger"
      },
      {
        category: "Other high-risk drugs",
        drug: "Clozapine",
        baseline: "FBC, ECG",
        monitoring: "FBC per mandatory schedule",
        keyRisks: ["Agranulocytosis", "Myocarditis", "Constipation/ileus"],
        action: [
          "Any breach/cytopenia: stop per clozapine service",
          "Chest pain/dyspnoea early: urgent myocarditis workup"
        ],
        highlight: ["mandatory schedule", "myocarditis", "ileus"],
        severity: "danger"
      }
    ];

    // --- DOM Elements ---
    const grid = document.getElementById('grid');
    const q = document.getElementById('q');
    const cat = document.getElementById('cat');
    const reset = document.getElementById('reset');
    const printBtn = document.getElementById('print');
    const highRiskToggle = document.getElementById('highRiskToggle');
    const stamp = document.getElementById('stamp');

    stamp.textContent = new Date().toLocaleDateString();

    // --- Initialization ---
    const categories = Array.from(new Set(data.map(d => d.category))).sort();
    categories.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      cat.appendChild(opt);
    });

    // --- Helpers ---
    function escapeHtml(s) {
      return (s ?? "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function highlightText(text, needles) {
      if (!text) return "";
      let out = escapeHtml(text);
      (needles || []).forEach(n => {
        if (!n) return;
        // Escape regex special chars in the needle
        const safeN = n.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const re = new RegExp(`(${safeN})`, "gi");
        out = out.replace(re, '<span class="hl">$1</span>');
      });
      return out;
    }

    // --- Component Builders ---
    function getSevIcon(severity) {
      if (severity === 'danger') {
        return `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`;
      } else if (severity === 'warn') {
        return `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line></svg>`;
      }
      return `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
    }

    function buildCard(d) {
      const isDanger = d.severity === "danger";
      
      // Build Risks Pills
      const riskPills = (d.keyRisks || []).map(r => `<span class="risk-pill">${escapeHtml(r)}</span>`).join("");

      // Build Action Items (Highlighted)
      const actionItems = (d.action || []).map(a => `<li>${highlightText(a, d.highlight)}</li>`).join("");

      // Special Alert Box HTML for Danger items
      const alertBoxHtml = isDanger ? `
        <div class="alert-box">
          <div class="alert-title">
            ${getSevIcon('danger')} STOP THRESHOLDS / RED FLAGS
          </div>
          <ul class="alert-list">
            ${actionItems}
          </ul>
        </div>
      ` : '';

      // Standard Action List for Warn/Ok items
      const standardActionsHtml = !isDanger ? `
        <div style="margin-bottom:16px;">
          <span class="label">Key Actions</span>
          <ul style="margin:0; padding-left:18px; font-size:13px;">
            ${actionItems}
          </ul>
        </div>
      ` : '';

      const el = document.createElement('div');
      el.className = "card";
      el.dataset.category = d.category;
      el.dataset.severity = d.severity;

      el.innerHTML = `
        <div class="card-header">
          <h2 class="drug-title">${highlightText(d.drug, d.highlight)}</h2>
          <div style="display:flex; align-items:center;">
            <span class="cat-badge">${escapeHtml(d.category)}</span>
            <div class="sev-icon" title="${d.severity.toUpperCase()}">
              ${getSevIcon(d.severity)}
            </div>
          </div>
        </div>

        <div class="card-body">
          ${alertBoxHtml}
          
          ${standardActionsHtml}

          <div class="data-grid">
            <div class="data-item">
              <span class="label">Baseline</span>
              <span class="value">${highlightText(d.baseline, d.highlight)}</span>
            </div>
            <div class="data-item">
              <span class="label">Monitoring</span>
              <span class="value">${highlightText(d.monitoring, d.highlight)}</span>
            </div>
          </div>

          <div class="risks-container">
            <span class="label">Risks</span>
            <div>${riskPills || "<span style='font-size:12px;color:#94a3b8'>‚Äî</span>"}</div>
          </div>

          <details>
            <summary>Revision Viva Prompt</summary>
            <div class="details-content">
              <strong>Scenario:</strong> "Tell me about monitoring ${escapeHtml(d.drug)}."<br><br>
              1. Start with <strong>Baseline</strong> tests.<br>
              2. State the <strong>Re-check Interval</strong>.<br>
              3. Mention <strong>Stop Thresholds</strong> (specifically ${d.highlight ? d.highlight.join(', ') : 'red flags'}).
            </div>
          </details>
        </div>
      `;
      return el;
    }

    // --- Render Logic ---
    function render() {
      grid.innerHTML = "";
      const query = (q.value || "").trim().toLowerCase();
      const chosen = cat.value;
      const showHighRiskOnly = highRiskToggle.checked;

      const filtered = data.filter(d => {
        // Category Filter
        if (chosen !== "all" && d.category !== chosen) return false;
        
        // Severity Toggle Filter
        if (showHighRiskOnly && d.severity !== "danger") return false;

        // Search Filter
        if (!query) return true;

        const hay = [
          d.drug, d.category, d.baseline, d.monitoring,
          ...(d.keyRisks || []), ...(d.action || [])
        ].join(" ").toLowerCase();

        return hay.includes(query);
      });

      if (filtered.length === 0) {
        const empty = document.createElement('div');
        empty.style.gridColumn = "1 / -1";
        empty.style.padding = "40px";
        empty.style.textAlign = "center";
        empty.style.color = "var(--text-muted)";
        empty.innerHTML = `
          <div style="font-size: 40px; margin-bottom: 10px;">üîç</div>
          <h3>No matches found</h3>
          <p>Try adjusting your search or filters.</p>
        `;
        grid.appendChild(empty);
        return;
      }

      filtered.forEach(d => grid.appendChild(buildCard(d)));
    }

    // --- Event Listeners ---
    q.addEventListener('input', render);
    cat.addEventListener('change', render);
    highRiskToggle.addEventListener('change', render);

    reset.addEventListener('click', () => {
      q.value = "";
      cat.value = "all";
      highRiskToggle.checked = false;
      render();
    });

    printBtn.addEventListener('click', () => window.print());

    // Initial Render
    render();

  </script>
</body>
</html>