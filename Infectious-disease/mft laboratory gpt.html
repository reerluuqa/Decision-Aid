<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MMMP Quick Algorithms — Interactive User Guide</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a30;
      --panel2:#0c162a;
      --text:#e7eefc;
      --muted:#a9b8da;
      --border:rgba(255,255,255,.10);
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --shadow2: 0 12px 26px rgba(0,0,0,.28);
      --radius: 18px;
      --radius2: 14px;
      --focus: rgba(120,180,255,.35);
      --good:#2dd4bf;
      --warn:#fbbf24;
      --bad:#fb7185;
      --info:#60a5fa;

      --c1:#60a5fa; /* blue */
      --c2:#34d399; /* green */
      --c3:#fbbf24; /* amber */
      --c4:#fb7185; /* rose */
      --c5:#a78bfa; /* violet */
      --c6:#22c55e; /* emerald */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1000px 600px at 20% 0%, rgba(96,165,250,.20), transparent 55%),
                  radial-gradient(900px 650px at 95% 15%, rgba(167,139,250,.16), transparent 55%),
                  radial-gradient(900px 650px at 60% 100%, rgba(45,212,191,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
      line-height:1.35;
    }

    a{color:inherit}
    .wrap{
      max-width: 1220px;
      margin: 0 auto;
      padding: 26px 18px 44px;
    }

    header{
      display:flex;
      flex-direction:column;
      gap:14px;
      margin-bottom: 18px;
    }

    .toprow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      min-width: 280px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(96,165,250,.9), rgba(167,139,250,.9));
      box-shadow: 0 12px 24px rgba(0,0,0,.35);
      display:grid;place-items:center;
      border: 1px solid rgba(255,255,255,.20);
    }
    .titleblock h1{
      font-size: 18px;
      margin:0;
      letter-spacing:.2px;
    }
    .titleblock p{
      margin:2px 0 0;
      color:var(--muted);
      font-size: 13px;
      max-width: 680px;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
      user-select:none;
    }
    .pill:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(0,0,0,.25);
      background: rgba(255,255,255,.08);
    }

    .search{
      width:min(520px, 100%);
      display:flex;
      align-items:center;
      gap:10px;
      padding: 12px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      box-shadow: var(--shadow2);
      transition: border-color .18s ease, box-shadow .18s ease, transform .18s ease;
    }
    .search:focus-within{
      border-color: rgba(96,165,250,.55);
      box-shadow: 0 0 0 4px var(--focus), var(--shadow2);
      transform: translateY(-1px);
    }
    .search input{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size: 14px;
    }
    .search input::placeholder{color: rgba(169,184,218,.85)}
    .kdb{
      font-size: 12px;
      color: rgba(231,238,252,.85);
      border: 1px solid rgba(255,255,255,.18);
      padding: 2px 8px;
      border-radius: 8px;
      background: rgba(255,255,255,.05);
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
      margin-top: 14px;
    }

    .card{
      grid-column: span 6;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      transition: transform .20s ease, box-shadow .20s ease, border-color .20s ease;
    }
    .card:hover{
      transform: translateY(-3px);
      box-shadow: 0 22px 55px rgba(0,0,0,.45);
      border-color: rgba(255,255,255,.16);
    }

    .accent{
      position:absolute; inset:0 0 auto 0;
      height: 5px;
      background: var(--c1);
      opacity:.95;
    }

    .cardhead{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding: 16px 16px 12px;
    }

    .icon{
      width:40px;height:40px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.20);
      flex: 0 0 auto;
      box-shadow: 0 10px 20px rgba(0,0,0,.20);
    }

    .headtext{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 0;
      flex:1;
    }
    .headtext h2{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .headtext .sub{
      margin:0;
      color: var(--muted);
      font-size: 13px;
    }

    .badges{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 2px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(231,238,252,.92);
      user-select:none;
    }
    .b-good{border-color: rgba(45,212,191,.35); background: rgba(45,212,191,.10)}
    .b-warn{border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.10)}
    .b-bad{border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.10)}
    .b-info{border-color: rgba(96,165,250,.35); background: rgba(96,165,250,.10)}

    .cardbody{
      padding: 0 16px 14px;
    }

    .accordion{
      border-top: 1px solid rgba(255,255,255,.10);
      margin-top: 10px;
    }
    .accbtn{
      width:100%;
      text-align:left;
      background:transparent;
      border:0;
      color:var(--text);
      padding: 12px 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      font-size: 14px;
    }
    .accbtn:focus{
      outline:none;
      box-shadow: 0 0 0 4px var(--focus);
      border-radius: 12px;
    }
    .chev{
      width:18px;height:18px;
      opacity:.9;
      transition: transform .20s ease;
      flex: 0 0 auto;
    }
    .accbtn[aria-expanded="true"] .chev{ transform: rotate(180deg); }

    .accpanel{
      overflow:hidden;
      max-height: 0;
      transition: max-height .28s ease;
    }
    .accinner{
      padding: 0 0 12px;
      color: rgba(231,238,252,.92);
      font-size: 13.5px;
    }

    .flow{
      margin-top: 10px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    .flowhead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      gap:10px;
      flex-wrap:wrap;
    }
    .flowhead .label{
      font-size: 12.5px;
      color: rgba(169,184,218,.95);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .flowhead .mini{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 9px 10px;
      border-radius: 12px;
      font-size: 13px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      transition: transform .16s ease, background .16s ease, box-shadow .16s ease, border-color .16s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.09);
      box-shadow: 0 12px 22px rgba(0,0,0,.22);
      border-color: rgba(255,255,255,.20);
    }
    .btn:active{ transform: translateY(0px); }
    .btn:focus{
      outline:none;
      box-shadow: 0 0 0 4px var(--focus), 0 12px 22px rgba(0,0,0,.22);
    }
    .btn.primary{
      background: rgba(96,165,250,.16);
      border-color: rgba(96,165,250,.30);
    }
    .btn.danger{
      background: rgba(251,113,133,.14);
      border-color: rgba(251,113,133,.30);
    }

    .node{
      padding: 12px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .nodetop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .nodetitle{
      display:flex;
      align-items:flex-start;
      gap:10px;
      min-width: 0;
      flex:1;
    }
    .nodetitle .pillmini{
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: rgba(231,238,252,.92);
      user-select:none;
      white-space:nowrap;
    }
    .nodetitle h3{
      margin:0;
      font-size: 14px;
      letter-spacing:.1px;
    }
    .nodetitle p{
      margin:4px 0 0;
      color: rgba(169,184,218,.95);
      font-size: 13px;
    }
    .nodemeta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .callout{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      padding: 10px 10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .callout .dot{
      width:10px;height:10px;border-radius:999px;
      margin-top:4px;
      background: var(--info);
      box-shadow: 0 0 0 4px rgba(96,165,250,.18);
      flex:0 0 auto;
    }
    .callout.warn .dot{ background: var(--warn); box-shadow: 0 0 0 4px rgba(251,191,36,.18); }
    .callout.bad .dot{ background: var(--bad); box-shadow: 0 0 0 4px rgba(251,113,133,.18); }
    .callout.good .dot{ background: var(--good); box-shadow: 0 0 0 4px rgba(45,212,191,.18); }
    .callout .txt{
      font-size: 13px;
      color: rgba(231,238,252,.94);
    }
    .callout .txt b{ color: var(--text); }

    .options{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .list{
      margin: 6px 0 0;
      padding: 0 0 0 18px;
      color: rgba(231,238,252,.92);
      font-size: 13px;
    }
    .list li{ margin: 5px 0; color: rgba(231,238,252,.92); }
    .mono{
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum";
    }

    .footer{
      margin-top: 18px;
      color: rgba(169,184,218,.90);
      font-size: 12.5px;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding: 14px 16px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }
    .footer code{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      padding: 2px 6px;
      border-radius: 8px;
      color: rgba(231,238,252,.92);
    }

    @media (max-width: 980px){
      .card{ grid-column: span 12; }
      .actions{ justify-content:flex-start; }
    }

    /* --- subtle motion --- */
    @media (prefers-reduced-motion: reduce){
      *{transition:none !important; scroll-behavior:auto !important}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="toprow">
        <div class="brand">
          <div class="logo" aria-hidden="true">
            <!-- microscope-ish icon -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
              <path d="M6 20h12" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M9 17h6" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M11 3l4 4" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M10 8l4 4" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M8 10l6 6" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M7 21c1-4 3-6 7-6 3 0 5-1 5-4" stroke="white" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="titleblock">
            <h1>MMMP Quick Algorithms</h1>
            <p>Interactive operational workflows for requesting, labelling, transport, urgent & out-of-hours microbiology/virology processing (card-based, searchable).</p>
          </div>
        </div>

        <div class="actions">
          <div class="pill" title="Keyboard tip">
            <span style="opacity:.9">Search</span>
            <span class="kdb">Ctrl</span><span class="kdb">K</span>
          </div>
          <div class="pill" id="expandAllBtn" role="button" tabindex="0" aria-label="Expand all cards">
            <span style="opacity:.9">Expand all</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M7 10l5 5 5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="pill" id="collapseAllBtn" role="button" tabindex="0" aria-label="Collapse all cards">
            <span style="opacity:.9">Collapse all</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M7 14l5-5 5 5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </div>
      </div>

      <div class="search" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="opacity:.9">
          <path d="M21 21l-4.3-4.3" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <path d="M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" stroke="white" stroke-width="2"/>
        </svg>
        <input id="q" type="text" placeholder="Filter cards (e.g., urgent, out-of-hours, CSF, pod, labelling, EPIC, virology, Wythenshawe)..." />
        <span class="kdb" aria-hidden="true">Esc</span>
      </div>
    </header>

    <section class="grid" id="grid">

      <!-- CARD 1: WHO TO CALL -->
      <article class="card" data-tags="contact advice results switchboard virology microbiology wythenshawe oxford road urgent">
        <div class="accent" style="background: var(--c1)"></div>
        <div class="cardhead">
          <div class="icon" style="outline: 2px solid rgba(96,165,250,.25)">
            <!-- phone -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M22 16.9v3a2 2 0 0 1-2.2 2A19.8 19.8 0 0 1 3 5.2 2 2 0 0 1 5 3h3a2 2 0 0 1 2 1.7c.1.8.3 1.6.6 2.4a2 2 0 0 1-.5 2.1L9 10a16 16 0 0 0 5 5l.8-1.1a2 2 0 0 1 2.1-.5c.8.3 1.6.5 2.4.6A2 2 0 0 1 22 16.9Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="headtext">
            <h2>Who to call (routine vs urgent vs out-of-hours)</h2>
            <p class="sub">Decision tree for the fastest correct contact route.</p>
            <div class="badges">
              <span class="badge b-info">Microbiology</span>
              <span class="badge b-info">Virology</span>
              <span class="badge b-warn">Out-of-hours = emergency service</span>
            </div>
          </div>
        </div>

        <div class="cardbody">
          <div class="flow" data-flow="contactFlow"></div>

          <div class="accordion">
            <button class="accbtn" aria-expanded="false">
              Quick reference numbers & notes
              <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M7 10l5 5 5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div class="accpanel">
              <div class="accinner">
                <div class="callout good">
                  <div class="dot"></div>
                  <div class="txt">
                    <b>MMMP main telephone:</b> <span class="mono">0161 276 8788</span> (menu options for results/enquiries, virology, microbiology, out-of-hours, MRU/VEU, tracking).  
                    <br><span style="opacity:.9">Have up-to-date clinical context available when seeking advice.</span>
                  </div>
                </div>

                <div class="callout warn" style="margin-top:10px;">
                  <div class="dot"></div>
                  <div class="txt">
                    <b>Out-of-hours urgent testing:</b> via Hospital Switchboard <span class="mono">0161 276 1234</span> (ask for duty BMS / on-call services as appropriate).
                  </div>
                </div>

                <ul class="list">
                  <li>Microbiology routine advice: generally 9–5 weekdays; some sections note extension numbers for results/advice lines.</li>
                  <li>Wythenshawe site: routine clinical advice and urgent testing numbers are listed; out-of-hours urgent advice routed via switchboard.</li>
                  <li>Virology: routine advice via call centre numbers; out-of-hours ask for duty Consultant Virologist via switchboard.</li>
                </ul>

                <div class="callout" style="margin-top:10px;">
                  <div class="dot"></div>
                  <div class="txt">
                    <b>Operational reminder:</b> check electronic results systems first (ICE/Chameleon/HIVE/EPIC pathways as used locally) before phoning for routine updates.
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </article>

      <!-- CARD 2: URGENT DURING ROUTINE HOURS -->
      <article class="card" data-tags="urgent notify prioritise routine hours csf blood culture contact details">
        <div class="accent" style="background: var(--c3)"></div>
        <div class="cardhead">
          <div class="icon" style="outline: 2px solid rgba(251,191,36,.25)">
            <!-- bolt -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M13 2L3 14h7l-1 8 10-12h-7l1-8Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="headtext">
            <h2>Urgent processing (arrives in working hours)</h2>
            <p class="sub">Notify the laboratory to prioritise; ensure contact details for call-back.</p>
            <div class="badges">
              <span class="badge b-warn">Notify lab by phone</span>
              <span class="badge b-info">Provide call-back details</span>
            </div>
          </div>
        </div>

        <div class="cardbody">
          <div class="flow" data-flow="urgentInHoursFlow"></div>

          <div class="accordion">
            <button class="accbtn" aria-expanded="false">
              Notes that commonly cause delays
              <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M7 10l5 5 5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div class="accpanel">
              <div class="accinner">
                <ul class="list">
                  <li>Urgent samples should be <b>phoned through</b> to avoid processing delays.</li>
                  <li>Where used, rapid transport systems (pod/tube) are encouraged for routine specimens but have exclusions (see “Pod/tube suitability” card).</li>
                  <li>Blood cultures: do <b>not</b> refrigerate; send directly to specimen reception/lab reception.</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </article>

      <!-- CARD 3: OUT OF HOURS SUBMISSION -->
      <article class="card" data-tags="out-of-hours on-call bms protocol agreement emergency service csf joint fluid ascitic paediatric urine">
        <div class="accent" style="background: var(--c4)"></div>
        <div class="cardhead">
          <div class="icon" style="outline: 2px solid rgba(251,113,133,.25)">
            <!-- moon -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M21 15.5A8.5 8.5 0 0 1 8.5 3a7 7 0 1 0 12.5 12.5Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="headtext">
            <h2>Out-of-hours urgent testing (microbiology/virology)</h2>
            <p class="sub">Agreement first → correct transport pathway → limited investigation menu.</p>
            <div class="badges">
              <span class="badge b-bad">Do not send as urgent without prior agreement</span>
              <span class="badge b-warn">Ward responsible for transport</span>
            </div>
          </div>
        </div>

        <div class="cardbody">
          <div class="flow" data-flow="oohFlow"></div>

          <div class="accordion">
            <button class="accbtn" aria-expanded="false">
              Typical out-of-hours test menu (microbiology / virology)
              <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M7 10l5 5 5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div class="accpanel">
              <div class="accinner">
                <div class="callout warn">
                  <div class="dot"></div>
                  <div class="txt">
                    <b>Microbiology out-of-hours</b> is an <b>emergency service</b> with a limited investigation set.
                  </div>
                </div>
                <ul class="list">
                  <li>Paediatric emergency admission urines (&lt;3 months; and &gt;3 months with dipstick leucocytes/nitrites positive).</li>
                  <li>CSF: cell count & culture (TB investigations not processed out-of-hours).</li>
                  <li>Ascitic/peritoneal fluid: cell count & culture.</li>
                  <li>Joint fluids: gram stain & culture (crystals via histopathology; differential via cytology with separate sample/request).</li>
                  <li>Sterile fluids may be considered after discussion; investigations requiring lone containment level 3 working are not performed.</li>
                </ul>

                <div class="callout" style="margin-top:10px;">
                  <div class="dot"></div>
                  <div class="txt">
                    <b>Virology out-of-hours</b> lists a restricted urgent assay set (e.g., BBV serology/antigen-antibody screens and selected urinary antigens).
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </article>

      <!-- CARD 4: POD / PNEUMATIC TUBE SUITABILITY -->
      <article class="card" data-tags="pneumatic tube pod excluded respiratory csf mycobacterial hg3 glassware leaking precious">
        <div class="accent" style="background: var(--c2)"></div>
        <div class="cardhead">
          <div class="icon" style="outline: 2px solid rgba(52,211,153,.25)">
            <!-- package -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M21 8l-9 5-9-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M3 8l9-5 9 5v10l-9 5-9-5V8Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
              <path d="M12 13v10" stroke="white" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="headtext">
            <h2>Can I use pod / pneumatic tube?</h2>
            <p class="sub">Interactive rule-check for exclusions to prevent specimen compromise and safety incidents.</p>
            <div class="badges">
              <span class="badge b-good">Fast delivery when permitted</span>
              <span class="badge b-bad">HG3 & glassware exclusions</span>
            </div>
          </div>
        </div>

        <div class="cardbody">
          <div class="flow" data-flow="tubeFlow"></div>

          <div class="accordion">
            <button class="accbtn" aria-expanded="false">
              Exclusion list (high-yield)
              <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M7 10l5 5 5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div class="accpanel">
              <div class="accinner">
                <div class="callout bad">
                  <div class="dot"></div>
                  <div class="txt"><b>Must NOT be sent via pneumatic tube</b> (examples explicitly listed): respiratory samples (e.g., pleural fluid in blood culture bottle, sputum, BAL), mycobacterial investigations (including Myco/Lytic culture bottle), CSF, leaking/damaged specimens, precious/unrepeatable samples.</div>
                </div>
                <div class="callout warn" style="margin-top:10px;">
                  <div class="dot"></div>
                  <div class="txt"><b>Pod system:</b> encouraged for quick delivery where used, but <b>HG3 samples and glassware must never be sent</b>. Bactex FX40 glass bottles for mycobacteria must be transported by porter (not pod).</div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </article>

      <!-- CARD 5: SPECIMEN LABELLING & ACCEPTANCE -->
      <article class="card" data-tags="labelling identifiers acceptance policy reject mismatch illegible hazardous leaking tube type">
        <div class="accent" style="background: var(--c5)"></div>
        <div class="cardhead">
          <div class="icon" style="outline: 2px solid rgba(167,139,250,.25)">
            <!-- id card -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M3 6h18v12H3V6Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
              <path d="M7 10h6" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M7 14h10" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M16.5 10.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3Z" stroke="white" stroke-width="2"/>
            </svg>
          </div>
          <div class="headtext">
            <h2>Specimen labelling & acceptance screening</h2>
            <p class="sub">Rapid checklist to prevent rejection and re-bleeding/re-sampling.</p>
            <div class="badges">
              <span class="badge b-warn">≥4 identifiers (minimum)</span>
              <span class="badge b-bad">Mismatch / illegible / hazardous → rejection</span>
            </div>
          </div>
        </div>

        <div class="cardbody">
          <div class="flow" data-flow="labelFlow"></div>

          <div class="accordion">
            <button class="accbtn" aria-expanded="false">
              Rejection triggers (from acceptance policy summary)
              <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M7 10l5 5 5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div class="accpanel">
              <div class="accinner">
                <ul class="list">
                  <li>No unique identification / below minimum dataset.</li>
                  <li>Incorrect sample type/tube.</li>
                  <li>Incorrect transport conditions.</li>
                  <li>Hazardous condition (e.g., leaking; sharps attached).</li>
                  <li>Unlabelled or insufficiently labelled specimen/request.</li>
                  <li>Mismatch between request and sample identifiers.</li>
                  <li>Illegible information.</li>
                </ul>

                <div class="callout warn">
                  <div class="dot"></div>
                  <div class="txt">
                    <b>Label at time of collection</b> with positive patient ID cross-check. <b>Pre-labelling</b> is poor practice and increases misidentification risk.
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </article>

      <!-- CARD 6: REQUESTING (EPIC/BEAKER) -->
      <article class="card" data-tags="requesting epic beaker barcoded sticker scan collection time clinical information specimen type source">
        <div class="accent" style="background: var(--c6)"></div>
        <div class="cardhead">
          <div class="icon" style="outline: 2px solid rgba(34,197,94,.25)">
            <!-- clipboard -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M9 5h6" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M10 3h4a2 2 0 0 1 2 2v1H8V5a2 2 0 0 1 2-2Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
              <path d="M7 6h10v15H7V6Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
              <path d="M9 10h6" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M9 14h6" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M9 18h4" stroke="white" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="headtext">
            <h2>Electronic requesting (EPIC / BEAKER) workflow</h2>
            <p class="sub">Order → print label at collection → scan to confirm collection time → provide clinical metadata.</p>
            <div class="badges">
              <span class="badge b-good">Barcode label + scan-in</span>
              <span class="badge b-warn">Wrong specimen type/source → wrong testing</span>
            </div>
          </div>
        </div>

        <div class="cardbody">
          <div class="flow" data-flow="epicFlow"></div>

          <div class="accordion">
            <button class="accbtn" aria-expanded="false">
              Clinical information: what matters for validation & biosafety
              <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M7 10l5 5 5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div class="accpanel">
              <div class="accinner">
                <ul class="list">
                  <li>Symptoms/clinical syndrome, date of onset, antibiotic exposure, outbreak context, foreign travel.</li>
                  <li>Correct specimen type and source selection is essential to avoid mis-testing.</li>
                  <li>Relevant clinical info supports: result authorisation, urgent communication triggers, and identification of high-risk samples requiring additional biosafety measures.</li>
                </ul>
              </div>
            </div>
          </div>

        </div>
      </article>

    </section>

    <div class="footer" role="note">
      <div>
        <b>Data source:</b> MMMP User Guide (Edition 21, Oct 2024) sections on contact pathways, requesting, labelling/acceptance, transport, urgent/out-of-hours workflows, and pneumatic tube/pod exclusions. :contentReference[oaicite:1]{index=1}
      </div>
      <div>
        <b>Tips:</b> Use <code>Ctrl+K</code> to jump to search. Use <code>Esc</code> to clear. Each card contains a clickable algorithm + expandable “reference” text.
      </div>
    </div>
  </div>

  <script>
    // ---------- small helpers ----------
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    // ---------- accordion behavior (smooth max-height) ----------
    function setPanelHeight(panel, open){
      const inner = panel.firstElementChild;
      if (!inner) return;
      if (open){
        // measure
        panel.style.maxHeight = inner.scrollHeight + "px";
      } else {
        panel.style.maxHeight = "0px";
      }
    }

    function wireAccordions(){
      $$(".accordion").forEach(acc => {
        const btn = $(".accbtn", acc);
        const panel = $(".accpanel", acc);
        if (!btn || !panel) return;

        btn.addEventListener("click", () => {
          const isOpen = btn.getAttribute("aria-expanded") === "true";
          btn.setAttribute("aria-expanded", String(!isOpen));
          setPanelHeight(panel, !isOpen);
        });

        // reset on resize (keep height consistent)
        window.addEventListener("resize", () => {
          const isOpen = btn.getAttribute("aria-expanded") === "true";
          if (isOpen) setPanelHeight(panel, true);
        });
      });
    }

    function expandAll(){
      $$(".accordion").forEach(acc => {
        const btn = $(".accbtn", acc);
        const panel = $(".accpanel", acc);
        if (!btn || !panel) return;
        btn.setAttribute("aria-expanded", "true");
        setPanelHeight(panel, true);
      });
    }
    function collapseAll(){
      $$(".accordion").forEach(acc => {
        const btn = $(".accbtn", acc);
        const panel = $(".accpanel", acc);
        if (!btn || !panel) return;
        btn.setAttribute("aria-expanded", "false");
        setPanelHeight(panel, false);
      });
    }

    // ---------- Flow engine ----------
    // Each flow = nodes map + start id. Node has:
    //  - title, text[], severity (info|warn|bad|good), tag badges, options [{label,next,style}]
    //  - optionally "details" list items
    function renderFlow(container, flow){
      const state = { nodeId: flow.start, history: [] };

      const head = document.createElement("div");
      head.className = "flowhead";
      head.innerHTML = `
        <div class="label">
          <span class="mono">Algorithm</span>
          <span class="badge b-info">${flow.badge || "Interactive"}</span>
        </div>
        <div class="mini">
          <button class="btn" data-act="reset" title="Restart algorithm">Restart</button>
          <button class="btn" data-act="back" title="Go back one step">Back</button>
          <button class="btn primary" data-act="copy" title="Copy current step to clipboard">Copy step</button>
        </div>
      `;

      const nodeWrap = document.createElement("div");
      nodeWrap.className = "node";

      container.innerHTML = "";
      container.appendChild(head);
      container.appendChild(nodeWrap);

      function nodeSeverityClass(sev){
        if (sev === "good") return "good";
        if (sev === "warn") return "warn";
        if (sev === "bad")  return "bad";
        return ""; // info
      }

      function formatNode(n){
        const sev = n.severity || "info";
        const callout = document.createElement("div");
        callout.className = "callout " + nodeSeverityClass(sev);

        const dot = document.createElement("div");
        dot.className = "dot";
        callout.appendChild(dot);

        const txt = document.createElement("div");
        txt.className = "txt";

        const lines = (n.text || []).map(t => `<div>${t}</div>`).join("");
        txt.innerHTML = lines;
        callout.appendChild(txt);

        const top = document.createElement("div");
        top.className = "nodetop";

        const left = document.createElement("div");
        left.className = "nodetitle";
        left.innerHTML = `
          <div class="pillmini">${flow.short || "Flow"}</div>
          <div style="min-width:0">
            <h3>${n.title}</h3>
            ${n.subtitle ? `<p>${n.subtitle}</p>` : ""}
          </div>
        `;

        const meta = document.createElement("div");
        meta.className = "nodemeta";
        (n.tags || []).forEach(t => {
          const span = document.createElement("span");
          span.className = "badge " + (t.kind || "b-info");
          span.textContent = t.label;
          meta.appendChild(span);
        });

        top.appendChild(left);
        top.appendChild(meta);

        const options = document.createElement("div");
        options.className = "options";
        (n.options || []).forEach(o => {
          const b = document.createElement("button");
          b.className = "btn " + (o.style || "");
          b.textContent = o.label;
          b.addEventListener("click", () => {
            if (o.next){
              state.history.push(state.nodeId);
              state.nodeId = o.next;
              draw();
            }
          });
          options.appendChild(b);
        });

        const details = document.createElement("div");
        if (n.details && n.details.length){
          const ul = document.createElement("ul");
          ul.className = "list";
          n.details.forEach(li => {
            const item = document.createElement("li");
            item.innerHTML = li;
            ul.appendChild(item);
          });
          details.appendChild(ul);
        }

        nodeWrap.innerHTML = "";
        nodeWrap.appendChild(top);
        nodeWrap.appendChild(callout);
        if (details.childNodes.length) nodeWrap.appendChild(details);
        if (options.childNodes.length) nodeWrap.appendChild(options);
      }

      function draw(){
        const n = flow.nodes[state.nodeId];
        if (!n) return;
        formatNode(n);
        // disable back if no history
        const back = $('[data-act="back"]', head);
        if (back) back.disabled = state.history.length === 0;
      }

      head.addEventListener("click", async (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        const act = btn.getAttribute("data-act");
        if (act === "reset"){
          state.nodeId = flow.start;
          state.history = [];
          draw();
        } else if (act === "back"){
          if (state.history.length){
            state.nodeId = state.history.pop();
            draw();
          }
        } else if (act === "copy"){
          const n = flow.nodes[state.nodeId];
          const plain = [
            `${flow.name} — ${n.title}`,
            ...(n.text || []).map(t => t.replace(/<[^>]*>/g, "")),
            ...(n.details || []).map(t => "- " + t.replace(/<[^>]*>/g, "")),
          ].join("\n");
          try{
            await navigator.clipboard.writeText(plain);
            btn.textContent = "Copied ✓";
            setTimeout(()=>btn.textContent="Copy step", 900);
          }catch(_){
            btn.textContent = "Copy failed";
            setTimeout(()=>btn.textContent="Copy step", 900);
          }
        }
      });

      draw();
    }

    // ---------- Flows (content derived from MMMP manual sections) ----------
    const FLOWS = {
      contactFlow: {
        name: "Who to call",
        short: "Contact",
        badge: "Routing",
        start: "s0",
        nodes: {
          s0: {
            title: "Choose your purpose",
            subtitle: "Pick the closest match to route you to the correct service line.",
            severity: "info",
            text: [
              "Select the scenario that best fits your need (results / clinical advice / urgent specimen notification / out-of-hours)."
            ],
            tags: [{label:"Fast routing", kind:"b-info"}],
            options: [
              {label:"Routine results / general enquiries", next:"s1"},
              {label:"Clinical advice (routine hours)", next:"s2"},
              {label:"Notify urgent specimen (in-hours)", next:"s3", style:"primary"},
              {label:"Out-of-hours urgent testing/advice", next:"s4", style:"danger"},
            ]
          },
          s1: {
            title: "Routine results / general enquiries",
            severity: "info",
            text: [
              "<b>Primary route:</b> MMMP main telephone <span class='mono'>0161 276 8788</span> (results/general enquiries pathway).",
              "If your query is a routine update, check the electronic results system first where applicable."
            ],
            tags: [{label:"Routine", kind:"b-info"}],
            details: [
              "Culture results are typically available ≥24h after receipt; sensitivities often after a further 24h (sample-dependent).",
              "New specimen information is often updated by late morning on weekdays (workflow dependent)."
            ],
            options: [{label:"Back to start", next:"s0"}]
          },
          s2: {
            title: "Clinical advice (routine hours)",
            severity: "info",
            text: [
              "Use the relevant microbiology/virology advice line in routine hours; keep <b>clinical timeline, antimicrobials, allergy history, and relevant microbiology</b> to hand.",
              "For empiric antimicrobial choice, consult local antimicrobial guidance first (then call if unresolved/complex)."
            ],
            tags: [{label:"Advice", kind:"b-info"}],
            details: [
              "Microbiology advice is provided weekdays; out-of-hours advice is via on-call pathways.",
              "Wythenshawe has site-specific routine clinical advice numbers listed in the manual."
            ],
            options: [{label:"Back to start", next:"s0"}]
          },
          s3: {
            title: "Notify an urgent specimen (arrives in working hours)",
            severity: "warn",
            text: [
              "<b>Action:</b> telephone the laboratory to notify and allow prioritisation.",
              "<b>Ensure:</b> call-back/contact details are provided on the request so results can be phoned through promptly."
            ],
            tags: [{label:"Urgent", kind:"b-warn"}],
            options: [
              {label:"Open urgent in-hours algorithm", next:"jumpUrgent", style:"primary"},
              {label:"Back to start", next:"s0"},
            ]
          },
          jumpUrgent: {
            title: "Shortcut",
            severity: "info",
            text: [
              "Use the <b>Urgent processing</b> card for step-by-step routing."
            ],
            tags: [{label:"See card", kind:"b-info"}],
            options: [{label:"Back to start", next:"s0"}]
          },
          s4: {
            title: "Out-of-hours urgent testing/advice",
            severity: "bad",
            text: [
              "<b>Do not send specimens as urgent out-of-hours without prior agreement</b> with on-call laboratory staff.",
              "<b>Contact:</b> Hospital Switchboard <span class='mono'>0161 276 1234</span> to reach the duty BMS / on-call service."
            ],
            tags: [{label:"OOH", kind:"b-bad"}],
            details: [
              "Out-of-hours microbiology/virology services are emergency services with limited investigation menus.",
              "Ward/requesting area is responsible for arranging timely transport (porter/pneumatic tube where permitted)."
            ],
            options: [{label:"Open out-of-hours algorithm", next:"jumpOOH", style:"danger"}, {label:"Back to start", next:"s0"}]
          },
          jumpOOH: {
            title: "Shortcut",
            severity: "info",
            text: [
              "Use the <b>Out-of-hours urgent testing</b> card for step-by-step workflow and typical test menu."
            ],
            tags: [{label:"See card", kind:"b-info"}],
            options: [{label:"Back to start", next:"s0"}]
          }
        }
      },

      urgentInHoursFlow: {
        name: "Urgent processing in-hours",
        short: "Urgent",
        badge: "In-hours",
        start: "u0",
        nodes: {
          u0: {
            title: "Is the sample expected to arrive during routine lab hours?",
            severity: "info",
            text: ["If <b>yes</b>, you can request prioritisation by notifying the lab by telephone."],
            tags: [{label:"Decision node", kind:"b-info"}],
            options: [
              {label:"Yes (arrives in-hours)", next:"u1", style:"primary"},
              {label:"No (out-of-hours arrival)", next:"u3", style:"danger"},
            ]
          },
          u1: {
            title: "Notify the laboratory by telephone",
            severity: "warn",
            text: [
              "<b>Call the laboratory</b> to notify an urgent specimen so the request can be prioritised.",
              "Provide <b>direct call-back details</b> for urgent communication of results."
            ],
            tags: [{label:"Phone first", kind:"b-warn"}],
            details: [
              "If using rapid transport (pod/tube), you still need to notify the lab for urgent prioritisation.",
              "Ensure correct specimen type/source selection and adequate clinical information on the request."
            ],
            options: [
              {label:"Specimen is CSF / sterile site?", next:"u2", style:"primary"},
              {label:"Specimen is not CSF/sterile site", next:"u4"},
              {label:"Restart", next:"u0"},
            ]
          },
          u2: {
            title: "High-priority specimen types (examples)",
            severity: "warn",
            text: [
              "For time-critical specimens (e.g., <b>CSF</b>, positive blood culture alerts, other sterile sites), early notification supports rapid triage and communication."
            ],
            tags: [{label:"Time-critical", kind:"b-warn"}],
            details: [
              "Do not send CSF via pneumatic tube if excluded locally (see tube/pod card).",
              "Blood cultures should not be refrigerated; send directly to reception."
            ],
            options: [{label:"Proceed to transport suitability check", next:"u4", style:"primary"}]
          },
          u3: {
            title: "If arrival is out-of-hours",
            severity: "bad",
            text: [
              "<b>Agreement first:</b> urgent out-of-hours specimens should not be sent before agreement with on-call laboratory staff.",
              "Contact Hospital Switchboard <span class='mono'>0161 276 1234</span> to reach the duty BMS/on-call service."
            ],
            tags: [{label:"OOH rules", kind:"b-bad"}],
            options: [{label:"Open out-of-hours algorithm", next:"u5", style:"danger"}, {label:"Restart", next:"u0"}]
          },
          u4: {
            title: "Transport pathway (in-hours)",
            severity: "info",
            text: [
              "Arrange rapid transport via local pathways (porter / pod / pneumatic tube where permitted).",
              "Check exclusions for pod/tube (HG3, glassware, CSF, mycobacterial investigations, respiratory samples, leaking/damaged, precious)."
            ],
            tags: [{label:"Transport", kind:"b-info"}],
            options: [
              {label:"Run pod/tube suitability check", next:"u6", style:"primary"},
              {label:"Finish", next:"u7"}
            ]
          },
          u5: {
            title: "Go to out-of-hours workflow",
            severity: "info",
            text: ["Use the out-of-hours algorithm card for step-by-step actions."],
            tags: [{label:"See card", kind:"b-info"}],
            options: [{label:"Restart", next:"u0"}]
          },
          u6: {
            title: "Pod/tube suitability reminder",
            severity: "warn",
            text: [
              "If excluded from pod/tube, use porter/courier routes.",
              "If in doubt, contact specimen reception for advice per local process."
            ],
            tags: [{label:"Safety", kind:"b-warn"}],
            options: [{label:"Finish", next:"u7"}]
          },
          u7: {
            title: "Endpoint: urgent in-hours request submitted correctly",
            severity: "good",
            text: [
              "<b>Done:</b> lab notified + correct request info + appropriate transport pathway."
            ],
            tags: [{label:"Complete", kind:"b-good"}],
            options: [{label:"Restart", next:"u0"}]
          }
        }
      },

      oohFlow: {
        name: "Out-of-hours urgent testing",
        short: "OOH",
        badge: "On-call",
        start: "o0",
        nodes: {
          o0: {
            title: "Do you need urgent testing outside routine hours?",
            severity: "bad",
            text: [
              "<b>Out-of-hours services are emergency services</b> with limited investigations.",
              "Urgent specimens <b>should not be sent before agreement</b> with on-call laboratory staff."
            ],
            tags: [{label:"Agreement first", kind:"b-bad"}],
            options: [
              {label:"Yes — urgent OOH", next:"o1", style:"danger"},
              {label:"No — can wait until routine hours", next:"o8"},
            ]
          },
          o1: {
            title: "Call the on-call Biomedical Scientist via switchboard",
            severity: "bad",
            text: [
              "<b>Contact:</b> Hospital Switchboard <span class='mono'>0161 276 1234</span> and ask for the duty BMS / on-call service.",
              "Discuss specimen type + clinical urgency + required investigation."
            ],
            tags: [{label:"Switchboard", kind:"b-bad"}],
            options: [
              {label:"Agreement obtained", next:"o2", style:"primary"},
              {label:"No agreement / unclear indication", next:"o7"},
            ]
          },
          o2: {
            title: "Prepare specimen and request correctly",
            severity: "warn",
            text: [
              "Package and label correctly (minimum identifiers; avoid leaks/sharps).",
              "Ensure request includes adequate clinical information and call-back details."
            ],
            tags: [{label:"Packaging", kind:"b-warn"}],
            options: [
              {label:"Where are you sending from?", next:"o3", style:"primary"},
            ]
          },
          o3: {
            title: "Select sending site pathway",
            severity: "info",
            text: ["OOH routing differs for MFT vs partner hospitals."],
            tags: [{label:"Routing", kind:"b-info"}],
            options: [
              {label:"MFT (Oxford Road Campus)", next:"o4", style:"primary"},
              {label:"Wythenshawe/Trafford/Christie/partner", next:"o5"},
            ]
          },
          o4: {
            title: "MFT OOH: arrange immediate transport",
            severity: "warn",
            text: [
              "<b>Ward/requesting area is responsible</b> for transport (porter / pneumatic tube where permitted).",
              "Send specimen to reception immediately as agreed."
            ],
            tags: [{label:"Transport", kind:"b-warn"}],
            options: [{label:"Finish", next:"o6", style:"primary"}]
          },
          o5: {
            title: "Partner sites OOH: courier/taxi to Autolab reception",
            severity: "warn",
            text: [
              "Requesting hospital is responsible for packaging and arranging taxi/courier.",
              "Courier should deliver <b>directly to MFT Autolab reception</b>; security intercom access is used out-of-hours."
            ],
            tags: [{label:"Courier", kind:"b-warn"}],
            options: [{label:"Finish", next:"o6", style:"primary"}]
          },
          o6: {
            title: "Endpoint: OOH urgent specimen accepted into on-call pathway",
            severity: "good",
            text: [
              "<b>Done:</b> agreement obtained → specimen transported correctly → processing proceeds per on-call test menu."
            ],
            tags: [{label:"Complete", kind:"b-good"}],
            options: [{label:"Restart", next:"o0"}]
          },
          o7: {
            title: "If no agreement: specimen will be processed routinely",
            severity: "bad",
            text: [
              "OOH urgent specimens sent without prior agreement may be processed as routine.",
              "If urgency persists, re-contact the on-call pathway with clear indication and specimen details."
            ],
            tags: [{label:"Risk of delay", kind:"b-bad"}],
            options: [{label:"Back to call step", next:"o1", style:"danger"}, {label:"Restart", next:"o0"}]
          },
          o8: {
            title: "Plan for routine-hours submission",
            severity: "info",
            text: [
              "Store/transport per specimen requirements (note: blood cultures should not be refrigerated).",
              "Submit at earliest opportunity in routine hours with correct labelling and request information."
            ],
            tags: [{label:"Routine plan", kind:"b-info"}],
            options: [{label:"Restart", next:"o0"}]
          }
        }
      },

      tubeFlow: {
        name: "Pod / Pneumatic tube suitability",
        short: "Transport",
        badge: "Suitability",
        start: "t0",
        nodes: {
          t0: {
            title: "Choose the transport system you plan to use",
            severity: "info",
            text: ["Select <b>pod</b> or <b>pneumatic tube</b> to run the exclusion check."],
            tags: [{label:"Rule check", kind:"b-info"}],
            options: [
              {label:"Pod system", next:"t1", style:"primary"},
              {label:"Pneumatic tube", next:"t5", style:"primary"},
            ]
          },
          t1: {
            title: "Pod system exclusion check",
            severity: "warn",
            text: [
              "Pod is encouraged for quick delivery where used, <b>except</b> for excluded categories."
            ],
            tags: [{label:"Pod", kind:"b-info"}],
            options: [
              {label:"HG3 sample?", next:"t2", style:"danger"},
              {label:"Glassware / mycobacterial Bactex FX40 glass bottle?", next:"t2", style:"danger"},
              {label:"Neither", next:"t3", style:"primary"},
            ]
          },
          t2: {
            title: "Do NOT use pod",
            severity: "bad",
            text: [
              "<b>Pod must NOT be used</b> for HG3 samples or glassware.",
              "Mycobacterial Bactex FX40 glass bottles should be transported by <b>porter</b>."
            ],
            tags: [{label:"Excluded", kind:"b-bad"}],
            options: [{label:"Restart", next:"t0"}]
          },
          t3: {
            title: "Pod may be used (if locally permitted)",
            severity: "good",
            text: [
              "If not excluded, pod can support rapid delivery. Ensure specimen is non-leaking and packaged appropriately."
            ],
            tags: [{label:"Permitted", kind:"b-good"}],
            options: [
              {label:"Run a specimen safety check", next:"t4", style:"primary"},
              {label:"Restart", next:"t0"},
            ]
          },
          t4: {
            title: "Specimen safety check",
            severity: "warn",
            text: [
              "If specimen is damaged/leaking or has sharps attached, it is hazardous and should not be sent via automated systems."
            ],
            tags: [{label:"Safety", kind:"b-warn"}],
            options: [{label:"Restart", next:"t0"}]
          },
          t5: {
            title: "Pneumatic tube exclusion check",
            severity: "warn",
            text: [
              "Some specimens <b>must not</b> be sent via pneumatic tube."
            ],
            tags: [{label:"Tube", kind:"b-info"}],
            options: [
              {label:"Respiratory sample (e.g., sputum/BAL/pleural fluid in BC bottle)?", next:"t6", style:"danger"},
              {label:"Mycobacterial investigations / Myco-Lytic bottle?", next:"t6", style:"danger"},
              {label:"CSF?", next:"t6", style:"danger"},
              {label:"Leaking/damaged specimen or precious/unrepeatable?", next:"t6", style:"danger"},
              {label:"None of the above", next:"t7", style:"primary"},
            ]
          },
          t6: {
            title: "Do NOT use pneumatic tube",
            severity: "bad",
            text: [
              "<b>Excluded:</b> respiratory samples, mycobacterial investigations (incl. Myco/Lytic), CSF, leaking/damaged specimens, precious/unrepeatable samples."
            ],
            tags: [{label:"Excluded", kind:"b-bad"}],
            options: [{label:"Use porter/courier instead", next:"t8", style:"primary"}, {label:"Restart", next:"t0"}]
          },
          t7: {
            title: "Tube may be used (if locally permitted)",
            severity: "good",
            text: [
              "For non-excluded specimens (e.g., swabs, faeces, urines, many bloods), pneumatic tube can be used if compliant with local policy."
            ],
            tags: [{label:"Permitted", kind:"b-good"}],
            options: [{label:"Restart", next:"t0"}]
          },
          t8: {
            title: "Fallback: porter/courier pathway",
            severity: "info",
            text: [
              "Use porter or courier transport to specimen reception/lab reception as appropriate."
            ],
            tags: [{label:"Alternative", kind:"b-info"}],
            options: [{label:"Restart", next:"t0"}]
          }
        }
      },

      labelFlow: {
        name: "Labelling & acceptance screening",
        short: "Labelling",
        badge: "Checklist",
        start: "l0",
        nodes: {
          l0: {
            title: "At the bedside: label immediately after collecting",
            severity: "warn",
            text: [
              "<b>Label at time of collection</b> with positive patient identification cross-check.",
              "Avoid <b>pre-labelling</b> containers (misidentification risk)."
            ],
            tags: [{label:"Patient safety", kind:"b-warn"}],
            options: [
              {label:"Confirm ≥4 identifiers present", next:"l1", style:"primary"},
              {label:"Not sure / missing identifiers", next:"l2", style:"danger"},
            ]
          },
          l1: {
            title: "Identifiers and matching request",
            severity: "info",
            text: [
              "Minimum dataset requires <b>at least four key identifiers</b> and request/specimen identifiers must match where a form/order is used."
            ],
            tags: [{label:"≥4 identifiers", kind:"b-info"}],
            options: [
              {label:"Specimen & request match and are legible", next:"l3", style:"primary"},
              {label:"Mismatch / illegible", next:"l4", style:"danger"},
            ]
          },
          l2: {
            title: "High risk of rejection",
            severity: "bad",
            text: [
              "Specimens may be rejected if they do not meet minimum identification requirements."
            ],
            tags: [{label:"Rejection risk", kind:"b-bad"}],
            details: [
              "Correct identifiers now to avoid re-sampling and delays."
            ],
            options: [{label:"Back", next:"l0"}]
          },
          l3: {
            title: "Specimen condition and suitability",
            severity: "info",
            text: [
              "Confirm correct sample type/tube, correct transport conditions, and that the specimen is not hazardous."
            ],
            tags: [{label:"Pre-analytical", kind:"b-info"}],
            options: [
              {label:"Specimen is intact and safe (no leak/sharps)", next:"l5", style:"primary"},
              {label:"Leaking/damaged or sharps attached", next:"l6", style:"danger"},
            ]
          },
          l4: {
            title: "Mismatch / illegible details",
            severity: "bad",
            text: [
              "Mismatch between request and specimen identifiers, or illegible details, can result in non-acceptance."
            ],
            tags: [{label:"Fix before sending", kind:"b-bad"}],
            options: [{label:"Back", next:"l1"}]
          },
          l5: {
            title: "Endpoint: passes acceptance screening",
            severity: "good",
            text: [
              "<b>Ready to send:</b> labelled correctly, matches request, correct tube/sample type, safe condition."
            ],
            tags: [{label:"Complete", kind:"b-good"}],
            options: [{label:"Restart", next:"l0"}]
          },
          l6: {
            title: "Hazardous specimen condition",
            severity: "bad",
            text: [
              "Hazardous specimens (e.g., leaking; sharps attached) may not be accepted and must be managed safely before transport."
            ],
            tags: [{label:"Safety", kind:"b-bad"}],
            options: [{label:"Restart", next:"l0"}]
          }
        }
      },

      epicFlow: {
        name: "EPIC / BEAKER electronic requesting",
        short: "Requesting",
        badge: "EPIC",
        start: "e0",
        nodes: {
          e0: {
            title: "Place the order in EPIC (BEAKER module)",
            severity: "info",
            text: [
              "Search for the requested test and select the correct option from lists/synonyms.",
              "Ensure correct <b>specimen type</b> and <b>source</b> are selected."
            ],
            tags: [{label:"Order", kind:"b-info"}],
            options: [{label:"Print label at the time of collection", next:"e1", style:"primary"}]
          },
          e1: {
            title: "Print barcoded label at collection",
            severity: "warn",
            text: [
              "<b>Order labels must be printed at the time of sample collection.</b>",
              "Apply the barcode label immediately after collection (do not pre-label)."
            ],
            tags: [{label:"Barcode", kind:"b-warn"}],
            options: [{label:"Scan specimen into EPIC to confirm collection time", next:"e2", style:"primary"}]
          },
          e2: {
            title: "Scan to confirm collection date/time",
            severity: "warn",
            text: [
              "After collection, <b>scan into EPIC</b> to confirm collection date and time.",
              "If not scanned/collected on the ward, the laboratory may be unable to receive the specimen appropriately."
            ],
            tags: [{label:"Scan-in", kind:"b-warn"}],
            options: [
              {label:"Add clinical details/mandatory questions", next:"e3", style:"primary"},
              {label:"Restart", next:"e0"}
            ]
          },
          e3: {
            title: "Provide adequate clinical information",
            severity: "info",
            text: [
              "Complete mandatory questions/tick boxes or free-text where needed (symptoms, onset, antimicrobials, travel, outbreak).",
              "Clinical info supports: validation, urgent communication triggers, and high-risk specimen identification for biosafety."
            ],
            tags: [{label:"Clinical metadata", kind:"b-info"}],
            options: [{label:"Final check: specimen type/source correct?", next:"e4", style:"primary"}]
          },
          e4: {
            title: "Final pre-send check",
            severity: "warn",
            text: [
              "Confirm the <b>ordered test</b>, <b>specimen type</b>, and <b>source</b> are correct to avoid incorrect testing."
            ],
            tags: [{label:"Prevent mis-testing", kind:"b-warn"}],
            options: [
              {label:"All correct → send specimen", next:"e5", style:"primary"},
              {label:"Not correct → amend order", next:"e6", style:"danger"},
            ]
          },
          e5: {
            title: "Endpoint: electronic request completed correctly",
            severity: "good",
            text: [
              "<b>Done:</b> ordered + labelled + scanned + clinically annotated → specimen ready for transport."
            ],
            tags: [{label:"Complete", kind:"b-good"}],
            options: [{label:"Restart", next:"e0"}]
          },
          e6: {
            title: "Amend before sending",
            severity: "bad",
            text: [
              "Correct the order/specimen type/source before dispatch to prevent delays or incorrect testing."
            ],
            tags: [{label:"Fix now", kind:"b-bad"}],
            options: [{label:"Back", next:"e4"}]
          }
        }
      }
    };

    // ---------- render all flows ----------
    function renderAllFlows(){
      $$(".flow").forEach(el => {
        const key = el.getAttribute("data-flow");
        const flow = FLOWS[key];
        if (flow) renderFlow(el, flow);
      });
    }

    // ---------- search/filter cards ----------
    function filterCards(q){
      const term = q.trim().toLowerCase();
      const cards = $$(".card");
      cards.forEach(card => {
        const hay = (card.getAttribute("data-tags") || "") + " " + card.textContent;
        const show = term === "" || hay.toLowerCase().includes(term);
        card.style.display = show ? "" : "none";
      });
    }

    function wireSearch(){
      const input = $("#q");

      // Ctrl+K focus
      window.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k"){
          e.preventDefault();
          input.focus();
        }
        if (e.key === "Escape"){
          if (document.activeElement === input || input.value){
            input.value = "";
            filterCards("");
            input.blur();
          }
        }
      });

      input.addEventListener("input", () => filterCards(input.value));
    }

    // ---------- expand/collapse all buttons ----------
    function wireGlobalButtons(){
      const exp = $("#expandAllBtn");
      const col = $("#collapseAllBtn");

      function onKeyActivate(el, fn){
        el.addEventListener("click", fn);
        el.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " "){
            e.preventDefault(); fn();
          }
        });
      }

      onKeyActivate(exp, expandAll);
      onKeyActivate(col, collapseAll);
    }

    // ---------- init ----------
    wireAccordions();
    renderAllFlows();
    wireSearch();
    wireGlobalButtons();
  </script>
</body>
</html>
