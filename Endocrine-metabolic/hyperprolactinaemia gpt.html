<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hyperprolactinaemia — Rapid Clinical Guidance</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --line: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);

      --green:#31d07c;
      --red:#ff4d4d;
      --amber:#ffb020;
      --blue:#6aa7ff;
      --violet:#b59bff;

      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(106,167,255,.18), transparent 55%),
        radial-gradient(900px 600px at 90% 0%, rgba(181,155,255,.16), transparent 50%),
        radial-gradient(1200px 900px at 50% 120%, rgba(49,208,124,.10), transparent 55%),
        linear-gradient(180deg, #070a14 0%, #0b1020 35%, #070a14 100%);
      min-height:100vh;
    }

    /* Layout */
    .app{
      max-width: 1180px;
      margin: 0 auto;
      padding: 22px 18px 44px;
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      margin: 10px 0 18px;
    }
    .title{
      display:flex; flex-direction:column; gap:6px;
    }
    h1{
      margin:0;
      font-size: 26px;
      letter-spacing: .2px;
    }
    .subtitle{
      color: var(--muted);
      font-size: 13.5px;
      line-height: 1.35;
      max-width: 820px;
    }
    .chiprow{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 8px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      font-size: 12.5px;
      color: var(--muted);
      user-select:none;
      backdrop-filter: blur(10px);
    }
    .chip b{ color: var(--text); font-weight: 650;}
    .chip .dot{
      width: 8px; height: 8px; border-radius:999px; display:inline-block;
      background: var(--blue);
      box-shadow: 0 0 0 4px rgba(106,167,255,.14);
    }

    .toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .search{
      position:relative;
      min-width: 280px;
      flex: 1 1 320px;
      max-width: 420px;
    }
    .search input{
      width:100%;
      padding: 12px 12px 12px 40px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--text);
      outline:none;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    .search input::placeholder{ color: rgba(255,255,255,.45); }
    .search .icon{
      position:absolute; left: 12px; top: 50%; transform: translateY(-50%);
      opacity:.7;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 11px 12px;
      border-radius: 14px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      transition: transform .14s ease, background .14s ease, border-color .14s ease;
      user-select:none;
      backdrop-filter: blur(10px);
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18); }
    .btn:active{ transform: translateY(0px); }
    .btn small{ color: var(--muted); font-weight: 600; }

    /* Grid */
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      header{ flex-direction:column; }
      .toolbar{ justify-content:flex-start; width:100%;}
      .search{ max-width: none; width:100%;}
      .grid{ grid-template-columns: 1fr; }
    }

    /* Panels / Cards */
    .panel{
      border:1px solid var(--line);
      background: var(--panel);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .panel::before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(600px 120px at 10% 0%, rgba(106,167,255,.20), transparent 60%);
      pointer-events:none;
      opacity:.7;
    }
    .panel > *{ position:relative; }

    .panelhead{
      display:flex; justify-content:space-between; align-items:flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }
    .panelhead h2{
      margin:0;
      font-size: 15px;
      letter-spacing: .2px;
    }
    .panelhead p{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.35;
    }

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      white-space:nowrap;
    }
    .badge strong{ color: var(--text); font-weight: 700; }
    .badge.red{ border-color: rgba(255,77,77,.35); background: rgba(255,77,77,.10); color: rgba(255,255,255,.88); }
    .badge.green{ border-color: rgba(49,208,124,.35); background: rgba(49,208,124,.10); color: rgba(255,255,255,.88); }
    .badge.amber{ border-color: rgba(255,176,32,.35); background: rgba(255,176,32,.10); color: rgba(255,255,255,.88); }

    .callout{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: var(--radius2);
      padding: 12px;
      display:flex;
      gap: 12px;
      align-items:flex-start;
      transition: transform .14s ease, border-color .14s ease, background .14s ease;
    }
    .callout:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.07);
    }
    .callout.red{ border-color: rgba(255,77,77,.35); background: rgba(255,77,77,.08); }
    .callout.green{ border-color: rgba(49,208,124,.35); background: rgba(49,208,124,.08); }
    .callout.amber{ border-color: rgba(255,176,32,.35); background: rgba(255,176,32,.08); }

    .callout .ico{
      width: 36px; height: 36px;
      border-radius: 12px;
      display:grid; place-items:center;
      border:1px solid var(--line);
      background: rgba(0,0,0,.15);
      flex: 0 0 auto;
    }
    .callout.red .ico{ border-color: rgba(255,77,77,.35); background: rgba(255,77,77,.10); }
    .callout.green .ico{ border-color: rgba(49,208,124,.35); background: rgba(49,208,124,.10); }
    .callout.amber .ico{ border-color: rgba(255,176,32,.35); background: rgba(255,176,32,.10); }

    .callout h3{
      margin:0;
      font-size: 13.5px;
      letter-spacing:.2px;
    }
    .callout p{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.35;
    }
    .klist{
      margin: 8px 0 0;
      padding: 0;
      list-style:none;
      display:grid;
      gap:6px;
      color: rgba(255,255,255,.84);
      font-size: 12.6px;
    }
    .klist li{
      display:flex; gap:8px; align-items:flex-start;
    }
    .klist .tick{
      margin-top:2px;
      width:16px; height:16px;
      border-radius: 6px;
      display:grid; place-items:center;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      flex: 0 0 auto;
      opacity: .9;
    }
    .klist code{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.92);
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      padding: 1px 6px;
      border-radius: 10px;
    }

    /* Tabs */
    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin: 0 0 12px;
    }
    .tab{
      padding: 9px 10px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      transition: background .14s ease, border-color .14s ease;
      display:flex; align-items:center; gap:8px;
      font-size: 12.5px;
      font-weight: 650;
    }
    .tab[aria-selected="true"]{
      color: var(--text);
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 12px 28px rgba(0,0,0,.22);
    }
    .tab .pill{
      width: 8px; height: 8px; border-radius: 999px;
      background: rgba(255,255,255,.35);
      box-shadow: 0 0 0 4px rgba(255,255,255,.08);
    }
    .tab.red .pill{ background: var(--red); box-shadow: 0 0 0 4px rgba(255,77,77,.16); }
    .tab.green .pill{ background: var(--green); box-shadow: 0 0 0 4px rgba(49,208,124,.14); }
    .tab.amber .pill{ background: var(--amber); box-shadow: 0 0 0 4px rgba(255,176,32,.14); }
    .tab.blue .pill{ background: var(--blue); box-shadow: 0 0 0 4px rgba(106,167,255,.14); }

    .tabpanes > section{ display:none; }
    .tabpanes > section.active{ display:block; }

    /* Form / decision */
    .formgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 520px){
      .formgrid{ grid-template-columns: 1fr; }
    }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      letter-spacing:.2px;
    }
    .control{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: 14px;
      padding: 10px 10px;
      width:100%;
      color: var(--text);
      outline:none;
    }
    select.control{ padding: 10px 8px; }
    .toggleRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .toggle{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      background: rgba(255,255,255,.04);
      display:flex; gap:10px;
      align-items:flex-start;
      cursor:pointer;
      user-select:none;
      transition: background .14s ease, border-color .14s ease, transform .14s ease;
      min-height: 62px;
    }
    .toggle:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.06); }
    .toggle input{ margin-top: 3px; }
    .toggle b{ display:block; font-size: 13px; }
    .toggle small{ display:block; color: var(--muted); margin-top: 3px; line-height: 1.25; }

    .results{
      margin-top: 12px;
      display:grid;
      gap: 10px;
    }
    .resultCard{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.05);
      padding: 12px;
      display:flex;
      gap: 12px;
      align-items:flex-start;
    }
    .resultCard .left{
      display:flex; flex-direction:column; gap:6px;
      min-width: 0;
      flex: 1 1 auto;
    }
    .resultCard .titleRow{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .resultCard h4{
      margin:0;
      font-size: 13.5px;
      letter-spacing:.2px;
    }
    .resultCard p{
      margin:0;
      color: var(--muted);
      font-size: 12.6px;
      line-height: 1.35;
    }
    .severity{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 9px;
      border-radius: 999px;
      font-size: 11.5px;
      font-weight: 750;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .severity.red{ border-color: rgba(255,77,77,.40); background: rgba(255,77,77,.10); }
    .severity.green{ border-color: rgba(49,208,124,.40); background: rgba(49,208,124,.10); }
    .severity.amber{ border-color: rgba(255,176,32,.40); background: rgba(255,176,32,.10); }

    /* Accordions */
    details{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.04);
      overflow:hidden;
    }
    summary{
      cursor:pointer;
      padding: 12px;
      list-style:none;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      user-select:none;
    }
    summary::-webkit-details-marker{ display:none; }
    summary .sleft{ display:flex; align-items:center; gap:10px; min-width:0; }
    summary b{ font-size: 13px; letter-spacing:.2px; }
    summary span{
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 480px;
    }
    .chev{ opacity:.75; transition: transform .15s ease; }
    details[open] .chev{ transform: rotate(180deg); }
    .dcontent{
      padding: 0 12px 12px;
      color: rgba(255,255,255,.86);
      font-size: 12.7px;
      line-height: 1.45;
      display:grid; gap:10px;
    }
    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 720px){
      .twoCol{ grid-template-columns: 1fr; }
    }
    .mini{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      border-radius: 14px;
      padding: 10px;
    }
    .mini h5{
      margin:0 0 6px;
      font-size: 12.8px;
      letter-spacing:.15px;
    }
    .mini ul{
      margin:0;
      padding: 0 0 0 18px;
      color: rgba(255,255,255,.80);
    }
    .mini li{ margin: 6px 0; }

    /* Footer */
    footer{
      margin-top: 16px;
      color: rgba(255,255,255,.55);
      font-size: 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      padding: 10px 2px;
    }
    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      padding: 2px 6px;
      border-radius: 8px;
      color: rgba(255,255,255,.8);
    }

    /* Search highlight */
    mark{
      background: rgba(255,176,32,.22);
      color: var(--text);
      border: 1px solid rgba(255,176,32,.22);
      padding: 0 3px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <h1>Hyperprolactinaemia — Rapid Decision Guidance</h1>
        <div class="subtitle">
          Fast triage + step-wise aetiology work-up + PRL-pattern interpretation. Designed for high-throughput clinical use:
          red flags & immediate actions are visually prioritised; deeper detail is collapsible.
        </div>
        <div class="chiprow" aria-label="Key thresholds">
          <span class="chip"><span class="dot"></span> Normal PRL: <b>♀ &lt;1087 pmol/L (25 μg/L)</b> · <b>♂ &lt;870 pmol/L (20 μg/L)</b></span>
          <span class="chip"><span class="dot" style="background:var(--amber);box-shadow:0 0 0 4px rgba(255,176,32,.14)"></span> Repeat if mild: <b>&lt;5× ULN</b></span>
          <span class="chip"><span class="dot" style="background:var(--violet);box-shadow:0 0 0 4px rgba(181,155,255,.14)"></span> Prolactinoma likely: <b>&gt;150 μg/L</b> (common) · Macroprolactinoma: <b>&gt;250 μg/L</b></span>
        </div>
      </div>

      <div class="toolbar">
        <div class="search">
          <span class="icon" aria-hidden="true">
            <!-- magnifier -->
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="rgba(255,255,255,.7)" stroke-width="2"/>
              <path d="M16.2 16.2 21 21" stroke="rgba(255,255,255,.7)" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </span>
          <input id="searchInput" type="search" placeholder="Search within this page (e.g., ‘hook effect’, ‘PEG’, ‘MRI’)…  ⌘/Ctrl+K" />
        </div>
        <button class="btn" id="resetBtn" type="button" title="Reset inputs">
          <!-- refresh -->
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 12a9 9 0 0 1-15.9 5.6" stroke="rgba(255,255,255,.86)" stroke-width="2" stroke-linecap="round"/>
            <path d="M3 12a9 9 0 0 1 15.9-5.6" stroke="rgba(255,255,255,.86)" stroke-width="2" stroke-linecap="round"/>
            <path d="M6 18H3v-3" stroke="rgba(255,255,255,.86)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M18 6h3v3" stroke="rgba(255,255,255,.86)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Reset <small>R</small>
        </button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: rapid decision -->
      <section class="panel" id="decisionPanel" aria-label="Rapid decision">
        <div class="panelhead">
          <div>
            <h2>Rapid decision engine</h2>
            <p>Enter PRL + context → instant prioritised next steps (red flags first). Hover cards for quick scanning.</p>
          </div>
          <span class="badge" title="Decision rules derived from uploaded BMJ Best Practice PDF">
            <strong>Evidence</strong> · BMJ Best Practice (PDF)
          </span>
        </div>

        <div class="tabs" role="tablist" aria-label="Navigation tabs">
          <div class="tab red" role="tab" tabindex="0" aria-selected="true" data-tab="triage"><span class="pill"></span> Triage</div>
          <div class="tab green" role="tab" tabindex="0" aria-selected="false" data-tab="workup"><span class="pill"></span> Step-wise work-up</div>
          <div class="tab amber" role="tab" tabindex="0" aria-selected="false" data-tab="interpret"><span class="pill"></span> PRL interpretation</div>
          <div class="tab blue" role="tab" tabindex="0" aria-selected="false" data-tab="causes"><span class="pill"></span> Common causes</div>
        </div>

        <div class="tabpanes">
          <!-- TRIAGE -->
          <section id="tab-triage" class="active" aria-label="Triage tab">
            <div class="twoCol">
              <div class="callout red" data-search="pituitary apoplexy red flags acute headache visual loss cranial nerve palsy hypotension shock steroid neurosurgery 24 48 hours">
                <div class="ico" aria-hidden="true">
                  <!-- warning triangle -->
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M12 3 22 20H2L12 3Z" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linejoin="round"/>
                    <path d="M12 9v5" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round"/>
                    <path d="M12 17h.01" stroke="rgba(255,255,255,.92)" stroke-width="3" stroke-linecap="round"/>
                  </svg>
                </div>
                <div>
                  <h3>RED FLAG: suspect pituitary apoplexy</h3>
                  <p>Clinical syndrome from infarction/haemorrhage of pituitary adenoma with rapid mass effect.</p>
                  <ul class="klist">
                    <li><span class="tick">!</span> Sudden severe headache ± <b>visual loss</b></li>
                    <li><span class="tick">!</span> N/V, cranial nerve palsies, meningism/photophobia</li>
                    <li><span class="tick">!</span> Hypotension/shock from secondary adrenal deficiency</li>
                    <li><span class="tick">→</span> Immediate: <b>IV fluids + corticosteroids</b>; urgent endocrine/neurosurgery</li>
                    <li><span class="tick">⏱</span> Consider decompression if progressive vision/CN deficits: <b>within 24–48 h</b></li>
                  </ul>
                </div>
              </div>

              <div class="callout green" data-search="initial quick screen pregnancy test thyroid renal liver macroprolactin medication">
                <div class="ico" aria-hidden="true">
                  <!-- bolt/check -->
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M13 2 3 14h7l-1 8 12-14h-7l-1-6Z" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div>
                  <h3>Rapid first-pass (non-tumour causes first)</h3>
                  <p>Prioritise reversible secondary causes to avoid unnecessary imaging.</p>
                  <ul class="klist">
                    <li><span class="tick">✓</span> Exclude: <b>pregnancy</b>, <b>medications</b>, <b>renal failure</b>, <b>hypothyroidism</b></li>
                    <li><span class="tick">✓</span> Order: renal/liver function, TSH/free T4, pregnancy test</li>
                    <li><span class="tick">✓</span> Consider macroprolactin (PEG) if asymptomatic/atypical</li>
                    <li><span class="tick">✓</span> MRI pituitary after physiological/drug/secondary causes excluded</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="formgrid" style="margin-top:12px">
              <div>
                <label for="sex">Sex (for ULN reference)</label>
                <select id="sex" class="control">
                  <option value="female">Female (ULN 25 μg/L)</option>
                  <option value="male">Male (ULN 20 μg/L)</option>
                </select>
              </div>
              <div>
                <label for="prlValue">Prolactin value</label>
                <input id="prlValue" class="control" inputmode="decimal" placeholder="e.g., 85" />
              </div>
              <div>
                <label for="prlUnit">Unit</label>
                <select id="prlUnit" class="control">
                  <option value="ugL">μg/L</option>
                  <option value="pmolL">pmol/L</option>
                  <option value="mIUL">mIU/L</option>
                </select>
              </div>
              <div>
                <label for="context">Clinical context (optional)</label>
                <select id="context" class="control">
                  <option value="general">General outpatient / ED evaluation</option>
                  <option value="pregnant">Pregnant / postpartum / lactating</option>
                  <option value="onDopAntag">On dopamine antagonist / antipsychotic / metoclopramide</option>
                  <option value="knownMass">Known sellar mass on imaging</option>
                </select>
              </div>
            </div>

            <div class="toggleRow">
              <label class="toggle" title="Acute headache with visual symptoms strongly raises concern for pituitary apoplexy.">
                <input id="tHeadacheVisual" type="checkbox" />
                <div>
                  <b>Acute severe headache + visual deficit</b>
                  <small>Triggers red-flag pathway (apoplexy / urgent imaging).</small>
                </div>
              </label>
              <label class="toggle" title="Cranial nerve palsy suggests acute mass effect; urgent escalation.">
                <input id="tCNPalsy" type="checkbox" />
                <div>
                  <b>Cranial nerve palsy / diplopia</b>
                  <small>Escalates urgency for pituitary apoplexy/mass effect.</small>
                </div>
              </label>
              <label class="toggle" title="Shock/hypotension can reflect secondary adrenal insufficiency in pituitary apoplexy.">
                <input id="tShock" type="checkbox" />
                <div>
                  <b>Hypotension/shock</b>
                  <small>Prioritise steroids + resuscitation.</small>
                </div>
              </label>
              <label class="toggle" title="Asymptomatic or atypical phenotype: consider macroprolactin testing.">
                <input id="tAtypical" type="checkbox" />
                <div>
                  <b>Asymptomatic / atypical phenotype</b>
                  <small>Macroprolactin (PEG) becomes higher-yield.</small>
                </div>
              </label>
            </div>

            <div class="results" id="results"></div>
          </section>

          <!-- WORKUP -->
          <section id="tab-workup" aria-label="Work-up tab">
            <div class="twoCol">
              <div class="callout green" data-search="repeat testing mild raised prolactin less than five times upper limit exclude stress pulsatility">
                <div class="ico" aria-hidden="true">
                  <!-- checklist -->
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M9 11 11 13 15 9" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M4 6h16v14H4V6Z" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linejoin="round"/>
                    <path d="M8 3h8" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </div>
                <div>
                  <h3>Confirm the signal (avoid false positives)</h3>
                  <p>Repeat testing is recommended when PRL is mildly raised (<5× ULN) to exclude stress/pulsatility.</p>
                  <ul class="klist">
                    <li><span class="tick">✓</span> Recheck on another day, ≥1 h after waking/eating</li>
                    <li><span class="tick">✓</span> If needed: 2–3 samples 15–20 min apart to reduce pulsatility</li>
                    <li><span class="tick">✓</span> If stress suspected: indwelling cannula / rest strategy can help</li>
                  </ul>
                </div>
              </div>

              <div class="callout amber" data-search="medications risperidone chlorpromazine aripiprazole quetiapine prolactin sparing change">
                <div class="ico" aria-hidden="true">
                  <!-- pill -->
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M10 14 20 4" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round"/>
                    <path d="M7.5 16.5a5 5 0 0 1 0-7.1l2.9-2.9a5 5 0 0 1 7.1 7.1l-2.9 2.9a5 5 0 0 1-7.1 0Z" stroke="rgba(255,255,255,.92)" stroke-width="2"/>
                    <path d="M13 5l6 6" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round" opacity=".55"/>
                  </svg>
                </div>
                <div>
                  <h3>Medication strategy (high-yield)</h3>
                  <p>If feasible, replace/withdraw PRL-raising drugs; antipsychotics with high risk may be switched to PRL-sparing agents.</p>
                  <ul class="klist">
                    <li><span class="tick">→</span> Consider switch: <b>risperidone/chlorpromazine → aripiprazole/quetiapine</b></li>
                    <li><span class="tick">⏱</span> Withdrawal window is typically ~48–72 h (half-life dependent)</li>
                  </ul>
                </div>
              </div>
            </div>

            <details data-search="laboratory tests renal liver thyroid pregnancy macroprolactin">
              <summary>
                <div class="sleft">
                  <b>Core investigations</b>
                  <span>Order-set that front-loads secondary causes</span>
                </div>
                <svg class="chev" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 9l6 6 6-6" stroke="rgba(255,255,255,.8)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </summary>
              <div class="dcontent">
                <div class="twoCol">
                  <div class="mini">
                    <h5>Labs to identify aetiology</h5>
                    <ul>
                      <li>Renal function (electrolytes, urea/creatinine)</li>
                      <li>Liver function (LFTs, albumin ± PT)</li>
                      <li>Thyroid (TSH, free T4)</li>
                      <li>Pregnancy test</li>
                      <li>Macroprolactin (PEG) in asymptomatic/atypical phenotypes</li>
                    </ul>
                  </div>
                  <div class="mini">
                    <h5>Imaging strategy</h5>
                    <ul>
                      <li>MRI pituitary after physiological/drug/secondary causes excluded</li>
                      <li>If macroadenoma: screen for hypopituitarism (other pituitary axes)</li>
                      <li>If large mass + only mild PRL: consider assay artifact / dilution strategies</li>
                    </ul>
                  </div>
                </div>
              </div>
            </details>

            <details data-search="macroprolactin PEG precipitation percentage recovery 40 60 60">
              <summary>
                <div class="sleft">
                  <b>Macroprolactin (PEG) interpretation</b>
                  <span>Rapid read for lab reports</span>
                </div>
                <svg class="chev" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 9l6 6 6-6" stroke="rgba(255,255,255,.8)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </summary>
              <div class="dcontent">
                <div class="mini">
                  <h5>PEG precipitation — % recovery</h5>
                  <ul>
                    <li><b>&lt;40%</b> recovery: very sensitive for significant macroprolactin</li>
                    <li><b>40–60%</b>: mixed macroprolactin + oligomeric PRL → consider confirmation (e.g., gel filtration)</li>
                    <li><b>&gt;60%</b>: predominantly monomeric (“true”) PRL</li>
                  </ul>
                </div>
              </div>
            </details>
          </section>

          <!-- INTERPRETATION -->
          <section id="tab-interpret" aria-label="Interpretation tab">
            <div class="twoCol">
              <div class="callout violet" style="border-color:rgba(181,155,255,.35);background:rgba(181,155,255,.08)" data-search="most patients with prolactin levels greater than 150 micrograms have prolactinoma macroprolactinoma greater than 250">
                <div class="ico" aria-hidden="true" style="border-color:rgba(181,155,255,.35);background:rgba(181,155,255,.10)">
                  <!-- chart -->
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M4 19V5" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round"/>
                    <path d="M4 19h16" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round"/>
                    <path d="M8 15v-5" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round"/>
                    <path d="M12 15V8" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round"/>
                    <path d="M16 15V10" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </div>
                <div>
                  <h3>Pattern recognition by PRL magnitude</h3>
                  <p>Use as a heuristic while you exclude secondary causes and interpret imaging.</p>
                  <ul class="klist">
                    <li><span class="tick">★</span> <b>&gt;150 μg/L</b>: prolactinoma common</li>
                    <li><span class="tick">★</span> <b>&gt;250 μg/L</b>: macroprolactinoma typical</li>
                    <li><span class="tick">↔</span> Stalk effect often: <b>&lt;250 μg/L</b> with non-functioning mass</li>
                    <li><span class="tick">⚠</span> Large mass + low/normal PRL: consider <b>hook effect</b> → dilute sample (e.g., 1/100)</li>
                  </ul>
                </div>
              </div>

              <div class="callout amber" data-search="pregnancy prolactin 200 500 micrograms 4000 10000 mIU">
                <div class="ico" aria-hidden="true">
                  <!-- baby/heart -->
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M12 21s-7-4.6-7-10a4 4 0 0 1 7-2 4 4 0 0 1 7 2c0 5.4-7 10-7 10Z" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div>
                  <h3>Pregnancy/lactation context</h3>
                  <p>Physiological PRL is often high. Ensure you are asking the right question (symptoms/mass effect vs routine PRL).</p>
                  <ul class="klist">
                    <li><span class="tick">i</span> Pregnancy PRL can sit around <b>200–500 μg/L</b> (lab-dependent)</li>
                    <li><span class="tick">→</span> Escalate if new headache/visual symptoms (mass effect/apoplexy pathway)</li>
                  </ul>
                </div>
              </div>
            </div>

            <details data-search="MRI pituitary after exclusion CT calcified craniopharyngioma incidentaloma 10 percent">
              <summary>
                <div class="sleft">
                  <b>Imaging rules-of-thumb</b>
                  <span>When MRI is highest-yield + common pitfalls</span>
                </div>
                <svg class="chev" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 9l6 6 6-6" stroke="rgba(255,255,255,.8)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </summary>
              <div class="dcontent">
                <div class="twoCol">
                  <div class="mini">
                    <h5>MRI vs CT</h5>
                    <ul>
                      <li>MRI with pituitary cuts after exclusion of physiological/drug/secondary causes</li>
                      <li>CT useful for calcified sellar/suprasellar lesions (e.g., craniopharyngioma) or bony involvement</li>
                      <li>Remember incidentalomas occur (pituitary adenoma-like findings in asymptomatic imaging)</li>
                    </ul>
                  </div>
                  <div class="mini">
                    <h5>If macroadenoma present</h5>
                    <ul>
                      <li>Screen for hypopituitarism / other pituitary axes</li>
                      <li>Large tumour + mild PRL: think non-functioning lesion (“stalk effect”) and/or assay artifact</li>
                      <li>Giant prolactinoma can show falsely low PRL (“hook effect”): measure after dilution (e.g., 1/100)</li>
                    </ul>
                  </div>
                </div>
              </div>
            </details>
          </section>

          <!-- CAUSES -->
          <section id="tab-causes" aria-label="Causes tab">
            <div class="twoCol">
              <div class="callout green" data-search="common differentials prolactinoma hypothyroidism drug induced macroprolactinaemia pregnancy">
                <div class="ico" aria-hidden="true">
                  <!-- layers -->
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2 2 7l10 5 10-5-10-5Z" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linejoin="round"/>
                    <path d="M2 12l10 5 10-5" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linejoin="round"/>
                    <path d="M2 17l10 5 10-5" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div>
                  <h3>Common causes (high yield)</h3>
                  <p>Most frequent diagnostic buckets to clear early.</p>
                  <ul class="klist">
                    <li><span class="tick">✓</span> Prolactinoma</li>
                    <li><span class="tick">✓</span> Primary hypothyroidism (usually mild PRL elevation)</li>
                    <li><span class="tick">✓</span> Drug-induced hyperprolactinaemia (often &lt;100 μg/L)</li>
                    <li><span class="tick">✓</span> Macroprolactinaemia (PEG pattern; often asymptomatic)</li>
                    <li><span class="tick">✓</span> Pregnancy</li>
                  </ul>
                </div>
              </div>

              <div class="callout amber" data-search="stalk effect non functioning pituitary adenoma craniopharyngioma glioma metastasis prolactin usually less than 250">
                <div class="ico" aria-hidden="true">
                  <!-- target -->
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M12 22a10 10 0 1 1 0-20 10 10 0 0 1 0 20Z" stroke="rgba(255,255,255,.92)" stroke-width="2"/>
                    <path d="M12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8Z" stroke="rgba(255,255,255,.92)" stroke-width="2"/>
                    <path d="M12 12h.01" stroke="rgba(255,255,255,.92)" stroke-width="3" stroke-linecap="round"/>
                  </svg>
                </div>
                <div>
                  <h3>Don’t miss: stalk effect / parasellar mass</h3>
                  <p>Masses compressing the pituitary stalk often yield PRL &lt;250 μg/L—interpret PRL in context of imaging.</p>
                  <ul class="klist">
                    <li><span class="tick">i</span> NFPA, craniopharyngioma, glioma, metastasis, etc.</li>
                    <li><span class="tick">→</span> If big tumour + only mild PRL: favour non-secreting mass + stalk effect</li>
                  </ul>
                </div>
              </div>
            </div>

            <details data-search="urgent considerations pituitary apoplexy management dexamethasone transsphenoidal decompression 24 48 hours">
              <summary>
                <div class="sleft">
                  <b>Emergency: pituitary apoplexy</b>
                  <span>Clickable action card (what to do now)</span>
                </div>
                <svg class="chev" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 9l6 6 6-6" stroke="rgba(255,255,255,.8)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </summary>
              <div class="dcontent">
                <div class="twoCol">
                  <div class="mini">
                    <h5>Clinical picture</h5>
                    <ul>
                      <li>Sudden headache, visual loss/field defects, N/V</li>
                      <li>Cranial nerve palsies; possible meningism if SAH extension</li>
                      <li>Risk: hypotension/shock from secondary adrenal deficiency</li>
                    </ul>
                  </div>
                  <div class="mini">
                    <h5>Immediate management</h5>
                    <ul>
                      <li>Supportive care: IV fluids + corticosteroids (e.g., dexamethasone)</li>
                      <li>Consider transsphenoidal decompression if progressive vision/CN deficits or failed conservative care</li>
                      <li>Time-critical: surgery ideally within 24–48 h in appropriate cases</li>
                    </ul>
                  </div>
                </div>
              </div>
            </details>
          </section>
        </div>
      </section>

      <!-- RIGHT: Quick reference / thresholds -->
      <aside class="panel" id="quickRef" aria-label="Quick reference">
        <div class="panelhead">
          <div>
            <h2>At-a-glance reference</h2>
            <p>Thresholds, pitfalls, and “do-not-miss” items in one glance.</p>
          </div>
          <span class="badge red"><strong>Red flags</strong> · immediate</span>
        </div>

        <div class="callout red" style="margin-bottom:10px" data-search="red flags pituitary apoplexy sudden headache visual loss cranial nerve palsy shock">
          <div class="ico" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M12 3 22 20H2L12 3Z" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linejoin="round"/>
              <path d="M12 9v5" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 17h.01" stroke="rgba(255,255,255,.92)" stroke-width="3" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <h3>Escalate now</h3>
            <p>Sudden headache + visual deficit, cranial neuropathy, meningism, or shock → treat as pituitary apoplexy until proven otherwise.</p>
          </div>
        </div>

        <div class="callout green" style="margin-bottom:10px" data-search="step-wise exclude medication renal failure hypothyroidism parasellar tumours MRI once excluded">
          <div class="ico" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M9 11 11 13 15 9" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M4 6h16v14H4V6Z" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </div>
          <div>
            <h3>Core algorithm</h3>
            <p>Confirm PRL → exclude physiological/drug/secondary causes → MRI pituitary → interpret PRL vs imaging (stalk effect vs prolactinoma vs assay artifact).</p>
          </div>
        </div>

        <details open data-search="thresholds uln 25 20 micrograms prolactinoma 150 macro 250 mild less than 5 times">
          <summary>
            <div class="sleft">
              <b>Thresholds & heuristics</b>
              <span>Useful “mental shortcuts”</span>
            </div>
            <svg class="chev" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6 9l6 6 6-6" stroke="rgba(255,255,255,.8)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </summary>
          <div class="dcontent">
            <div class="mini">
              <ul>
                <li>Normal: ♀ &lt;1087 pmol/L (25 μg/L) · ♂ &lt;870 pmol/L (20 μg/L)</li>
                <li>Repeat PRL if mild elevation: &lt;5× ULN (stress/pulsatility)</li>
                <li>&gt;150 μg/L: prolactinoma common; &gt;250 μg/L: macroprolactinoma typical</li>
                <li>Large mass + mild PRL: consider stalk effect vs hook effect</li>
              </ul>
            </div>
          </div>
        </details>

        <details data-search="hook effect 1/100 dilution large macroadenoma low prolactin">
          <summary>
            <div class="sleft">
              <b>Pitfall: hook effect</b>
              <span>Large tumour + deceptively low PRL</span>
            </div>
            <svg class="chev" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6 9l6 6 6-6" stroke="rgba(255,255,255,.8)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </summary>
          <div class="dcontent">
            <div class="mini">
              <h5>When to suspect</h5>
              <ul>
                <li>Giant macroadenoma (&gt;2 cm) with “normal/low” PRL</li>
                <li>Action: repeat PRL after dilution (e.g., 1/100) to unmask true level</li>
              </ul>
            </div>
          </div>
        </details>

        <details data-search="macroprolactinaemia asymptomatic peg precipitation 40 60">
          <summary>
            <div class="sleft">
              <b>Macroprolactin</b>
              <span>When to test + how to read</span>
            </div>
            <svg class="chev" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6 9l6 6 6-6" stroke="rgba(255,255,255,.8)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </summary>
          <div class="dcontent">
            <div class="mini">
              <ul>
                <li>Consider in asymptomatic/atypical presentations</li>
                <li>PEG % recovery: &lt;40% suggests significant macroprolactin; 40–60% mixed; &gt;60% monomeric PRL</li>
              </ul>
            </div>
          </div>
        </details>
      </aside>
    </div>

    <footer>
      <div>
        Shortcuts: <span class="kbd">Ctrl/⌘</span> + <span class="kbd">K</span> search · <span class="kbd">R</span> reset · <span class="kbd">1–4</span> tabs
      </div>
      <div>
        Built for rapid scannability: hover cards, accordions, two-column layout, urgency color-coding.
      </div>
    </footer>
  </div>

  <script>
    // --- Unit conversion helpers (based on provided equivalences in PDF)
    // 25 μg/L ≈ 1087 pmol/L => 1 μg/L ≈ 43.48 pmol/L
    // 25 μg/L ≈ 500 mIU/L  => 1 μg/L ≈ 20 mIU/L
    const PMOL_PER_UGL = 1087 / 25;
    const MIU_PER_UGL  = 500 / 25;

    const ULN = {
      female_ugL: 25,
      male_ugL: 20
    };

    const $ = (id) => document.getElementById(id);

    function parseNum(x){
      if(!x) return null;
      const v = Number(String(x).replace(/,/g,'.').trim());
      return Number.isFinite(v) ? v : null;
    }

    function toUgL(value, unit){
      if(value == null) return null;
      if(unit === 'ugL') return value;
      if(unit === 'pmolL') return value / PMOL_PER_UGL;
      if(unit === 'mIUL') return value / MIU_PER_UGL;
      return null;
    }

    function format1(x){
      if(x == null) return '—';
      const r = Math.round(x * 10) / 10;
      return (Math.abs(r) >= 100 ? Math.round(r) : r).toString();
    }

    function compute(){
      const sex = $('sex').value;
      const val = parseNum($('prlValue').value);
      const unit = $('prlUnit').value;
      const ctx = $('context').value;

      const acuteHV = $('tHeadacheVisual').checked;
      const cn = $('tCNPalsy').checked;
      const shock = $('tShock').checked;
      const atypical = $('tAtypical').checked;

      const uln = (sex === 'female') ? ULN.female_ugL : ULN.male_ugL;
      const prlUgL = toUgL(val, unit);

      const results = [];

      // --- RED FLAG pathway: pituitary apoplexy suspicion
      if(acuteHV || cn || shock){
        results.push({
          sev: 'red',
          title: 'Immediate escalation: treat as pituitary apoplexy until excluded',
          body:
            'Sudden headache/visual deficit, cranial neuropathy, or shock strongly prioritises acute pituitary mass effect. Start supportive care with IV fluids + corticosteroids and escalate urgently for endocrine/neurosurgical input. Consider urgent decompression if progressive vision/CN deficits or failed conservative management (ideal window 24–48 h).'
        });
      }

      // --- If PRL missing, still give algorithmic prompts
      if(prlUgL == null){
        results.push({
          sev: 'amber',
          title: 'Add a PRL value to unlock magnitude-based interpretation',
          body:
            'You can still proceed: confirm/replicate PRL if mild elevation is suspected; exclude pregnancy, medications, renal failure, and hypothyroidism; then proceed to pituitary MRI once secondary causes are excluded.'
        });
        render(results, { sex, uln, prlUgL, unit, ctx });
        return;
      }

      // --- Magnitude interpretation
      const ratio = prlUgL / uln;
      const magnitude = (() => {
        if(prlUgL < uln) return 'normal';
        if(ratio < 5) return 'mild';
        if(prlUgL >= 250) return 'very_high';
        if(prlUgL >= 150) return 'high';
        return 'moderate';
      })();

      // --- Core step-wise workup prompt (always helpful)
      results.push({
        sev: 'green',
        title: 'Step-wise work-up (non-tumour causes first)',
        body:
          'Exclude physiological causes and secondary drivers (pregnancy; medications; renal failure; hypothyroidism; liver disease as relevant). Order renal/liver function, TSH/free T4, pregnancy test; consider macroprolactin (PEG) if asymptomatic/atypical. MRI pituitary after physiological/drug/secondary causes are excluded; if macroadenoma present, screen for hypopituitarism.'
      });

      // --- Repeat testing if mild (<5× ULN)
      if(magnitude === 'mild'){
        results.push({
          sev: 'amber',
          title: 'Mild elevation (<5× ULN): repeat PRL to exclude stress/pulsatility',
          body:
            'Repeat on another day (≥1 h after waking/eating). Consider 2–3 samples 15–20 minutes apart. If stress is suspected, a resting sample strategy (e.g., cannula/rest) may clarify.'
        });
      }

      // --- Pregnancy context
      if(ctx === 'pregnant'){
        // heuristic range from PDF: 200–500 μg/L (variable)
        if(prlUgL >= 200 && prlUgL <= 500){
          results.push({
            sev: 'green',
            title: 'Physiological range compatible with pregnancy',
            body:
              'PRL can be markedly elevated in pregnancy/lactation. Focus escalation on symptoms of mass effect (headache/visual changes) rather than PRL magnitude alone.'
          });
        } else {
          results.push({
            sev: 'amber',
            title: 'Pregnancy context: interpret PRL with symptoms + imaging triggers',
            body:
              'Physiological PRL varies widely. If new headache/visual symptoms occur, prioritise pituitary imaging/urgent assessment pathways.'
          });
        }
      }

      // --- Drug context
      if(ctx === 'onDopAntag'){
        results.push({
          sev: 'amber',
          title: 'Medication-associated hyperprolactinaemia is common',
          body:
            'If clinically feasible, replace/withdraw PRL-raising drugs. Higher-risk antipsychotics may be switched to prolactin-sparing alternatives (e.g., aripiprazole, quetiapine). Recheck PRL after an appropriate washout (often ~48–72 h; half-life dependent).'
        });
      }

      // --- High PRL suggests prolactinoma
      if(magnitude === 'high' || magnitude === 'very_high'){
        results.push({
          sev: 'amber',
          title: (magnitude === 'very_high') ? 'Very high PRL: macroprolactinoma pattern is typical' : 'High PRL: prolactinoma is common',
          body:
            (magnitude === 'very_high')
              ? 'Values >250 μg/L are typical for macroprolactinomas. Ensure secondary causes are excluded, then prioritise pituitary MRI and evaluate for mass effect/hypopituitarism.'
              : 'Values >150 μg/L commonly reflect prolactinoma. After excluding secondary causes, prioritise pituitary MRI; if macroadenoma present, assess other pituitary axes.'
        });
      }

      // --- Known mass + mild PRL => stalk effect vs assay artifact
      if(ctx === 'knownMass' && prlUgL < 100){
        results.push({
          sev: 'amber',
          title: 'Known large sellar mass + mild PRL: consider stalk effect vs assay artifact',
          body:
            'A macroadenoma with only mild hyperprolactinaemia is more consistent with a non-PRL-secreting lesion (stalk effect). If tumour is very large with unexpectedly low/normal PRL, consider the “hook effect” and request PRL after dilution (e.g., 1/100).'
        });
      }

      // --- Atypical/asymptomatic => macroprolactin emphasis
      if(atypical){
        results.push({
          sev: 'green',
          title: 'Atypical/asymptomatic phenotype: prioritise macroprolactin (PEG)',
          body:
            'Macroprolactinaemia is a common explanation for discordant symptoms. Interpret PEG % recovery: <40% suggests significant macroprolactin; 40–60% mixed; >60% monomeric PRL.'
        });
      }

      render(results, { sex, uln, prlUgL, unit, ctx, ratio });
    }

    function render(items, meta){
      const box = $('results');
      const prlLine = (() => {
        if(meta.prlUgL == null) return '';
        const u = meta.uln;
        const r = meta.ratio ? (Math.round(meta.ratio*10)/10) : (Math.round((meta.prlUgL/u)*10)/10);
        return `PRL ≈ <b>${format1(meta.prlUgL)} μg/L</b> (<b>${r}× ULN</b>)`;
      })();

      const headerCard = `
        <div class="resultCard" data-search="computed summary">
          <div class="left">
            <div class="titleRow">
              <h4>Computed summary</h4>
              <span class="severity ${meta.prlUgL == null ? 'amber' : (meta.prlUgL/meta.uln >= 5 ? 'amber' : 'green')}">
                ${meta.prlUgL == null ? 'INCOMPLETE' : (meta.prlUgL/meta.uln >= 5 ? 'ELEVATED' : (meta.prlUgL >= meta.uln ? 'MILD' : 'NORMAL'))}
              </span>
              <span class="badge" title="Converted using PDF equivalences (25 μg/L ≈ 1087 pmol/L; 25 μg/L ≈ 500 mIU/L)">
                ULN: <strong>${meta.sex==='female' ? '25' : '20'} μg/L</strong>
              </span>
            </div>
            <p>${prlLine || 'Enter a PRL value to compute magnitude-based guidance.'}</p>
          </div>
        </div>
      `;

      const cards = items.map(it => `
        <div class="resultCard" data-search="${escapeHtml(it.title + ' ' + it.body)}">
          <div class="left">
            <div class="titleRow">
              <h4>${escapeHtml(it.title)}</h4>
              <span class="severity ${it.sev}">${it.sev.toUpperCase()}</span>
            </div>
            <p>${escapeHtml(it.body)}</p>
          </div>
        </div>
      `).join('');

      box.innerHTML = headerCard + cards;
      applySearch(); // keep search highlighting live
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // --- Tabs
    function setTab(name){
      document.querySelectorAll('.tab').forEach(t=>{
        const on = (t.dataset.tab === name);
        t.setAttribute('aria-selected', on ? 'true' : 'false');
      });
      document.querySelectorAll('.tabpanes > section').forEach(p=>{
        p.classList.toggle('active', p.id === `tab-${name}`);
      });
      $('searchInput').focus({preventScroll:true});
      applySearch();
    }

    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click', ()=> setTab(t.dataset.tab));
      t.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); setTab(t.dataset.tab); }
      });
    });

    // Keyboard shortcuts: 1–4
    window.addEventListener('keydown', (e)=>{
      const k = e.key.toLowerCase();
      if((e.ctrlKey || e.metaKey) && k === 'k'){
        e.preventDefault();
        $('searchInput').focus();
        $('searchInput').select();
      }
      if(!e.ctrlKey && !e.metaKey && !e.altKey){
        if(k === 'r'){ $('resetBtn').click(); }
        if(k === '1') setTab('triage');
        if(k === '2') setTab('workup');
        if(k === '3') setTab('interpret');
        if(k === '4') setTab('causes');
      }
    });

    // --- Inputs
    ['sex','prlValue','prlUnit','context','tHeadacheVisual','tCNPalsy','tShock','tAtypical'].forEach(id=>{
      $(id).addEventListener('input', compute);
      $(id).addEventListener('change', compute);
    });

    // --- Reset
    $('resetBtn').addEventListener('click', ()=>{
      $('sex').value = 'female';
      $('prlValue').value = '';
      $('prlUnit').value = 'ugL';
      $('context').value = 'general';
      $('tHeadacheVisual').checked = false;
      $('tCNPalsy').checked = false;
      $('tShock').checked = false;
      $('tAtypical').checked = false;
      compute();
      $('searchInput').value = '';
      applySearch();
    });

    // --- Search (highlights + hide non-matching blocks)
    function applySearch(){
      const q = $('searchInput').value.trim().toLowerCase();
      const scope = document.querySelector('.app');
      // Remove old highlights
      scope.querySelectorAll('mark').forEach(m=>{
        const t = document.createTextNode(m.textContent);
        m.replaceWith(t);
      });

      const blocks = scope.querySelectorAll('[data-search]');
      if(!q){
        blocks.forEach(b=> b.style.display = '');
        return;
      }

      blocks.forEach(b=>{
        const hay = (b.getAttribute('data-search') || '').toLowerCase();
        const match = hay.includes(q);
        b.style.display = match ? '' : 'none';
        if(match){
          // highlight in visible block
          highlightTextNodes(b, q);
        }
      });
    }

    function highlightTextNodes(root, q){
      const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
        acceptNode(node){
          if(!node.nodeValue) return NodeFilter.FILTER_REJECT;
          const v = node.nodeValue.toLowerCase();
          return v.includes(q) ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;
        }
      });
      const nodes = [];
      while(walker.nextNode()) nodes.push(walker.currentNode);

      nodes.forEach(node=>{
        const text = node.nodeValue;
        const idx = text.toLowerCase().indexOf(q);
        if(idx < 0) return;
        const before = document.createTextNode(text.slice(0, idx));
        const mid = document.createElement('mark');
        mid.textContent = text.slice(idx, idx + q.length);
        const after = document.createTextNode(text.slice(idx + q.length));
        const frag = document.createDocumentFragment();
        frag.append(before, mid, after);
        node.parentNode.replaceChild(frag, node);
      });
    }

    $('searchInput').addEventListener('input', applySearch);

    // Initial render
    compute();
  </script>
</body>
</html>
