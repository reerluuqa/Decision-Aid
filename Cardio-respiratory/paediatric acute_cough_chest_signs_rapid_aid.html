<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Peds Acute Cough + Chest Signs ‚Äî Rapid Decision Aid (UK)</title>
<style>
  :root{
    --bg:#0b1220;
    --panel:#0f1a2e;
    --panel2:#0c1627;
    --text:#e9eefc;
    --muted:#a9b3cf;
    --border:rgba(255,255,255,.10);
    --shadow:0 16px 40px rgba(0,0,0,.45);
    --red:#ff3b30;
    --green:#34c759;
    --amber:#ffb020;
    --blue:#4da3ff;
    --chip:rgba(255,255,255,.08);
    --focus:rgba(77,163,255,.35);
    --radius:18px;
    --radius2:14px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:var(--sans);
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 10% 10%, rgba(77,163,255,.20), transparent 60%),
      radial-gradient(900px 500px at 90% 20%, rgba(52,199,89,.16), transparent 60%),
      radial-gradient(1000px 600px at 40% 95%, rgba(255,59,48,.14), transparent 60%),
      linear-gradient(180deg, #070b14 0%, var(--bg) 55%, #070b14 100%);
    overflow-x:hidden;
  }
  a{color:inherit}
  header{
    position:sticky; top:0; z-index:50;
    backdrop-filter: blur(12px);
    background: rgba(7,11,20,.65);
    border-bottom:1px solid var(--border);
  }
  .wrap{max-width:1180px;margin:0 auto;padding:20px 18px 22px}
  .top{
    display:flex; gap:14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
  }
  .title{
    display:flex; gap:12px; align-items:flex-start;
  }
  .logo{
    width:44px;height:44px; border-radius:14px;
    display:grid; place-items:center;
    background: linear-gradient(135deg, rgba(77,163,255,.35), rgba(52,199,89,.25));
    border:1px solid var(--border);
    box-shadow:0 10px 25px rgba(0,0,0,.35);
  }
  .title h1{
    font-size:18px; margin:0; letter-spacing:.2px;
  }
  .title p{margin:3px 0 0; color:var(--muted); font-size:13px; max-width:72ch}
  .controls{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
  }
  .search{
    position:relative; min-width:260px; flex:1 1 260px;
  }
  .search input{
    width:100%;
    padding:11px 12px 11px 38px;
    border-radius:14px;
    border:1px solid var(--border);
    background:rgba(255,255,255,.06);
    color:var(--text);
    outline:none;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
  }
  .search input:focus{box-shadow:0 0 0 4px var(--focus); border-color:rgba(77,163,255,.55)}
  .search .icon{position:absolute; left:12px; top:10px; opacity:.9}
  .pillrow{display:flex; gap:8px; flex-wrap:wrap}
  .pill{
    user-select:none;
    cursor:pointer;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:rgba(255,255,255,.05);
    color:var(--muted);
    font-size:12px;
    transition:transform .12s ease, background .12s ease, color .12s ease, border-color .12s ease;
  }
  .pill:hover{transform:translateY(-1px); background:rgba(255,255,255,.08); color:var(--text)}
  .pill.active{background:rgba(77,163,255,.16); border-color:rgba(77,163,255,.5); color:var(--text)}
  main{max-width:1180px;margin:0 auto;padding:18px}
  .grid{
    display:grid;
    grid-template-columns: 1.05fr .95fr;
    gap:16px;
    align-items:start;
  }
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
  .card{
    border:1px solid var(--border);
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }
  .card .hd{
    padding:14px 14px 10px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .card .hd h2{
    margin:0;
    font-size:14px;
    letter-spacing:.25px;
  }
  .sub{
    color:var(--muted);
    font-size:12px;
    margin:0;
  }
  .card .bd{padding:12px 14px 14px}
  .badge{
    display:inline-flex; gap:8px; align-items:center;
    font-size:12px; color:var(--text);
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.05);
    white-space:nowrap;
  }
  .badge.red{background:rgba(255,59,48,.14); border-color:rgba(255,59,48,.45)}
  .badge.green{background:rgba(52,199,89,.14); border-color:rgba(52,199,89,.45)}
  .badge.amber{background:rgba(255,176,32,.14); border-color:rgba(255,176,32,.45)}
  .badge.blue{background:rgba(77,163,255,.14); border-color:rgba(77,163,255,.45)}
  .kpi{
    display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;
  }
  @media (max-width: 520px){ .kpi{grid-template-columns:1fr} }
  .kpi .box{
    padding:10px 10px;
    border-radius: var(--radius2);
    border:1px solid var(--border);
    background: rgba(0,0,0,.16);
    position:relative;
    overflow:hidden;
  }
  .kpi .box:hover{border-color:rgba(255,255,255,.18)}
  .kpi .box .t{font-size:11px; color:var(--muted)}
  .kpi .box .v{margin-top:3px; font-family:var(--mono); font-size:12px}
  .kpi .box::after{
    content:""; position:absolute; inset:-40px -40px auto auto; width:120px; height:120px;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.12), transparent 60%);
    transform: rotate(10deg);
    pointer-events:none;
  }
  .two{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
  @media (max-width: 720px){ .two{grid-template-columns:1fr} }
  .sectionTitle{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    margin:6px 0 10px;
  }
  .sectionTitle .left{display:flex; align-items:center; gap:8px}
  .sectionTitle h3{margin:0; font-size:13px}
  .sectionTitle small{color:var(--muted)}
  .callout{
    border-radius: var(--radius2);
    border:1px solid var(--border);
    padding:12px;
    background: rgba(255,255,255,.05);
    position:relative;
  }
  .callout.red{border-color:rgba(255,59,48,.5); background:rgba(255,59,48,.10)}
  .callout.green{border-color:rgba(52,199,89,.5); background:rgba(52,199,89,.10)}
  .callout .row{display:flex; gap:10px; align-items:flex-start}
  .callout .ico{
    width:34px;height:34px; border-radius:12px; display:grid;place-items:center;
    border:1px solid var(--border);
    background:rgba(0,0,0,.16);
    flex:0 0 34px;
  }
  .callout.red .ico{border-color:rgba(255,59,48,.5); background:rgba(255,59,48,.12)}
  .callout.green .ico{border-color:rgba(52,199,89,.5); background:rgba(52,199,89,.12)}
  .callout h4{margin:0; font-size:13px}
  .callout ul{margin:8px 0 0 18px; padding:0; color:var(--text); font-size:12px; line-height:1.45}
  .callout li{margin:6px 0}
  .hint{color:var(--muted); font-size:11px; margin-top:8px}
  details{
    border:1px solid var(--border);
    border-radius: var(--radius2);
    background: rgba(0,0,0,.12);
    overflow:hidden;
  }
  details + details{margin-top:10px}
  summary{
    cursor:pointer;
    list-style:none;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:12px;
    font-size:13px;
  }
  summary::-webkit-details-marker{display:none}
  .sumL{display:flex; gap:10px; align-items:center}
  .chev{transition: transform .12s ease; opacity:.9}
  details[open] .chev{transform: rotate(90deg)}
  .panel{
    padding:0 12px 12px;
    color:var(--text);
  }
  .panel p,.panel li{font-size:12px; color:var(--text); line-height:1.5}
  .panel p{margin:6px 0}
  .miniGrid{
    display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;
  }
  @media (max-width: 720px){ .miniGrid{grid-template-columns:1fr} }
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 10px;
    border-radius: 999px;
    border:1px solid var(--border);
    background: var(--chip);
    font-size:12px;
    color:var(--text);
  }
  .chip .k{color:var(--muted); font-size:11px}
  .list{
    display:grid; gap:8px;
  }
  .item{
    padding:10px;
    border-radius: var(--radius2);
    border:1px solid var(--border);
    background: rgba(255,255,255,.04);
    transition: transform .12s ease, border-color .12s ease, background .12s ease;
  }
  .item:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.18); background:rgba(255,255,255,.06)}
  .item .t{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .item h5{margin:0; font-size:12px}
  .item p{margin:6px 0 0; color:var(--muted); font-size:11px; line-height:1.45}
  .btnrow{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  button{
    cursor:pointer;
    border:1px solid var(--border);
    background: rgba(255,255,255,.06);
    color:var(--text);
    border-radius: 12px;
    padding:9px 10px;
    font-size:12px;
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
  }
  button:hover{transform:translateY(-1px); background:rgba(255,255,255,.09); border-color:rgba(255,255,255,.18)}
  button.primary{background:rgba(52,199,89,.14); border-color:rgba(52,199,89,.45)}
  button.danger{background:rgba(255,59,48,.14); border-color:rgba(255,59,48,.45)}
  button.ghost{background:transparent}
  .footer{
    color:var(--muted);
    font-size:11px;
    margin-top:14px;
    display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between;
    opacity:.95;
  }
  .kbd{
    font-family:var(--mono);
    padding:2px 6px;
    border-radius:8px;
    border:1px solid var(--border);
    background: rgba(0,0,0,.25);
    color:var(--text);
    font-size:11px;
  }
  .toast{
    position:fixed;
    bottom:14px; left:50%; transform:translateX(-50%);
    background: rgba(7,11,20,.78);
    border:1px solid var(--border);
    border-radius:999px;
    padding:10px 12px;
    box-shadow:0 18px 50px rgba(0,0,0,.55);
    display:none;
    align-items:center;
    gap:10px;
    z-index:200;
  }
  .toast.show{display:flex}
  .toast .dot{width:10px;height:10px;border-radius:999px;background:var(--blue)}
  .toast.red .dot{background:var(--red)}
  .toast.green .dot{background:var(--green)}
  .sr{position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden;}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <div class="logo" aria-hidden="true">ü´Å</div>
        <div>
          <h1>Peds acute cough + chest signs (1&nbsp;month‚Äì5&nbsp;years) ‚Äî rapid decision aid</h1>
          <p>Fast triage for <b>viral-induced wheeze / infective asthma exacerbation</b>, <b>bronchiolitis</b>, and <b>community-acquired pneumonia</b>. Optimised for scannability and immediate actions.</p>
        </div>
      </div>
      <div class="controls">
        <div class="search">
          <div class="icon" aria-hidden="true">üîé</div>
          <input id="q" type="search" placeholder="Search (e.g. SpO‚ÇÇ, grunting, amoxicillin, prednisolone)  ‚Äî press /" />
        </div>
        <div class="pillrow" role="tablist" aria-label="Views">
          <div class="pill active" role="tab" tabindex="0" data-view="triage">‚ö° Triage</div>
          <div class="pill" role="tab" tabindex="0" data-view="wheeze">üå¨Ô∏è Wheeze/Asthma</div>
          <div class="pill" role="tab" tabindex="0" data-view="bronchiolitis">üë∂ Bronchiolitis</div>
          <div class="pill" role="tab" tabindex="0" data-view="cap">ü¶† CAP</div>
          <div class="pill" role="tab" tabindex="0" data-view="rx">üíä Rx quick</div>
        </div>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <!-- LEFT COLUMN -->
    <section class="card" id="leftCard">
      <div class="hd">
        <div>
          <h2 id="viewTitle">‚ö° Rapid triage</h2>
          <p class="sub" id="viewSub">Identify condition + decide: <span class="badge red">999 / ED</span> vs <span class="badge amber">same-day review</span> vs <span class="badge green">home + safety-net</span></p>
        </div>
        <div class="badge blue" title="Keyboard shortcuts"><span aria-hidden="true">‚å®Ô∏è</span><span>Press <span class="kbd">/</span> to search</span></div>
      </div>
      <div class="bd" id="viewBody">

        <!-- TRIAGE VIEW -->
        <div class="view" data-view="triage">
          <div class="two">
            <div class="callout red">
              <div class="row">
                <div class="ico" aria-hidden="true">üö®</div>
                <div>
                  <h4>Red flags ‚Äî immediate emergency referral</h4>
                  <ul>
                    <li><b>Apnoea</b> (observed/reported) or <b>central cyanosis</b>.</li>
                    <li><b>Severe respiratory distress</b> (e.g. grunting, marked recession, very high RR).</li>
                    <li><b>Persistent SpO‚ÇÇ &lt;92%</b> in air (or <b>&lt;92%</b> for wheeze/asthma life‚Äëthreatening).</li>
                    <li><b>Child looks seriously unwell</b> / reduced responsiveness.</li>
                    <li><b>Age ‚â§3 months</b> with fever ‚â•38¬∞C.</li>
                  </ul>
                  <div class="hint">If in doubt: treat as severe and escalate early.</div>
                </div>
              </div>
            </div>

            <div class="callout green">
              <div class="row">
                <div class="ico" aria-hidden="true">‚úÖ</div>
                <div>
                  <h4>Immediate actions while awaiting transfer / escalation</h4>
                  <ul>
                    <li><b>Oxygen</b> if SpO‚ÇÇ low: aim <b>94‚Äì98%</b> for wheeze/asthma; give O‚ÇÇ if <b>persistent &lt;92%</b> in bronchiolitis/CAP.</li>
                    <li><b>Wheeze/severe asthma:</b> salbutamol neb <b>5 mg (&gt;5y)</b> or <b>2.5 mg (2‚Äì5y)</b>; repeat q20‚Äì30 min (or continuous if available).</li>
                    <li>Assess hydration, RR, HR, work of breathing, consciousness; repeat obs frequently.</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <div class="sectionTitle" style="margin-top:14px">
            <div class="left"><span aria-hidden="true">üß≠</span><h3>Decision builder</h3></div>
            <small>Tick what you see; the tool highlights the likely pathway</small>
          </div>

          <div class="kpi" id="triageKPIs">
            <div class="box">
              <div class="t">SpO‚ÇÇ in air</div>
              <div class="v"><span id="kpiSpo2">‚Äî</span></div>
            </div>
            <div class="box">
              <div class="t">Respiratory rate</div>
              <div class="v"><span id="kpiRR">‚Äî</span></div>
            </div>
            <div class="box">
              <div class="t">Best-fit pathway</div>
              <div class="v"><span id="kpiPath">‚Äî</span></div>
            </div>
          </div>

          <div class="miniGrid">
            <div class="item">
              <div class="t">
                <h5>Inputs</h5>
                <span class="badge blue">Tap to toggle</span>
              </div>
              <div class="panel">
                <div class="miniGrid" style="margin-top:0">
                  <label class="chip" title="Use corrected gestational age when relevant.">
                    <span class="k">Age</span>
                    <select id="age" style="margin-left:auto; border:0; background:transparent; color:var(--text); font-size:12px; outline:none">
                      <option value="lt2">Under 2 years</option>
                      <option value="2to5">2‚Äì5 years</option>
                      <option value="gt5">Over 5 years</option>
                    </select>
                  </label>
                  <label class="chip">
                    <span class="k">SpO‚ÇÇ (%)</span>
                    <input id="spo2" inputmode="numeric" placeholder="e.g. 91" style="margin-left:auto; width:88px; border:0; background:transparent; color:var(--text); font-family:var(--mono); outline:none"/>
                  </label>
                </div>

                <div class="miniGrid">
                  <label class="chip">
                    <span class="k">RR (/min)</span>
                    <input id="rr" inputmode="numeric" placeholder="e.g. 62" style="margin-left:auto; width:88px; border:0; background:transparent; color:var(--text); font-family:var(--mono); outline:none"/>
                  </label>
                  <label class="chip">
                    <span class="k">Temp (¬∞C)</span>
                    <input id="temp" inputmode="decimal" placeholder="e.g. 39.2" style="margin-left:auto; width:88px; border:0; background:transparent; color:var(--text); font-family:var(--mono); outline:none"/>
                  </label>
                </div>

                <div class="list" style="margin-top:10px">
                  <label class="item" style="cursor:pointer">
                    <div class="t"><h5>Wheeze on auscultation</h5><span class="badge" id="bWheeze">off</span></div>
                    <input class="sr" type="checkbox" id="wheeze" />
                    <p>Suggests viral-induced wheeze / asthma (esp. 6 months‚Äì5 years).</p>
                  </label>
                  <label class="item" style="cursor:pointer">
                    <div class="t"><h5>Crackles (diffuse or focal)</h5><span class="badge" id="bCrackles">off</span></div>
                    <input class="sr" type="checkbox" id="crackles" />
                    <p>Diffuse fine crackles ‚Üí bronchiolitis; persistent focal crackles ‚Üí pneumonia.</p>
                  </label>
                  <label class="item" style="cursor:pointer">
                    <div class="t"><h5>Severe distress: grunting / marked recession / nasal flaring</h5><span class="badge" id="bDistress">off</span></div>
                    <input class="sr" type="checkbox" id="distress" />
                    <p>Triggers emergency pathway if severe or with hypoxia.</p>
                  </label>
                  <label class="item" style="cursor:pointer">
                    <div class="t"><h5>Reduced alertness / not responding to social cues</h5><span class="badge" id="bNeuro">off</span></div>
                    <input class="sr" type="checkbox" id="neuro" />
                    <p>High-risk feature ‚Üí urgent escalation.</p>
                  </label>
                  <label class="item" style="cursor:pointer">
                    <div class="t"><h5>Feeding poor (‚â§75% usual) or clinical dehydration</h5><span class="badge" id="bFeed">off</span></div>
                    <input class="sr" type="checkbox" id="feed" />
                    <p>Supports referral decision in bronchiolitis/CAP.</p>
                  </label>
                  <label class="item" style="cursor:pointer">
                    <div class="t"><h5>Apnoea / cyanosis (reported or observed)</h5><span class="badge red" id="bApnoea">off</span></div>
                    <input class="sr" type="checkbox" id="apnoea" />
                    <p><b>Always emergency referral.</b></p>
                  </label>
                </div>

                <div class="btnrow">
                  <button class="primary" id="run">Update pathway</button>
                  <button class="ghost" id="reset">Reset</button>
                  <button id="copy">Copy plan</button>
                </div>
              </div>
            </div>

            <div class="item">
              <div class="t">
                <h5>Recommended next step</h5>
                <span class="badge green" id="riskBadge">Ready</span>
              </div>

              <div id="plan" class="panel">
                <p class="sub">Use the builder on the left. The app will output a brief action list tailored to the flags you tick.</p>
              </div>

              <details style="margin-top:10px">
                <summary>
                  <div class="sumL"><span aria-hidden="true">üß†</span><span>Pattern recognition cheatsheet</span></div>
                  <span class="chev" aria-hidden="true">‚ñ∂</span>
                </summary>
                <div class="panel">
                  <p><b>Bronchiolitis (usually &lt;2y)</b>: coryzal prodrome ‚Üí cough + tachypnoea/recession + wheeze/crackles; may have apnoea in very young infants.</p>
                  <p><b>CAP</b>: high fever, cyanosis, raised RR by age band, focal crackles, SpO‚ÇÇ ‚â§95% in air, effusion signs (dullness + absent breath sounds).</p>
                  <p><b>Viral-induced wheeze</b> (6m‚Äì5y): wheeze only with infection; <b>asthma</b> more likely with wheeze outside infections or typical triggers/atopy history.</p>
                </div>
              </details>

              <details style="margin-top:10px">
                <summary>
                  <div class="sumL"><span aria-hidden="true">üìå</span><span>‚ÄúLower threshold‚Äù admission modifiers</span></div>
                  <span class="chev" aria-hidden="true">‚ñ∂</span>
                </summary>
                <div class="panel">
                  <ul>
                    <li>Prematurity (esp. &lt;32 weeks), age &lt;3 months.</li>
                    <li>Chronic lung disease (incl. BPD), haemodynamically significant CHD, neuromuscular disorder, immunodeficiency.</li>
                    <li>Carer factors / distance to care / inability to monitor deterioration.</li>
                  </ul>
                </div>
              </details>

            </div>
          </div>
        </div>

        <!-- WHEEZE VIEW -->
        <div class="view" data-view="wheeze" hidden>
          <div class="two">
            <div class="callout red">
              <div class="row">
                <div class="ico" aria-hidden="true">‚ö†Ô∏è</div>
                <div>
                  <h4>Life-threatening wheeze/asthma features</h4>
                  <ul>
                    <li><b>PEFR &lt;33%</b> best/predicted or <b>SpO‚ÇÇ &lt;92%</b></li>
                    <li>Altered consciousness, exhaustion, cyanosis, poor respiratory effort, silent chest</li>
                    <li>Arrhythmia or hypotension</li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="callout green">
              <div class="row">
                <div class="ico" aria-hidden="true">üßØ</div>
                <div>
                  <h4>First actions (severe/life-threatening)</h4>
                  <ul>
                    <li><b>O‚ÇÇ</b> if SpO‚ÇÇ &lt;94% ‚Üí target <b>94‚Äì98%</b>.</li>
                    <li><b>Salbutamol neb</b>: <b>5 mg</b> (&gt;5y) or <b>2.5 mg</b> (2‚Äì5y); repeat q20‚Äì30 min or continuous 30‚Äì60 min.</li>
                    <li>If mild‚Äìmoderate and no neb: <b>pMDI + spacer</b> up to <b>10 puffs</b>, 1 puff every 30‚Äì60 s (5 tidal breaths per puff).</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <details open style="margin-top:12px">
            <summary>
              <div class="sumL"><span aria-hidden="true">üìä</span><span>Severity grading (quick)</span></div>
              <span class="chev" aria-hidden="true">‚ñ∂</span>
            </summary>
            <div class="panel">
              <div class="list">
                <div class="item">
                  <div class="t"><h5>Moderate</h5><span class="badge amber">PEFR ‚â•50%</span></div>
                  <p>Normal speech (if applicable); no severe or life-threatening features.</p>
                </div>
                <div class="item">
                  <div class="t"><h5>Acute severe</h5><span class="badge amber">PEFR &lt;50% OR obs thresholds</span></div>
                  <p>RR ‚â•25 (&gt;12y), ‚â•30 (5‚Äì12y), ‚â•40 (2‚Äì5y) OR pulse ‚â•110 (&gt;12y), ‚â•125 (5‚Äì12y), ‚â•140 (2‚Äì5y) OR cannot complete sentences, accessory muscle use, inability to feed; SpO‚ÇÇ ‚â•92%.</p>
                </div>
                <div class="item">
                  <div class="t"><h5>Life-threatening</h5><span class="badge red">Act now</span></div>
                  <p>PEFR &lt;33% OR SpO‚ÇÇ &lt;92% OR altered consciousness/exhaustion/arrhythmia/hypotension/cyanosis/poor effort/silent chest/confusion.</p>
                </div>
              </div>
            </div>
          </details>

          <details>
            <summary>
              <div class="sumL"><span aria-hidden="true">üè•</span><span>Admission & disposition prompts</span></div>
              <span class="chev" aria-hidden="true">‚ñ∂</span>
            </summary>
            <div class="panel">
              <ul>
                <li>Admit all life-threatening.</li>
                <li>Admit if any severe feature persists after initial bronchodilator therapy.</li>
                <li>Admit if moderate but worsening despite initial bronchodilator and/or prior near-fatal asthma.</li>
              </ul>
            </div>
          </details>

          <details>
            <summary>
              <div class="sumL"><span aria-hidden="true">üíä</span><span>When to add prednisolone / antibiotics</span></div>
              <span class="chev" aria-hidden="true">‚ñ∂</span>
            </summary>
            <div class="panel">
              <p><b>Prednisolone</b> if existing asthma diagnosis OR asthma suspected (wheeze with non-viral triggers / atopy pattern).</p>
              <p class="sub"><b>Dose</b>: 1 month‚Äì11y: 1‚Äì2 mg/kg OD (max 40 mg) x3 days; 12‚Äì17y: 40‚Äì50 mg OD ‚â•5 days.</p>
              <p><b>Antibiotics</b> only if signs suggest bacterial infection (wheeze pathway). Typical duration ~5 days.</p>
            </div>
          </details>
        </div>

        <!-- BRONCHIOLITIS VIEW -->
        <div class="view" data-view="bronchiolitis" hidden>
          <div class="two">
            <div class="callout red">
              <div class="row">
                <div class="ico" aria-hidden="true">üö®</div>
                <div>
                  <h4>Bronchiolitis ‚Äî emergency referral criteria</h4>
                  <ul>
                    <li><b>Apnoea</b> (observed/reported)</li>
                    <li>Child looks <b>seriously unwell</b></li>
                    <li><b>Severe distress</b>: grunting, marked recession, or <b>RR &gt;70/min</b></li>
                    <li><b>Central cyanosis</b></li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="callout green">
              <div class="row">
                <div class="ico" aria-hidden="true">ü´ß</div>
                <div>
                  <h4>Supportive care focus</h4>
                  <ul>
                    <li>Assess work of breathing, hydration (CRT, mucosa, urine), SpO‚ÇÇ in air.</li>
                    <li><b>O‚ÇÇ</b> if SpO‚ÇÇ persistently <b>&lt;92%</b>.</li>
                    <li>Home care: fluids, antipyretic for distress, smoke avoidance, monitoring overnight.</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <details open style="margin-top:12px">
            <summary>
              <div class="sumL"><span aria-hidden="true">üß∑</span><span>Consider referral / same-day assessment if‚Ä¶</span></div>
              <span class="chev" aria-hidden="true">‚ñ∂</span>
            </summary>
            <div class="panel">
              <ul>
                <li><b>RR &gt;60/min</b></li>
                <li>Feeding difficulty or intake <b>50‚Äì75%</b> usual</li>
                <li>Clinical dehydration (reduced turgor, CRT &gt;3s, dry mucosa, reduced urine output)</li>
                <li>SpO‚ÇÇ persistently <b>&lt;92%</b> in air</li>
              </ul>
            </div>
          </details>

          <details>
            <summary>
              <div class="sumL"><span aria-hidden="true">üßØ</span><span>Safety-net: what to tell carers</span></div>
              <span class="chev" aria-hidden="true">‚ñ∂</span>
            </summary>
            <div class="panel">
              <ul>
                <li>Breathing rate increases, apnoea/cyanosis, or increased effort (grunting, nasal flaring, marked recession).</li>
                <li>Intake falls to 50‚Äì75% or signs of dehydration (dry mouth / no wet nappy for ~12h).</li>
                <li>Becoming less responsive or difficult to rouse.</li>
                <li>Persistent worsening of fever.</li>
              </ul>
            </div>
          </details>
        </div>

        <!-- CAP VIEW -->
        <div class="view" data-view="cap" hidden>
          <div class="two">
            <div class="callout red">
              <div class="row">
                <div class="ico" aria-hidden="true">üöë</div>
                <div>
                  <h4>CAP ‚Äî emergency referral criteria</h4>
                  <ul>
                    <li><b>SpO‚ÇÇ &lt;92%</b> in air (persistent)</li>
                    <li><b>RR &gt;60/min</b> OR grunting/marked recession</li>
                    <li><b>Cyanosis</b> (pale/mottled/ashen/blue skin, lips or tongue)</li>
                    <li>Seriously unwell or reduced responsiveness to cues</li>
                    <li><b>Age ‚â§3 months</b> with fever ‚â•38¬∞C</li>
                    <li>Effusion signs: dull percussion + absent breath sounds</li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="callout green">
              <div class="row">
                <div class="ico" aria-hidden="true">üß´</div>
                <div>
                  <h4>Non-severe CAP in primary care</h4>
                  <ul>
                    <li><b>Antibiotics for clinical pneumonia</b> (viral vs bacterial not reliably distinguishable).</li>
                    <li><b>First-line:</b> amoxicillin. Alternatives: erythromycin / clarithromycin / doxycycline (‚â•12y).</li>
                    <li><b>Course length:</b> 3 days (3 months‚Äì11y) or 5 days (1‚Äì2 months; ‚â•12y). Stop after 5 days unless not clinically stable.</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <details open style="margin-top:12px">
            <summary>
              <div class="sumL"><span aria-hidden="true">üß∑</span><span>Consider referral / same-day assessment if‚Ä¶</span></div>
              <span class="chev" aria-hidden="true">‚ñ∂</span>
            </summary>
            <div class="panel">
              <ul>
                <li>Temp ‚â•39¬∞C (age 3‚Äì6 months)</li>
                <li>Tachycardia: &gt;160 (&lt;1y), &gt;150 (1‚Äì2y), &gt;140 (2‚Äì5y)</li>
                <li>Intake 50‚Äì75% usual, pallor (skin/lips/tongue), nasal flaring, dehydration (CRT &gt;3s etc.)</li>
                <li>Abnormal response to cues, wakes only with prolonged stimulation, decreased activity</li>
              </ul>
            </div>
          </details>

          <details>
            <summary>
              <div class="sumL"><span aria-hidden="true">üè†</span><span>Home care + follow-up triggers</span></div>
              <span class="chev" aria-hidden="true">‚ñ∂</span>
            </summary>
            <div class="panel">
              <ul>
                <li>Monitor overnight; seek review if breathing worsens, intake drops to 50‚Äì75%, reduced responsiveness, or fever persists/worsens.</li>
                <li>If fever not settling within 48h of antibiotics ‚Üí reassess.</li>
              </ul>
            </div>
          </details>
        </div>

        <!-- RX VIEW -->
        <div class="view" data-view="rx" hidden>
          <div class="sectionTitle">
            <div class="left"><span aria-hidden="true">üíä</span><h3>High-yield prescribing snippets</h3></div>
            <small>Tap items to expand; copy button pulls a one-line plan</small>
          </div>

          <details open>
            <summary>
              <div class="sumL"><span aria-hidden="true">ü¶†</span><span>Amoxicillin (CAP first-line) ‚Äî dose & duration</span></div>
              <span class="chev" aria-hidden="true">‚ñ∂</span>
            </summary>
            <div class="panel">
              <div class="list">
                <div class="item"><div class="t"><h5>1‚Äì2 months</h5><span class="badge amber">5 days</span></div><p><span class="chip"><span class="k">Dose</span>125 mg TDS</span> (may increase to 30 mg/kg TDS if needed)</p></div>
                <div class="item"><div class="t"><h5>3‚Äì11 months</h5><span class="badge green">3 days</span></div><p><span class="chip"><span class="k">Dose</span>125 mg TDS</span> (may increase to 30 mg/kg TDS if needed)</p></div>
                <div class="item"><div class="t"><h5>1‚Äì4 years</h5><span class="badge green">3 days</span></div><p><span class="chip"><span class="k">Dose</span>250 mg TDS</span> (may increase to 30 mg/kg TDS if needed)</p></div>
                <div class="item"><div class="t"><h5>5‚Äì11 years</h5><span class="badge green">3 days</span></div><p><span class="chip"><span class="k">Dose</span>500 mg TDS</span> (may increase to 30 mg/kg TDS; max 1 g/dose)</p></div>
                <div class="item"><div class="t"><h5>12‚Äì17 years</h5><span class="badge amber">5 days</span></div><p><span class="chip"><span class="k">Dose</span>500 mg TDS</span> (may increase to 1 g TDS)</p></div>
              </div>
              <p class="hint">In CAP: stop after 5 days unless not clinically stable or microbiology indicates longer.</p>
            </div>
          </details>

          <details>
            <summary>
              <div class="sumL"><span aria-hidden="true">üå¨Ô∏è</span><span>Prednisolone (suspected/known asthma)</span></div>
              <span class="chev" aria-hidden="true">‚ñ∂</span>
            </summary>
            <div class="panel">
              <div class="list">
                <div class="item"><div class="t"><h5>1 month‚Äì11 years</h5><span class="badge green">3 days</span></div><p><span class="chip"><span class="k">Dose</span>1‚Äì2 mg/kg OD (max 40 mg)</span> (longer if necessary)</p></div>
                <div class="item"><div class="t"><h5>12‚Äì17 years</h5><span class="badge amber">‚â•5 days</span></div><p><span class="chip"><span class="k">Dose</span>40‚Äì50 mg OD</span></p></div>
              </div>
            </div>
          </details>

          <details>
            <summary>
              <div class="sumL"><span aria-hidden="true">ü´ß</span><span>Salbutamol (short-acting Œ≤2 agonist) ‚Äî rapid delivery options</span></div>
              <span class="chev" aria-hidden="true">‚ñ∂</span>
            </summary>
            <div class="panel">
              <div class="list">
                <div class="item">
                  <div class="t"><h5>Severe/life-threatening</h5><span class="badge red">Neb</span></div>
                  <p>Nebulised: <b>5 mg</b> (&gt;5y) or <b>2.5 mg</b> (2‚Äì5y). Repeat q20‚Äì30 min; continuous neb over 30‚Äì60 min if supported. Prefer oxygen-driven neb (‚âà6 L/min) if available.</p>
                </div>
                <div class="item">
                  <div class="t"><h5>Mild‚Äìmoderate / no neb</h5><span class="badge green">pMDI + spacer</span></div>
                  <p>1 puff every 30‚Äì60 s up to 10 puffs; 5 tidal breaths per puff; young children may need a face mask.</p>
                </div>
              </div>
            </div>
          </details>

          <div class="btnrow">
            <button id="copyRx">Copy common Rx bundle</button>
            <button class="ghost" id="print">Print view</button>
          </div>
        </div>

      </div>
      <div class="footer">
        <div>Built for rapid clinical scanning ‚Ä¢ No network calls ‚Ä¢ Single-file app</div>
        <div>Tip: hover over badges for context; <span class="kbd">Tab</span> to jump between controls</div>
      </div>
    </section>

    <!-- RIGHT COLUMN -->
    <aside class="card" id="rightCard">
      <div class="hd">
        <div>
          <h2>üìå Quick-reference rails</h2>
          <p class="sub">Always-visible ‚Äúdo now / do next / don‚Äôt forget‚Äù prompts</p>
        </div>
        <div class="badge amber" id="railMode">Mode: triage</div>
      </div>
      <div class="bd">
        <div class="sectionTitle">
          <div class="left"><span aria-hidden="true">üö¶</span><h3>Disposition</h3></div>
          <small>tap to copy</small>
        </div>

        <div class="list" id="rails">
          <div class="item" data-copy="Emergency referral (999/ED): apnoea/cyanosis, severe distress, persistent SpO2<92%, seriously unwell/reduced responsiveness; give oxygen and treat wheeze aggressively while awaiting transfer.">
            <div class="t"><h5>üö® Emergency referral</h5><span class="badge red">999 / ED</span></div>
            <p>Apnoea/cyanosis ‚Ä¢ severe distress ‚Ä¢ persistent SpO‚ÇÇ &lt;92% ‚Ä¢ seriously unwell / reduced responsiveness ‚Ä¢ ‚â§3 months + fever ‚â•38¬∞C.</p>
          </div>

          <div class="item" data-copy="Same-day assessment/referral: RR>60 (bronchiolitis) or >60 with grunting/recession (CAP), intake 50‚Äì75% usual, dehydration (CRT>3s etc.), persistent SpO2<92% in air, high fever in young infant. Lower threshold in prematurity/CHD/CLD/ND/immunodeficiency.">
            <div class="t"><h5>üüß Same-day assessment</h5><span class="badge amber">Refer / assess</span></div>
            <p>RR thresholds, feeding 50‚Äì75%, dehydration, SpO‚ÇÇ low, or significant comorbidity / carer factors.</p>
          </div>

          <div class="item" data-copy="Home management + safety-net: supportive care, fluids, antipyretic for distress, smoke avoidance, check overnight. Return if breathing worsens, intake drops, reduced responsiveness, persistent/worsening fever; in CAP if fever not settling within 48h antibiotics.">
            <div class="t"><h5>‚úÖ Home + safety-net</h5><span class="badge green">Advice</span></div>
            <p>Supportive care; clear return precautions; consider follow-up interval based on risk and trajectory.</p>
          </div>
        </div>

        <div class="sectionTitle" style="margin-top:14px">
          <div class="left"><span aria-hidden="true">üß™</span><h3>Investigations (primary care)</h3></div>
          <small>default</small>
        </div>
        <div class="callout">
          <div class="row">
            <div class="ico" aria-hidden="true">üßæ</div>
            <div>
              <h4>Usually not routine</h4>
              <ul>
                <li>Microbiology and CXR are not routinely initiated in primary care for these presentations.</li>
              </ul>
              <div class="hint">Escalate / refer if you‚Äôre considering imaging or labs for severity/complications.</div>
            </div>
          </div>
        </div>

        <div class="sectionTitle" style="margin-top:14px">
          <div class="left"><span aria-hidden="true">üß©</span><h3>Antibiotics: when (and when not)</h3></div>
          <small>high-yield</small>
        </div>

        <details>
          <summary>
            <div class="sumL"><span aria-hidden="true">ü¶†</span><span>CAP</span></div>
            <span class="chev" aria-hidden="true">‚ñ∂</span>
          </summary>
          <div class="panel">
            <p><b>Treat clinical pneumonia</b> (viral vs bacterial not reliably distinguishable).</p>
            <p><b>Exception:</b> &lt;2y with mild LRTI symptoms usually not pneumonia; review if persists; PCV history increases confidence.</p>
          </div>
        </details>

        <details>
          <summary>
            <div class="sumL"><span aria-hidden="true">üë∂</span><span>Bronchiolitis</span></div>
            <span class="chev" aria-hidden="true">‚ñ∂</span>
          </summary>
          <div class="panel">
            <p>Do <b>not</b> use antibiotics for bronchiolitis (supportive care focus).</p>
          </div>
        </details>

      </div>
    </aside>
  </div>
</main>

<div class="toast" id="toast" role="status" aria-live="polite">
  <div class="dot" aria-hidden="true"></div>
  <div id="toastMsg">Copied</div>
</div>

<script>
  // ---------- Helpers ----------
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const clamp = (n, a, b) => Math.min(b, Math.max(a, n));

  function toast(msg, tone="blue"){
    const t = $("#toast"), m=$("#toastMsg");
    t.classList.remove("red","green");
    if(tone==="red") t.classList.add("red");
    if(tone==="green") t.classList.add("green");
    m.textContent = msg;
    t.classList.add("show");
    clearTimeout(toast._h);
    toast._h = setTimeout(()=>t.classList.remove("show"), 1600);
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      toast("Copied to clipboard");
    }catch(e){
      // fallback
      const ta=document.createElement("textarea");
      ta.value=text; document.body.appendChild(ta);
      ta.select(); document.execCommand("copy");
      ta.remove();
      toast("Copied (fallback)");
    }
  }

  // ---------- Tabs / Views ----------
  const pills = $$(".pill");
  const views = $$(".view");
  const railMode = $("#railMode");
  const viewTitle = $("#viewTitle");
  const viewSub = $("#viewSub");

  function setView(name){
    pills.forEach(p=>p.classList.toggle("active", p.dataset.view===name));
    views.forEach(v=>v.hidden = v.dataset.view !== name);

    const titles = {
      triage:["‚ö° Rapid triage","Identify condition + decide: 999/ED vs same-day vs home + safety-net"],
      wheeze:["üå¨Ô∏è Viral-induced wheeze / infective asthma exacerbation","Severity grading + first actions + disposition prompts"],
      bronchiolitis:["üë∂ Bronchiolitis","Emergency criteria, referral thresholds, safety-netting"],
      cap:["ü¶† Community-acquired pneumonia (CAP)","Emergency criteria, referral prompts, antibiotic course lengths"],
      rx:["üíä Prescribing quick view","Amoxicillin + prednisolone + salbutamol delivery (rapid recall)"]
    };
    viewTitle.textContent = titles[name][0];
    viewSub.textContent = titles[name][1];
    railMode.textContent = "Mode: " + name;

    // keep rails contextually highlighted
    $("#rails").style.opacity = (name==="rx") ? ".92" : "1";
  }

  pills.forEach(p=>{
    p.addEventListener("click", ()=>setView(p.dataset.view));
    p.addEventListener("keydown", (e)=>{
      if(e.key==="Enter" || e.key===" "){ e.preventDefault(); setView(p.dataset.view); }
    });
  });

  // ---------- Search (filters items + opens matching accordions) ----------
  const q = $("#q");
  function doSearch(){
    const term = q.value.trim().toLowerCase();
    const targets = $$("details, .item, .callout, .box, .chip, .badge, p, li, h4, h5, h2, h3");
    let hits=0;

    // reset highlights
    $$(".hl").forEach(x=>x.classList.remove("hl"));

    if(!term){
      $$("[data-filtered='1']").forEach(el=>{ el.style.display=""; el.dataset.filtered="0"; });
      $$("details").forEach(d=>d.open = d.hasAttribute("data-default-open"));
      return;
    }

    // simple: hide elements with no match (only for top-level interactive blocks)
    const blocks = $$(".view:not([hidden]) .item, .view:not([hidden]) details, .view:not([hidden]) .callout");
    blocks.forEach(b=>{
      const text = b.innerText.toLowerCase();
      const ok = text.includes(term);
      b.style.display = ok ? "" : "none";
      b.dataset.filtered = ok ? "0":"1";
      if(ok) hits++;
      if(ok && b.tagName==="DETAILS") b.open = true;
    });

    if(hits===0) toast("No matches in this view");
    else toast(hits + " match" + (hits===1?"":"es"));
  }
  q.addEventListener("input", ()=>doSearch());

  // keyboard shortcut "/"
  window.addEventListener("keydown", (e)=>{
    if(e.key==="/" && document.activeElement !== q){
      e.preventDefault();
      q.focus();
    }
  });

  // ---------- Triage builder ----------
  const inputs = {
    age: $("#age"),
    spo2: $("#spo2"),
    rr: $("#rr"),
    temp: $("#temp"),
    wheeze: $("#wheeze"),
    crackles: $("#crackles"),
    distress: $("#distress"),
    neuro: $("#neuro"),
    feed: $("#feed"),
    apnoea: $("#apnoea"),
  };

  function toggleBadge(cb, badgeEl, onClass){
    badgeEl.textContent = cb.checked ? "on" : "off";
    badgeEl.classList.toggle(onClass, cb.checked);
  }

  function updateToggleBadges(){
    toggleBadge(inputs.wheeze, $("#bWheeze"), "green");
    toggleBadge(inputs.crackles, $("#bCrackles"), "green");
    toggleBadge(inputs.distress, $("#bDistress"), "amber");
    toggleBadge(inputs.neuro, $("#bNeuro"), "red");
    toggleBadge(inputs.feed, $("#bFeed"), "amber");
    toggleBadge(inputs.apnoea, $("#bApnoea"), "red");
  }

  Object.values(inputs).forEach(el=>{
    if(el.type==="checkbox") el.addEventListener("change", updateToggleBadges);
  });
  updateToggleBadges();

  function parseNum(el){
    const v = (el.value||"").toString().trim();
    if(!v) return null;
    const n = Number(v.replace(",","."));
    return Number.isFinite(n) ? n : null;
  }

  function triage(){
    const age = inputs.age.value;
    const spo2 = parseNum(inputs.spo2);
    const rr = parseNum(inputs.rr);
    const temp = parseNum(inputs.temp);

    const wheeze = inputs.wheeze.checked;
    const crackles = inputs.crackles.checked;
    const distress = inputs.distress.checked;
    const neuro = inputs.neuro.checked;
    const feed = inputs.feed.checked;
    const apnoea = inputs.apnoea.checked;

    $("#kpiSpo2").textContent = (spo2==null) ? "‚Äî" : (spo2.toFixed(0) + "%");
    $("#kpiRR").textContent = (rr==null) ? "‚Äî" : (rr.toFixed(0) + "/min");

    const red = [];
    const refer = [];
    const actions = [];
    const notes = [];

    // Red flag logic (derived from CKS thresholds used across pathways)
    if(apnoea) red.push("Apnoea/cyanosis reported/observed ‚Üí emergency referral.");
    if(neuro) red.push("Reduced responsiveness / abnormal social cues ‚Üí emergency referral.");
    if(spo2!=null && spo2 < 92) red.push("SpO‚ÇÇ <92% in air ‚Üí emergency referral (bronchiolitis/CAP; also life-threatening wheeze).");
    if(distress && (rr!=null ? rr>60 : true)) red.push("Marked distress (grunting/marked recession), especially with high RR ‚Üí emergency referral.");
    if(temp!=null && temp>=38 && age==="lt2") {
      // age band is coarse; flag infant fever for safety.
      refer.push("Consider age-based fever thresholds in young infants; fever ‚â•38¬∞C in ‚â§3 months is emergency criterion in CAP.");
    }

    // Condition scoring
    let scoreBron=0, scoreCap=0, scoreWz=0;
    if(age==="lt2") scoreBron += 2;
    if(wheeze) scoreWz += 2;
    if(crackles) { scoreBron += 1; scoreCap += 1; }
    if(temp!=null && temp>=39) scoreCap += 1;
    if(rr!=null){
      if(rr>70 && age==="lt2") scoreBron += 2;
      if(rr>60) scoreCap += 2;
      if(age==="2to5" && rr>=40 && wheeze) scoreWz += 1; // aligns to severe RR threshold for 2‚Äì5y
    }
    if(spo2!=null && spo2<=95) scoreCap += 1; // suggest pneumonia consideration
    if(feed) scoreBron += 1, scoreCap += 1;

    // pick best-fit
    const best = [{k:"Bronchiolitis", v:scoreBron, view:"bronchiolitis"},
                  {k:"CAP", v:scoreCap, view:"cap"},
                  {k:"Wheeze/Asthma", v:scoreWz, view:"wheeze"}]
                 .sort((a,b)=>b.v-a.v)[0];

    $("#kpiPath").textContent = (best.v===0) ? "‚Äî" : best.k;

    // Build plan text
    const isEmerg = red.length>0;

    if(isEmerg){
      actions.push("üö® Emergency: call 999/ED referral now.");
      actions.push("Give oxygen if hypoxic; repeat obs; prepare for transfer.");
      if(wheeze) actions.push("If wheeze: start salbutamol (neb if severe; spacer if mild‚Äìmoderate).");
      if(best.k==="CAP") notes.push("CAP: consider effusion if dullness + absent breath sounds.");
    } else {
      // referral thresholds (non-emergency)
      if(best.k==="Bronchiolitis"){
        if(rr!=null && rr>60) refer.push("Bronchiolitis: RR >60/min ‚Üí consider referral.");
        if(feed) refer.push("Bronchiolitis: intake 50‚Äì75% or dehydration ‚Üí consider referral.");
        if(spo2!=null && spo2<92) refer.push("Bronchiolitis: persistent SpO‚ÇÇ <92% ‚Üí refer.");
        actions.push("Supportive care: fluids; antipyretic for distress; smoke avoidance.");
        actions.push("Safety-net: breathing worse, apnoea/cyanosis, intake drops, reduced responsiveness.");
      }
      if(best.k==="CAP"){
        if(rr!=null && rr>60) refer.push("CAP: RR >60/min or grunting/marked recession ‚Üí emergency referral threshold.");
        if(feed) refer.push("CAP: intake 50‚Äì75% or dehydration ‚Üí consider referral.");
        if(temp!=null && temp>=39 && age==="lt2") refer.push("CAP: temp ‚â•39¬∞C in 3‚Äì6 months is referral criterion (age band approximate).");
        actions.push("If clinical pneumonia: start antibiotics (amoxicillin first-line).");
        actions.push("Safety-net: reassess if fever not settling within 48h antibiotics or clinical deterioration.");
      }
      if(best.k==="Wheeze/Asthma"){
        actions.push("Assess severity (PEFR if possible) + obs; bronchodilator via spacer/nebuliser per severity.");
        actions.push("Consider prednisolone if known asthma or asthma suspected.");
        if(spo2!=null && spo2<94) actions.push("O‚ÇÇ if SpO‚ÇÇ <94% (target 94‚Äì98%).");
      }
    }

    const riskBadge = $("#riskBadge");
    if(isEmerg){
      riskBadge.textContent="Emergency";
      riskBadge.className="badge red";
    }else if(refer.length){
      riskBadge.textContent="Consider referral";
      riskBadge.className="badge amber";
    }else{
      riskBadge.textContent="Home + safety-net";
      riskBadge.className="badge green";
    }

    // Render plan
    const plan = $("#plan");
    const html = `
      ${isEmerg ? `<div class="badge red">üö® IMMEDIATE ACTION</div>` : (refer.length?`<div class="badge amber">üüß SAME-DAY / REFER THRESHOLD</div>`:`<div class="badge green">‚úÖ HOME MANAGEMENT OK (IF STABLE)</div>`)}
      <p style="margin:10px 0 6px"><b>Likely pathway:</b> ${best.v===0 ? "Undifferentiated ‚Äî use clinical judgement" : best.k}</p>
      ${red.length? `<div class="callout red" style="margin-top:8px"><div class="row"><div class="ico">üö®</div><div><h4>Red flags detected</h4><ul>${red.map(x=>`<li>${x}</li>`).join("")}</ul></div></div></div>`:""}
      ${refer.length? `<div class="callout" style="margin-top:8px"><div class="row"><div class="ico">üüß</div><div><h4>Referral prompts</h4><ul>${refer.map(x=>`<li>${x}</li>`).join("")}</ul></div></div></div>`:""}
      <div class="callout green" style="margin-top:8px"><div class="row"><div class="ico">‚úÖ</div><div><h4>Do now</h4><ul>${actions.map(x=>`<li>${x}</li>`).join("")}</ul></div></div></div>
      ${notes.length? `<div class="callout" style="margin-top:8px"><div class="row"><div class="ico">üß†</div><div><h4>Notes</h4><ul>${notes.map(x=>`<li>${x}</li>`).join("")}</ul></div></div></div>`:""}
    `;
    plan.innerHTML = html;

    return {best, isEmerg, red, refer, actions, notes, spo2, rr, temp, age, wheeze, crackles, distress, neuro, feed, apnoea};
  }

  $("#run").addEventListener("click", ()=>{
    const state = triage();
    toast("Updated: " + (state.best.v===0 ? "use judgement" : state.best.k), state.isEmerg ? "red" : "blue");
  });

  $("#reset").addEventListener("click", ()=>{
    inputs.spo2.value=""; inputs.rr.value=""; inputs.temp.value="";
    ["wheeze","crackles","distress","neuro","feed","apnoea"].forEach(k=>inputs[k].checked=false);
    updateToggleBadges();
    $("#kpiSpo2").textContent="‚Äî"; $("#kpiRR").textContent="‚Äî"; $("#kpiPath").textContent="‚Äî";
    $("#riskBadge").textContent="Ready"; $("#riskBadge").className="badge green";
    $("#plan").innerHTML = '<p class="sub">Use the builder on the left. The app will output a brief action list tailored to the flags you tick.</p>';
    toast("Reset");
  });

  $("#copy").addEventListener("click", ()=>{
    const state = triage();
    const lines = [];
    if(state.isEmerg) lines.push("EMERGENCY referral now (999/ED).");
    if(state.best.v) lines.push("Likely pathway: " + state.best.k + ".");
    if(state.spo2!=null) lines.push("SpO2: " + state.spo2.toFixed(0) + "%.");
    if(state.rr!=null) lines.push("RR: " + state.rr.toFixed(0) + "/min.");
    if(state.temp!=null) lines.push("Temp: " + state.temp.toFixed(1) + "¬∞C.");
    if(state.red.length) lines.push("Red flags: " + state.red.join(" | "));
    if(state.refer.length) lines.push("Referral prompts: " + state.refer.join(" | "));
    lines.push("Actions: " + state.actions.join(" | "));
    copyText(lines.join(" "));
  });

  // ---------- Rails copy ----------
  $$("#rails .item").forEach(it=>{
    it.addEventListener("click", ()=>copyText(it.dataset.copy));
  });

  // ---------- Rx copy/print ----------
  $("#copyRx").addEventListener("click", ()=>{
    const txt = [
      "CAP: amoxicillin first-line; course 3 days (3m‚Äì11y) or 5 days (1‚Äì2m; ‚â•12y); stop after 5 days unless not stable.",
      "Asthma suspected/known: prednisolone 1‚Äì2 mg/kg OD (max 40 mg) x3 days (1m‚Äì11y) OR 40‚Äì50 mg OD ‚â•5 days (12‚Äì17y).",
      "Severe wheeze: salbutamol neb 2.5 mg (2‚Äì5y) or 5 mg (>5y); repeat q20‚Äì30 min; oxygen target 94‚Äì98% if SpO2<94%."
    ].join(" ");
    copyText(txt);
  });

  $("#print").addEventListener("click", ()=>window.print());

  // Initialize
  setView("triage");
</script>
</body>
</html>
