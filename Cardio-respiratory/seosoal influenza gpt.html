<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Seasonal Influenza ‚Äî Rapid Clinical Guide (Local)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a33;
      --card:#121f3d;
      --card2:#0f1a33;
      --text:#e9eefc;
      --muted:#b9c4e6;
      --muted2:#93a3d6;
      --line:rgba(255,255,255,.10);
      --shadow: 0 14px 45px rgba(0,0,0,.35);
      --shadow2: 0 8px 25px rgba(0,0,0,.25);

      --good:#1fd18a;
      --good2:#103b2a;

      --warn:#ffbf3c;
      --warn2:#3d2f10;

      --bad:#ff4d5a;
      --bad2:#3b1017;

      --info:#58a6ff;
      --info2:#10263d;

      --chip:#1a2a55;
      --focus: 0 0 0 3px rgba(88,166,255,.28);
      --radius: 18px;
      --radius2: 14px;
      --radius3: 12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(900px 600px at 10% 10%, rgba(88,166,255,.18), transparent 55%),
        radial-gradient(900px 600px at 90% 20%, rgba(31,209,138,.14), transparent 60%),
        radial-gradient(900px 700px at 70% 90%, rgba(255,77,90,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      letter-spacing:.2px;
    }

    a{color:var(--info); text-decoration:none}
    a:hover{text-decoration:underline}

    .wrap{
      max-width: 1220px;
      margin: 0 auto;
      padding: 22px 18px 36px;
    }

    /* Header */
    header{
      display:flex;
      gap:16px;
      align-items:flex-start;
      justify-content:space-between;
      padding: 18px 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky;
      top: 12px;
      z-index: 20;
      backdrop-filter: blur(12px);
    }
    .brand{
      display:flex; gap:14px; align-items:flex-start;
      min-width: 320px;
    }
    .logo{
      width:44px; height:44px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(88,166,255,.35), rgba(31,209,138,.20));
      border: 1px solid rgba(255,255,255,.14);
      display:grid; place-items:center;
      box-shadow: var(--shadow2);
      flex: 0 0 auto;
    }
    .logo svg{opacity:.95}
    .title h1{
      font-size: 16.5px;
      margin: 0;
      line-height: 1.25;
      font-weight: 720;
    }
    .title .sub{
      margin-top:6px;
      font-size: 12.5px;
      color: var(--muted);
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 6px 10px;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .pill strong{color:var(--text); font-weight:650}

    .header-actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      max-width: 520px;
    }
    .search{
      position:relative;
      min-width: 270px;
      flex: 1 1 270px;
    }
    .search input{
      width:100%;
      padding: 11px 12px 11px 38px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: var(--text);
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    .search input:focus{box-shadow: var(--focus), inset 0 1px 0 rgba(255,255,255,.04)}
    .search svg{
      position:absolute; left:12px; top:50%;
      transform: translateY(-50%);
      opacity:.8;
    }

    .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      font-weight: 650;
      font-size: 13px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.09)}
    .btn:active{transform: translateY(0)}
    .btn:focus{outline:none; box-shadow: var(--focus)}
    .btn.primary{
      background: rgba(88,166,255,.18);
      border-color: rgba(88,166,255,.34);
    }
    .btn.danger{
      background: rgba(255,77,90,.14);
      border-color: rgba(255,77,90,.30);
    }
    .btn.good{
      background: rgba(31,209,138,.14);
      border-color: rgba(31,209,138,.30);
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 16px;
      margin-top: 16px;
      align-items:start;
    }
    @media (max-width: 1000px){
      header{position:relative; top:auto}
      .grid{grid-template-columns: 1fr}
      .brand{min-width: unset}
      .header-actions{max-width: unset}
      .search{min-width: 200px}
    }

    /* Cards */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      overflow: clip;
    }
    .card .hd{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: rgba(0,0,0,.12);
    }
    .card .hd h2{
      margin:0;
      font-size: 13.5px;
      letter-spacing:.2px;
      font-weight: 760;
      display:flex; align-items:center; gap:10px;
    }
    .card .bd{padding: 14px 16px 16px}

    .muted{color: var(--muted); font-size: 12.8px; line-height: 1.35}
    .mini{font-size: 12px; color: var(--muted2)}
    .mono{font-family: var(--mono)}

    /* Callouts */
    .callout{
      border-radius: var(--radius2);
      padding: 12px 12px;
      border: 1px solid rgba(255,255,255,.12);
      display:flex;
      gap: 10px;
      align-items:flex-start;
      background: rgba(255,255,255,.04);
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .callout:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.16);
    }
    .callout .ic{
      width:34px; height:34px; border-radius: 12px;
      display:grid; place-items:center;
      border: 1px solid rgba(255,255,255,.14);
      flex: 0 0 auto;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .callout .ct{min-width: 0}
    .callout .ct .t{font-weight: 760; font-size: 13px; margin:0}
    .callout .ct .d{margin-top:4px; font-size: 12.5px; color: var(--muted); line-height:1.35}
    .callout.bad{background: rgba(255,77,90,.10); border-color: rgba(255,77,90,.22)}
    .callout.bad .ic{background: rgba(255,77,90,.12); border-color: rgba(255,77,90,.30)}
    .callout.good{background: rgba(31,209,138,.10); border-color: rgba(31,209,138,.22)}
    .callout.good .ic{background: rgba(31,209,138,.12); border-color: rgba(31,209,138,.30)}
    .callout.info{background: rgba(88,166,255,.10); border-color: rgba(88,166,255,.22)}
    .callout.info .ic{background: rgba(88,166,255,.12); border-color: rgba(88,166,255,.30)}
    .callout.warn{background: rgba(255,191,60,.10); border-color: rgba(255,191,60,.22)}
    .callout.warn .ic{background: rgba(255,191,60,.12); border-color: rgba(255,191,60,.30)}

    .stack{display:flex; flex-direction:column; gap:10px}

    /* Tabs */
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding: 10px 10px 0;
    }
    .tab{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      font-weight: 760;
      font-size: 12.5px;
      color: var(--muted);
      display:flex; align-items:center; gap:8px;
      transition: background .12s ease, transform .12s ease, border-color .12s ease;
      user-select:none;
    }
    .tab:hover{transform: translateY(-1px); background: rgba(255,255,255,.08)}
    .tab.active{
      color: var(--text);
      border-color: rgba(88,166,255,.35);
      background: rgba(88,166,255,.14);
    }
    .tabpanel{display:none}
    .tabpanel.active{display:block}

    /* Two-column content blocks */
    .cols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 740px){
      .cols{grid-template-columns: 1fr}
    }

    /* Accordions */
    details{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
      border-radius: var(--radius2);
      overflow: clip;
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      user-select:none;
    }
    summary::-webkit-details-marker{display:none}
    .sumL{
      display:flex; align-items:center; gap:10px;
      font-weight: 780;
      font-size: 13px;
    }
    .chev{transition: transform .14s ease; opacity:.9}
    details[open] .chev{transform: rotate(180deg)}
    .accBody{
      padding: 0 12px 12px;
      color: var(--muted);
      font-size: 12.7px;
      line-height: 1.42;
    }
    .accBody ul{margin: 8px 0 0 18px}
    .accBody li{margin: 6px 0}
    .accBody .hint{margin-top:10px; padding:10px; border-radius: 12px; border:1px dashed rgba(255,255,255,.14); background: rgba(255,255,255,.03)}
    .accBody .hint strong{color:var(--text)}

    /* Chips/badges */
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 12px;
      cursor:pointer;
      transition: background .12s ease, transform .12s ease, border-color .12s ease;
      user-select:none;
    }
    .chip:hover{transform: translateY(-1px); background: rgba(255,255,255,.06)}
    .chip.on{
      color: var(--text);
      border-color: rgba(31,209,138,.34);
      background: rgba(31,209,138,.12);
    }
    .chip.bad{
      border-color: rgba(255,77,90,.26);
      background: rgba(255,77,90,.08);
    }
    .chip.bad.on{
      border-color: rgba(255,77,90,.38);
      background: rgba(255,77,90,.16);
    }

    /* Forms */
    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 740px){ .form{grid-template-columns: 1fr} }

    label{
      display:flex; flex-direction:column; gap:6px;
      font-size: 12px; color: var(--muted);
    }
    input, select{
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    input:focus, select:focus{box-shadow: var(--focus), inset 0 1px 0 rgba(255,255,255,.04)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row .btn{padding: 9px 11px}

    /* Results panel */
    .result{
      margin-top: 12px;
      padding: 12px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    .result .k{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .result .k .left{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      border: 1px solid transparent;
      white-space:nowrap;
    }
    .badge.good{background: rgba(31,209,138,.14); border-color: rgba(31,209,138,.30); color: var(--text)}
    .badge.bad{background: rgba(255,77,90,.14); border-color: rgba(255,77,90,.30); color: var(--text)}
    .badge.warn{background: rgba(255,191,60,.14); border-color: rgba(255,191,60,.30); color: var(--text)}
    .badge.info{background: rgba(88,166,255,.14); border-color: rgba(88,166,255,.30); color: var(--text)}

    .result .t{font-weight: 820; margin:0; font-size: 13.5px}
    .result .d{margin-top:6px; color: var(--muted); font-size: 12.7px; line-height:1.4}
    .result ul{margin: 8px 0 0 18px}
    .result li{margin: 6px 0}

    /* Toast */
    .toast{
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      box-shadow: var(--shadow2);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 999;
      display:flex; align-items:center; gap:10px;
      max-width: min(720px, calc(100% - 24px));
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-2px)}
    .kbd{
      font-family: var(--mono);
      font-size: 11.5px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      padding: 2px 6px;
      border-radius: 8px;
      color: var(--text);
      white-space:nowrap;
    }

    /* Highlight search matches */
    mark{
      background: rgba(255,191,60,.18);
      color: var(--text);
      padding: 0 .12em;
      border-radius: 6px;
    }

    /* Print */
    @media print{
      header{position: static; box-shadow:none}
      body{background:#fff; color:#000}
      .card{box-shadow:none}
      .btn, .search, .toast{display:none !important}
      .wrap{max-width: unset}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <!-- simple inline SVG icon -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M12 2c2.7 2.3 4 4.8 4 7.4 0 1.5-.4 3-1.2 4.3 2.6.2 4.6 2.3 4.6 5a5.3 5.3 0 0 1-5.3 5.3H10A6 6 0 0 1 4 18c0-3.3 2.7-6 6-6h.4C9.5 10.9 9 9.7 9 8.3 9 6.2 10 4 12 2Z" stroke="rgba(233,238,252,.95)" stroke-width="1.6" stroke-linejoin="round"/>
            <path d="M9.2 15.2c.8.1 1.4.4 2 .9.6-.6 1.4-1 2.3-1.1" stroke="rgba(233,238,252,.85)" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="title">
          <h1>Seasonal Influenza ‚Äî Rapid Decision Guide</h1>
          <div class="sub">
            <span class="pill"><strong>Use-case:</strong> fast triage + antiviral/prophylaxis decisions</span>
            <span class="pill"><strong>Scope:</strong> uncomplicated vs complicated + post-exposure prophylaxis</span>
          </div>
        </div>
      </div>

      <div class="header-actions">
        <div class="search" title="Search within this page (highlights matches)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="rgba(233,238,252,.85)" stroke-width="1.8"/>
            <path d="M16.5 16.5 21 21" stroke="rgba(233,238,252,.85)" stroke-width="1.8" stroke-linecap="round"/>
          </svg>
          <input id="searchBox" placeholder="Search e.g. ‚Äòhaemoptysis‚Äô, ‚Äò48 hours‚Äô, ‚Äòzanamivir‚Äô‚Ä¶" />
        </div>

        <button class="btn primary" id="btnQuickStart" title="Jump to decision engine">
          <span aria-hidden="true">‚ö°</span> Decision Engine
        </button>
        <button class="btn good" id="btnCopySummary" title="Copy the current recommendation to clipboard">
          <span aria-hidden="true">üìã</span> Copy Plan
        </button>
        <button class="btn danger" id="btnReset" title="Reset all inputs">
          <span aria-hidden="true">‚Ü∫</span> Reset
        </button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT COLUMN -->
      <section class="card" id="decisionEngine">
        <div class="hd">
          <h2>
            <span aria-hidden="true">üß≠</span>
            Rapid Decision Engine
          </h2>
          <div class="mini">hover cards ‚Ä¢ toggles ‚Ä¢ instant recommendations</div>
        </div>

        <div class="tabs" role="tablist" aria-label="Clinical pathway tabs">
          <div class="tab active" role="tab" aria-selected="true" tabindex="0" data-tab="treat">
            <span aria-hidden="true">üíä</span> Treat symptomatic ILI
          </div>
          <div class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="pep">
            <span aria-hidden="true">üõ°Ô∏è</span> Post-exposure prophylaxis
          </div>
          <div class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="dose">
            <span aria-hidden="true">üßÆ</span> Dosing calculators
          </div>
        </div>

        <!-- Treat tab -->
        <div class="bd tabpanel active" id="tab-treat" role="tabpanel">
          <div class="cols">
            <div class="stack">
              <div class="callout bad" id="redFlagsCard">
                <div class="ic" aria-hidden="true">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2 22 20H2L12 2Z" stroke="rgba(233,238,252,.95)" stroke-width="1.6" stroke-linejoin="round"/>
                    <path d="M12 9v5" stroke="rgba(233,238,252,.95)" stroke-width="1.6" stroke-linecap="round"/>
                    <path d="M12 17h.01" stroke="rgba(233,238,252,.95)" stroke-width="2.6" stroke-linecap="round"/>
                  </svg>
                </div>
                <div class="ct">
                  <p class="t">Red flags / consider admission</p>
                  <div class="d">
                    Any features of complicated/severe influenza or concern for alternative diagnosis ‚Üí <strong>escalate</strong>.
                    <div class="mini" style="margin-top:6px">Click ‚ÄúDetails‚Äù below for the specific triggers.</div>
                  </div>
                </div>
              </div>

              <details>
                <summary>
                  <div class="sumL"><span aria-hidden="true">üö®</span> Red flag triggers (fast scan)</div>
                  <svg class="chev" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M6 9l6 6 6-6" stroke="rgba(233,238,252,.85)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </summary>
                <div class="accBody">
                  <ul>
                    <li><strong>Severe/complicated influenza indicators:</strong> need for hospital admission; lower respiratory tract infection (hypoxaemia, dyspnoea, lung infiltrate); CNS involvement; significant exacerbation of comorbidity.</li>
                    <li><strong>Urgent deterioration signals:</strong> shortness of breath, pleuritic chest pain, haemoptysis (suggest bacterial superinfection/pneumonia).</li>
                    <li><strong>Admission considerations:</strong> complication occurs; co-existing condition conferring high risk of complications (e.g. diabetes‚Äîrisk hyperglycaemia/DKA); alternative diagnosis suspected.</li>
                    <li><strong>Paediatrics:</strong> consider admission <strong>&lt;2 years</strong> if in an at-risk group; or febrile symptoms suggest serious illness.</li>
                  </ul>
                  <div class="hint">
                    <strong>Tip:</strong> If complicated influenza suspected, rapid influenza testing is recommended; <strong>do not delay antivirals while awaiting confirmation</strong>.
                  </div>
                </div>
              </details>

              <div class="callout info">
                <div class="ic" aria-hidden="true">üß™</div>
                <div class="ct">
                  <p class="t">Testing logic (pragmatic)</p>
                  <div class="d">
                    Clinical diagnosis is typical when influenza is circulating. If COVID-19 is a plausible differential and you‚Äôre considering antivirals, arrange PCR to rule it out; point-of-care tests can inform but don‚Äôt replace PCR where indicated.
                  </div>
                </div>
              </div>
            </div>

            <div class="stack">
              <div class="callout good">
                <div class="ic" aria-hidden="true">‚úÖ</div>
                <div class="ct">
                  <p class="t">Treatment decision (the 3 gates)</p>
                  <div class="d">
                    Antivirals for uncomplicated influenza in primary care are generally guided by:
                    <ul>
                      <li><strong>Influenza circulating</strong> (surveillance indicates community circulation)</li>
                      <li><strong>At-risk group</strong> (poorer prognosis)</li>
                      <li><strong>Early start</strong> ‚â§48h from onset (‚â§36h for zanamivir in children)</li>
                    </ul>
                  </div>
                </div>
              </div>

              <details open>
                <summary>
                  <div class="sumL"><span aria-hidden="true">üß©</span> Gate-check inputs</div>
                  <svg class="chev" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M6 9l6 6 6-6" stroke="rgba(233,238,252,.85)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </summary>
                <div class="accBody">
                  <div class="form" id="treatInputs">
                    <label>
                      Influenza circulating locally?
                      <select id="fluCirculating">
                        <option value="unknown" selected>Unknown / not sure</option>
                        <option value="yes">Yes (surveillance indicates circulating)</option>
                        <option value="no">No / not circulating</option>
                      </select>
                    </label>

                    <label>
                      Time since symptom onset
                      <select id="onsetWindow">
                        <option value="lt48" selected>‚â§48 hours</option>
                        <option value="gt48">&gt;48 hours</option>
                      </select>
                    </label>

                    <label>
                      Possible COVID-19 differential?
                      <select id="covidPossible">
                        <option value="no" selected>No / unlikely</option>
                        <option value="yes">Yes / plausible</option>
                      </select>
                    </label>

                    <label>
                      Complicated/severe features now?
                      <select id="complicatedNow">
                        <option value="no" selected>No</option>
                        <option value="yes">Yes (or admission likely)</option>
                      </select>
                    </label>
                  </div>

                  <div style="margin-top:12px">
                    <div class="mini" style="margin-bottom:8px">
                      Toggle ‚Äúat-risk‚Äù factors (auto-updates recommendation):
                    </div>
                    <div class="chips" id="riskChips"></div>
                    <div class="row" style="margin-top:10px">
                      <button class="btn good" id="btnSelectCommonRisks" title="Select the most common UK risk groups quickly">Common risks</button>
                      <button class="btn" id="btnClearRisks">Clear risks</button>
                    </div>
                  </div>

                  <div class="result" id="treatResult" aria-live="polite"></div>
                </div>
              </details>
            </div>
          </div>

          <details style="margin-top:12px">
            <summary>
              <div class="sumL"><span aria-hidden="true">üßª</span> Symptomatic advice & safety net</div>
              <svg class="chev" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6 9l6 6 6-6" stroke="rgba(233,238,252,.85)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </summary>
            <div class="accBody">
              <div class="cols">
                <div class="callout good">
                  <div class="ic" aria-hidden="true">üåø</div>
                  <div class="ct">
                    <p class="t">Self-care (default)</p>
                    <div class="d">
                      Fluids; paracetamol/ibuprofen for symptom relief; rest. Usually ~1 week off work/school. Fever/systemic symptoms typically resolve ~1 week; cough/fatigue may persist up to ~2 weeks after fever resolves.
                    </div>
                  </div>
                </div>
                <div class="callout bad">
                  <div class="ic" aria-hidden="true">üìû</div>
                  <div class="ct">
                    <p class="t">Safety-net (make it explicit)</p>
                    <div class="d">
                      Seek urgent review if <strong>SOB</strong>, <strong>pleuritic chest pain</strong>, or <strong>haemoptysis</strong>. Arrange review if no improvement after ~1 week or deterioration. Lower threshold in babies/young children.
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </details>
        </div>

        <!-- PEP tab -->
        <div class="bd tabpanel" id="tab-pep" role="tabpanel">
          <div class="cols">
            <div class="stack">
              <div class="callout info">
                <div class="ic" aria-hidden="true">üßØ</div>
                <div class="ct">
                  <p class="t">Post-exposure prophylaxis: when it matters</p>
                  <div class="d">
                    Generally <strong>not</strong> considered for vaccinated at-risk contacts if vaccinated ‚â•14 days pre-exposure. PEP is considered when influenza is circulating and there is close exposure (household/residential setting), and the contact is at risk and not adequately protected by vaccination.
                  </div>
                </div>
              </div>

              <details open>
                <summary>
                  <div class="sumL"><span aria-hidden="true">üõ°Ô∏è</span> PEP gate-check inputs</div>
                  <svg class="chev" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M6 9l6 6 6-6" stroke="rgba(233,238,252,.85)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </summary>
                <div class="accBody">
                  <div class="form" id="pepInputs">
                    <label>
                      Influenza circulating locally?
                      <select id="pepCirculating">
                        <option value="unknown" selected>Unknown / not sure</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                      </select>
                    </label>

                    <label>
                      Exposure setting
                      <select id="pepExposure">
                        <option value="household" selected>Household / residential setting</option>
                        <option value="outbreak">Localised outbreak (e.g. care home)</option>
                        <option value="other">Other / low-risk contact</option>
                      </select>
                    </label>

                    <label>
                      Time since exposure
                      <select id="pepWindow">
                        <option value="lt48" selected>‚â§48h (oseltamivir window)</option>
                        <option value="gt48">&gt;48h</option>
                      </select>
                    </label>

                    <label>
                      Zanamivir-specific: ‚â§36h since exposure?
                      <select id="pepZana36">
                        <option value="yes" selected>Yes / within 36h</option>
                        <option value="no">No / beyond 36h</option>
                      </select>
                    </label>

                    <label>
                      At-risk contact?
                      <select id="pepAtRisk">
                        <option value="yes" selected>Yes</option>
                        <option value="no">No</option>
                      </select>
                    </label>

                    <label>
                      Adequately protected by vaccination?
                      <select id="pepVaccinated">
                        <option value="no" selected>No / not adequately protected</option>
                        <option value="yes">Yes (vaccinated ‚â•14 days pre-exposure, well-matched)</option>
                        <option value="uncertain">Uncertain / mismatch / &lt;14 days</option>
                      </select>
                    </label>

                    <label>
                      Severely immunosuppressed?
                      <select id="pepSevereImm">
                        <option value="no" selected>No</option>
                        <option value="yes">Yes</option>
                      </select>
                    </label>

                    <label>
                      Child under 5 years?
                      <select id="pepUnder5">
                        <option value="no" selected>No</option>
                        <option value="yes">Yes</option>
                      </select>
                    </label>

                    <label>
                      Suspected/confirmed oseltamivir resistance exposure?
                      <select id="pepOselRes">
                        <option value="no" selected>No / not suspected</option>
                        <option value="yes">Yes</option>
                      </select>
                    </label>
                  </div>

                  <div class="result" id="pepResult" aria-live="polite"></div>
                </div>
              </details>
            </div>

            <div class="stack">
              <div class="callout warn">
                <div class="ic" aria-hidden="true">üß¨</div>
                <div class="ct">
                  <p class="t">Immunosuppressed contacts: sampling first</p>
                  <div class="d">
                    If giving prophylaxis to immunosuppressed contacts of a confirmed case, obtain diagnostic sampling for influenza detection prior to antiviral use; if infected, commence <strong>treatment-dose</strong> antivirals.
                  </div>
                </div>
              </div>

              <details>
                <summary>
                  <div class="sumL"><span aria-hidden="true">üßæ</span> PEP regimen overview (10 days)</div>
                  <svg class="chev" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M6 9l6 6 6-6" stroke="rgba(233,238,252,.85)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </summary>
                <div class="accBody">
                  <ul>
                    <li>PEP: <strong>oseltamivir once daily for 10 days</strong> or <strong>zanamivir once daily for 10 days</strong> (as appropriate).</li>
                    <li>Localised outbreak exposures may warrant consideration regardless of vaccination status.</li>
                    <li>Vaccination: arrange influenza immunisation if not already done this season; note vaccine efficacy may be reduced if administered within 2 weeks of antiviral use.</li>
                  </ul>
                </div>
              </details>
            </div>
          </div>
        </div>

        <!-- Dosing tab -->
        <div class="bd tabpanel" id="tab-dose" role="tabpanel">
          <div class="cols">
            <div class="stack">
              <div class="callout good">
                <div class="ic" aria-hidden="true">üßÆ</div>
                <div class="ct">
                  <p class="t">Oseltamivir calculator (treatment vs PEP)</p>
                  <div class="d">Adult/paediatric/renal dosing shortcuts with clear outputs.</div>
                </div>
              </div>

              <div class="card" style="background: rgba(0,0,0,.10); border-color: rgba(255,255,255,.12)">
                <div class="bd">
                  <div class="form">
                    <label>
                      Indication
                      <select id="oseInd">
                        <option value="treat" selected>Treatment (5 days)</option>
                        <option value="pep">PEP (10 days)</option>
                      </select>
                    </label>

                    <label>
                      Age band
                      <select id="oseAge">
                        <option value="adult13" selected>‚â•13 years</option>
                        <option value="child1to12">1‚Äì12 years</option>
                        <option value="infantlt1">&lt;1 year</option>
                        <option value="preterm">Preterm (&lt;36 weeks post-conceptual age)</option>
                      </select>
                    </label>

                    <label>
                      Weight (kg) ‚Äî for 1‚Äì12y / baloxavir logic only
                      <input id="oseWt" type="number" min="0" step="0.1" placeholder="e.g. 18" />
                    </label>

                    <label>
                      Adult/teen renal function (CrCl mL/min)
                      <input id="oseCrcl" type="number" min="0" step="1" placeholder="optional (13‚Äì17/Adult)" />
                    </label>

                    <label>
                      Immunosuppressed (‚â•13y treatment course differs)
                      <select id="oseImm">
                        <option value="no" selected>No</option>
                        <option value="yes">Yes</option>
                      </select>
                    </label>

                    <label>
                      Adult weight ‚â§41 kg? (‚â•13y only)
                      <select id="oseAdultWt41">
                        <option value="no" selected>No / ‚â•41 kg</option>
                        <option value="yes">Yes / &lt;=41 kg</option>
                      </select>
                    </label>
                  </div>

                  <div class="result" id="oseOut"></div>
                </div>
              </div>

              <div class="callout warn">
                <div class="ic" aria-hidden="true">‚ö†Ô∏è</div>
                <div class="ct">
                  <p class="t">Key caveat</p>
                  <div class="d">
                    Preterm prophylaxis dosing is not publicly available (outside product licence). Preterm treatment dose may be used as unlicensed, evidence/expert-opinion based.
                  </div>
                </div>
              </div>
            </div>

            <div class="stack">
              <div class="callout info">
                <div class="ic" aria-hidden="true">üí®</div>
                <div class="ct">
                  <p class="t">Zanamivir (inhaled) ‚Äî quick dosing & cautions</p>
                  <div class="d">
                    Treatment: <strong>10 mg twice daily √ó 5 days</strong>. PEP: <strong>10 mg once daily √ó 10 days</strong>. Not licensed &lt;5 years. Avoid in milk protein allergy; caution asthma/COPD (bronchospasm risk).
                  </div>
                </div>
              </div>

              <div class="callout warn">
                <div class="ic" aria-hidden="true">üß™</div>
                <div class="ct">
                  <p class="t">Baloxavir marboxil ‚Äî single-dose (weight-based)</p>
                  <div class="d">
                    Adults: &lt;20 kg: 2 mg/kg once; 20‚Äì79 kg: 40 mg once; ‚â•80 kg: 80 mg once.
                    (12‚Äì17y: 40 mg up to 79 kg; 80 mg if ‚â•80 kg). Not recommended in pregnancy due to insufficient data; avoid polyvalent cations co-administration.
                  </div>
                </div>
              </div>

              <details>
                <summary>
                  <div class="sumL"><span aria-hidden="true">üß∑</span> Oseltamivir adverse effects & interactions</div>
                  <svg class="chev" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M6 9l6 6 6-6" stroke="rgba(233,238,252,.85)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </summary>
                <div class="accBody">
                  <ul>
                    <li>Common: abdominal pain, headache, nausea/vomiting, dizziness/vertigo.</li>
                    <li>Rare: neuropsychiatric effects, hepatic disorders, haemorrhage.</li>
                    <li>Interactions noted: leflunomide/teriflunomide, tolvaptan (‚Üë active metabolite), warfarin (isolated ‚ÜëINR reports).</li>
                    <li>Renal impairment: dose adjustment may be needed.</li>
                  </ul>
                </div>
              </details>

              <details>
                <summary>
                  <div class="sumL"><span aria-hidden="true">üß†</span> ‚ÄúWhich antiviral?‚Äù quick rule</div>
                  <svg class="chev" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M6 9l6 6 6-6" stroke="rgba(233,238,252,.85)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </summary>
                <div class="accBody">
                  <ul>
                    <li>Previously healthy uncomplicated: usually <strong>no antiviral</strong> unless serious risk of complications ‚Üí consider oseltamivir early.</li>
                    <li>At-risk (incl. pregnancy), not severely immunosuppressed: <strong>oseltamivir</strong>; don‚Äôt wait for lab confirmation.</li>
                    <li>Severely immunosuppressed: consider strain resistance risk; if higher oseltamivir resistance risk (e.g. A[H1N1]) ‚Üí <strong>zanamivir</strong> or oseltamivir + follow-up if unsuitable.</li>
                  </ul>
                </div>
              </details>

              <div class="result" id="doseMiniOut"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT COLUMN -->
      <aside class="card" id="quickReference">
        <div class="hd">
          <h2><span aria-hidden="true">üìå</span> Quick Reference</h2>
          <div class="mini">one-glance anchors</div>
        </div>
        <div class="bd">
          <div class="stack">
            <div class="callout bad">
              <div class="ic" aria-hidden="true">‚õî</div>
              <div class="ct">
                <p class="t">Immediate actions</p>
                <div class="d">
                  If complicated/severe features: escalate, consider admission, test rapidly (where indicated), and <strong>do not delay antivirals</strong> awaiting confirmation.
                </div>
              </div>
            </div>

            <div class="callout good">
              <div class="ic" aria-hidden="true">üü©</div>
              <div class="ct">
                <p class="t">Treat uncomplicated influenza (primary care)</p>
                <div class="d">
                  When influenza is circulating: prescribe oseltamivir/zanamivir if at-risk and able to start ‚â§48h (zanamivir in children ‚â§36h). Late start is off-label ‚Üí use judgement.
                </div>
              </div>
            </div>

            <div class="callout info">
              <div class="ic" aria-hidden="true">üü¶</div>
              <div class="ct">
                <p class="t">PEP (post-exposure) in at-risk contacts</p>
                <div class="d">
                  Consider if circulating + household/residential exposure + not adequately vaccine-protected; aim ‚â§48h (oseltamivir) or ‚â§36h (zanamivir). Outbreak settings may justify regardless of vaccination.
                </div>
              </div>
            </div>

            <details>
              <summary>
                <div class="sumL"><span aria-hidden="true">üßæ</span> At-risk groups (click to expand)</div>
                <svg class="chev" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 9l6 6 6-6" stroke="rgba(233,238,252,.85)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </summary>
              <div class="accBody">
                <ul>
                  <li>Age &gt;65</li>
                  <li>Child &lt;6 months</li>
                  <li>Pregnancy (any stage) and up to 2 weeks postpartum</li>
                  <li>Asplenia/splenic dysfunction</li>
                  <li>Chronic respiratory disease (incl. asthma needing regular/repeated steroids or prior admission)</li>
                  <li>Chronic heart, kidney (CKD 3‚Äì5/transplant), liver disease</li>
                  <li>Chronic neurological conditions (incl. stroke/TIA; respiratory compromise; severe neurodisability)</li>
                  <li>Diabetes mellitus (type 1 or 2)</li>
                  <li>Immunosuppression (chemo/radio; transplant; GVHD; HIV severe; systemic steroids ‚â•1 month at pred 20 mg/day equiv; other highly immunosuppressive therapy; myeloma; genetic immune disorders)</li>
                  <li>Morbid obesity (BMI ‚â•40)</li>
                </ul>
              </div>
            </details>

            <details>
              <summary>
                <div class="sumL"><span aria-hidden="true">üß≠</span> Differential reminders</div>
                <svg class="chev" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 9l6 6 6-6" stroke="rgba(233,238,252,.85)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </summary>
              <div class="accBody">
                Consider: sepsis; common cold; COVID-19; RSV; parainfluenza; bacterial pneumonia/bronchitis; streptococcal pharyngitis; meningitis; pertussis; malaria (travel).
              </div>
            </details>

            <div class="result" id="planPreview" aria-live="polite"></div>

            <div class="mini">
              Keyboard: <span class="kbd">/</span> focus search ‚Ä¢ <span class="kbd">Esc</span> clear search ‚Ä¢ <span class="kbd">Ctrl</span>+<span class="kbd">K</span> jump to engine
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    // -------------------------
    // Data (from uploaded NICE CKS content)
    // -------------------------
    const riskFactors = [
      { id:"age65", label:"Age >65", group:"Core", common:true },
      { id:"infantlt6m", label:"Child <6 months", group:"Core", common:false },
      { id:"preg", label:"Pregnancy / ‚â§2w postpartum", group:"Core", common:true },

      { id:"asplenia", label:"Asplenia/splenic dysfunction", group:"Comorbidity", common:false },
      { id:"resp", label:"Chronic respiratory disease (incl asthma on steroids/previous admission)", group:"Comorbidity", common:true },
      { id:"heart", label:"Chronic heart disease", group:"Comorbidity", common:true },
      { id:"kidney", label:"CKD stage 3‚Äì5 / transplant / nephrotic syndrome", group:"Comorbidity", common:true },
      { id:"liver", label:"Chronic liver disease", group:"Comorbidity", common:false },
      { id:"neuro", label:"Chronic neurological condition / severe neurodisability", group:"Comorbidity", common:false },
      { id:"dm", label:"Diabetes mellitus", group:"Comorbidity", common:true },
      { id:"imm", label:"Immunosuppression (disease/treatment)", group:"Immunity", common:true, bad:true },
      { id:"bmi40", label:"Morbid obesity (BMI ‚â•40)", group:"Core", common:true },
    ];

    // -------------------------
    // Helpers
    // -------------------------
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    function toast(msg){
      const t = $("#toast");
      t.innerHTML = msg;
      t.classList.add("show");
      window.clearTimeout(toast._tm);
      toast._tm = window.setTimeout(()=> t.classList.remove("show"), 1800);
    }

    function clampNumber(x){
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }

    function setActiveTab(tabId){
      $$(".tab").forEach(t=>{
        const on = t.dataset.tab === tabId;
        t.classList.toggle("active", on);
        t.setAttribute("aria-selected", on ? "true":"false");
        t.tabIndex = on ? 0 : -1;
      });
      $$(".tabpanel").forEach(p=> p.classList.toggle("active", p.id === "tab-" + tabId));
      updatePlanPreview();
    }

    // -------------------------
    // Risk chip rendering
    // -------------------------
    const riskChipsEl = $("#riskChips");
    const selectedRisks = new Set();

    function renderRiskChips(){
      riskChipsEl.innerHTML = "";
      riskFactors.forEach(r=>{
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "chip" + (r.bad ? " bad":"");
        chip.dataset.id = r.id;
        chip.innerHTML = `${r.bad ? "üß®" : "üè∑Ô∏è"} <span>${r.label}</span>`;
        chip.addEventListener("click", ()=>{
          if(selectedRisks.has(r.id)) selectedRisks.delete(r.id);
          else selectedRisks.add(r.id);
          syncRiskChips();
          computeTreat();
          updatePlanPreview();
        });
        riskChipsEl.appendChild(chip);
      });
      syncRiskChips();
    }

    function syncRiskChips(){
      $$(".chip", riskChipsEl).forEach(c=>{
        c.classList.toggle("on", selectedRisks.has(c.dataset.id));
      });
    }

    function selectCommonRisks(){
      selectedRisks.clear();
      riskFactors.filter(r=>r.common).forEach(r=> selectedRisks.add(r.id));
      syncRiskChips();
      computeTreat();
      updatePlanPreview();
      toast("Selected common risk factors.");
    }

    function clearRisks(){
      selectedRisks.clear();
      syncRiskChips();
      computeTreat();
      updatePlanPreview();
      toast("Cleared risk factors.");
    }

    // -------------------------
    // Treatment recommendation
    // -------------------------
    function computeTreat(){
      const circulating = $("#fluCirculating").value;     // yes/no/unknown
      const onset = $("#onsetWindow").value;              // lt48/gt48
      const covid = $("#covidPossible").value;            // yes/no
      const complicated = $("#complicatedNow").value;     // yes/no

      const atRisk = selectedRisks.size > 0;

      // Compose guidance (high-yield)
      const out = $("#treatResult");

      const blocks = [];
      let badge = { cls:"info", text:"Needs clinical context" };
      let title = "Decision pending ‚Äî complete gates";
      let rec = [];
      let safety = [];

      // Red flag override
      if(complicated === "yes"){
        badge = { cls:"bad", text:"Red flag / escalate" };
        title = "Complicated/severe features ‚Üí escalate & consider admission";
        rec.push("Assess for lower respiratory tract involvement (hypoxaemia/dyspnoea/infiltrate), CNS involvement, or significant comorbidity exacerbation.");
        rec.push("If influenza suspected, do not delay antivirals awaiting confirmation.");
        safety.push("If alternative diagnosis suspected (e.g. sepsis), manage accordingly.");
      } else {
        // Standard triage
        if(circulating === "no"){
          badge = { cls:"warn", text:"Influenza not circulating" };
          title = "Antivirals usually not indicated if influenza not circulating";
          rec.push("Reassess diagnosis; consider other causes of influenza-like illness.");
          if(atRisk) rec.push("If high clinical probability despite surveillance, use judgement / specialist advice as appropriate.");
        } else if(circulating === "unknown"){
          badge = { cls:"info", text:"Circulation unknown" };
          title = "Check local surveillance; if high probability, treat promptly";
          rec.push("If point-of-care testing is unavailable and influenza is highly probable (e.g. close contact with confirmed case), start antiviral without awaiting PCR results.");
        } else {
          // circulating yes
          if(atRisk && onset === "lt48"){
            badge = { cls:"good", text:"Recommend antiviral" };
            title = "Start antiviral (at-risk + circulating + early window)";
            rec.push("First-line in at-risk (incl. pregnancy) generally: oral oseltamivir; do not wait for lab confirmation.");
            if(selectedRisks.has("imm")) rec.push("If severely immunosuppressed, consider strain resistance risk; zanamivir may be preferred when higher oseltamivir resistance risk is suspected.");
          } else if(atRisk && onset === "gt48"){
            badge = { cls:"warn", text:"Late window" };
            title = "At-risk but >48h from onset ‚Äî late start is off-label";
            rec.push("Consider severity, trajectory, and risk profile; clinical judgement required (late initiation is off-label).");
          } else if(!atRisk && onset === "lt48"){
            badge = { cls:"info", text:"Usually no antiviral" };
            title = "Previously healthy uncomplicated ‚Äî usually supportive care";
            rec.push("Consider oseltamivir only if the person is not ‚Äòat risk‚Äô but is at serious risk of complications, and can start within 48h.");
          } else {
            badge = { cls:"info", text:"Supportive care" };
            title = "Uncomplicated influenza ‚Äî supportive management + safety net";
            rec.push("Fluids; antipyretics/analgesia; rest; time off work/school as needed.");
          }
        }
      }

      // Testing callout
      if(covid === "yes"){
        safety.push("If COVID-19 is a plausible differential and antivirals are being considered, arrange PCR to rule it out (POCT may inform but does not replace PCR where indicated).");
      }

      // universal safety net (brief)
      safety.push("Safety-net: urgent review for SOB, pleuritic chest pain, or haemoptysis; review if no improvement after ~1 week or deterioration; lower threshold in babies/young children.");

      const riskLine = atRisk
        ? `At-risk selected: <strong>${selectedRisks.size}</strong> factor(s).`
        : `No at-risk factors selected.`;

      out.innerHTML = `
        <div class="k">
          <div class="left">
            <span class="badge ${badge.cls}">${badge.text}</span>
            <p class="t">${title}</p>
          </div>
          <button class="btn" id="btnCopyTreatMini" title="Copy this plan">Copy</button>
        </div>
        <div class="d">
          <div class="mini" style="margin-top:6px">${riskLine}</div>
          <ul>${rec.map(x=>`<li>${x}</li>`).join("")}</ul>
          <div style="margin-top:10px" class="mini"><strong>Safety / testing</strong></div>
          <ul>${safety.map(x=>`<li>${x}</li>`).join("")}</ul>
        </div>
      `;

      $("#btnCopyTreatMini").addEventListener("click", ()=>{
        const txt = buildPlanText();
        copyToClipboard(txt);
      });

      updatePlanPreview();
    }

    // -------------------------
    // PEP recommendation
    // -------------------------
    function computePEP(){
      const circulating = $("#pepCirculating").value;   // yes/no/unknown
      const exposure = $("#pepExposure").value;         // household/outbreak/other
      const window48 = $("#pepWindow").value;           // lt48/gt48
      const z36 = $("#pepZana36").value;                // yes/no
      const atRisk = $("#pepAtRisk").value;             // yes/no
      const vaccinated = $("#pepVaccinated").value;     // yes/no/uncertain
      const severeImm = $("#pepSevereImm").value;       // yes/no
      const under5 = $("#pepUnder5").value;             // yes/no
      const oselRes = $("#pepOselRes").value;           // yes/no

      const out = $("#pepResult");

      let badge = { cls:"info", text:"Context-dependent" };
      let title = "PEP decision pending";
      const rec = [];
      const notes = [];

      // Basic eligibility framing
      if(exposure === "other"){
        badge = { cls:"info", text:"Low-yield exposure" };
        title = "PEP usually not indicated for low-risk contact";
        rec.push("PEP is typically considered for household/residential exposures; use judgement for others.");
      }

      // Circulation gate (except outbreaks sometimes)
      const circulationGate = (circulating === "yes") || (exposure === "outbreak");
      if(!circulationGate){
        if(circulating === "no"){
          badge = { cls:"warn", text:"Not circulating" };
          title = "If influenza is not circulating, PEP usually not indicated";
        } else {
          badge = { cls:"info", text:"Check surveillance" };
          title = "Confirm if influenza is circulating (unless outbreak context)";
        }
        rec.push("If outbreak in a closed setting, PEP can be considered regardless of vaccination status.");
      }

      // At-risk gate
      if(atRisk === "no"){
        badge = { cls:"info", text:"Not at-risk" };
        title = "PEP usually reserved for at-risk contacts";
      }

      // Vaccine protection gate (except outbreaks)
      if(exposure !== "outbreak" && vaccinated === "yes"){
        badge = { cls:"info", text:"Vaccinated" };
        title = "PEP normally not considered if adequately protected by vaccination";
        rec.push("If ‚â•14 days since vaccination and well matched, PEP is usually not required.");
      } else if(vaccinated === "uncertain"){
        notes.push("Not adequately protected includes: not vaccinated since previous season; mismatch; or <14 days since vaccination at time of contact.");
      }

      // Timing gate
      if(window48 === "gt48"){
        badge = { cls:"warn", text:"Late window" };
        title = "PEP beyond 48h (oseltamivir) is off-label ‚Üí specialist advice";
        rec.push("Late PEP should be initiated on specialist advice only.");
      }

      // Now synthesize "recommend PEP" if gates met
      const likelyEligible =
        circulationGate &&
        (exposure === "household" || exposure === "outbreak") &&
        (atRisk === "yes") &&
        (vaccinated !== "yes") &&
        (window48 === "lt48");

      if(likelyEligible){
        badge = { cls:"good", text:"Recommend PEP" };
        title = "Start PEP (aim early)";

        // regimen selection
        if(oselRes === "yes"){
          rec.push("If exposed to suspected/confirmed oseltamivir-resistant influenza: use inhaled zanamivir daily √ó 10 days (if suitable); otherwise seek specialist advice.");
        } else {
          if(severeImm === "yes"){
            rec.push("Severely immunosuppressed (adults & children ‚â•5y): oseltamivir once daily √ó 10 days when lower resistance risk; consider zanamivir where higher resistance risk is suspected, or if oseltamivir unsuitable.");
          } else if(under5 === "yes"){
            rec.push("Children <5y in at-risk groups: oseltamivir once daily √ó 10 days (seek specialist advice if resistant exposure suspected).");
          } else {
            rec.push("PEP regimen: oseltamivir once daily √ó 10 days (or zanamivir once daily √ó 10 days where appropriate).");
          }
        }

        // zanamivir timing nuance
        if(z36 === "no"){
          notes.push("Zanamivir exposure window is 36 hours; beyond this is off-label and should be specialist-led.");
        }

        // immunosuppressed sampling note
        if(severeImm === "yes"){
          notes.push("If immunosuppressed contact of a confirmed case: obtain diagnostic sampling prior to antiviral; if infected, switch to treatment-dose course.");
        }

        notes.push("Arrange influenza immunisation if not already done this season (vaccine efficacy may be reduced if given within 2 weeks of antiviral use).");
        notes.push("Counsel that prophylaxis is not completely effective; provide symptomatic advice and safety-net if influenza develops.");
      }

      // Render
      out.innerHTML = `
        <div class="k">
          <div class="left">
            <span class="badge ${badge.cls}">${badge.text}</span>
            <p class="t">${title}</p>
          </div>
          <button class="btn" id="btnCopyPepMini" title="Copy this plan">Copy</button>
        </div>
        <div class="d">
          ${rec.length ? `<ul>${rec.map(x=>`<li>${x}</li>`).join("")}</ul>` : `<div class="mini">Adjust inputs above to generate a recommendation.</div>`}
          ${notes.length ? `<div style="margin-top:10px" class="mini"><strong>Notes</strong></div><ul>${notes.map(x=>`<li>${x}</li>`).join("")}</ul>` : ``}
        </div>
      `;

      $("#btnCopyPepMini").addEventListener("click", ()=>{
        const txt = buildPlanText();
        copyToClipboard(txt);
      });

      updatePlanPreview();
    }

    // -------------------------
    // Oseltamivir calculator (table logic)
    // -------------------------
    function computeOseltamivir(){
      const ind = $("#oseInd").value;         // treat/pep
      const age = $("#oseAge").value;         // adult13/child1to12/infantlt1/preterm
      const wt = clampNumber($("#oseWt").value);
      const crcl = clampNumber($("#oseCrcl").value);
      const imm = $("#oseImm").value;         // yes/no
      const adultWt41 = $("#oseAdultWt41").value;

      let badge = { cls:"info", text:"Dose" };
      let title = "Oseltamivir dosing";
      const lines = [];
      const notes = [];

      function setDose(d){
        lines.push(`<strong>${d}</strong>`);
      }

      if(age === "adult13"){
        // renal overrides if provided
        const treatDays = (imm === "yes" && ind === "treat") ? 10 : (ind === "treat" ? 5 : 10);

        // base adult/teen by weight
        let baseTreat = (adultWt41 === "yes") ? "60 mg twice daily" : "75 mg twice daily";
        let basePep   = (adultWt41 === "yes") ? "60 mg once daily"  : "75 mg once daily";

        // renal adjustment for adults and 13‚Äì17y
        if(crcl !== null){
          if(crcl > 60){
            // no change
          } else if(crcl >= 30 && crcl <= 60){
            baseTreat = "30 mg twice daily";
            basePep = "30 mg once daily";
          } else if(crcl >= 11 && crcl <= 30){
            baseTreat = "30 mg once daily";
            basePep = "30 mg once every second day";
          } else if(crcl <= 10){
            baseTreat = "30 mg ONCE";
            basePep = "30 mg ONCE, repeat after 7 days";
          }
          notes.push("Renal impairment dosing applies to adults and children aged 13‚Äì17 years.");
        }

        if(ind === "treat"){
          setDose(`${baseTreat} √ó ${treatDays} days`);
          if(imm === "yes") notes.push("Immunosuppressed ‚â•13y: treatment course is 10 days.");
        } else {
          setDose(`${basePep} √ó 10 days`);
        }

        notes.push("Use caution in renal impairment; dose adjustment may be necessary.");
      }

      if(age === "child1to12"){
        if(wt === null || wt <= 0){
          badge = { cls:"warn", text:"Need weight" };
          title = "Enter weight to calculate paediatric dose";
        } else {
          let treat, pep;
          if(wt <= 15){ treat="30 mg twice daily"; pep="30 mg once daily"; }
          else if(wt > 15 && wt <= 23){ treat="45 mg twice daily"; pep="45 mg once daily"; }
          else if(wt > 23 && wt <= 40){ treat="60 mg twice daily"; pep="60 mg once daily"; }
          else { treat="75 mg twice daily"; pep="75 mg once daily"; }

          if(ind === "treat") setDose(`${treat} √ó 5 days`);
          else setDose(`${pep} √ó 10 days`);

          notes.push("Dose for children 1‚Äì12 years is weight-based.");
        }
      }

      if(age === "infantlt1"){
        if(ind === "treat") setDose(`3 mg/kg twice daily √ó 5 days`);
        else setDose(`3 mg/kg once daily √ó 10 days`);
        notes.push("Infants <1y: 3 mg/kg dosing.");
      }

      if(age === "preterm"){
        // treatment listed; prophylaxis not publicly available in the source
        if(ind === "treat"){
          setDose(`1 mg/kg twice daily √ó 5 days <span class="mini">(unlicensed; evidence/expert-opinion based)</span>`);
        } else {
          badge = { cls:"warn", text:"No public PEP dose" };
          title = "Preterm prophylaxis dosing is not publicly available";
          lines.push("Seek specialist advice (outside product licence).");
        }
      }

      $("#oseOut").innerHTML = `
        <div class="k">
          <div class="left">
            <span class="badge ${badge.cls}">${badge.text}</span>
            <p class="t">${title}</p>
          </div>
          <button class="btn" id="btnCopyDoseMini" title="Copy dose">Copy</button>
        </div>
        <div class="d">
          ${lines.length ? `<ul>${lines.map(x=>`<li>${x}</li>`).join("")}</ul>` : `<div class="mini">Enter inputs to generate a dose.</div>`}
          ${notes.length ? `<div style="margin-top:10px" class="mini"><strong>Notes</strong></div><ul>${notes.map(x=>`<li>${x}</li>`).join("")}</ul>` : ``}
        </div>
      `;

      $("#btnCopyDoseMini").addEventListener("click", ()=>{
        const txt = stripHtml($("#oseOut").innerHTML);
        copyToClipboard("Oseltamivir: " + txt);
      });

      // Provide a tiny ‚Äúwhat to do next‚Äù box
      $("#doseMiniOut").innerHTML = `
        <div class="k">
          <div class="left">
            <span class="badge info">Workflow</span>
            <p class="t">Use the dosing output alongside the decision engine</p>
          </div>
        </div>
        <div class="d">
          <ul>
            <li>Confirm indication: treatment vs PEP.</li>
            <li>Apply eligibility (circulation + risk + timing).</li>
            <li>Document safety-net + follow-up threshold (especially high-risk).</li>
          </ul>
        </div>
      `;

      updatePlanPreview();
    }

    function stripHtml(html){
      const tmp = document.createElement("div");
      tmp.innerHTML = html.replace(/<button[^>]*>.*?<\/button>/g,"");
      return tmp.textContent.replace(/\s+/g," ").trim();
    }

    // -------------------------
    // Plan preview + copy
    // -------------------------
    function buildPlanText(){
      const tab = $$(".tab").find(t=>t.classList.contains("active"))?.dataset.tab || "treat";
      let txt = "Seasonal Influenza ‚Äî Plan\n";

      // treat summary
      const treatSummary = stripHtml($("#treatResult").innerHTML);
      const pepSummary = stripHtml($("#pepResult").innerHTML);
      const oseSummary = stripHtml($("#oseOut").innerHTML);

      if(tab === "treat"){
        txt += "\n[Treatment decision]\n" + (treatSummary || "‚Äî") + "\n";
      } else if(tab === "pep"){
        txt += "\n[Post-exposure prophylaxis]\n" + (pepSummary || "‚Äî") + "\n";
      } else {
        txt += "\n[Dosing]\n" + (oseSummary || "‚Äî") + "\n";
      }

      // add key inputs snapshot
      txt += "\n[Inputs snapshot]\n";
      txt += `Influenza circulating: ${$("#fluCirculating").value}\n`;
      txt += `Onset window: ${$("#onsetWindow").value}\n`;
      txt += `COVID possible: ${$("#covidPossible").value}\n`;
      txt += `Complicated now: ${$("#complicatedNow").value}\n`;
      txt += `At-risk selected: ${selectedRisks.size ? Array.from(selectedRisks).join(", ") : "none"}\n`;

      // add dosing snapshot
      txt += "\n[Oseltamivir calculator]\n";
      txt += `Indication: ${$("#oseInd").value}, Age band: ${$("#oseAge").value}, Weight: ${$("#oseWt").value||"‚Äî"} kg, CrCl: ${$("#oseCrcl").value||"‚Äî"}\n`;

      return txt.trim();
    }

    function updatePlanPreview(){
      const p = $("#planPreview");
      const txt = buildPlanText();
      p.innerHTML = `
        <div class="k">
          <div class="left">
            <span class="badge info">Plan</span>
            <p class="t">Live plan preview (copy-ready)</p>
          </div>
        </div>
        <div class="d"><span class="mono">${escapeHtml(txt).replace(/\n/g,"<br>")}</span></div>
      `;
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        toast("Copied to clipboard.");
      } catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        toast("Copied to clipboard (fallback).");
      }
    }

    // -------------------------
    // Search highlighting (in-page)
    // -------------------------
    const searchableRoots = ["#decisionEngine", "#quickReference"];

    function clearHighlights(){
      searchableRoots.forEach(sel=>{
        const root = $(sel);
        if(!root) return;
        // unwrap <mark>
        $$("mark", root).forEach(m=>{
          const txt = document.createTextNode(m.textContent);
          m.replaceWith(txt);
        });
        root.normalize();
      });
    }

    function highlight(query){
      clearHighlights();
      if(!query || query.trim().length < 2) return;

      const q = query.trim().toLowerCase();
      const rx = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), "ig");

      searchableRoots.forEach(sel=>{
        const root = $(sel);
        if(!root) return;

        const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
          acceptNode: (node)=>{
            if(!node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
            const parent = node.parentElement;
            if(!parent) return NodeFilter.FILTER_REJECT;
            if(parent.closest("script, style, textarea, input, select, button")) return NodeFilter.FILTER_REJECT;
            return NodeFilter.FILTER_ACCEPT;
          }
        });

        const nodes = [];
        while(walker.nextNode()) nodes.push(walker.currentNode);

        nodes.forEach(node=>{
          const text = node.nodeValue;
          if(!rx.test(text)) return;
          rx.lastIndex = 0;

          const frag = document.createDocumentFragment();
          let last = 0;
          text.replace(rx, (m, idx)=>{
            frag.appendChild(document.createTextNode(text.slice(last, idx)));
            const mark = document.createElement("mark");
            mark.textContent = m;
            frag.appendChild(mark);
            last = idx + m.length;
          });
          frag.appendChild(document.createTextNode(text.slice(last)));
          node.parentNode.replaceChild(frag, node);
        });
      });
    }

    // -------------------------
    // Event wiring
    // -------------------------
    function wireTabs(){
      $$(".tab").forEach(t=>{
        t.addEventListener("click", ()=> setActiveTab(t.dataset.tab));
        t.addEventListener("keydown", (e)=>{
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            setActiveTab(t.dataset.tab);
          }
        });
      });
    }

    function wireInputs(){
      // treat inputs
      ["fluCirculating","onsetWindow","covidPossible","complicatedNow"].forEach(id=>{
        $("#"+id).addEventListener("change", ()=> { computeTreat(); });
      });

      $("#btnSelectCommonRisks").addEventListener("click", selectCommonRisks);
      $("#btnClearRisks").addEventListener("click", clearRisks);

      // pep inputs
      ["pepCirculating","pepExposure","pepWindow","pepZana36","pepAtRisk","pepVaccinated","pepSevereImm","pepUnder5","pepOselRes"]
        .forEach(id=> $("#"+id).addEventListener("change", computePEP));

      // dosing
      ["oseInd","oseAge","oseWt","oseCrcl","oseImm","oseAdultWt41"].forEach(id=>{
        $("#"+id).addEventListener("input", computeOseltamivir);
        $("#"+id).addEventListener("change", computeOseltamivir);
      });

      // header buttons
      $("#btnQuickStart").addEventListener("click", ()=>{
        $("#decisionEngine").scrollIntoView({behavior:"smooth", block:"start"});
        toast("Jumped to Decision Engine.");
      });

      $("#btnCopySummary").addEventListener("click", ()=>{
        copyToClipboard(buildPlanText());
      });

      $("#btnReset").addEventListener("click", ()=>{
        // reset select inputs
        $("#fluCirculating").value = "unknown";
        $("#onsetWindow").value = "lt48";
        $("#covidPossible").value = "no";
        $("#complicatedNow").value = "no";
        clearRisks();

        $("#pepCirculating").value = "unknown";
        $("#pepExposure").value = "household";
        $("#pepWindow").value = "lt48";
        $("#pepZana36").value = "yes";
        $("#pepAtRisk").value = "yes";
        $("#pepVaccinated").value = "no";
        $("#pepSevereImm").value = "no";
        $("#pepUnder5").value = "no";
        $("#pepOselRes").value = "no";

        $("#oseInd").value = "treat";
        $("#oseAge").value = "adult13";
        $("#oseWt").value = "";
        $("#oseCrcl").value = "";
        $("#oseImm").value = "no";
        $("#oseAdultWt41").value = "no";

        $("#searchBox").value = "";
        clearHighlights();

        computeTreat();
        computePEP();
        computeOseltamivir();
        toast("Reset complete.");
      });

      // Search box
      $("#searchBox").addEventListener("input", (e)=> highlight(e.target.value));
    }

    function wireKeyboard(){
      document.addEventListener("keydown", (e)=>{
        // "/" focus search
        if(e.key === "/" && !e.ctrlKey && !e.metaKey && !e.altKey){
          const a = document.activeElement;
          const typing = a && ["INPUT","TEXTAREA","SELECT"].includes(a.tagName);
          if(!typing){
            e.preventDefault();
            $("#searchBox").focus();
          }
        }
        // ESC clears search
        if(e.key === "Escape"){
          if(document.activeElement === $("#searchBox")){
            $("#searchBox").value = "";
            clearHighlights();
            $("#searchBox").blur();
            toast("Search cleared.");
          }
        }
        // Ctrl+K jump to engine
        if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k"){
          e.preventDefault();
          $("#decisionEngine").scrollIntoView({behavior:"smooth", block:"start"});
          toast("Jumped to Decision Engine.");
        }
      });
    }

    // -------------------------
    // Init
    // -------------------------
    function init(){
      wireTabs();
      renderRiskChips();
      wireInputs();
      wireKeyboard();

      computeTreat();
      computePEP();
      computeOseltamivir();
      updatePlanPreview();
    }
    init();
  </script>
</body>
</html>
